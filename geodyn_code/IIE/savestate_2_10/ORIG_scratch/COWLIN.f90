!$COWLIN
      SUBROUTINE COWLIN(LORBIT,LORBVE,LNDRAG,LAFRC,                     &
     &   LBACKW,NSATS3,                                                 &
     &   NSETS,IBACK,IBACKV,IORDER,IORDRV,                              &
     &   NOSTEP,NOCORR,NSAT,N3,NEQN,NEQN3,NH,NHV,                       &
     &   NSTEPS,NSTEPV,ICPP,ICPV,ICCP,ICCV,ICCPV,                       &
     &   ICCVV,ISUMX,IXDDOT,    ISUMPX,                                 &
     &   IPXDDT,MJDSEC,MJDSV,MJDS0,MJDSB,NMAXG,NTOLDV,NTOLOV,JSAFRC,    &
     &   IORFRC,IPDFRC,JSPFRC,FSEC,FSECV,FSEC0,FSECB,H,HV,XEPOCH,       &
     &   IXDTMC,IPLPTR,NPANEL,NMOVEP,ITPXAT,ILTPAT,IBCKNC,NRAT,         &
     &   IXDDNC,ISMXNC,IDXDDN,IDSMXN,ICPPNC,LFHIRT,LSURFF,IPXDDA,       &
     &   NEQNA,IPTFBS,NPRMAC,LSETDN,NXSTAT,TXSTAT,DELXST,IPXST,         &
     &   JSALST,L12,HOLDV,NSSAVE,HOLDA1,HOLDA4,                         &
     &   HOLDA7,AA,II,LL)
!********1*********2*********3*********4*********5*********6*********7**
! COWLIN           82/08/27            8208.0    PGMR - TOM MARTIN
!
! FUNCTION:  INITIALIZE THE COWELL NUMERICAL INTEGRATOR.
!            1. LOOP THRU EACH SATELLITE SET IN THE ARC
!            2. MOVE THE EPOCH ELEMENTS INTO THE INTEG. ARRAYS
!            3. OBTAIN THE PREDICTOR/CORRECTOR COEFFICIENTS
!            4. START THE ORBIT AND MOVE EPOCH AS REQUIRED
!            5. START THE ORBIT AND VARIATIONAL EQUATIONS
!            6. MOVE TO A COMMON TIME AS REQUIRED
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   LORBIT   I    A    LOGICAL SWITCH INDICATING ORBIT-ONLY
!                      INTEGRATION WHEN .TRUE.
!   LORBVE   O    A    LOGICAL SWITCH INDICATING SAME ORDER AND
!                      STEPSIZE FOR ORBIT AND VARIATIONAL EQUATION
!                      WHEN .TRUE.
!   LNDRAG   I    A    LOGICAL SWITCH INDICATING THAT THE
!                      FORCING FUNCTION IS VELOCITY INDEPENDENT
!                      WHEN .TRUE.
!   LAFRC    I    A   .TRUE. WHEN THE ITH COMPONENT OF THE
!   (I,J,K)            JTH FORCE MODEL OF THE KTH SET IS ADJUSTED.
!                      I=1+TAYLOR SERIES ORDER IF I=1,3.FOR DESCREET
!                      PERIODS,I=4.FOR DRAG,J=1,FOR SOLRD,J=2.FOR
!                      GENERAL ACCELERATION,J=3.
!   LBACKW   I    A    LOGICAL SWITCH INDICATING THAT THE
!                      ORBIT INTEGRATION IS TO BE MOVED WHEN .TRUE.
!   NSATS3   I    S    3 TIMES THE NUMBER OF SATELLITES IN THE ARC
!   NSETS    I    S    NUMBER OF ORBIT INTEGRATION SETS IN THE ARC
!   IBACK    O    A    COUNTER INDICATING HOW MANY EXTRA BACK
!                      VALUES ARE STORED FOR SUMS AND
!                      ACCELERATIONS
!   IBACKV   O    A    SAME AS IBACK EXCEPT APPLIES TO
!                      VARIATIONAL EQUATIONS
!   IORDER   I    A    ORDER OF COWELL INTEGRATION FOR ORBIT
!   IORDRV   I    A    ORDER OF COWELL INTEGRATION FOR VAR. EQ.
!   NOSTEP   O    A    ACCUMULATED TOTAL OF ORBIT INTEGRATION
!                      OF INTEGRATION:PLUS ONE-FORWARD IN TIME
!                      MINUS ONE-BACKWARD IN TIME
!                      STEPS
!   NOCORR   O    A    ACCUMULATED TOTAL OF ORBIT CORRECTION
!                      STEPS
!   NSAT     I    A    NUMBER OF SATELLITES OF LIKE CHARACTERISTIS
!                      TO BE SIMULTANEOUSLY INTEGRATED
!   N3       O    A    NSAT*3
!   NEQN     I    A    NUMBER OF FORCE MODEL VARIATIONAL EQUATIONS
!   NEQN3    O    A    NEQN*N3
!   NH       I    A    MAXIMUM NUMBER OF ORBIT BACK VALUES PLUS ONE
!   NHV      I    A    MAXIMUM NUMBER OF VAR. EQ. BACK VALUES
!                      PLUS ONE
!   NSTEPS   I    A    NH+IORDER-2
!   NSTEPV   I    A    NHV+IORDRV-2
!   ICPP     O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR PREDICTING POSITION
!   ICPV     O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR PREDICTING VELOCITY
!   ICCP     O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR CORRECTING POSITION
!   ICCV     O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR CORRECTING VELOCITY
!   ICCPV    O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR CORRECTING POS. PARTIALS
!   ICCVV    O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      COEFFICIENTS FOR CORRECTING VEL. PARTIALS
!   ISUMX    O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      POSITION AND VELOCITY SUMS
!   IXDDOT   O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      ACCELERATIONS
!   ISUMPX   O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      SUMS FOR POSITION AND VELOCITY PARTIALS
!   IPXDDT   O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      ACCELERATION PARTIALS
!   MJDSEC   O    S    CURRENT DATE AND INTEGRAL SECONDS OF TIME O
!                      ORBIT INTEGRATION
!   MJDSV    O    S    CURRENT DATE AND INTEGRAL SECONDS OF
!                      VAR. EQ. TIME
!   MJDS0    I    S    DATE & INTEGRAL SECONDS OF INITIAL EPOCH
!   MJDSB    I    S    DATE & INTEGRAL SECONDS OF  RESET  EPOCH
!   NMAXG    O    A    ARRAY OF NMAX GEOPOTENTIAL VALUES
!                      OVER AN ARC.
!   NTOLDV   O    A    ARRAY OF MAX DEGREE TO BE USED IN VARIATIONAL
!                      EQUATIONS
!   NTOLOV   O    A    AARAY OF MAX ORDER TO BE USED IN VARIATIONAL
!                      EQUATIONS
!   JSAFRC   I    A    POINTER TO STARTING LOCATION IN PXDDOT
!                      ARRAY FOR DRAG,SOLRD,GENERAL ACCEL,C&S'S,
!                      AND TIDES
!   IORFRC   I    A    ORDER OF FORCE MODEL FOR DRAG,SOLRD,GENERAL
!                      ACEL
!   IPDFRC   I    A    NUMBER OF DESCREET PERIODS USED BY THE
!                      HIGHEST ORDER EFFECT IN DRAG,SOLRD,GENERAL
!                      ACCEL.
!   JSPFRC   I    A    POINTER TO STARTING LOCATIONS IN VARIOUS
!                      ARRAYS NEEDED BY THE FORCE MODEL
!   FSEC     O    A    CURRENT FRACTIONAL SECONDS OF ORBIT TIME
!   FSECV    O    A    CURRENT FRACTIONAL SECONDS OF VAR. EQ. TIME
!   FSEC0    I    A    FRACTIONAL SECONDS OF INITIAL EPOCH
!   FSECB    I    A    FRACTIONAL SECONDS OF  RESET  EPOCH
!   H        I    A    INTEGRATION STEP SIZE IN SECONDS FOR ORBIT
!   HV       I    A    INTEGRATION STEP SIZE IN SECONDS FOR VAR. EQ.
!   XEPOCH   I    A    INITIAL CARTESIAN EPOCH ELEMENTS
!   IXDTMC   O    A    LOCATIONS IN THE AA ARRAY OF THE POINT
!                      MASS ACCELERATION PARTIALS
!   IPLPTR   I    A    BOX-WING PARAMETER POINTER(SET IN 2S)
!   NPANEL   I    A    NUMBER OF "BW" PANELS ON EACH SATELLITE
!   NMOVEP   I    A    # OF MOVING "BW" PANELS ON EACH SATELLITE
!   ITPXAT   I    A    TOPEX ATT. BACK VALUES POINTER ARRAY (REALS)
!   ILPXAT   I    A    TOPEX ATT. BACK VALUES POINTER ARRAY (LOGICALS)
!   AA      I/O   A    REAL DYNAMIC ARRAY
!   II      I/O   A    INTEGER DYNAMIC ARRAY
!   LL      I/O   A    LOGICAL DYNAMIC ARRAY
!   IBACK    O    A    COUNTER INDICATING HOW MANY EXTRA BACK
!                      VALUES ARE STORED FOR SUMS AND ACCELEATIONS
!                      AT THE SMALL STEPSIZE (SEPARATELY INTEGRATED)
!   NRAT     I    A    THE RATIO OF LARGE STEPSIZE TO (SEPARATELY
!                      INTEGRATED) SMALL STEPSIZE (1==> NO SEPARATION)
!   IXDDNC   O    A    POINTERS TO THE ARRAY OF THE COWELL ACCELERATIONS
!                      FOR SEPARATELY INTEGRATED FORCES OR ACCELEROMTER
!                      FORCES
!   ISMXNC   O    A    LOCATIONS IN THE AA ARRAY OF THE COWELL
!                      POSITION AND VELOCITY SUMS FOR SEPARATELY
!                      INTEGRATED FORCES
!   IDXDDN   O    A    NUMBER OF STEPS COVERED BY XDDTNC ARRAY (ARRAY OF
!                      SEPARATELY INTEGRATED ACCELS)
!   IDSMXN   O    A    NUMBER OF STEPS COVERED BY SUMXNC AYYAY (ARRAY OF
!                      SEPARATELY INTEGRATED SUMS)
!   ICPPNC   O    A    LOCATIONS IN THE AA ARRAY OF INTERPOLATION
!                      COEFFICIENTS THAT ARE USED TO GET THE BIG STEP
!                      TRAJECTORY AT SMALL STEPS
!   LFHIRT   I    A    ARRAY OF LOGICAL FLAGS. EACH ELEMENT
!                      CORRESPONDS TO A FORCE MODEL COMPONENT.
!                      THE ARRAY DESCRIBES WHICH COMPONENTS ARE
!                      INTEGRATED AT A HIGH RATE.
!   LSURFF   I    A    ARRAY OF LOGICAL FLAGS. EACH ELEMENT
!                      CORRESPONDS TO A FORCE MODEL COMPONENT.
!                      THE ARRAY DESCRIBES WHICH COMPONENTS ARE
!                      INTEGRATED AT A HIGH RATE.
!   IPXDDA   O    A    POINTERS TO THE ARRAY OF PARTIAL DERIVATIVES
!                      OF COMPUTED ACCELEROMTER FORCES
!   NEQNA    I    A    NUMBER OF ADJUSTING ACCELEROMTER PARTIALS
!   IPTFBS   I    A    MAPPING ARRAY ; EXPLICIT PARTIAL ARRAY TO
!                      COMPUTED ACCELERATION PARTIAL ARRAY
!   NPRMAC   I    A    NUMBER OF PARMETERS IN EACH FORCE MODEL
!                      GROUP CATEGORY YO BE MAPPED BY IPTFBS
!
! COMMENTS:
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      DOUBLE PRECISION, ALLOCATABLE :: XR(:)
      DOUBLE PRECISION, ALLOCATABLE :: XRP(:)
      DOUBLE PRECISION, ALLOCATABLE :: PXA(:)
      CHARACTER*33 FILNAM
      SAVE
      DIMENSION LORBIT(NSETS),LORBVE(NSETS),LNDRAG(NSETS),              &
     &   LAFRC(4,3,1),                                                  &
     &   LBACKW(NSETS),IBACK(NSETS),IBACKV(NSETS),                      &
     &   IORDER(NSETS),IORDRV(NSETS),NOSTEP(NSETS),                     &
     &   NOCORR(NSETS),NSAT(NSETS),N3(NSETS),                           &
     &   NEQN(NSETS),NEQN3(NSETS),NH(NSETS),                            &
     &   NHV(NSETS),NSTEPS(NSETS),NSTEPV(NSETS),                        &
     &   ICPP(NSETS),ICPV(NSETS),ICCP(NSETS),                           &
     &   ICCV(NSETS),ICCPV(NSETS),ICCVV(NSETS),                         &
     &   ISUMX(NSETS),IXDDOT(NSETS),ISUMPX(NSETS),                      &
     &   IPXDDT(NSETS),MJDSEC(NSETS),MJDSV(NSETS),                      &
     &   MJDS0(NSETS),MJDSB(NSETS),NMAXG(NSETS),NTOLDV(NSETS),          &
     &   NTOLOV(NSETS),JSAFRC(MXFMG,1),IORFRC(3,1),IPDFRC(3,1),         &
     &   JSPFRC(9,1),FSEC(NSETS),FSECV(NSETS),FSEC0(NSETS),FSECB(NSETS),&
     &   H(NSETS),HV(NSETS),XEPOCH(1),IXDTMC(NSETS),                    &
     &   PKPX(6,6),AA(1),II(1),LL(1)
!      DIMENSION AEI(6),SVECT(6)
      DIMENSION IPLPTR(NSETS),NPANEL(NSETS),NMOVEP(NSETS),ITPXAT(NSETS),&
     &          ILTPAT(NSETS),IBCKNC(NSETS),NRAT(NSETS),IXDDNC(NSETS),  &
     &          ISMXNC(NSETS),IDXDDN(NSETS),IDSMXN(NSETS),ICPPNC(NSETS),&
     &          IPXDDA(NSETS),NEQNA(NSETS)
      DIMENSION LFHIRT(NHRATE,NSETS),LSURFF(NSURF,NSETS),               &
     &          IPTFBS(MXFMG,NSETS),NPRMAC(MXHRG,NSETS)
      DIMENSION FSECIN(1),FSECOT(1)
      DIMENSION ISTPST(30),ISTPCW(30)
      DIMENSION LSETDN(NSETS)
      DIMENSION NXSTAT(NSETS),TXSTAT(MXSTAT,NSETS)
!     DIMENSION IPXST(NSETS),DELXST(6,MXSTAT,MXSSET,NSETS)
      DIMENSION IPXST(MXSTAT,NSETS),DELXST(6,MXSTAT,MSATG,NSETS)
      DIMENSION JSALST(NSETS)
      DIMENSION P1(6),P2(6),Q1(6),Q2(6)
      DIMENSION FSC(1),HOS(1)
      DIMENSION XA(6,2),XA2(6)
      DIMENSION HOLDV(1),NSSAVE(1),HOLDA1(1)
      DIMENSION HOLDA4(1)
      DIMENSION HOLDA7(1)
      DIMENSION XAST(6)
! DYNAMIC ARRAY POINTERS
      COMMON/ASTLGT/CBODY1(7)
      COMMON/AXIS/LINTAX
      COMMON/HOLDRT/YQR(456),YQRDOT(450000),SUMXRQ(450000),YMNRT(3)
      COMMON/LALIQUE/LALIQ
      COMMON/HOLDQ/SUMXO(3,2,200,3),SUMXX(8000,3,2,200,3),QINTQ
      COMMON/ACCLRM/MDYNPD,MBAPPD,MACOBS,IDYNSC(200),MDYNST,IACCSC(200),&
     &              MACCSC,NACPRM(200),NATPRM(200),NXCLRM
      COMMON/BWINTG/JBFNRM,JTDNRM,JBWARE,JBWSPC,JBWDIF,JBWEMS,JBWTPA,   &
     &              JBWTPC,JBWTMD,JBWTMF,JBWTHX,JARADJ,JSPADJ,JDFADJ,   &
     &              JEMADJ,JTAADJ,JTCADJ,JTDADJ,JTFADJ,JTXADJ,JARUA ,   &
     &              JSPUA ,JDFUA ,JEMUA ,JTAUA ,JTCUA ,JTDUA ,JTFUA ,   &
     &              JTXUA ,NFACE ,NMOVE,NTFACE,JBFNR2,JBFNR3,JTDNR2,    &
     &              JTDNR3
      COMMON/BWLOGC/LVAREA,LTOPEX,LSPOT2,LGPSVA,LERS1,LMO,LMOC,LTDRSA,  &
     &              LMAGNA,LGFO,LTRMM,LEUVE,LVCL,LENVS,LCRYO,LGRAIL,    &
     &              LHY2A,LSARAL
      COMMON/BWREAL/SHADOW(2),SUNPCT,SCAREA,SCMASS,BWMEAN
      COMMON/CBDSTA/BDSTAT(7,999),XBDSTA
      COMMON/CEGREL/LGRELE,LRLCLK,LGRELR,LXPCLK,LBPCLK,NXEGRL
      COMMON/CGRAV/GM,AE,AESQ,FE,FFSQ32,FSQ32,XK2,XK3,XLAM,SIGXK2,      &
     &      SIGXK3,SIGLAM,RATIOM(2),AU,RPRESS
      COMMON/CNIARC/NSATA,NSATG,NSETA,NEQNG,NMORDR,NMORDV,NSORDR,       &
     &              NSORDV,NSUMX,NXDDOT,NSUMPX,NPXDDT,NXBACK,NXI,       &
     &              NXILIM,NPXPF,NINTIM,NSATOB,NXBCKP,NXTIMB,           &
     &              NOBSBK,NXTPMS,NXCNIA
      COMMON/CIMDST/IDRLTM(200),ITRLTM(200),IRELON,IRLONA,NRLTMC,       &
     & IDRCK4(200),IRKONA,NROCK4,IRKRAD,NXIRTM
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CIROCK/IGPSBK,IRKSTN
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORI06/KPTRAU,KPTRUA,KNFMG ,KIPTFM,KILNFM,KIGPC ,          &
     &              KIGPS ,KIGPCA,KIGPSA,KIELMT,KMFMG ,KTPGPC,          &
     &              KTPGPS,KTPUC ,KTPUS,                                &
     &              KLINK,KPTFAU,KPTFUA,NXCI06
      COMMON/CORL01/KLORBT,KLORBV,KLNDRG,KLBAKW,KLSETS,KLAFRC,KLSTSN,   &
     &              KLSNLT,KLAJDP,KLAJSP,KLAJGP,KLTPAT,KEALQT,KLRDGA,   &
     &              KLRDDR,KLRDSR,KFHIRT,KLSURF,KHRFON,KLTPXH,KSETDN,   &
     &              KTALTA,NXCL01
      COMMON/CORL02/KLNDTT,KLWSTR,KLNDTR,KLEVMF,KLTPMS,NXCL02
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/EXATAC/LEXTAC
      COMMON/EXATFL/LEXATO
      COMMON/EXATGL/LEXATT,NXEAGL
      COMMON/EXATFI/ISBJ20,NUMPEA,IPMPEA,MJDSEA
      COMMON/EXATFR/FSSCEA,RINTEA
      COMMON/GEODEG/NMAX,NMAXP1,NP,NTOLD,NTOLO,NADJC,NADJS,NADJCS,      &
     &              NPMAX,NXGDEG
      COMMON/G2EINF/G2EVER,G2EDAT,G2ERTM
      COMMON/G2SINF/G2SVER,G2SDAT,G2SRTM,G2SCOM,TDFVER,TDFRTM,SETCDS,   &
     &              GPCKSM,GPDEG ,GPORD ,XG2SIN
      COMMON/GPSBLK/LGPS,LNOARC,LSPL85,NXGPS
      COMMON/GPSSHD/LGPSHD,LGPSHO,LSHADS
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/INTSAV/ILSTEP,NSEG,NSCHED(2,50,10)
      COMMON/IRAPBUF/IBUFBEG(3)
      COMMON/IDELTX/MXSTAT,NEVENTS,NDSTAT,IDSYST,NDELTX
      COMMON/ITHERM/IDGSTN,NARC0
      COMMON/LASTER/LASTR(2),LBINAST,NXASTR
      COMMON/LDUAL/LASTSN,LSTSNX,LSTSNY
      COMMON/LSTRT/LSTART
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NFORCE/NHRATE,NSURF,MPXHDT,MXHRG,MXFMG,NFSCAC,NXFORC
      COMMON/NHINPT/NH1VOC,NXNHIN
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/RAPIDI/LINTF,LBUFOP
      COMMON/SETADJ/LSADRG(4),LSASRD(4),LSAGA(4),LSAGP,LSATID,LSAGM,    &
     &              LSADPM,LSAKF,LSADNX,LSADJ2,LSAPGM
      COMMON/SETAGP/NAJCA,NAJSA,NAJCG,NAJSG,NAJCT,NAJST
      COMMON/SETAPT/                                                    &
     &       JSADRG(1),JSASRD(1),JSAGA(1),JFAADJ,JTHDRG,JACBIA,JATITD,  &
     &       JDSTAT,JDTUM ,                                             &
     &       JSACS, JSATID,JSALG,JSAGM,JSAKF,JSAXYP,JSADJ2,JSAPGM,      &
     &       JFGADJ,JLTPMU,JLTPAL,JL2CCO,JL2SCO,JL2GM,JLRELT,           &
     &       JLJ2SN,JLGMSN,JLPLFM,JL2AE,JSAXTO,JSABRN
      COMMON/SETIOR/IORDRG,IORSRD,IORGA,IPDDRG,IPDSRD,IPDGA
      COMMON/SETOPT/LSDRG,LSSRD,LSGA,LSORB,LTHDRG,LROCK4
      COMMON/SETPPT/JSPDRG(3),JSPSRD(3),JSPGA(3),JCSAT
      COMMON/STARTT/ESSTRT,FSSTRT
      COMMON/TELEM/LTELEM,NXTELE
      COMMON/TELEN/NTELEM,NXTELEN
      COMMON/THERMD/DRGSAT,DTHSC,ZETA,SPAXT,SPAXL,THRMFL,XTHERM
      COMMON/TOPEXL/LTOPX1,LRAMP,LRDOWN,LRUP,LFIX0,LFIX90,LSIN,LTXPRT
      COMMON/XEPHMI/IBLKXE,IBLKXL,IBLKXP(2),IXEPRW,IXEPRD,              &
     &              IXEPB1,IXEPB2,IXBFS(2),IXBFE(2),                    &
     &              MJXEPS,IXPSAT(200),NXPSAT,MXPBFR,                   &
     &              NEPPBK,IXEPEF,IUNTXE,NXXEPH
      COMMON/XPCNT /NXTRAC,NXFLAG,NXALLC,NCPPER,NMINRT,NDPOR,NXXTRA
      COMMON/IOS/ISTOS1,ISTOS2,ISTOS3,ISTLST,INTSUB(3),JNTSUB(3),      &
     &        ILSTSG(80),INTOSP,MAPSAT(3,4)
      DATA ONE/1.0D0/,ZERO/0.0D0/
      DATA kentry/0/
      DATA IOUT/64/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
!
      IF(NXPSAT.GT.0) THEN
        CALL XEPHEM(AA,0,MJDSEC,X,AA(KXEPBF),1,              &
     &              FSEC,AA(KXEPBR),18,  L_error,LFIND)
      ENDIF
      ISETU=1
      LSTSNX=.FALSE.
      LSTSNY=.FALSE.
      IF(LASTSN) THEN
        IF(NXPSAT.GT.0) THEN
        ISATID=II(KISATN)
        CALL GETAST(AA,ISATID,MJDS0(1),FSEC0(1),XAST)
        IF(NXPSAT.GT.0) THEN
          DO IXP=1,NXPSAT
           IF(ISATID.EQ.IXPSAT(IXP)) LSTSNX=.TRUE.
          ENDDO
        ENDIF
        ENDIF
        ISETU=2
        NDPOR2=2*NDPOR
        NQ=NDPOR2
        IF(LBINAST) NQ=NQ*2
        ALLOCATE(XR(NQ))
        ALLOCATE(XRP(NQ))
        NQ=NEQN3(1)*2
        IF(LBINAST) NQ=NQ*2
        ALLOCATE(PXA(NQ))
        NAST=1
        GM2=1.D0
        IF(LBINAST) THEN
          ISATID=II(KISATN+1)
          IF(NXPSAT.GT.0) THEN
            DO IXP=1,NXPSAT
             IF(ISATID.EQ.IXPSAT(IXP)) LSTSNY=.TRUE.
            ENDDO
          ENDIF
          ISETU=3
          NAST=2
          GM2=AA(KPRMV-1+IPVAL(IX2GM))
        ENDIF
      ENDIF
      ISETU1=ISETU+1
      CBODY1(7)=0.D0
      IF(NINTOT.GT.0) CALL SYSTEM('rm RAPID*')
      kentry=kentry+1
      if(kentry.eq.0) then
      DO I=1,2
      DO J=1,50
      DO K=1,10
      NSCHED(I,J,K)=0
      ENDDO
      ENDDO
      ENDDO
      endif
      LINTF=.TRUE.
      LINTF=.TRUE.
      IF(NINTOT.GT.0)LINTF=.FALSE.
      LFLAG=.FALSE.
      ISATPX=KISATN
      LSTART=.TRUE.
      LTXPRT = .FALSE.
      NTFACE=ZERO
      KSATE=KIELMT
      KSATB=KPRMV-1+IPVAL(IXSATP)
      KSATB0=KPRMV0-1+IPVAL0(IXSATP)
      KSATBP=KPRMVP-1+IPVAL0(IXSATP)
      KSATBC=KPRMVC-1+IPVAL0(IXSATP)
      LTHDRG=.FALSE.
      ISATNO = 1
! COMPUTE DYNAMIC ARRAY POINTERS FOR EACH SATELLITE SET
      JSUMX=KSUMX
      JSMXNC=KSMXNC
      JXDDOT=KXDDOT
      JXDDNC=KXDDNC
      JSUMPX=KSUMPX
      JPXDDT=KPXDDT
      JXDTMC=KXDTMC
      JTPXAT=KTPXAT
      JLTPAT=KLTPAT
      JCPPNC=KCPPNC
      JPXDDA=KPXHDT
      JDYACT=KDYACT
      JDYNPE=KDYNPE
      JEXACT=KEXACT
      JXACIN=KXACIN
      JXACOB=KXACOB
      JACCBT=KACCBT
      JACPER=KACPER
      JACCPE=KACCPE
      JCOWL=0
      JCOWLV=0
      JCSAT=0
!***************DEBUG
!     PRINT 6234
!6234 FORMAT('- COWLIN BEFORE 1000 LOOP;IORDER,IORDRV,H,HV,FSEC0 ')
!     PRINT 6235,IORDER(1),IORDRV(1)
!6235 FORMAT(' ',10I10)
!     PRINT 6236,H(1),HV(1),FSEC0(1)
!6236 FORMAT(' ',5D25.16)
!***************DEBUG
!     DO 9911 ISET=1,NSETS
!     write(6,*)' dbg COWLIN END TIMES ', II(KMJDND-1+ISET), ISET
!9911  CONTINUE
      DO 1000 ISET=1,NSETS

! SET POINTERS TO THE OS ARRAY FOR INTEGRATION INFORMATION STORAGE
      IF(NINTOT.GT.0) THEN
      KSUMXOS=MAPSAT(1,1)
      KSUMPOS=MAPSAT(1,2)
      KXDDTOS=MAPSAT(1,3)
      KPDDTOS=MAPSAT(1,4)
      KNSTEPS=II(KSTEPS-1+ISET)
      ISEGM=II(KSGMNT-1+ISET)
      NEQNI=II(KNEQNI-1+ISET)
      ENDIF

      IBACKV(ISET)=0
      IBACK(ISET)=0
      IBCKNC(ISET)=0
      NOSTEP(ISET)=0
      NOCORR(ISET)=0
      N3(ISET)=3*NSAT(ISET)
      N2=NSAT(ISET)*2
      NEQN3(ISET)=N3(ISET)*NEQN(ISET)
      ICPP(ISET)=KCPP+JCOWL
      ICPV(ISET)=KCPV+JCOWL
      ICCP(ISET)=KCCP+JCOWL
      ICCV(ISET)=KCCV+JCOWL
      ICPPNC(ISET)=JCPPNC
      JCPPNC=JCPPNC+(NRAT(ISET)-1)*IORDER(ISET)*2
      JCOWL=JCOWL+IORDER(ISET)
      ICCPV(ISET)=KCCPV+JCOWLV
      ICCVV(ISET)=KCCVV+JCOWLV
      JCOWLV=JCOWLV+IORDRV(ISET)
      NSTEPS(ISET)=(MAX(IORDER(ISET),IORDRV(ISET))-1)*2
      NH(ISET)=NSTEPS(ISET)-(IORDER(ISET)-1)+1
      NHD=(NH1VOC+1)-NH(ISET)
      NHD=MAX(NHD,0)
      NHDO=NHD
      NSTEPS(ISET)=NSTEPS(ISET)+NHD
      NH(ISET)=NH(ISET)+NHD
      NSTEPV(ISET)=(IORDRV(ISET)-1)*2
      NHV(ISET)=NSTEPV(ISET)-(IORDRV(ISET)-1)+1
      NHD=(NH1VOC+1)-NHV(ISET)
      NHD=MAX(NHD,0)
      NSTEPV(ISET)=NSTEPV(ISET)+NHD
      NHV(ISET)=NHV(ISET)+NHD
      ISUMX(ISET)=JSUMX
      IDEL=(JSUMX-KSUMX)/3
      JSUMRC=KSUMRC+IDEL
      JSUMX=JSUMX+2*N3(ISET)*NH(ISET)
      ISMXNC(ISET)=JSMXNC
      IDSMXN(ISET)=1

      IF(NRAT(ISET).GT.1) THEN
         JSMXNC=JSMXNC+2*N3(ISET)*(3-IORDER(ISET)+NRAT(ISET)            &
     &         *((2*IORDER(ISET)-3)+NHDO))
         IDSMXN(ISET)=(3-IORDER(ISET)+NRAT(ISET)                        &
     &         *((2*IORDER(ISET)-3)+NHDO))
      ENDIF
      IXDDOT(ISET)=JXDDOT
      IDEL=(JXDDOT-KXDDOT)/3
      JXDDRC=KXDDRC+IDEL
      JXDDOT=JXDDOT+N3(ISET)*NSTEPS(ISET)
      IXDDNC(ISET)=JXDDNC
      IXDDAC=(IXDDNC(ISET)-KXDDNC)*NFSCAC+KXDDAO
      JXDDNC=JXDDNC+N3(ISET)*(1+NRAT(ISET)                              &
     &         *((2*IORDER(ISET)-3)+NHDO))
      IDXDDN(ISET)=(1+NRAT(ISET)                                        &
     &         *((2*IORDER(ISET)-3)+NHDO))
      IPXDDA(ISET)=JPXDDA
      JPXDDA=JPXDDA+IDXDDN(ISET)*NEQNA(ISET)*N3(ISET)
      ITPXAT(ISET)=JTPXAT
      JTPXAT=JTPXAT+2*NSAT(ISET)*NSTEPS(ISET)
      ILTPAT(ISET)=JLTPAT
      JLTPAT=JLTPAT+3*NSAT(ISET)*NSTEPS(ISET)
      ISUMPX(ISET)=JSUMPX
      JSUMPX=JSUMPX+2*NEQN3(ISET)*NHV(ISET)
      IPXDDT(ISET)=JPXDDT
      JPXDDT=JPXDDT+NEQN3(ISET)*NSTEPV(ISET)
!     IXDTMC(ISET)=JXDTMC
!     JXDTMC=JXDTMC+N3(ISET)*NSTEPS(ISET)
      NTOLDV(ISET)=MIN(NTOLDV(ISET),NMAXG(ISET))
!
! COMPUTE TOTAL NUMBER OF PANELS FOR THIS ARC
!
!     print *,'cowlin:iset,ntface,npanel:',iset,ntface,npanel(iset)
      NTFACE=NTFACE+NPANEL(ISET)
!     print *,'cowlin: ntface: ',ntface
!
 1000 END DO
      ICTOL=KCTOL
      JXEPOC=1
      ICNTT=0
      DO 9999 ISET=1,NSETS
      ICNTT=ICNTT+1

      IF(NINTOT.GT.0) THEN
      KSUMXOS=MAPSAT(1,1)
      KSUMPOS=MAPSAT(1,2)
      KXDDTOS=MAPSAT(1,3)
      KPDDTOS=MAPSAT(1,4)
      KNSTEPS=II(KSTEPS-1+ISET)
      ISEGM=II(KSGMNT-1+ISET)
      NEQNI=II(KNEQNI-1+ISET)
      ENDIF

      ISET1=ISET-1
      LROCK4 = .FALSE.
      IXDDAC=(IXDDNC(ISET)-KXDDNC)*NFSCAC+KXDDAO
      IF(ISET.GT.1) ISATPX=ISATPX+NSAT(ISET1)
! FILL THE GEODEG COMMON BLOCK
      NTOLD=NTOLDV(ISET)
      NTOLO=NTOLOV(ISET)
      NMAX=NMAXG(ISET)
      NMAXP1=NMAXG(ISET)+1
      NP=NMAXG(ISET)*(NMAXG(ISET)+1)/2+NMAXG(ISET)*3
      NAJCA=NEQN(ISET+2*MSETA)
      NAJSA=NEQN(ISET+3*MSETA)
      NAJCG=NEQN(ISET+4*MSETA)
      NAJSG=NEQN(ISET+5*MSETA)
      NAJCT=NEQN(ISET+6*MSETA)
      NAJST=NEQN(ISET+7*MSETA)
      CALL CLRTRG(AA,NSAT(ISET))
!  SET FORCE EXECUTIVE COMMON BLOCKS
      ESSTRT=MJDS0(ISET)+FSEC0(ISET)
      IORDRG=IORFRC(1,ISET)
      IORSRD=IORFRC(2,ISET)
      IORGA=IORFRC(3,ISET)
      IPDDRG=IPDFRC(1,ISET)
      IPDSRD=IPDFRC(2,ISET)
      IPDGA=IPDFRC(3,ISET)
      LSDRG=IORDRG.GT.0
      LSSRD=IORSRD.GT.0
      LSGA=IORGA.GT.0
      LNVEL=LNDRAG(ISET)
      IF(LSGA) LNVEL=.FALSE.
      LSORB=LORBIT(ISET)
      JSPDRG(1)=JSPFRC(1,ISET)
      JSPDRG(2)=JSPFRC(2,ISET)
      JSPDRG(3)=JSPFRC(3,ISET)
      JSPSRD(1)=JSPFRC(4,ISET)
      JSPSRD(2)=JSPFRC(5,ISET)
      JSPSRD(3)=JSPFRC(6,ISET)
      JSPGA(1)=JSPFRC(7,ISET)
      JSPGA(2)=JSPFRC(8,ISET)
      JSPGA(3)=JSPFRC(9,ISET)
      IF(ISET.GT.1) JCSAT=JCSAT+NSAT(ISET1)
! SET UP LOGICAL FLAG FOR THE THERMAL DRAG MODEL (LAGEOS)
! CALCULATE SWITCHES FOR ROCK4 SOLAR RADIATION MODEL
! IF SETS OF SATELLITES ARE USED, ALL SATELLITES IN SET MUST HAVE THE
! SAME MASS.
! CALCULATION OF POINTER TO SATELLITE ID ARRAY FOR FIRST SATELLITE
! IN SET
      IF(ISET.GT.1) ISATNO = ISATNO+NSAT(ISET1)
      ISATID=II(KISATN+ISATNO-1)
      IF(LSTINR.AND.ISET.EQ.NSETS.AND.LSETDN(ISET)) THEN
         MJDSIN=MJDS0(ISET)
         FSECIN(1)=FSEC0(ISET)
         CALL UTCET(.FALSE.,1,MJDSIN,FSECIN,FSECOT,AA(KA1UT))
         ETMUTC=FSECIN(1)-FSECOT(1)
         WRITE(91) ISATID,ETMUTC,NSURF,(LSURFF(IQP,ISET),IQP=1,NSURF)
      ENDIF
      IF((IRKONA.GT.0).OR.(THRMFL.GT.ZERO)) THEN
! ROCK4 MODEL CODE
       IF(IRKONA.GT.0) THEN
        IF(NROCK4.GT.0) THEN
          DO 1010 ISTID=1,NROCK4
            IF(ISATID.EQ.IDRCK4(ISTID)) THEN
             LROCK4=.TRUE.
             IRKSTN=ISATNO
             IGPSBK=MOD(ISATID,10)
             if( igpsbk >= 3 ) igpsbk = 3   ! jjm 20130617
             GOTO 1015
            ENDIF
 1010     CONTINUE
          GOTO 1015
        ELSE
          LROCK4=.TRUE.
          IRKSTN=ISATNO
          IGPSBK=MOD(ISATID,10)
          if( igpsbk >= 3 ) igpsbk = 3   ! jjm 20130617
        ENDIF
       ENDIF
 1015 CONTINUE
!
!
      IF(LGPSHD.AND..NOT.LROCK4) GO TO 9999
! THERMAL DRAG CODE
       IF(THRMFL.GT.ZERO) THEN
!       write(6,*)
!     1     'cowlin: thermal drag section entered: thrmfl ',thrmfl
        IF(ISATID.EQ.INT(DRGSAT+0.0001D0)) THEN
             LTHDRG=.TRUE.
             IDGSTN=ISATNO
             ENDIF
       ENDIF
      ENDIF
!
! BOX-WING PARAMETER POINTER CONTROL
!*************************************************************
!  THIS CODE ASSUMES ONLY ONE SATELLITE PER SET!!!!!!!
!*************************************************************
! INITIALIZE LVAREA,LTOPEX
      LVAREA = .FALSE.
      LTOPEX = .FALSE.
      LSPOT2 = .FALSE.
      LGPSVA = .FALSE.
      LERS1  = .FALSE.
      LMO    = .FALSE.
      LMOC   = .FALSE.
      LEXATO = .FALSE.
      LTDRSA = .FALSE.
      LMAGNA = .FALSE.
      LGFO   = .FALSE.
      LTRMM  = .FALSE.
      LEUVE  = .FALSE.
      LVCL   = .FALSE.
      LENVS  = .FALSE.
      LCRYO  = .FALSE.
      LGRAIL = .FALSE.
      LEXTAC = .FALSE.
      LHY2A  = .FALSE.
      LSARAL = .FALSE.
      DO IJ=1,NSURF
      IF(LSURFF(IJ,ISET)) LEXTAC = .TRUE.
      ENDDO
      IF(NPANEL(ISET).GT.0.OR.LEXTAC) THEN
! LOAD EXTERNAL ATTITUDE INFORMATION IF NECESSARY
         IF(LEXATT) THEN
         IF(LL(KEALQT+ISET-1)) THEN
          LEXATO = .TRUE.
          ISBJ20 = II(KEASBJ+ISET-1)
          NUMPEA = II(KEANMP+ISET-1)
          IPMPEA = II(KEAPMP+ISET-1)
          MJDSEA = II(KEAMJS+ISET-1)
          FSSCEA = AA(KEAFSS+ISET-1)
          RINTEA = AA(KEAINS+ISET-1)
         ENDIF
         ENDIF
         ENDIF
      IF(NPANEL(ISET).GT.0.OR.LEXTAC) THEN
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
! SET LOGICAL FLAGS FOR SAT ATTITUDE CONTROL
       IF(II(KSCATT+ISET-1) .EQ.1) THEN
         LTOPEX=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 2) THEN
         LSPOT2=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 3) THEN
         LGPSVA=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 4) THEN
         LERS1=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 5) THEN
         LMO=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 6) THEN
         LMOC=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 7) THEN
         LTDRSA=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 8) THEN
         LMAGNA=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 9) THEN
         LGFO=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 10) THEN
         LTRMM=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 11) THEN
         LEUVE=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 12) THEN
         LVCL=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 13) THEN
         LENVS=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 14) THEN
         LCRYO=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 15) THEN
         LGRAIL=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 16) THEN
         LGRAIL=.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 17) THEN
         LHY2A =.TRUE.
       ELSE IF (II(KSCATT+ISET-1) .EQ. 18) THEN
         LSARAL=.TRUE.
       ENDIF
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      ENDIF
      IF(NPANEL(ISET).GT.0) THEN
! COMPUTE POINTERS TO BOX-WING PARAMETER VALUES
!        print *,'cowlin: kbfnrm: ',kbfnrm
         JBFNRM = KBFNRM+IPLPTR(ISET)-1
         JBFNR2 = JBFNRM + NTFACE
         JBFNR3 = JBFNRM + 2*NTFACE
!        print *,'cowlin: jbfnr: ',jbfnrm,jbfnr2,jbfnr3
!        print *,'cowlin: iset jbfnrm: ',iset,jbfnrm
!        print *,'cowlin: iplptr: ',iplptr(iset)
         JTDNRM = KTDNRM+IPLPTR(ISET)-1
         JTDNR2 = JTDNRM + NTFACE
         JTDNR3 = JTDNRM + 2*NTFACE
!        print *,'cowlin: jtdnr: ',jtdnrm,jtdnr2,jtdnr3
         JBWARE = KPRMV+IPVAL(IXAREA)+IPLPTR(ISET)-2
         JBWSPC = KPRMV+IPVAL(IXSPRF)+IPLPTR(ISET)-2
         JBWDIF = KPRMV+IPVAL(IXDFRF)+IPLPTR(ISET)-2
         JBWEMS = KPRMV+IPVAL(IXEMIS)+IPLPTR(ISET)-2
         JBWTPA = KPRMV+IPVAL(IXTMPA)+IPLPTR(ISET)-2
         JBWTPC = KPRMV+IPVAL(IXTMPC)+IPLPTR(ISET)-2
         JBWTMD = KPRMV+IPVAL(IXTIMD)+IPLPTR(ISET)-2
         JBWTMF = KPRMV+IPVAL(IXTIMF)+IPLPTR(ISET)-2
         JBWTHX = KPRMV+IPVAL(IXTHTX)+IPLPTR(ISET)-2
! COMPUTE POINTERS TO UNADJUSTED TO ADJUSTED MAPPING ARRAYS(IPTRUA)
         JARUA  = KPTRUA+IPVAL(IXAREA)+IPLPTR(ISET)-2
         JSPUA  = KPTRUA+IPVAL(IXSPRF)+IPLPTR(ISET)-2
         JDFUA  = KPTRUA+IPVAL(IXDFRF)+IPLPTR(ISET)-2
         JEMUA  = KPTRUA+IPVAL(IXEMIS)+IPLPTR(ISET)-2
         JTAUA  = KPTRUA+IPVAL(IXTMPA)+IPLPTR(ISET)-2
         JTCUA  = KPTRUA+IPVAL(IXTMPC)+IPLPTR(ISET)-2
         JTDUA  = KPTRUA+IPVAL(IXTIMD)+IPLPTR(ISET)-2
         JTFUA  = KPTRUA+IPVAL(IXTIMF)+IPLPTR(ISET)-2
         JTXUA  = KPTRUA+IPVAL(IXTHTX)+IPLPTR(ISET)-2
! DETERMINE # OF PLATES & # OF MOVEABLE PLATES FOR SAT. OF INTEGRATION
         NFACE  = NPANEL(ISET)
         NMOVE  = NMOVEP(ISET)
! DETERMINE AREA AND MASS FOR SAT. OF INTEGRATION
         SCAREA = AA(KAREA+ISET-1)
         SCMASS = AA(KXMASS+ISET-1)
! DETERMINE MEAN MOTION FOR SAT. OF INTEGRATION FOR THERMAL MODEL
         IKEPLR=(ISET-1)*6+KCKEP
       IF(II(KSCATT+ISET-1) .EQ.1) BWMEAN = SQRT(AA(IKEPLR)**3/GM)
! SET LOGICAL FLAG FOR VARIABLE AREA
         LVAREA=.TRUE.
!
! PRINT OUT TELEM FILE HEADER IF ON LAST ITERATION AN
!CCC        IF(LSTITR .AND. LTELEM .AND. LTOPX1 .AND.
!       IF(LSTITR .AND. LTELEM .AND. (.NOT. LTXPRT) .AND.               &
!    &     II(KSCATT+ISET-1) .GT. 0) THEN
        IF(LSTITR .AND. LTELEM .AND. (.NOT. LTXPRT)) then
!
! PRINT OUT TELEM FILE HEADERS FOR MULTIPLE SETS USING STARTING INFO.
! FROM FIRST SET.
!
           LTXPRT = .TRUE.
!     print *,'cowlin: printing header for telem file'
!
           WRITE(97) G2ERTM
           WRITE(97) G2SVER,G2EVER,DBLE(NSETS)
!
! PRINT SAT. MODEL RECORD FOR ALL SETS AND NUMPNL RECORD
!
           WRITE(97) (DBLE(II(KSCATT+ICNT-1)),ICNT=1,NSETS)
!
           WRITE(97) (DBLE(NPANEL(ICNT)),ICNT=1,NSETS)
!
           IOFF=0
           DO 1007 IDXSET = 1,NSETS
           NUMPNL = NPANEL(IDXSET)
!     print *,'cowlin: printing telem sat info. numpnl:',idxset,numpnl
           IF(NUMPNL.EQ.0) GOTO 1007
!
! OUTPUT BODY-FIXED NORMAL VECTORS
!
           DO 1017 IK=1,NUMPNL
!             WRITE(97,11200) (AA(JBFNRM+IOFF+IK+NTFACE*(ICNT-1)-1),ICNT
           WRITE(97) (AA(JBFNRM+IOFF+IK+NTFACE*(ICNT-1)-1),ICNT=1,3)
 1017      CONTINUE
! OUTPUT PANEL AREAS
           WRITE(97) (AA(JBWARE+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWARE+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL SPEC REFLEC.
           WRITE(97) (AA(JBWSPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWSPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL DIFF. REFLEC
           WRITE(97) (AA(JBWDIF+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWDIF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL EMISSIVITY
           WRITE(97) (AA(JBWEMS+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWEMS+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TEMP A
           WRITE(97) (AA(JBWTPA+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTPA+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TEMP C
           WRITE(97) (AA(JBWTPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TIME D
           WRITE(97) (AA(JBWTMD+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTMD+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TIME F
           WRITE(97) (AA(JBWTMF+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTMF+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL THETAX
           WRITE(97) (AA(JBWTHX+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTHX+IOFF+ICNT-1),ICNT=1,NUMPNL)
        IOFF=IOFF+NUMPNL
 1007   CONTINUE
        ENDIF

      ELSE
!
!     write(6,*)'NO PANELS IN THE SETUP BUT TELEM REQUIRED FOR ',ISATID
! PRINT OUT TELEM FILE HEADER IF ON LAST ITERATION AN
!
      CALL FNDNUM(ISATID,II(KTELEO),NTELEM,IRET)
      IF(IRET.NE.0)  THEN
        IF(LSTITR .AND. LTELEM .AND. II(KTELEO-1+IRET).EQ.ISATID) THEN
!
! PRINT OUT TELEM FILE HEADERS FOR MULTIPLE SETS USING STARTING INFO.
! FROM FIRST SET.
!
           LTXPRT = .TRUE.
!
           IF(ICNTT.EQ.1) WRITE(97) DBLE(NTELEM)
               SATID=DBLE(ISATID)
           WRITE(97) G2ERTM
           WRITE(97) G2EVER,SATID,DBLE(NSETS)
!
! PRINT SAT. MODEL RECORD FOR ALL SETS AND NUMPNL RECORD
!
           WRITE(97) (DBLE(II(KSCATT+ICNT-1)),ICNT=1,NSETS)
!
           WRITE(97) (DBLE(NPANEL(ICNT)),ICNT=1,NSETS)
!
           IOFF=0
           DO 1107 IDXSET = 1,NSETS
           NUMPNL = NPANEL(IDXSET)
!     print *,'cowlin: printing telem sat info. numpnl:',idxset,numpnl
           IF(NUMPNL.EQ.0) GOTO 1107
!
! OUTPUT BODY-FIXED NORMAL VECTORS
!
           DO 1117 IK=1,NUMPNL
!             WRITE(97,11200) (AA(JBFNRM+IOFF+IK+NTFACE*(ICNT-1)-1),ICNT
           WRITE(97) (AA(JBFNRM+IOFF+IK+NTFACE*(ICNT-1)-1),ICNT=1,3)
 1117      CONTINUE
! OUTPUT PANEL AREAS
           WRITE(97) (AA(JBWARE+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWARE+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL SPEC REFLEC.
           WRITE(97) (AA(JBWSPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWSPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL DIFF. REFLEC
           WRITE(97) (AA(JBWDIF+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWDIF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL EMISSIVITY
           WRITE(97) (AA(JBWEMS+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWEMS+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TEMP A
           WRITE(97) (AA(JBWTPA+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTPA+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TEMP C
           WRITE(97) (AA(JBWTPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTPC+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TIME D
           WRITE(97) (AA(JBWTMD+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTMD+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL TIME F
           WRITE(97) (AA(JBWTMF+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTMF+IOFF+ICNT-1),ICNT=1,NUMPNL)
! OUTPUT PANEL THETAX
           WRITE(97) (AA(JBWTHX+IOFF+ICNT-1),ICNT=1,NUMPNL)
!          WRITE(97,11300) (AA(JBWTHX+IOFF+ICNT-1),ICNT=1,NUMPNL)
        IOFF=IOFF+NUMPNL
 1107   CONTINUE
        ENDIF
       ENDIF  ! IRET.NE.0

      ENDIF
      IF(LSORB) GO TO 1030
!  SET FORCE MODEL ADJUSTMENT LOGICALS&POINTERS
      DO 1020 N=1,4
      LSADRG(N)=LAFRC(N,1,ISET)
      LSASRD(N)=LAFRC(N,2,ISET)
      LSAGA(N)=LAFRC(N,3,ISET)
 1020 END DO
!
! THE NEXT SECTION OF CODE (UNTIL THE CALL TO GPOINT)
! UNLOADS THE JSAFRC ARRAY
! INTO TWO COMMON BLOCKS OF POINTERS SETAPT AND BWINTG
! THE POINTERS ARE INDXES OF WHERE EACH FORCE MODEL
! CATEGORY FITS INTO THE EXPLICIT PARTIAL ARRAY FOR
! THE VARIATIONAL EQUATIONS
!
! NOTE THAT THE POINTERS IN JSAFRC, AND SETAPT
! ARE NOT ALWAS IN ASCENDING ORDER. THEY DO, HOWEVER,
! POINT TO THE PROPER LOCATION IN THE VARIATIONAL
! EQUATIONS
!
!Categories for MXFMG (Currently 39)
!
!(note that JSAFRC is mostly in ascending order with the following 3 exceptions)
!
!1) JSAFRC(39) (finite BURN) is just after JSAFRC(18) (TUM SOLR)
!2) JSAFRC(26) (Dynamic PM contribution to C20) is just after JSAFRC(19) (C & S
!3) JSAFRC(38) (Planetary Orientation) is just after JSAFRC(25) (DynamiC Xp and
!
!
! FOLLOWING 3 POINTERS ARE IN SETADJ
      JSADRG(1)=JSAFRC(1,ISET) ! DRAG
      JSASRD(1)=JSAFRC(2,ISET) ! SOLAR RADIATION
      JSAGA(1)=JSAFRC(3,ISET)  ! GEN ACCEL
! COMPUTE POINTERS TO BOX-WING PARAMETER PARTIALS
! THE FOLLWING 9 (THROUGH JTXADJ) POINTERS IN BWINTG
      JARADJ = JSAFRC(4,ISET)
      JSPADJ = JSAFRC(5,ISET)
      JDFADJ = JSAFRC(6,ISET)
      JEMADJ = JSAFRC(7,ISET)
      JTAADJ = JSAFRC(8,ISET)
      JTCADJ = JSAFRC(9,ISET)
      JTDADJ = JSAFRC(10,ISET)
      JTFADJ = JSAFRC(11,ISET)
      JTXADJ = JSAFRC(12,ISET)
! REMAINING POINTERS ARE IN SETADJ
      JTHDRG = JSAFRC(13,ISET) ! LAGEOS THERMAL DRAG SPIN AXIS
      JFAADJ = JSAFRC(14,ISET) ! FANTOM ARC FORCE PARAMETERS POINTER
      JACBIA = JSAFRC(15,ISET) ! ACCELEROMETER BIAS
      JATITD = JSAFRC(16,ISET) ! ARC FORCE ATTITUDE
      JDSTAT = JSAFRC(17,ISET) ! DELTA STATE
      JDTUM  = JSAFRC(18,ISET) ! TUM SOLAR RAD
!              JSAFRC(39)   FINITE BURN
      JSACS  = JSAFRC(19,ISET) ! GLOBAL GEOPTENTIAL POINTER
!              JSAFRC(26)         POLAR MOTION J2 PARTIAL
      JSATID = JSAFRC(20,ISET) ! TIDES
      JSALG  = JSAFRC(21,ISET) ! LOCAL GRAVITY
      JSAKF  = JSAFRC(22,ISET) ! DYNAMIC POLAR MOTION SCALE
      JSAGM  = JSAFRC(23,ISET) ! CENTRAL BODY GM
      JSAPGM = JSAFRC(24,ISET) ! PLANETARY MOON
      JSAXYP = JSAFRC(25,ISET) ! POLAR MOTION (WHEN THERE IS A FORCE EFFE
!              JSAFRC(38)          PLANETARY ORIENTATION
      JSADJ2 = JSAFRC(26,ISET) ! POLAR MOTION J2 PARTIAL
      JFGADJ = JSAFRC(27,ISET) ! GLOBAL FANTOM FORCE MODEL PARTIALS
      JLTPMU = JSAFRC(28,ISET) ! LENSE THIRRING MU PARTIALS
      JLTPAL = JSAFRC(29,ISET) ! LENSE THIRRING ALPHA PARTIALS
      JL2CCO = JSAFRC(30,ISET) ! C COEFS FOR 2ND ASTEROID
      JL2SCO = JSAFRC(31,ISET) ! S COEFS FOR 2ND ASTEROID
      JL2GM  = JSAFRC(32,ISET) ! GM 2ND ASTEROID
      JL2AE  = JSAFRC(33,ISET) ! AE 2ND ASTEROID
      JLRELT = JSAFRC(34,ISET) ! RELATIVITY PARM FOR SUN
      JLJ2SN = JSAFRC(35,ISET) ! J2 SUN
      JLGMSN = JSAFRC(36,ISET) ! GM SUN
      JLPLFM = JSAFRC(37,ISET) ! 698 PLANETARY FORCE
      JSAXTO = JSAFRC(38,ISET) ! PLANETARY ORIENTATION PARTIALS
      JSABRN = JSAFRC(39,ISET) ! FINITE BURN PARTIALS


      CALL GPOINT(JSAFRC(1,ISET),LSURFF(1,ISET),IPTFBS(1,ISET),         &
     &            NPRMAC(1,ISET))
!
!
! THE COMMENTED OUT CODE BELOW IS NO LOMGER NEEDED. THERE IS NOW
! A SLOT IN THE JSAFRC ARRAY FOR PLANETARY ORIENTATION
!
!
! NOTE THAT CODE CURRENTLY ASSUMES THAT:
!     PLANET ORIENTATION IS NEAR THE END OF THE FORCE MODEL PARAMTETERS
!     AND THE ONLY FORCE MODEL PARMETERS AFTER IT ARE
!    IXFGFM, IX2CCO, IX2SCO AND IX2GM
!
!      IF(NPVAL0(IXXTRO).LE.0) GO TO 1030
!      IF(.NOT.LSTINR) GO TO 1030
!      NDIF=NEQN(ISET)-JSALST(ISET)+1
!      IF(NDIF.NE.NPVAL0(IXXTRO)) THEN
!         WRITE(6,12000)
!         WRITE(6,12001) NEQN(ISET)
!         WRITE(6,12002) JSAFRC(MXFMG,ISET)
!         WRITE(6,12003) NPVAL0(IXXTRO),ISET
!         STOP
!      ENDIF
!
!
 1030 CONTINUE
! INITIALIZE SUMMARY PAGE ARRAYS
      JNVSTP=KNVSTP+ISET1
      II(JNVSTP)=0
      IUP=NSAT(ISET)
      DO 1040 N=1,IUP
      II(KNDARK+JCSAT+N-1)=0
      II(KNSTRN+JCSAT+N-1)=0
      LL(KLSTSN+JCSAT+N-1)=.FALSE.
      LL(KLSNLT+JCSAT+N-1)=.FALSE.
 1040 END DO
      NXEPOC=JXEPOC
      NX=KX
      N3I=N3(ISET)
! STORE EPOCH CARTESIAN STATE INTO INTEGRATION STATE ARRAY
      DO 2000 N=1,N3I
      AA(NX)=XEPOCH(NXEPOC)
      AA(NX+N3I)=XEPOCH(NXEPOC+3)
      NX=NX+1
      NXEPOC=NXEPOC+1
 2000 END DO
      IISET=2
      IF(LASTSN.AND.ISET.EQ.1) IISET=1
      IF(LBINAST.AND.ISET.EQ.2) IISET=3
      CALL SWTCPT(IISET,.TRUE.)
      IF(LASTSN.AND.ISET.EQ.1) THEN
         XA(1,1)=AA(KX)
         XA(2,1)=AA(KX+1)
         XA(3,1)=AA(KX+2)
         XA(4,1)=AA(KX+3)
         XA(5,1)=AA(KX+4)
         XA(6,1)=AA(KX+5)
         ICTOL=ICTOL+1
         JXEPOC=JXEPOC+N3I*2
         GO TO 9999
      ENDIF
      IF(LBINAST.AND.ISET.EQ.2) THEN
         XA(1,2)=AA(KX)
         XA(2,2)=AA(KX+1)
         XA(3,2)=AA(KX+2)
         XA(4,2)=AA(KX+3)
         XA(5,2)=AA(KX+4)
         XA(6,2)=AA(KX+5)
         ICTOL=ICTOL+1
         JXEPOC=JXEPOC+N3I*2
         GO TO 9999
      ENDIF
      IF(LASTSN.AND.ISET.GE.ISETU1) THEN
         IF(LBINAST) THEN
           JQ1=(ISET-ISETU1)*12
           JQ2=(ISET-ISETU1)*4*NDPOR
           DO J=1,6
             XA(J,1)=HOLDA1(JQ1+J)
             XA(J,2)=HOLDA1(JQ1+6+J)
           ENDDO
           IF(LINTAX) THEN
              DO J=1,2*NDPOR
!!!!            YQR(J)=HOLDA7(JQ2+J)
                XR(J)=HOLDA7(JQ2+J)
                XR(J+2*NDPOR)=HOLDA7(JQ2+2*NDPOR+J)
              ENDDO
           ENDIF
         ELSE
          JQ1=(ISET-ISETU1)*6
           JQ2=(ISET-ISETU1)*2*NDPOR
           DO J=1,6
             XA(J,1)=HOLDA1(JQ1+J)
           ENDDO
           IF(LINTAX) THEN
              DO J=1,2*NDPOR
!!!!            YQR(J)=HOLDA7(JQ2+J)
                XR(J)=HOLDA7(JQ2+J)
              ENDDO
           ENDIF
        ENDIF
      ENDIF
! OBTAIN ORBIT PREDICTOR COEFFICIENTS
      CALL COWCOF(AA(ICPP(ISET)),AA(ICPV(ISET)),                        &
     &   IORDER(ISET),1)
! OBTAIN ORBIT CORRECTOR COEFFICIENTS
      CALL COWCOF(AA(ICCP(ISET)),AA(ICCV(ISET)),                        &
     &   IORDER(ISET),0)
      IF(LORBIT(ISET))GO TO 2500
! OBTAIN VARIATIONAL EQUATION CORRECTOR COEFFICIENTS
      CALL COWCOF(AA(ICCPV(ISET)),AA(ICCVV(ISET)),                      &
     &   IORDRV(ISET),0)
 2500 CONTINUE
      NRAT1=NRAT(ISET)-1
      IF(NRAT(ISET).GT.1) CALL COEFNC(IORDER(ISET),NRAT1,               &
     &                                AA(ICPPNC(ISET)))
      IF(NRAT1.GT.0.AND.LASTSN) THEN
        NZQ=IDXDDN(ISET)*3
        CALL CLEARA(AA(IXDDNC(ISET)),NZQ)
        NZQ=IDSMXN(ISET)*6
        CALL CLEARA(AA(ISMXNC(ISET)),NZQ)
      ENDIF
!***** DEBUG *****
!     PRINT 12345,MJDS0(ISET),MJDSB(ISET),FSEC0(ISET),FSECB(ISET),
!    1   LBACKW(ISET)
!2345 FORMAT(' **COWLIN** MJDS0,MJDSB,FSEC0,FSECB,LBACKW'/2I12,
!    1   2G25.16,10X,L1)
!***** END DEBUG *
      IOL1=IORDER(ISET)-1
      MJDSEC(ISET)=MJDS0(ISET)
      FSEC(ISET)=FSEC0(ISET)
      IF(.NOT.LBACKW(ISET))GO TO 4000
      IF(LASTSN) THEN
        WRITE(6,12010)
        WRITE(6,12011)
        STOP
      ENDIF

      LFLAG=.TRUE.
      LBACKW(ISET)=.FALSE.
! INTEGRATE BACKWARDS(FORWARDS) AND RESET EPOCH
      DIFSEC=(MJDSB(ISET)-MJDS0(ISET))+FSECB(ISET)                      &
     &      -FSEC0(ISET)
! IF EPOCH IS TO BE RESET USE SMALL STEP SIZE TO INTEGRATE
! ALL OF THE FORCES
      HSMALL=H(ISET)/DBLE(NRAT(ISET))
      IF(LASTSN) HSMALL=H(ISET)
      HSTEP=SIGN(HSMALL,DIFSEC)
      IF(LGPSHD) HSTEP=SIGN(360.D0,DIFSEC)
      HSTEP2=HSTEP+HSTEP
!***** DEBUG *****
!     PRINT 23456
!23456 FORMAT(' **COWLIN** BACKWARDS(FORWARD) START CALL')
!***** END DEBUG *

! START INTEGRATOR
      JEQN=MAX(NEQN(ISET),1)
      JEQN3=MAX(NEQN3(ISET),1)
      CALL START(.TRUE.,LNVEL,IORDER(ISET),                             &
     &   HSTEP,MJDSEC(ISET),FSEC(ISET),NSAT(ISET),                      &
     &   N3(ISET),JEQN,JEQN3,IOL1,                                      &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),                              &
     &   AA(KPX),AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),          &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1))

      POSNEG=SIGN(ONE,DIFSEC)
      DIFSEC=DIFSEC+HSTEP2
      DIFSB=(MJDSEC(ISET)-MJDS0(ISET))+FSEC(ISET)                       &
     &     -FSEC0(ISET)
      RATIO=DIFSB/DIFSEC
      IF(RATIO.GE.ONE)GO TO 3000
! INTEGRATION IS INCOMPLETE--COMPLETE USING COWELL'S METHOD
      ISH2=HSTEP2
      FSH2=HSTEP2-ISH2
      FSEC2=FSECB(ISET)+FSH2
      ISEC=FSEC2
      FSEC2=FSEC2-ISEC
      MJDS2=MJDSB(ISET)+ISH2+ISEC
      JEQN=MAX(NEQN(ISET),1)
      JEQN3=MAX(NEQN3(ISET),1)
      NRATS1=0
      LATOT=.TRUE.
      LSAVEA=.FALSE.
      NSTPSV=0
      CALL COWELL(.TRUE.,LNVEL,IBACK(ISET),                             &
     &   IBACKV(ISET),IORDER(ISET),IORDRV(ISET),                        &
     &   HSTEP,HSTEP,POSNEG,NOSTEP(ISET),NOCORR(ISET),                  &
     &   AA(ICTOL),NSAT(ISET),MJDSEC(ISET),FSEC(ISET),                  &
     &   MJDSV(ISET),FSECV(ISET),MJDS2,FSEC2,N3(ISET),                  &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),                             &
     &   AA(ICCVV(ISET)),AA(KVMATX),AA(KRSQ),                           &
     &   AA(KXPPPP),AA(KX),AA(ISUMX(ISET)),                             &
     &   AA(IXDDOT(ISET)),AA(KPX),AA(KPX),                              &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(IPXDDT(ISET)),            &
     &   II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),AA(ITPXAT(ISET)),        &
     &   LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),AA(KXUTDT),               &
     &   NRATS1,LATOT,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),   &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEA,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSTPSV,ISTPST,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .FALSE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),        &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(JSUMRC),AA(JXDDRC),                                         &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMPOS),                                          &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS))
 3000 CONTINUE
! INTEGRATION BACKWARD(FORWARD)IS COMPLETE
!
! INTERPOLATE FOR NEW EPOCH STATE
      IBAKDD=IBACK(ISET)*N3(ISET)
      IBAKSM=IBAKDD*2+ISUMX(ISET)
      IBAKDD=IBAKDD+IXDDOT(ISET)
      S=((MJDSB(ISET)-MJDSEC(ISET))+(FSECB(ISET)-FSEC(ISET)))/HSTEP
      CALL INTRP(S,AA(KCIP),AA(KCIV),IORDER(ISET),                      &
     &   HSTEP,AA(IBAKSM),AA(IBAKDD),N3(ISET),                          &
     &   IOL1,AA(KX))
! * THE FOLLOWING LENS-THIRRING CODE HAS BEEN COMMENTED OUT
!   BECAUSE LENS-THIRRING IS NOW BEING APPLIED TO THE EQUATIONS
!   OF MOTION IN SUBROUTINE FEAREL.
!     NX=KX
!     IF(.NOT.LGRELE) GO TO 3200
! ADJUST THE RESET ELEMENTS FOR LENSE-THIRRING
!     IUP=NSAT(ISET)
!     DO 3100 N=1,IUP
!     KGMP=KPRMV+IPVAL(IXGM)+IBDGM(ICBDGM)-2
!     GMP =AA(KGMP)
!     CALL ELEM(AA(NX),AA(NX+1),AA(NX+2),AA(NX+N3I),AA(NX+1+N3I),
!    .          AA(NX+2+N3I),AEI,1,PKPX,GMP)
!     AEI(4)=AEI(4)+AA(KDNLT+JCSAT-1+N)
!     CALL POSVEL(SVECT,AEI,2,GMP)
!     AA(NX)=SVECT(1)
!     AA(NX+1)=SVECT(2)
!     AA(NX+2)=SVECT(3)
!     AA(NX+N3I)=SVECT(4)
!     AA(NX+N3I+1)=SVECT(5)
!     AA(NX+N3I+2)=SVECT(6)
!     NX=NX+3
!3100 CONTINUE
!3200 CONTINUE
      NXEPOC=JXEPOC
      NX=KX
      DO 3500 N=1,N3I
      XEPOCH(NXEPOC)=AA(NX)
      XEPOCH(NXEPOC+3)=AA(NX+N3I)
      NX=NX+1
      NXEPOC=NXEPOC+1
 3500 END DO
      NT=NSAT(ISET)
      NX=KX
      ISATB=KSATB
      JSATB=KSATB
      DO 3600 N=1,NT
      AA(JSATB)=AA(NX)
      AA(JSATB+1)=AA(NX+1)
      AA(JSATB+2)=AA(NX+2)
      AA(JSATB+3)=AA(NX+N3I)
      AA(JSATB+4)=AA(NX+N3I+1)
      AA(JSATB+5)=AA(NX+N3I+2)
      JSATB=JSATB+6
      NX=NX+3
 3600 END DO
      KSATB=JSATB
      IF(LORBIT(ISET)) GO TO 3800
      NT=NT*6
      JSATE=KSATE
      JSATB=ISATB
      JSATB0=KSATB0
      JSATBC=KSATBC
      JSATBP=KSATBP
      DO 3700 N=1,NT,6
      IF(II(JSATE).NE.1) GO TO 3620
      DO 3610 NN=1,6
      AA(JSATB0)=AA(JSATB)
      AA(JSATBC)=AA(JSATB)
      AA(JSATBP)=AA(JSATB)
      JSATB=JSATB+1
      JSATB0=JSATB0+1
      JSATBC=JSATBC+1
      JSATBP=JSATBP+1
 3610 END DO
      GO TO 3690
 3620 CONTINUE
      IRAD=0
      IF(II(JSATE).EQ.3) IRAD=8
      KGMP=KPRMV+IPVAL(IXGM)+IBDGM(ICBDGM)-2
      GMP =AA(KGMP)
      GMPX=GMP
      IF(ISET.EQ.1.AND.LASTSN) GMPX=BDSTAT(7,8)
      CALL ELEM(AA(JSATB),AA(JSATB+1),AA(JSATB+2),AA(JSATB+3),          &
     &          AA(JSATB+4),AA(JSATB+5),AA(JSATB0),IRAD,                &
     &          AA(JSATB0),GMPX)
      DO 3630 NN=1,6
      AA(JSATBC)=AA(JSATB0)
      AA(JSATBP)=AA(JSATB0)
      JSATB=JSATB+1
      JSATB0=JSATB0+1
      JSATBC=JSATBC+1
      JSATBP=JSATBP+1
 3630 END DO
 3690 CONTINUE
      JSATE=JSATE+1
 3700 END DO
      KSATE=JSATE
      KSATB0=JSATB0
      KSATBC=JSATBC
      KSATBP=JSATBP
 3800 CONTINUE
! CALL SUBROUTINE HERE TO RECOMPUTE KEPLER
!       AND NON-SINGULAR KEPLER EPOCH ELEMENTS
!
! RESET EPOCH TIME
      MJDS0(ISET)=MJDSB(ISET)
      FSEC0(ISET)=FSECB(ISET)
      ESSTRT=MJDS0(ISET)+FSEC0(ISET)
      MJDSEC(ISET)=MJDSB(ISET)
      FSEC(ISET)=FSECB(ISET)
      KGMP=KPRMV+IPVAL(IXGM)+IBDGM(ICBDGM)-2
      GMP =AA(KGMP)
      GMPX=GMP
      IF(ISET.EQ.1.AND.LASTSN) GMPX=BDSTAT(7,8)
      CALL ELEM(XEPOCH(JXEPOC),XEPOCH(JXEPOC+1),XEPOCH(JXEPOC+2),       &
     &          XEPOCH(JXEPOC+3),XEPOCH(JXEPOC+4),XEPOCH(JXEPOC+5),     &
     &          AA(KCKEP+6*ISET-6),1,PKPX,GMPX)

!********** DEBUG **********
!     WRITE(6,20000) MJDS0(ISET),FSEC0(ISET),(XEPOCH(JXEPOC-1+I),I=1,6)
!    .,(AA(KCKEP+6*ISET-7+I),I=1,6)
!20000 FORMAT('0COWLIN  MJDS0,FSEC0,XEPOCH'/1X,I12,G25.16/(1X,6G22.14),
!     .  /' KEPLERIAN ELEMENTS',6G22.12)
!********** END DEBUG ******
      IBACKV(ISET)=0
      IBACK(ISET)=0
      IBCKNC(ISET)=0
      NOSTEP(ISET)=0
      NOCORR(ISET)=0
! TIME OF INTEGRATION EPOCH HAS BEEN ADJUSTED AS REQUESTED
 4000 CONTINUE
! ORBIT MUST NOW BE STARTED ALONG WITH VAR. EQ. IF NECESSARY
! ORBIT-ONLY MUST THEN BE RESTARTED IF ORDER OR STEPSIZE
!            DIFFER FROM VAR. EQ.
      IF(LORBIT(ISET))GO TO 4500
      IOVL1=IORDRV(ISET)-1
      MJDSV(ISET)=MJDS0(ISET)
      FSECV(ISET)=FSEC0(ISET)
!***** DEBUG *****
!     PRINT 34567
!4567 FORMAT(' **COWLIN** START ORBIT AND VAR. EQ.')
!***** END DEBUG *
      JEQN=MAX(NEQN(ISET),1)
      JEQN3=MAX(NEQN3(ISET),1)
      LORBVE(ISET)=IOL1 .EQ.IOVL1.AND.H(ISET).EQ.HV(ISET)
      IF(.NOT.LORBVE(ISET).AND.NRAT(ISET).GT.1) THEN
           WRITE(6,12004)
           WRITE(6,12005) ISET,NRAT(ISET)
           WRITE(6,12006)
           WRITE(6,12007) IOL1,IOVL1,H(ISET),HV(ISET)
           STOP
      ENDIF
      HNEW=HV(ISET)
! IF NRAT>1 THEN H=HV, ALSO WILL BE INTEGRATING BACKWARDS, SO:
      IF(NRAT(ISET).GT.1.AND..NOT.LASTSN) HNEW=-H(ISET)/DBLE(NRAT(ISET))

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!! CALL TO START WHEN NO FRILLS AREATTACHED!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

      IF(.NOT.LASTSN) THEN
      CALL START(LORBIT(ISET),LNVEL,IORDRV(ISET),                       &
     &   HNEW,MJDSV(ISET),FSECV(ISET),NSAT(ISET),                       &
     &   N3(ISET),JEQN,JEQN3,IOVL1,                                     &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1))
      ELSE
      JEQNA=MAX(NEQN(1),1)
      JEQNA3=MAX(NEQN3(1),1)
      KPX2=KPX+JEQN3*2
      LPXA0=.TRUE.
      IFCT=1
      IF(LBINAST) IFCT=2
      KPXA0=1+(ISET-ISETU1)*JEQNA3*2*IFCT
      IF(ISET.LE.ISETU) THEN
        LPXA0=.FALSE.
        KPXA0=1
      ENDIF
      JQAST1=KQAST1+(ISET-ISETU)*6*NH(1)*IFCT
      JQAST2=KQAST2+(ISET-ISETU)*3*NSTEPS(1)*IFCT
      JQAST3=KQAST3+(ISET-ISETU)*JEQNA3*2*NH(1)*IFCT
      JQAST4=KQAST4+(ISET-ISETU)*JEQNA3*NSTEPS(1)*IFCT
      JQAST5=KQAST5+(ISET-ISETU)*2*NDPOR*NH(1)*IFCT
      JQAST6=KQAST6+(ISET-ISETU)*NDPOR*NSTEPS(1)*IFCT
      ISQ=1+(ISET-ISETU)
!
        J2AST1=JQAST1
        J2AST2=JQAST2
        J2AST3=JQAST3
        J2AST4=JQAST4
        J2AST5=JQAST5
        J2AST6=JQAST6
        KPXA20=KPXA0
        JKAST1=KQAST1
        JKAST2=KQAST2
        JKAST3=KQAST3
        JKAST4=KQAST4
        JKAST5=KQAST5
        JKAST6=KQAST6
!
      IF(LBINAST) THEN
        J2AST1=JQAST1+6*NH(1)
        J2AST2=JQAST2+3*NSTEPS(1)
        J2AST3=JQAST3+JEQNA3*2*NH(1)
        J2AST4=JQAST4+JEQNA3*NSTEPS(1)
        J2AST5=JQAST5+2*NDPOR*NH(1)
        J2AST6=JQAST6+NDPOR*NSTEPS(1)
        KPXA20=KPXA0+JEQNA3*2
        JKAST1=KQAST1+6*NH(1)
        JKAST2=KQAST2+3*NSTEPS(1)
        JKAST3=KQAST3+JEQNA3*2*NH(1)
        JKAST4=KQAST4+JEQNA3*NSTEPS(1)
        JKAST5=KQAST5+2*NDPOR*NH(1)
        JKAST6=KQAST6+NDPOR*NSTEPS(1)
      ENDIF
!      CALL STARTD(LORBIT(ISET),LNVEL,IORDRV(ISET),                      &
!     &   HNEW,MJDSV(ISET),FSECV(ISET),NSAT(ISET),                       &
!     &   N3(ISET),JEQN,JEQN3,IOVL1,                                     &
!     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
!     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
!     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
!     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
!     &   II(ISATPX),                                                    &
!     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
!     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
!     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
!     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
!     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
!     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
!     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
!     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1),&
!     &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),AA(KPX2),              &
!     &   AA(ISUMPX(1)),AA(IPXDDT(1)),XA,YQR,YQRDOT,SUMXRQ,YMNRT)
      CALL STARTD(LORBIT(ISET),LNVEL,IORDRV(ISET),                      &
     &   HNEW,MJDSV(ISET),FSECV(ISET),NSAT(ISET),                       &
     &   N3(ISET),JEQN,JEQN3,IOVL1,                                     &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1),&
!!!! &   JEQNA,JEQNA3,AA(JQAST1),AA(JQAST2),AA(KPX2),                   &
     &   JEQNA,JEQNA3,AA(JQAST1),AA(JQAST2),PXA,                        &
     &   AA(JQAST3),AA(JQAST4),XA,XR,AA(JQAST6),AA(JQAST5),YMNRT,ISQ,   &
!!!! &   HOLDA4(KPXA0),LPXA0,XRP)
     &   HOLDA4(KPXA0),LPXA0,XRP,XA(1,2),AA(J2AST1),AA(J2AST2),         &
     &   PXA(1+2*JEQN3*(NAST-1)),AA(J2AST3),AA(J2AST4),HOLDA4(KPXA20),  &
     &   XR(1+NDPOR2*(NAST-1)),                                         &
     &   XRP(1+NDPOR2*(NAST-1)),AA(J2AST6),AA(J2AST5),GM2,II(KISATN),   &
     &   II(KISATN+1))
      IF(NSETS.LE.ISETU.AND.LSTINR) THEN
        CLOSE(77)
        CALL SYSTEM('rm CBTRAJ')
      ENDIF
      IF(NSETS.GT.ISETU.AND.ISET.EQ.ISETU) THEN
         CALL SWTCPT(1,.FALSE.)
         JJQ2=1
         IF(LBINAST) JJQ2=2
         CALL INCWA0(IOVL1,JEQNA3,AA(KQAST1),AA(KQAST2),AA(KQAST3),     &
     &               AA(KQAST4),AA(KQAST5),AA(KQAST6),AA(ISUMX(1)),     &
     &               AA(IXDDOT(1)),AA(ISUMPX(1)),AA(IPXDDT(1)),SUMXRQ,  &
     &               YQRDOT,AA(JKAST1),AA(JKAST2),AA(JKAST3),           &
     &               AA(JKAST4),AA(JKAST5),AA(JKAST6),AA(ISUMX(JJQ2)),  &
     &               AA(IXDDOT(JJQ2)),AA(ISUMPX(JJQ2)),AA(IPXDDT(JJQ2)),&
     &               SUMXRQ(1+2*NDPOR*NH(1)*(JJQ2-1)),                  &
     &               YQRDOT(1+NDPOR*NSTEPS(1)*(JJQ2-1)))
         NTIMES1=0
         T1=DBLE(MJDSV(2))+FSECV(2)
         DO JS=ISETU1,NSETS
           NTIMES1=NTIMES1+1
           T2=DBLE(MJDS0(JS))+FSEC0(JS)
           NSSAVE(NTIMES1)=((T2-T1)/HNEW+.001D0)
           ENDT=T2+10.D0*HNEW
         ENDDO
      MJDEND=ENDT
      FSCEND=ENDT-DBLE(MJDEND)
      NRATQ1=0
      LATOTQ=.TRUE.
      LSAVEQ=.FALSE.
      NSTPSQ=0
      MJDSEC(ISET)=MJDSV(ISET)
      FSEC(ISET)=FSECV(ISET)
      MJDS1=MJDSEC(ISET)
      FSC1=FSEC(ISET)
      MJDSV1=MJDSV(ISET)
      FSCV1=FSECV(ISET)
      IBACK(1)=IBACK(ISET)
      IBACKV(1)=IBACKV(ISET)
      NOSTEP(1)=NOSTEP(ISET)
      NOCORR(1)=NOCORR(ISET)
      CALL COWLA0(LORBIT(ISET),LNVEL,IBACK(1),                          &
     &   IBACKV(1),IORDER(ISET),IORDRV(ISET),                           &
     &   HNEW,HNEW,ONE,NOSTEP(1),NOCORR(1),                             &
     &   AA(ICTOL),NSAT(ISET),MJDS1,FSC1,                               &
     &   MJDSV1,FSCV1,MJDEND,FSCEND,N3(ISET),                           &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),AA(ICCVV(ISET)),             &
     &   AA(KVMATX),AA(KRSQ),AA(KXPPPP),AA(KX),                         &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(KPX),AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),                     &
     &   AA(IPXDDT(ISET)),II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),        &
     &   AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),         &
     &   AA(KXUTDT),                                                    &
     &   NRATQ1,LATOTQ,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),  &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEQ,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSTPSQ,ISTPST,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .FALSE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),        &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),                                          &
     &   AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS),                &
!!!  &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),AA(KPX2),AA(KPX2),     &
     &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),PXA,PXA,               &
     &   AA(ISUMPX(1)),AA(IPXDDT(1)),AA(IPXDDT(1)),YQRDOT,SUMXRQ,YMNRT, &
     &   HOLDV,NTIMES1,NSSAVE,HOLDA1,HOLDA4,HOLDA7,XR,XRP,NAST,GM2,     &
     &   II(KISATN),II(KISATN+1))

         IF(LSTINR) CLOSE(77)
         CALL SWTCPT(2,.FALSE.)
      ENDIF
      ENDIF
!!!!! END CALL TO START WHEN NO FRILLS AREATTACHED!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      IF(.NOT.LORBVE(ISET))GO TO 4500
      MJDSEC(ISET)=MJDSV(ISET)
      FSEC(ISET)=FSECV(ISET)
      GO TO 5000
 4500 CONTINUE
      IF(LASTSN.AND..NOT.LORBIT(ISET)) THEN
        WRITE(6,12010)
        WRITE(6,12011)
        STOP
      ENDIF

! ORBIT-ONLY MUST BE STARTED(RESTARTED)
!***** DEBUG *****
!     PRINT 45678
!5678 FORMAT(' **COWLIN** START ORBIT ONLY')
!***** END DEBUG *
      JEQN=MAX(NEQN(ISET),1)
      JEQN3=MAX(NEQN3(ISET),1)
      HNEW=H(ISET)
! IF NRAT>1 THEN H=HV, ALSO WILL BE INTEGRATING BACKWARDS, SO:
      IF(NRAT(ISET).GT.1.AND..NOT.LASTSN) HNEW=-H(ISET)/DBLE(NRAT(ISET))
      IF(.NOT.LASTSN) THEN
      CALL START(.TRUE.,LNVEL,IORDER(ISET),                             &
     &   HNEW,MJDSEC(ISET),FSEC(ISET),NSAT(ISET),                       &
     &   N3(ISET),JEQN,JEQN3,IOL1,                                      &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1))
      ELSE
      JEQNA=MAX(NEQN(1),1)
      JEQNA3=MAX(NEQN3(1),1)
      KPX2=KPX+JEQN3*2
      LPXA0=.TRUE.
      IFCT=1
      IF(LBINAST) IFCT=2
      KPXA0=1+(ISET-ISETU1)*JEQNA3*2*IFCT
      IF(ISET.LE.ISETU) THEN
        LPXA0=.FALSE.
        KPXA0=1
      ENDIF
      ISQ=1+(ISET-ISETU)
      JQAST1=KQAST1+(ISET-ISETU)*6*NH(1)*IFCT
      JQAST2=KQAST2+(ISET-ISETU)*3*NSTEPS(1)*IFCT
      JQAST3=KQAST3+(ISET-ISETU)*JEQNA3*2*NH(1)*IFCT
      JQAST4=KQAST4+(ISET-ISETU)*JEQNA3*NSTEPS(1)*IFCT
      JQAST5=KQAST5+(ISET-ISETU)*2*NDPOR*NH(1)*IFCT
      JQAST6=KQAST6+(ISET-ISETU)*NDPOR*NSTEPS(1)*IFCT
!
        J2AST1=JQAST1
        J2AST2=JQAST2
        J2AST3=JQAST3
        J2AST4=JQAST4
        J2AST5=JQAST5
        J2AST6=JQAST6
        KPXA20=KPXA0
        JKAST1=KQAST1
        JKAST2=KQAST2
        JKAST3=KQAST3
        JKAST4=KQAST4
        JKAST5=KQAST5
        JKAST6=KQAST6
!

      IF(LBINAST) THEN
        J2AST1=JQAST1+6*NH(1)
        J2AST2=JQAST2+3*NSTEPS(1)
        J2AST3=JQAST3+JEQNA3*2*NH(1)
        J2AST4=JQAST4+JEQNA3*NSTEPS(1)
        J2AST5=JQAST5+2*NDPOR*NH(1)
        J2AST6=JQAST6+NDPOR*NSTEPS(1)
        KPXA20=KPXA0+JEQNA3*2
        JKAST1=KQAST1+6*NH(1)
        JKAST2=KQAST2+3*NSTEPS(1)
        JKAST3=KQAST3+JEQNA3*2*NH(1)
        JKAST4=KQAST4+JEQNA3*NSTEPS(1)
        JKAST5=KQAST5+2*NDPOR*NH(1)
        JKAST6=KQAST6+NDPOR*NSTEPS(1)
      ENDIF
!      CALL STARTD(.TRUE.,LNVEL,IORDER(ISET),                            &
!     &   HNEW,MJDSEC(ISET),FSEC(ISET),NSAT(ISET),                       &
!     &   N3(ISET),JEQN,JEQN3,IOL1,                                      &
!     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
!     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
!     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
!     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
!     &   II(ISATPX),                                                    &
!     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
!     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
!     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
!     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
!     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
!     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
!     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
!     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1),&
!     &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),AA(KPX2),              &
!     &   AA(ISUMPX(1)),AA(IPXDDT(1)),XA,YQR,YQRDOT,SUMXRQ,YMNRT)
      CALL STARTD(.TRUE.,LNVEL,IORDER(ISET),                            &
     &   HNEW,MJDSEC(ISET),FSEC(ISET),NSAT(ISET),                       &
     &   N3(ISET),JEQN,JEQN3,IOL1,                                      &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1),&
!!!! &   JEQNA,JEQNA3,AA(JQAST1),AA(JQAST2),AA(KPX2),                   &
     &   JEQNA,JEQNA3,AA(JQAST1),AA(JQAST2),PXA,                        &
     &   AA(JQAST3),AA(JQAST4),XA,XR,AA(JQAST6),AA(JQAST5),YMNRT,ISQ,   &
!!!! &   HOLDA4(KPXA0),LPXA0,XRP)
     &   HOLDA4(KPXA0),LPXA0,XRP,XA(1,2),AA(J2AST1),AA(J2AST2),         &
     &   PXA(1+2*JEQN3*(NAST-1)),AA(J2AST3),AA(J2AST4),HOLDA4(KPXA20),  &
     &   XR(1+NDPOR2*(NAST-1)),                                         &
     &   XRP(1+NDPOR2*(NAST-1)),AA(J2AST6),AA(J2AST5),GM2,II(KISATN),   &
     &   II(KISATN+1))
      IF(NSETS.LE.ISETU.AND.LSTINR) THEN
        CLOSE(77)
        CALL SYSTEM('rm CBTRAJ')
      ENDIF
      IF(NSETS.GT.ISETU.AND.ISET.EQ.ISETU) THEN
         CALL SWTCPT(1,.FALSE.)
         CALL INCWA0(IOVL1,JEQNA3,AA(KQAST1),AA(KQAST2),AA(KQAST3),     &
     &               AA(KQAST4),AA(KQAST5),AA(KQAST6),AA(ISUMX(1)),     &
     &               AA(IXDDOT(1)),AA(ISUMPX(1)),AA(IPXDDT(1)),SUMXRQ,  &
     &               YQRDOT,AA(JKAST1),AA(JKAST2),AA(JKAST3),           &
     &               AA(JKAST4),AA(JKAST5),AA(JKAST6),AA(ISUMX(JJQ2)),  &
     &               AA(IXDDOT(JJQ2)),AA(ISUMPX(JJQ2)),AA(IPXDDT(JJQ2)),&
     &               SUMXRQ(1+2*NDPOR*NH(1)*(JJQ2-1)),                  &
     &               YQRDOT(1+NDPOR*NSTEPS(1)*(JJQ2-1)))
         NTIMES1=0
         T1=DBLE(MJDSV(2))+FSECV(2)
         DO JS=ISETU1,NSETS
           NTIMES1=NTIMES1+1
           T2=DBLE(MJDS0(JS))+FSEC0(JS)
           NSSAVE(NTIMES1)=((T2-T1)/HNEW+.001D0)
           ENDT=T2+10.D0*HNEW
         ENDDO
         MJDEND=ENDT
         FSCEND=ENDT-DBLE(MJDEND)
         NRATQ1=0
         LATOTQ=.TRUE.
         LSAVEQ=.FALSE.
         NSTPSQ=0
         MJDS1=MJDSEC(ISET)
         FSC1=FSEC(ISET)
         MJDSV1=MJDSV(ISET)
         FSCV1=FSECV(ISET)
         IBACK(1)=IBACK(ISET)
         IBACKV(1)=IBACKV(ISET)
         NOSTEP(1)=NOSTEP(ISET)
         NOCORR(1)=NOCORR(ISET)
      CALL COWLA0(.TRUE.,LNVEL,IBACK(1),                                &
     &   IBACKV(1),IORDER(ISET),IORDRV(ISET),                           &
     &   HNEW,HNEW,ONE,NOSTEP(1),NOCORR(1),                             &
     &   AA(ICTOL),NSAT(ISET),MJDS1,FSC1,                               &
     &   MJDSV1,FSCV1,MJDEND,FSCEND,N3(ISET),                           &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),AA(ICCVV(ISET)),             &
     &   AA(KVMATX),AA(KRSQ),AA(KXPPPP),AA(KX),                         &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(KPX),AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),                     &
     &   AA(IPXDDT(ISET)),II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),        &
     &   AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),         &
     &   AA(KXUTDT),                                                    &
     &   NRATQ1,LATOTQ,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),  &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEQ,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSTPSQ,ISTPST,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .FALSE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),        &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),                                          &
     &   AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS),                &
!!!! &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),AA(KPX2),AA(KPX2),     &
     &   JEQNA,JEQNA3,AA(ISUMX(1)),AA(IXDDOT(1)),PXA,PXA,               &
     &   AA(ISUMPX(1)),AA(IPXDDT(1)),AA(IPXDDT(1)),YQRDOT,SUMXRQ,YMNRT, &
     &   HOLDV,NTIMES1,NSSAVE,HOLDA1,HOLDA4,HOLDA7,XR,XRP,NAST,GM2,     &
     &   II(KISATN),II(KISATN+1))
         IF(LSTINR) CLOSE(77)
         CALL SWTCPT(2,.FALSE.)
      ENDIF
      ENDIF

 5000 CONTINUE
      IF(LORBIT(ISET))GO TO 9000
      IF(H(ISET).NE.HV(ISET))GO TO 9000
      IF(IORDER(ISET)-IORDRV(ISET))6000,9000,7000
 6000 CONTINUE
      IF(LASTSN) THEN
        WRITE(6,12010)
        WRITE(6,12011)
        STOP
      ENDIF
      MJDS2=MJDSV(ISET)
      FSEC2=FSECV(ISET)
      GO TO 8000
 7000 CONTINUE

      IF(LASTSN) THEN
        WRITE(6,12010)
        WRITE(6,12011)
        STOP
      ENDIF
      MJDS2=MJDSEC(ISET)
      FSEC2=FSEC(ISET)
 8000 CONTINUE
! THE STEPSIZE IS THE SAME FOR THE ORBIT AND VAR. EQ.
!     BUT THE ORDER IS DIFFERENT
! INTEGRATE TO THE LATER OF THE TWO TIMES
      JEQN=MAX(NEQN(ISET),1)
      JEQN3=MAX(NEQN3(ISET),1)
      NRATS1=0
      LATOT=.TRUE.
      LSAVEA=.FALSE.
      NSTPSV=0
      CALL COWELL(LORBIT(ISET),LNVEL,IBACK(ISET),                       &
     &   IBACKV(ISET),IORDER(ISET),IORDRV(ISET),                        &
     &   H(ISET),HV(ISET),ONE,NOSTEP(ISET),NOCORR(ISET),                &
     &   AA(ICTOL),NSAT(ISET),MJDSEC(ISET),FSEC(ISET),                  &
     &   MJDSV(ISET),FSECV(ISET),MJDS2,FSEC2,N3(ISET),                  &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),AA(ICCVV(ISET)),             &
     &   AA(KVMATX),AA(KRSQ),AA(KXPPPP),AA(KX),                         &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(KPX),AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),                     &
     &   AA(IPXDDT(ISET)),II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),        &
     &   AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),         &
     &   AA(KXUTDT),                                                    &
     &   NRATS1,LATOT,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),   &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEA,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSTPSV,ISTPST,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .FALSE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),        &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(JSUMRC),AA(JXDDRC),                                         &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),                                          &
     &   AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS))
      GO TO 9030
 9000 CONTINUE
      IF(NRAT(ISET).LE.1.OR.LASTSN) GO TO 9030
      CALL PRERAT(IORDER(ISET),H(ISET),IOL1,NRAT(ISET),MJDS0(ISET),     &
     &   FSEC0(ISET),MJDRS,FSECRS,MJDE,FSECE,NSAVST,ISTPST,NSAVCW,      &
     &   ISTPCW)
!
! INTEGRATE BACK TO NEW STARTING TIME FOR SMALL FORCES
      HSMALL=-H(ISET)/NRAT(ISET)
      POSNEG=-ONE
      NRATS1=0
      LATOT=.TRUE.
      LSAVEA=.FALSE.
      NSTPSD=0
      CALL COWELL(.TRUE.,LNVEL,IBACK(ISET),                             &
     &   IBACKV(ISET),IORDER(ISET),IORDRV(ISET),                        &
     &   HSMALL,HSMALL,POSNEG,NOSTEP(ISET),NOCORR(ISET),                &
     &   AA(ICTOL),NSAT(ISET),MJDSEC(ISET),FSEC(ISET),                  &
     &   MJDSV(ISET),FSECV(ISET),MJDRS,FSECRS,N3(ISET),                 &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),                             &
     &   AA(ICCVV(ISET)),AA(KVMATX),AA(KRSQ),                           &
     &   AA(KXPPPP),AA(KX),AA(ISUMX(ISET)),                             &
     &   AA(IXDDOT(ISET)),AA(KPX),AA(KPX),                              &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(IPXDDT(ISET)),            &
     &   II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),AA(ITPXAT(ISET)),        &
     &   LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),AA(KXUTDT),               &
     &   NRATS1,LATOT,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),   &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEA,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSTPSD,ISTPST,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .TRUE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),         &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(JSUMRC),AA(JXDDRC),                                         &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),                                          &
     &   AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS))
! RESRART AT THE SMALL STEPSIZE AA(KX) SHOULD BE FILLED
! FROM PREVIOUS CALL TO COWELL
      IBACKV(ISET)=0
      IBACK(ISET)=0
      IBCKNC(ISET)=0
      NOSTEP(ISET)=0
      NOCORR(ISET)=0
      HSMALL=H(ISET)/NRAT(ISET)
      POSNEG=ONE
      CALL START(LORBIT(ISET),LNVEL,IORDER(ISET),                       &
     &   HSMALL,MJDSEC(ISET),FSEC(ISET),NSAT(ISET),                     &
     &   N3(ISET),JEQN,JEQN3,IOL1,                                      &
     &   AA(KCIP),AA(KCIV),AA(KXPPPP),AA(KX),                           &
     &   AA(ISUMX(ISET)),AA(IXDDOT(ISET)),AA(KPX),                      &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(KXDTMC),                  &
     &   AA(JCSAT+KDNLT),AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA,II,LL,    &
     &   II(ISATPX),                                                    &
     &   AA(KXUTDT),AA(IXDDNC(ISET)),AA(KPDDTH),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET),        &
     &   IPTFBS(1,ISET),NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),&
     &   AA(JXACIN),AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),      &
     &   II(JACCPE),AA(JSUMRC),AA(JXDDRC),                              &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),                            &
     &   AA(KTMOSP-1+ISET),AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),   &
     &   AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,HOS(1))
      MJDSV(ISET)=MJDSEC(ISET)
      FSECV(ISET)=FSEC(ISET)
      CALL STRTSV(LORBIT(ISET),AA(IXDDOT(ISET)),AA(IPXDDT(ISET)),IOL1,  &
     &            N3(ISET),JEQN3,NSAVST,ISTPST,AA(KXDDTH),AA(KPDDTH),   &
     &            N2,AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA(KTPXTH),      &
     &            LL(KLTPXH),AA(IXDDNC(ISET)))
      NRATS1=0
      LATOT=.TRUE.
      LSAVEA=.TRUE.
      CALL COWELL(LORBIT(ISET),LNVEL,IBACK(ISET),                       &
     &   IBACKV(ISET),IORDER(ISET),IORDRV(ISET),                        &
     &   HSMALL,HSMALL,POSNEG,NOSTEP(ISET),NOCORR(ISET),                &
     &   AA(ICTOL),NSAT(ISET),MJDSEC(ISET),FSEC(ISET),                  &
     &   MJDSV(ISET),FSECV(ISET),MJDE,FSECE,N3(ISET),                   &
     &   JEQN,JEQN3,NH(ISET),NHV(ISET),                                 &
     &   NSTEPS(ISET),NSTEPV(ISET),AA(ICPP(ISET)),                      &
     &   AA(ICPV(ISET)),AA(ICCP(ISET)),AA(ICCV(ISET)),                  &
     &   AA(KCIP),AA(KCIV),AA(ICCPV(ISET)),                             &
     &   AA(ICCVV(ISET)),AA(KVMATX),AA(KRSQ),                           &
     &   AA(KXPPPP),AA(KX),AA(ISUMX(ISET)),                             &
     &   AA(IXDDOT(ISET)),AA(KPX),AA(KPX),                              &
     &   AA(ISUMPX(ISET)),AA(IPXDDT(ISET)),AA(IPXDDT(ISET)),            &
     &   II(JNVSTP),AA(KXDTMC),AA(KDNLT+JCSAT),AA(ITPXAT(ISET)),        &
     &   LL(ILTPAT(ISET)),AA,II,LL,II(ISATPX),AA(KXUTDT),               &
     &   NRATS1,LATOT,AA(IXDDNC(ISET)),IDXDDN(ISET),AA(ISMXNC(ISET)),   &
     &   IBCKNC(ISET),IDSMXN(ISET),LSAVEA,AA(KXDDTH),AA(KPDDTH),        &
     &   AA(KTPXTH),LL(KLTPXH),NSAVCW,ISTPCW,AA(KXPPNC),AA(KXNC),       &
     &   AA(ICPPNC(ISET)),AA(KXSSBS),AA(IXDDAC),LFHIRT(1,ISET),         &
     &   LSURFF(1,ISET),AA(IPXDDA(ISET)),NEQNA(ISET),IPTFBS(1,ISET),    &
     &   NPRMAC(1,ISET),AA(JDYACT),II(JDYNPE),AA(JEXACT),AA(JXACIN),    &
     &   AA(JXACOB),LSETDN(ISET),AA(JACCBT),AA(JACPER),II(JACCPE),      &
     &   .TRUE.,NXSTAT(ISET),TXSTAT(1,ISET),DELXST(1,1,1,ISET),         &
     &   AA(KSMRNC),IPXST(1,ISET),AA(KPRX),AA(KSMRNP),AA(KDSROT),       &
     &   AA(JSUMRC),AA(JXDDRC),                                         &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),                                          &
     &   AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),                     &
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA(KSMPNS))
      NOSTEP(ISET)=0
      NOCORR(ISET)=0
      IBACKV(ISET)=0
      IBACK(ISET)=0
      NXEPOC=JXEPOC
      NX=KX
      N3I=N3(ISET)
! STORE EPOCH CARTESIAN STATE INTO INTEGRATION STATE ARRAY
      DO NQ=1,N3I
         AA(NX)=XEPOCH(NXEPOC)
         AA(NX+N3I)=XEPOCH(NXEPOC+3)
         NX=NX+1
         NXEPOC=NXEPOC+1
      ENDDO
      CALL STRTNC(IORDER(ISET),H(ISET),NH(ISET),                        &
     &   N3(ISET),IOL1,AA(KCIP),                                        &
     &   AA(KCIV),AA(KXPPNC),AA(ISMXNC(ISET)),IDSMXN(ISET),             &
     &   AA(IXDDNC(ISET)),IDXDDN(ISET),NRAT(ISET),IBCKNC(ISET),AA(KX),  &
     &   AA(KXDDTH),AA(IXDDOT(ISET)),AA(ISUMX(ISET)),LORBIT(ISET),      &
     &   JEQN3,AA(KPX),AA(KPDDTH),AA(IPXDDT(ISET)),AA(ISUMPX(ISET)),    &
     &   N2,AA(ITPXAT(ISET)),LL(ILTPAT(ISET)),AA(KTPXTH),LL(KLTPXH),    &
     &   AA(IXDDAC),AA(IPXDDA(ISET)),NEQNA(ISET))
 9030 CONTINUE
      ICTOL=ICTOL+1
      JXEPOC=JXEPOC+N3I*2
! REINITIALIZE SOME SUMMARY PAGE ARRAYS
      II(JNVSTP)=0
      IUP=NSAT(ISET)
      DO 9040 N=1,IUP
      II(KNDARK+JCSAT+N-1)=0
      II(KNSTRN+JCSAT+N-1)=0
      LL(KLSTSN+JCSAT+N-1)=LL(KLSNLT+JCSAT+N-1)
 9040 END DO
      JDYACT=JDYACT+NSAT(ISET)*2*MDYNPD
      JDYNPE=JDYNPE+NSAT(ISET)
      JEXACT=JEXACT+NSAT(ISET)*2
      JXACIN=JXACIN+NSAT(ISET)
      JXACOB=JXACOB+NSAT(ISET)*MACOBS
      JACCBT=JACCBT+NSAT(ISET)*2*MBAPPD
      JACPER=JACPER+NSAT(ISET)*2
      JACCPE=JACCPE+NSAT(ISET)

! RAPID INTEGRATION CAPTURE MODE
!     write(6,*)' dbg RAPID INTEGRATION CAPTURE MODE '
          IF(NINTOT.GT.0.AND..NOT.LINTF) THEN
!     MJDS= II(KMJDND-1+ISET)+2*3600
      MJDS= II(KMJDND-1+ISET)
      FSC(1)=0.D0
      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),ISATNO,           &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+ISET),                           &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),ISET,MJDS,FSC(1),FSC(1),&
     &   1,AA,II)

! OPEN A NEW FILE FOR THIS NEW SATELLITE


      ILSTEP=0
      NSEG=1

      write(6,*)' CAPTURE MODE IN COWLIN FOR SATELLITE ',ISATID
      CALL ORBIT(MJDS,FSC,AA(KS),1,II(KINDH),II(KNMH),              &
     &           II(KMJDSC),AA(KFSEC),II(KMJDSV),AA(KFSECV),        &
     &           LL(KLSETS),II(KIPXPF),II(KIVSAT),1,II(KNMAX),      &
     &           II(KNTOLD),AA(KXSM),AA(KPXPFM),.TRUE.,.FALSE.,     &
     &           II(KPLPTR),II(KPANEL),II(KNMOVE),                  &
     &           AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),           &
     &           LL(KSETDN),                                        &
     &   AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),          &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+ISET),          &
     &   AA(KSGTM1-1+ISET),AA(KSGTM2-1+ISET),AA,II,LL)

      ILSTSG(ISET)=ILSTEP
      CLOSE(IOUT)

      WRITE(FILNAM,FMT='(A13,I7,A4,I2,A7)')'RAPID_INT_SAT',ISATID,      &
     & '_SEG',NSEG,'.COWELL'
      NSCHED(1,ISET,NSEG)=ISET
      NSCHED(2,ISET,NSEG)=ILSTEP
!     write(6,*)' dbg OPEN FILE ',IOUT,NSEG,NEQNI,ILSTEP,ISATID,ISET
!     write(6,*)' dbg NSCCOWLIN ',NSCHED(1,ISET,NSEG),       &
!    & NSCHED(2,ISET,NSEG),ISET,NSEG
      OPEN(IOUT,FILE=FILNAM,STATUS='NEW',FORM='UNFORMATTED')

      WRITE(IOUT) AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET), &
     &NEQNI,HOS(1)
!     WRITE(6,*) AA(KTMOS0-1+ISET),AA(KTMOS-1+ISET),AA(KTMOSP-1+ISET),  &
!    &NEQNI,HOS(1)

      CALL DUMPLB(IOUT,AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),      &
     & AA(KSMXOS-1+KXDDTOS),AA(KSMXOS-1+KPDDTOS),ILSTEP,KNSTEPS,NEQNI)
      CLOSE(IOUT)
      write(6,*)' CAPTURE MODE COMPLETED SUCCESFULLY '
!     write(6,*)'dbg COWLIN closed the last seg for this s/c ',ILSTEP

          ENDIF    ! (IF(.NOT.LINTF)

! END RAPID INTEGRATION CAPTURE MODE
 9999 CONTINUE
!     WRITE(6,*)' STOP HERE '
!     STOP
      IF(NINTOT.GT.0) THEN
      LALIQ=.FALSE.
      LINTF=.TRUE.
      QINTQ=1.D0
      ENDIF
! DEFINE ISTOS
      ISTOS1=0
      ISTOS2=0
      ISTOS3=0
      ISTLST=0
      IF(.NOT.LFLAG)GO TO 30000
      IF(L12) THEN
      IP1=KPRMV
      IP2=KPRMV+6
      IP10=KPRMV0
      IP20=KPRMV0+6
      IP1C=KPRMVC
      IP2C=KPRMVC+6
      IP1P=KPRMVP
      IP2P=KPRMVP+6
      CALL TWELVE(AA(IP1),AA(IP2),P1,P2,.TRUE.)
      CALL GETBCR(.TRUE.,P1,Q1,P2,Q2,DXMDN,DXBDN)
      DO I=1,6
      AA(IP1-1+I)=Q1(I)
      AA(IP10-1+I)=Q1(I)
      AA(IP1C-1+I)=Q1(I)
      AA(IP1P-1+I)=Q1(I)
      ENDDO
      DO I=1,6
      AA(IP2-1+I)=Q2(I)
      AA(IP20-1+I)=Q2(I)
      AA(IP2C-1+I)=Q2(I)
      AA(IP2P-1+I)=Q2(I)
      ENDDO
      ENDIF
30000 CONTINUE
11000 FORMAT('FILE CREATION DATE: ',F13.0)
11100 FORMAT('G2S: ',F7.2,3X,'G2E: ',F7.2,'NUMPNL ',F7.1)
11200 FORMAT(3D23.16)
11300 FORMAT(8D17.10)
12000 FORMAT(' EXECUTION TERMINATING IN COWLIN. CONFLICT IN FORCE MOD')
12001 FORMAT(' PARTIAL POINTERS. NEQN= ',I6,' POINTER TO LAST FM GROUP')
12002 FORMAT(' MOTION PARTIALS= ',I6,' NUMBER OF PLANET ORIENTATION')
12003 FORMAT(' PARAMETERS= ',I6,' THIS HAPPENED FOR SET # ',I5)
12004 FORMAT(' EXECUTION TERMINATING IN COWLIN. MULTATE INTEGRATION')
12005 FORMAT(' CHOSEN FOR SET # ',I4,' NRAT=',I5,' WHILE ORDER OR')
12006 FORMAT(' STEP SIZE OF ORBIT AND VARIATIOBAL EQUATIONS ARE ')
12007 FORMAT(' DIFFERENT: IOL1 IOVL1,H,HV  ',2I10,2F15.4)
12010 FORMAT(' EXECUTION TERMINATING IN COWLIN; ASTEROID OD RUN ')
12011 FORMAT(' WITH A  NON STAN START')
!********** DEBUG **********
!     CALL KORDMP(AA,AA,AA)
!********** END DEBUG ******
      IF(LGPSHD) LGPSHO=.TRUE.
      LSTART=.FALSE.
      IF(LASTSN) THEN
        DEALLOCATE(XR)
        DEALLOCATE(XRP)
        DEALLOCATE(PXA)
      ENDIF
      RETURN
70000 FORMAT(I2)
      END
