!COWLA0
      SUBROUTINE COWLA0(LORBIT,LNDRAG,IBACK,IBACKV,                     &
     &   IORDER,IORDRV,H,HV,POSNEG,NOSTEP,NOCORR,CTOL,NSAT,             &
     &   MJDSEC,FSEC,MJDSV,FSECV,                                       &
     &   MJDS2,FSEC2,N3,NEQN,NEQN3,NH,NHV,NSTEPS,NSTEPV,                &
     &   CPP,CPV,CCP,CCV,CIP,CIV,CCPV,CCVV,VMATRX,RSQ,                  &
     &   XP,X,SUMX,XDDOT,PX,PX3,SUMPX,PXDDOT,PXDDT3,NVSTEP,XDDTMC,      &
     &   DNLT,TOPXAT,LTPXAT,AA,II,LL,ISATID,UTDT,NRAT1,LATOT,XDDTNC,    &
     &   IDXDDN,SUMXNC,IBCKNC,IDSMXN,LSAVEA,XDDOTH,PXDDTH,TOPXTH,LTPXTH,&
     &   NSTPSV,ISTPSV,XPNC,XNC,CPPNC,XLSASS,XDDTAC,LFHIRT,LSURFF,      &
     &   PXDDAC,NEQNAC,IPTFBS,NPRMAC,DYNTIM,NPERDY,EXACCT,EXACIN,EXACOB,&
     &   LACCELS,ACCTIM,ACCPER,NPERAC,L4MRST,NXSTAT,TXSTAT,DELXST,      &
     &   SUMRNC,IPXST,PXR,SUMRNP,DSROT,TMOS0,TMOS,TMOSP,                &
     &   SUMPOS, SUMXOS,                                                &
     &   XDDTOS,PDDTOS,KNSTEPS,NEQNI,ISEGM,T1SEG,T2SEG,SUMPNS,          &
     &   NEQNA,NEQNA3,SUMXA,XDDOTA,PXA,PXA3,SUMPXA,PXDDTA,PXDTA3,       &
     &   XRDOT,SUMXR,XMNRT,HOLDV,NTIMES1,NSSAVE,HOLDA1,                 &
     &   HOLDA4,HOLDA7,XR,XRP,NAST,GM2,IDA1,IDA2)
!********1*********2*********3*********4*********5*********6*********7**
!COWLA0           82/06/17            8206.0    PGMR - TOM MARTIN
!
! FUNCTION:  NUMERICAL INTEGRATION OF SPACECRAFT ORBIT AND
!            VARIATIONAL EQUATIONS USING COWELLS METHOD
!            SPECIAL VERSION OF COWELL USED FOR ASTEROID RUNS
!            CREATED BY DDR AND MERGED BY JTW
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   LORBIT   I    S    LOGICAL SWITCH INDICATING ORBIT-ONLY
!                      INTEGRATION WHEN .TRUE.
!   LNDRAG   I    S    LOGICAL SWITCH INDICATING THAT THE
!                      FORCING FUNCTION IS VELOCITY INDEPENDENT
!                      WHEN .TRUE.
!   IBACK    I    S    COUNTER INDICATING HOW MANY EXTRA BACK
!                      VALUES ARE STORED FOR SUMS AND
!                      ACCELERATIONS
!   IBACKV   I    S    SAME AS IBACK EXCEPT APPLIES TO
!                      VARIATIONAL EQUATIONS
!   IORDER   I    S    ORDER OF COWELL INTEGRATION FOR ORBIT
!   IORDRV   I    S    ORDER OF COWELL INTEGRATION FOR VAR. EQ.
!   H        I    S    INTEGRATION STEP SIZE IN SECONDS FOR ORBIT
!   HV       I    S    INTEGRATION STEP SIZE IN SECONDS FOR VAR. EQ.
!   POSNEG   I    S    PLUS OR MINUS ONE;INDICATING THE DIRECTION
!   NOSTEP   I    S    ACCUMULATED TOTAL OF ORBIT INTEGRATION
!                      OF INTEGRATION:PLUS ONE-FORWARD IN TIME
!                      MINUS ONE-BACKWARD IN TIME
!                      STEPS
!   NOCORR   I    S    ACCUMULATED TOTAL OF ORBIT CORRECTION
!                      STEPS
!   CTOL     I    S    INTEGRATION LOCAL ERROR TOLERANCE GOVERNING
!                      ORBIT CORRECTOR LOOP
!   NSAT     I    S    NUMBER OF SATELLITES OF LIKE CHARACTERISTICS
!                      TO BE SIMULATANEOUSLY INTEGRATED
!   MJDSEC   I    S    CURRENT DATE AND INTEGRAL SECONDS OF TIME O
!                      ORBIT INTEGRATION
!   FSEC     I    S    CURRENT FRACTIONAL SECONDS OF ORBIT TIME
!   MJDSV    I    S    CURRENT DATE AND INTEGRAL SECONDS OF
!                      VAR. EQ. TIME
!   FSECV    I    S    CURRENT FRACTIONAL SECONDS OF VAR. EQ. TIME
!   MJDS2    I    S    LATEST DATE AND INTEGRAL SECONDS OF TIME
!                      FOR WHICH ORBIT INTERPOLATION WILL BE
!                      PERFORMED AFTER RETURN FROM THIS ROUTINE
!   FSEC2    I    S    FRACTIONAL SECONDS OF TIME ASSOCIATED WITH
!                      MJDS2
!   N3       I    S    NSAT*3
!   NEQN     I    S    NUMBER OF FORCE MODEL VARIATIONAL EQUATIONS
!   NEQN3    I    S    NEQN*N3
!   NH       I    S    MAXIMUM NUMBER OF ORBIT BACK VALUES PLUS ONE
!   NHV      I    S    MAXIMUM NUMBER OF VAR. EQ. BACK VALUES
!                      PLUS ONE
!   NSTEPS   I    S    NH+IORDER-2
!   NSTEPV   I    S    NHV+IORDRV-2
!   CPP      I    S    COWELL COEFFICIENTS FOR PREDICTING POSITION
!   CPV      I    S    COWELL COEFFICIENTS FOR PREDICTING VELOCITY
!   CCP      I    A    COWELL COEFFICIENTS FOR CORRECTING POSITION
!   CCV      I    A    COWELL COEFFICIENTS FOR CORRECTING VELOCITY
!   CIP      I    A    COWELL COEFFICIENTS FOR INTERPOLATING
!                      POSITION
!   CIV      I    A    COWELL COEFFICIENTS FOR INTERPOLATING
!                      VELOCITY
!   CCPV     I    A    COWELL COEFFICIENTS FOR CORRECTING
!                      POSITIONAL VAR. EQ.
!   CCVV     I    A    COWELL COEFFICIENTS FOR CORRECTING VELOCITY
!                      VAR. EQ. (WORKING ARRAY)
!   VMATRX   I    A    PARTIALS OF ACCELERATION W.R.T. EPOCH
!                      POS. AND VEL. (WORKING ARRAY)
!   RSQ      I    A    MAGNITUDE OF THE POSITION VECTOR (WORKING ARRAY)
!   XP       I    A    PREDICTED S/C POS. AND VEL.
!   X        O    A    CORRECTED SC POS. AND VEL.
!   SUMX     O    A    INTEGRATION SUMS FOR ORBIT
!   XDDOT    O    A    ORBIT ACCELERATIONS
!   PX,PX3   O    A    CORRECTED VARIATIONAL EQUATIONS
!   SUMPX    O    A    INTEGRATION SUMS FOR VAR. EQ.
!   PXDDOT   O    A    VARIATIONAL ACCELERATION
!   PXDDT3   O    A    VARIATIONAL ACCELERATION
!   NVSTEP   I    S    NUMBER OF VARIATIONAL INTEGRATION STEPS
!   XDDTMC   O    A    NON POINT MASS ORBIT ACCELERATIONS
!   DNLT     O    S    ACCUMULATED CHANGE IN NODE (SINCE EPOCH)
!                      DUE TO LENSE-THIRRING
!   TOPXAT   O    A    TOPEX ATT. BACK VALUES (BETAPRIME & ORBIT ANGLE)
!   LTPXAT   O    A    TOPEX ATT. BACK VALUES (RAMPING LOGICALS)
!   AA      I/O   A    REAL DYNAMIC ARRAY
!   II      I/O   A    INTEGER DYNAMIC ARRAY
!   LL      I/O   A    LOGICAL DYNAMIC ARRAY
!   ISATID        A    SAT ID ARRAY
!   NRAT1    I    S    NRAT-1 WHERE NRAT=RATIO OF LARGE STEP SIZE TO
!                      SMALL STEP SZ (NRAT=1 => SINGLE RATE INTEGRATION)
!   LATOT    I    S    IF TRUE, THEN CALLS TO SUBROUTINE F WILL
!                      LOAD THE ENTIRE ACCELERATION (NOT JUST
!                      THE LARGE STEP ACCELERATION) INTO XDDOT
!   XDDTNC   O    A    SMALL STEP ACCELERATIONS
!   IDXDDN   I    S    NUMBER OF STEPS COVERED BY (LAST DIMENSION OF)
!                      THE XDDTNC ARRAY
!   SUMXNC   O    A    SMALL STEP INTEGRATION SUMS
!   IDSMXN   I    S    NUMBER OF STEPS COVERED BY (LAST DIMENSION OF)
!                      THE SUMXNC ARRAY
!   IBCKNC  I/O   S    COUNTER INDICATING HOW MANY EXTRA BACK
!                      VALUES HAVE BEEN COMPUTED FOR XDDTNC AND SUMXNC
!   LSAVEA   I    S    IF TRUE, THEN AT CERTAIN INTEGRATION STEPS
!                      VALUES OF THE XDDOT ARRAY WILL BE SAVED IN
!                      THE XDDOTH ARRAY AND PXDDOT IN PXDDTH
!   XDDOTH   O    A    ARRAY IN WHICH CERTAIN VALUES OF XDDOT SAVED
!   PXDDTH   O    A    ARRAY IN WHICH CERTAIN VALUES OF PXDDOT SAVED
!   TOPXTH   O    A    ARRAY IN WHICH CERTAIN VALUES OF TOPXAT SAVED
!   LTPXTH   O    A    ARRAY IN WHICH CERTAIN VALUES OF LTPXAT SAVED
!   NSTPSV   I    S    NUMBER OF STEPS AT WHICH XDDOT AND PXDDOT WILL
!   ISTPSV   I    A    STEPS AT WHICH XDDOT AND PXDDOT WILL
!                      BE SAVED (IF LSAVEA TRUE)
!   XPNC     O    A    PREDICTED S/C POS. AND VEL. SMALL STEP
!   XNC      O    A    CORRECTED SC POS. AND VEL. SMALL STEP
!   CPPNC    I    A    COEFFICIENTS FOR PRDICTING LARGE STEP STATE
!                      AT SMALL STEP TIMES
!   XLSASS   O    A    LARGE STEP STATE AT HIGH RATE STEPS
!   XDDTAC   O    A    COMPUTED ACCELERATIONS CORRESPOMDING TO
!                      ACCELEROMETER
!   LFHIRT   I    A    ARRAY OF LOGICAL FLAGS. EACH ELEMENT
!                      CORRESPONDS TO A FORCE MODEL COMPONENT.
!                      THE ARRAY DESCRIBES WHICH COMPONENTS ARE
!                      INTEGRATED AT A HIGH RATE.
!   LSURFF   I    A    ARRAY OF LOGICAL FLAGS. EACH ELEMENT
!                      CORRESPONDS TO A FORCE MODEL COMPONENT.
!                      THE ARRAY DESCRIBES WHICH COMPONENTS ARE
!                      INTEGRATED AT A HIGH RATE.
!   PXDDAC   O    A    PARTIAL DERIVATIVES OF XDDTAC
!   NEQNAC   I    S    NUMBER OF ADJUSTING ACCELEROMTER PARTIALS
!   IPTFBS   I    A    MAPPING ARRAY ; EXPLICIT PARTIAL ARRAY TO
!                      COMPUTED ACCELERATION PARTIAL ARRAY
!   NPRMAC   I    A    NUMBER OF PARMETERS IN EACH FORCE MODEL
!                      GROUP CATEGORY YO BE MAPPED BY IPTFBS
!   DYNTIM   I    A    USER REQUESTED START AND STOP TIMES FOR
!                      DYNAMIC ACCELERATION ACCELEROMETER PERIODS
!   NPERDY   I    A    NUMBER OF USER REQUESTED
!                      DYNAMIC ACCELERATION ACCELEROMETER PERIODS
!
! COMMENTS:  THIS SUBROUTINE IS BASED UPON THE COWELL
!            SUBROUTINE FROM THE GEODYN 8202.0 PROGRAM. THE
!            SUBROUTINE HAS BEEN COMPLETELY REWRITTEN TO
!            COLLECT VECTORS FOR OPTIMAL EXECUTION ON THE
!            CDC CYBER 205. ALL LOOPS BASED ON NEQN,NEQN3,
!            NMOVES, OR NMOVEA SHOULD BE REPLACED BY Q8 CALLS
!            ON THE CYBER 205 COMPUTER. IF THE NUMBER OF
!            LIKE SATELLITES TO BE SIMULTANEOUSLY
!            INTEGRATED IS EXPECTED TO EXCEED THREE
!            ADDITIONAL CHANGES TO THE SOURCE SHOULD
!            BE MADE AS INDICATED BY IN-LINE COMMENTS
!            AND Q8 CALLS SHOULD BE PERFORMED ON ALL
!            LOOPS BASED ON N3.
!
! RESTRICTIONS:  THE REGULARIZED INTEGRATION CAPABILITY
!                HAS BEEN DISCARDED.
!                VARY-STEP INTEGRATION HAS NOT BEEN
!                IMPLEMENTED AT PRESENT, BUT WILL BE
!                ADDED LATER.
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      CHARACTER*33 FILNAM
      CHARACTER*18 CARD
      DIMENSION XP(N3,2),X(N3,2),SUMX(N3,2,NH),                         &
     &   XDDOT(N3,NSTEPS),PX(NEQN3,2),PX3(NEQN,N3,2),                   &
     &   SUMPX(NEQN3,2,NHV),PXDDOT(NEQN3,NSTEPV),                       &
     &   PXDDT3(NEQN,N3,NSTEPV),RSQ(NSAT),VMATRX(3,6,NSAT)
!      DIMENSION XPA(3,2),XA(3,2),SUMXA(N3,2,NH),                        &
!     &   XDDOTA(N3,NSTEPS),PXA(NEQNA3,2),PXA3(NEQNA,N3,2),              &
!     &   SUMPXA(NEQNA3,2,NHV),PXDDTA(NEQNA3,NSTEPV),                    &
!     &   PXDTA3(NEQNA,N3,NSTEPV),HOLDV(NEQNA3)
      DIMENSION XPA(3,2,2),XA(3,2,2),SUMXA(N3,2,NH,NAST),               &
     &   XDDOTA(N3,NSTEPS,NAST),PXA(NEQNA3,2,NAST),                     &
     &   PXA3(NEQNA,N3,2,NAST),SUMPXA(NEQNA3,2,NHV,NAST),               &
     &   PXDDTA(NEQNA3,NSTEPV,NAST),PXDTA3(NEQNA,N3,NSTEPV,NAST),       &
     &   HOLDV(NEQNA3,NAST)
      DIMENSION NSSAVE(NTIMES1)
      DIMENSION HOLDA1(3,2,NTIMES1,NAST)
      DIMENSION HOLDA4(NEQNA3,2,NTIMES1,NAST)
      DIMENSION HOLDA7(NDPOR,2,NTIMES1,NAST)
      DIMENSION XDDCMP(3),XDDSUN(3),VMATA(3,6,2),VMATX(3,6)
      DIMENSION XDDCM2(3)
      DIMENSION XDDDMP(3)
      DIMENSION XRP(NDPOR,2,NAST),XR(NDPOR,2,NAST)
      DIMENSION SUMXR(NDPOR,2,NH,NAST)
      DIMENSION XRDOT(NDPOR,NSTEPS,NAST)
      DIMENSION XMNRT(3)
      DIMENSION XDDP(3),TRQP(3),TRQS(3)
      DIMENSION XDUM(3,4)
      DIMENSION DNLT(NSAT)
!      DIMENSION AEI(6),PKPX(6,6)
      DIMENSION XDDTMC(N3,2)
      DIMENSION CPP(IORDER),CPV(IORDER),                                &
     &    CCP(IORDER),CCV(IORDER),CIP(IORDER),                          &
     &   CIV(IORDER),CCPV(IORDRV),CCVV(IORDRV)
      DIMENSION SMAT(6,6),VMATS(3,2,3)
      DIMENSION TOPXAT(2*NSAT,NSTEPS),LTPXAT(3*NSAT,NSTEPS)
      DIMENSION TOPXTH(2*NSAT,IORDER),LTPXTH(3*NSAT,IORDER)
      DIMENSION AA(1),II(1),LL(1)
      DIMENSION ISATID(NSAT)
      DIMENSION UTDT(MINTPL,4)
      DIMENSION XDDTNC(N3,IDXDDN),SUMXNC(N3,2,IDSMXN)
      DIMENSION XDDTAC(3,NFSCAC,NSAT,IDXDDN),PXDDAC(NEQNAC,N3,IDXDDN)
      DIMENSION XDDOTH(N3,IORDER),PXDDTH(NEQN3,IORDER)
      DIMENSION XPNC(N3,2),XNC(N3,2)
      DIMENSION CPPNC(NRAT1,IORDER,2),XLSASS(N3,2,NRAT1)
      DIMENSION ISTPSV(30)
      DIMENSION LFHIRT(NHRATE),LSURFF(NHRATE),IPTFBS(MXFMG)
      DIMENSION NPRMAC(MXHRG)
      DIMENSION DYNTIM(MDYNPD,2,NSAT),NPERDY(NSAT)
      DIMENSION EXACCT(2,NSAT),EXACIN(NSAT),EXACOB(MACOBS,NSAT)
      DIMENSION ACCTIM(MBAPPD,2,NSAT),ACCPER(MBAPPD,NSAT),NPERAC(NSAT)
      DIMENSION SUMRNC(N3,2)
      DIMENSION PXR(6,3,NSAT,2),SUMRNP(6,3,NSAT,2)
      DIMENSION TXSTAT(MXSTAT),DELXST(6,MXSTAT,NSAT)
      DIMENSION DSROT(3,3,NSAT)
      DIMENSION TMOS0(1),TMOS(1),TMOSP(1)
      DIMENSION SUMXOS(3,2,1)
      DIMENSION SUMPOS(NEQNI,3,2,1)
      DIMENSION XDDTOS(3,KNSTEPS,1)
      DIMENSION PDDTOS(NEQNI,3,KNSTEPS,1)
      DIMENSION SUMXNS(3,2),SUMPNS(NEQNIM,3,2)
      DIMENSION T1SEG(10),T2SEG(10)
      DIMENSION FSECS(1),FSCUTC(1),IYMD(1),IHM(1),SEC(1)
!*************** DEBUG
      DIMENSION XTEMP(6)
!*************** DEBUG
      COMMON/ACCLRM/MDYNPD,MBAPPD,MACOBS,IDYNSC(200),MDYNST,IACCSC(200),&
     &              MACCSC,NACPRM(200),NATPRM(200),NXCLRM
      COMMON/ARCPAR/MAXSEL,NSEL,MAXDEL,NDEL,MAXMET,NMETDT,NSATID,       &
     &              IATDEN,ISATEQ,ITRMAX,ITRMIN,ITRMX2,                 &
     &              MJDSRF,MREFSY,NTDDR,NBTOTL,IDRAGM,IMRNUT,           &
     &              NXARCP
      COMMON/ASTSUN/BDAST(6),GMSAT,GEOPTS(3)
      COMMON/AXIS/LINTAX
      COMMON/CBDSTA/BDSTAT(7,999),XBDSTA
      COMMON/CEARTH/AEG,AEGSQ,FGINV,FG,EGSQ,EGSQP1,C1,C2,FOURC1,TWOC2,  &
     &              XH2,XL2,WREF,RMEAN,REFC20,REFC40,REFC60,BEG,CBLTC,  &
     &              WAE2,GAMMAA,FSTAR,F4
      COMMON/CEGREL/LGRELE,LRLCLK,LGRELR,LXPCLK,LBPCLK,NXEGRL
      COMMON/COBGLO/MABIAS,MCBIAS,MPVECT,MINTPL,MPARAM,MSTA,MOBBUF,     &
     &       MNPITR,MWIDTH,MSIZE ,MPART ,MBUF  ,NXCOBG
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CONTRL/LSIMDT,LOBS  ,LORB  ,LNOADJ,LNADJL,LORFST,LORLST,   &
     &              LORALL,LORBOB,LOBFST,LOBLST,LOBALL,LPREPO,LORBVX,   &
     &              LORBVK,LACC3D,LSDATA,LCUTOT,LACCEL,LDYNAC,LFRCAT,   &
     &              LNIAU, NXCONT
      COMMON/CGRAV/GM,AE,AESQ,FE,FFSQ32,FSQ32,XK2,XK3,XLAM,SIGXK2,      &
     &      SIGXK3,SIGLAM,RATIOM(2),AU,RPRESS
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORA07/KELEVT,KSRFEL,KTINT,KFSCSD,KXTIM,KFSDM,             &
     & KSGM1,KSGM2,KNOISE,KEPHMS,NXCA07
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CRDDIM/NDCRD2,NDCRD3,NDCRD4,NDCRD5,NDCRD6,NDCRD7,          &
     &              NDCRD8,NDCRD9,NXCRDM
      COMMON/CNIARC/NSATA,NSATG,NSETA,NEQNG,NMORDR,NMORDV,NSORDR,       &
     &              NSORDV,NSUMX,NXDDOT,NSUMPX,NPXDDT,NXBACK,NXI,       &
     &              NXILIM,NPXPF,NINTIM,NSATOB,NXBCKP,NXTIMB,           &
     &              NOBSBK,NXTPMS,NXCNIA
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988), &
     &              NXEPH2
      COMMON/INTSAV/ILSTEP,NSEG,NSCHED(2,50,10)
      COMMON/LASTER/LASTR(2),LBINAST,NXASTR
      COMMON/LCBODY/LEARTH,LMOON,LMARS
      COMMON/LDUAL/LASTSN,LSTSNX,LSTSNY
      COMMON/LEPHM2/LXEPHM
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NFORCE/NHRATE,NSURF,MPXHDT,MXHRG,MXFMG,NFSCAC,NXFORC
      COMMON/RAPIDI/LINTF,LBUFOP
      COMMON/XPCNT /NXTRAC,NXFLAG,NXALLC,NCPPER,NMINRT,NDPOR,NXXTRA
      COMMON/IDELTX/MXSTAT,NEVENTS,NDSTAT,IDSYST,NDELTX
      COMMON/IOS/ISTOS1,ISTOS2,ISTOS3,ISTLST,INTSUB(3),JNTSUB(3),      &
     &        ILSTSG(80),INTOSP,MAPSAT(3,4)

      DATA IOUT/64/
      DATA ZERO/0.0D0/,ONE/1.0D0/
      DATA EPSLON/1.0D-12/
      DATA kentry/0/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
      GMS=BDSTAT(7,8)
      IF(IORDER.NE.IORDRV) THEN
        WRITE(6,6100)
        WRITE(6,6101) IORDER,IORDRV
        STOP
      ENDIF
      TESTI=ABS(H-HV)
      IF(TESTI.GT..0001D0) THEN
        WRITE(6,6100)
        WRITE(6,6102) H,HV
        STOP
      ENDIF
!
! LBUF WILL BE TRUE WHEN THE BUFFER IS FILLED.
      LBUF=.FALSE.

      JPXST=0
      LXSTAT=.FALSE.
      EPSQ=.25D0*ABS(H)
      LSVSTP=.FALSE.
      N2=2*N3/3
      NRAT=NRAT1+1
      NSVCT=(IORDER-1)-NSTPSV
      NSVCK=1
      IOL2=IORDER-2
      IEVEN=MOD(IOL1,2)
      MF=IOL2/2-IEVEN
      MB=MF+1+IEVEN
      NTIMSF=0
      NSTEPC=0
      IW1=NSSAVE(NTIMSF+1)-MB
      IWL=NSSAVE(NTIMSF+1)+MF
      IWE=NSSAVE(NTIMSF+1)
      IOL1=IOL2+1
      IOVL2=IORDRV-2
      IOVL1=IOVL2+1
      N6=N3*2
      NEQN6=NEQN3*2
      NEQNA6=NEQNA3*2
      NH1=NH-1
      NHV1=NHV-1
      ISH=H
      FSH=H-ISH
      ISHV=HV
      FSHV=HV-ISHV
      H2=H*H
      HS=H
      IF(NRAT1.GT.0) HS=H/DBLE(NRAT)
      HS2=HS*HS
      HV2=HV*HV
      IF(.NOT.LORBIT) H2C=-CCPV(1)*HV2
      IF(.NOT.LORBIT) H1C=-CCVV(1)*HV
      NPV=2
      IF(LNDRAG)NPV=1
      NPV3=NPV*3
      ISN0=0
      ISN=POSNEG
      L1900=.FALSE.
      KF=KCFSC-1
!   SET UP FOR COORDINATE SYSTEMS
  800 CONTINUE
      XNSTP=(DBLE(MJDS2-MJDSEC)+(FSEC2-FSEC))/H
      NSTP=XNSTP+ONE+EPSLON
      NSTP=MIN(NSTP,NINTIM-1)
      IF(NRAT1.GT.0) NSTP=MAX(NSTP,2)
      FSECNS=FSEC+NSTP*FSH
      ISEC=FSECNS
      MJDSNS=MJDSEC+NSTP*ISH+ISEC
      FSECNS=FSECNS-ISEC
!
      IF(ICBDGM.EQ.3) THEN
      CALL BUFEAR(MJDSEC,FSEC,MJDSNS,FSECNS,ISN,MJDR,FSECR,LRECAL,AA,   &
     &            II)
      ELSE
      CALL BUFXTR(MJDSEC,FSEC,MJDSNS,FSECNS,ISN,MJDR,FSECR,LRECAL,AA)
!
       IF(LXEPHM) THEN
       DO IJ=1,ICBODY
       CALL BUFSUP(AA,MJDSEC,FSEC,MJDSNS,FSECNS,II(KISUPE),             &
     & AA(KEPHMS),IJ,2)
       ENDDO
       ENDIF
      ENDIF
!
      IF(.NOT.LRECAL) GO TO 810
      XNSTP=(DBLE(MJDR-MJDSEC)+(FSECR-FSEC))/H
      NSTP=XNSTP+EPSLON
  810 CONTINUE
      IF(ISN.LT.0) ISN0=NSTP+1
      IF(NRAT1.LE.0) THEN
         DO 820 I=1,NSTP
         AA(KF+ISN0+ISN*I)=FSEC+H*I
  820    CONTINUE
      ELSE
! WHEN MULTIRATE INTEGRATION IS BEING USED NEED THE
! PREVIOUS VALUE FOR INTERPOLATION
         DO 825 I=1,NSTP
         AA(KF+ISN0+ISN*I)=FSEC+H*(I-1)
  825    CONTINUE
      ENDIF
!   MAKE OTHER NECCESARY CALLS
!
      IF(ICBDGM.EQ.3) THEN
      CALL PRECSS(MJDSEC,AA(KCFSC),AA(KETA),AA(KZTA),AA(KTHTA),         &
     &            AA(KSRTCH),NSTP)
      CALL NUVECT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            NSTP,AA(KSRTCH))
      CALL NPVECT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            AA(KETA),AA(KTHTA),AA(KZTA),NSTP,AA(KSRTCH),          &
     &            AA(KROTMT),AA(KEQN),NDCRD2,.FALSE.)
      CALL GRHRAN(MJDSEC,AA(KCFSC),.FALSE.,.FALSE.,AA(KEQN),AA(KSRTCH), &
     &            AA(KTHG),AA(KCOSTG),AA(KSINTG),NSTP,AA,II,UTDT(1,1))
      ELSE
!  NEW MARS ONLY NUTATION SUBROUTINE
          IF(LMARS.AND.IMRNUT.EQ.1) THEN
      CALL PRMCSS(MJDSEC,AA(KCFSC),AA(KETA),AA(KZTA),AA(KTHTA),         &
     &            AA(KSRTCH),NSTP)
      CALL NUVMCT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            NSTP,AA(KSRTCH))
      CALL NPVMCT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            AA(KETA),AA(KTHTA),AA(KZTA),NSTP,AA(KSRTCH),          &
     &            AA(KROTMT),AA(KEQN),NDCRD2,.FALSE.)
      CALL MM2EJ2(MJDSEC,AA(KCFSC),AA(KROTMT),NDCRD2,AA(KSRTCH),        &
     & .FALSE.)
!
      CALL ROTMTR(MJDSEC,AA(KCFSC),.FALSE.,AA(KEQN),AA(KSRTCH),         &
     &            AA(KTHG),AA(KCOSTG),AA(KSINTG),NSTP,AA,II)
          ELSE
      CALL PRXCSS(MJDSEC,AA(KCFSC),AA(KETA),AA(KZTA),AA(KTHTA),         &
     &            AA(KSRTCH),NSTP,AA(KDPSI),AA(KEPST),AA(KEPSM),AA,1)
      CALL NUVXCT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            NSTP,AA(KSRTCH))
      CALL NPVXCT(MJDSEC,AA(KCFSC),AA(KDPSI),AA(KEPST),AA(KEPSM),       &
     &            AA(KETA),AA(KTHTA),AA(KZTA),NSTP,AA(KSRTCH),          &
     &            AA(KROTMT),AA(KEQN),NDCRD2,.FALSE.)
      CALL ROTXTR(MJDSEC,AA(KCFSC),.FALSE.,AA(KEQN),AA(KSRTCH),         &
     &            AA(KTHG),AA(KCOSTG),AA(KSINTG),NSTP,AA,               &
     &            AA(KACOSW),AA(KBSINW),AA(KANGWT),AA(KWT),AA(KACOFW),  &
     &            AA(KBCOFW),II,1)
      ENDIF
      ENDIF
!
      IF(NRAT1.LE.0) THEN
         NTCRD=0
      ELSE
! WHEN MULTIRATE INTEGRATION IS BEING USED ONE
! EXTRA VALUE WAS COMPUTED FOR INTERPOLATION
         NTCRD=1
      ENDIF
      IF(L1900) GO TO 1900
      L1900=.TRUE.
      IF(LORBIT)GO TO 1500
      S=DBLE(MJDSV-MJDSEC)+(FSECV-FSEC)
 1000 CONTINUE
! DETERMINE IF DESIRED TIME HAS BEEN ACHIEVED
      TIMDFV=(DBLE(MJDSV-MJDS2)+(FSECV-FSEC2))*POSNEG
!*********************** DEBUG
      IF(L4MRST) THEN
         TDQ=ABS(TIMDFV)
         IF(TDQ.LT.EPSQ) RETURN
      ELSE
         IF(TIMDFV.GE.ZERO) RETURN
      ENDIF
!*********************** DEBUG
! DESIRED TIME HAS NOT BEEN ACHIEVED
 1100 CONTINUE
      IF(IBACKV.LT.NHV1) GO TO 1400
! SHIFT BACK VALUE ARRAYS FOR PARTIALS AND RESET POINTERS
! NSAVSV WILL BE A FUNCTION OF THE NUMBER OF
!    ADDITIONAL INTEGRATION STEPS REQUIRED
!    TO ADVANCE PAST MJDS2,FSEC
      NSAVSV=TIMDFV/HV+DBLE(NHV)
      NSAVSV=MAX(MIN(NSAVSV,NHV1),1)
      NSHFTV=NHV-NSAVSV
      NSAVAV=NSAVSV+IOVL2
      NSHFTA=NSHFTV*NEQN3
      NSHFTS=NSHFTA*2
      NMOVEA=NSAVAV*NEQN3
      NMOVES=NSAVSV*NEQN6
!
!
!
!
      NSHFTA=NSHFTV*NEQNA3
      NSHFTS=NSHFTA*2
      NMOVEA=NSAVAV*NEQNA3
      NMOVES=NSAVSV*NEQNA6
!
      DO 1301 I=1,NMOVES
      SUMPXA(I,1,1,1)=SUMPXA(I+NSHFTS,1,1,1)
      IF(LBINAST) SUMPXA(I,1,1,NAST)=SUMPXA(I+NSHFTS,1,1,NAST)
 1301 END DO
!
!
      DO 1302 I=1,NMOVEA
      PXDDTA(I,1,1)=PXDDTA(I+NSHFTA,1,1)
      IF(LBINAST) PXDDTA(I,1,NAST)=PXDDTA(I+NSHFTA,1,NAST)
 1302 END DO

!
      IBACKV=IBACKV-NSHFTV
 1400 CONTINUE
      S=S+HV
      IF(S*POSNEG.LE.ZERO) GO TO 3300
      GO TO 1600
 1500 CONTINUE
! ORBIT GENERATION ONLY
! DETERMINE IF DESIRED TIME HAS BEEN ACHIEVED
      TIMDIF=(DBLE(MJDSEC-MJDS2)+FSEC-FSEC2)*POSNEG
      IF(L4MRST) THEN
         TDQ=ABS(TIMDIF)
         IF(TDQ.LT.EPSQ) RETURN
      ELSE
         IF(TIMDIF.GE.ZERO) RETURN
      ENDIF
! DESIRED TIME HAS NOT BEEN ACHIEVED
 1600 CONTINUE
! SHIFT BACK VALUE ARRAYS FOR ORBIT AND RESET POINTERS
      IF(IBACK.LT.NH1) GO TO 1900
!  NSAVES WILL BE A FUNCTION OF THE NUMBER OF ADDITIONAL
!         INTEGRATION STEPS REQUIRED TO ADVANCE PAST MJDS2,FSEC2
      TIMDIF=(DBLE(MJDSEC-MJDS2)+(FSEC-FSEC2))*POSNEG
      NSAVES=TIMDIF/H+DBLE(NH)
      NSAVES=MAX(MIN(NSAVES,NH1),1)
      NSHIFT=NH-NSAVES
      NSAVEA=NSAVES+IOL2
      NSHFTA=NSHIFT*N3
      NSHFTS=NSHFTA*2
      NSHFTP=NSHIFT*2*NSAT
      NMOVEA=NSAVEA*N3
      NMOVES=NSAVES*N6
      NMVTPX=NSAVEA*2*NSAT
!
      NSHFAX=NSHIFT*NDPOR
      NSHFSX=NSHFAX*2
      NMVAXA=NSAVEA*NDPOR
      NMVAXS=NSAVES*NDPOR*2
!
      DO 1700 I=1,NMOVES
      SUMXA(I,1,1,1)=SUMXA(I+NSHFTS,1,1,1)
      IF(LBINAST) SUMXA(I,1,1,NAST)=SUMXA(I+NSHFTS,1,1,NAST)
 1700 END DO
!
!
      DO 1800 I=1,NMOVEA
      XDDOTA(I,1,1)=XDDOTA(I+NSHFTA,1,1)
      IF(LBINAST) XDDOTA(I,1,NAST)=XDDOTA(I+NSHFTA,1,NAST)
 1800 END DO
      IF(LINTAX) THEN
         DO I=1,NMVAXS
           SUMXR(I,1,1,1)=SUMXR(I+NSHFSX,1,1,1)
           IF(LBINAST) SUMXR(I,1,1,NAST)=SUMXR(I+NSHFSX,1,1,NAST)
         ENDDO
         DO I=1,NMVAXA
           XRDOT(I,1,1)=XRDOT(I+NSHFAX,1,1)
           IF(LBINAST) XRDOT(I,1,NAST)=XRDOT(I+NSHFAX,1,NAST)
         ENDDO
      ENDIF
!
!
      IBACK=IBACK-NSHIFT
!
      IF(LSAVEA) GO TO 1900
      GO TO 1900
! ACCELERATIONS FOR SEPARATE STEP INTEGRATION
! (WHETHER OR NOT SEPARATE STEP INTEGRATION)
!
!   THE INTVL [IBACK+2-NSAVES,IBACK+1+IOL2] IS BEING SAVED FOR REG STEP
!   FOR LARGE STEP ACCELS ; THE NUMBER OF ACCELS SAVED IS NSAVES+IOL2
!
!   WHAT IS SAME INTERVAL FOR SMALL STEP ACCELS?
!   RIGHT HAND ENDPOINT IS  [IBCKNC+1+IOL2]
!   THE NUMBER OF SMALL STEP ACCELS WHICH MUST BE SAVED IS:
!   [(NSAVES-1+IOL2)*NRAT+1]  ; SO, THE LEFT HAND ENDPOINT IS:
!   (IBCKNC+1+IOL2)-(NSAVES-1+IOL2)*NRAT
!   THE SAVED ACCEL INTERVAL IS:
!   [(IBCKNC+1+IOL2)-(NSAVES-1+IOL2)*NRAT , IBCKNC+1+IOL2]
!   AND NSHFTN=(IBCKNC+IOL2)-(NSAVES-1+IOL2)*NRAT
!   THE NUMBER OF SUM STEPS TO BE SAVED IS [(NSAVES-1+IOL2)*NRAT+1-IOL2]
!
      NSHFTN=(IBCKNC+IOL2)-(NSAVES-1+IOL2)*NRAT
!
! FIRST SOME CHECKS
!
      IF(NSHFTN.LT.1) THEN
         WRITE(6,6000)
         WRITE(6,6001)
         WRITE(6,6002) ISATID(1),MJDSEC,FSEC
         WRITE(6,6003) IBCKNC,IORDER,NSAVES,NRAT,IDXDDN
         STOP
      ENDIF
      ITEST=IBCKNC+1+IOL2
      IF(ITEST.GT.IDXDDN) THEN
      WRITE(6,6000)
      WRITE(6,6001)
      WRITE(6,6002) ISATID(1),MJDSEC,FSEC
      WRITE(6,6003) IBCKNC,IORDER,NSAVES,NRAT,IDXDDN
      STOP
      ENDIF
!CCCCCNMOVEN=NMOVEA*NRAT
      NMOVEN=((NSAVES-1+IOL2)*NRAT+1)*N3
      NSHFT=NSHFTN*N3
!
 1890 CONTINUE
      IBCKNC=IBCKNC-NSHFTN
 1900 CONTINUE
      NTCRD=NTCRD+1
      IF(NTCRD.GT.NSTP) GO TO 800
      IBACK1=IBACK+1
      IORBAK=IORDER+IBACK
!!!      IORBNC=IORDER+IBCKNC
! PREDICT POSITION
! IF NSAT IS EXPECTED TO BE GREATER THAN 3; NESTING LOOP 2100
! INSIDE 2000 AND LOOP 2300 INSIDE 2200 ALONG WITH VECTORIZATION
! OF THE INNERMOST LOOPS WOULD SPEED-UP RUNNING TIME SIGNIFICANTLY.
      DO 2100 J=1,N3
      SUMA=SUMXA(J,1,IBACK1,1)
      SUMB=SUMXA(J,1,IBACK1,NAST)
      DO 2000 I=1,IOL2
      K=IORBAK-I
      SUMA=SUMA+CPP(I)*XDDOTA(J,K,1)
      SUMB=SUMB+CPP(I)*XDDOTA(J,K,NAST)
 2000 END DO
      XPA(J,1,1)=SUMA*H2
      XPA(J,1,NAST)=SUMB*H2
 2100 END DO
      IF(LNDRAG.AND..NOT.LGRELE) GO TO 2400
! PREDICT VELOCITY
      DO 2300 J=1,N3
      SUMA=SUMXA(J,2,IBACK1,1)
      SUMB=SUMXA(J,2,IBACK1,NAST)
      DO 2200 I=1,IOL1
      K=IORBAK-I
      SUMA=SUMA+CPV(I)*XDDOTA(J,K,1)
      SUMB=SUMB+CPV(I)*XDDOTA(J,K,NAST)
 2200 END DO
      XPA(J,2,1)=SUMA*H
      XPA(J,2,NAST)=SUMB*H
 2300 END DO
 2400 CONTINUE
      IF(.NOT.LINTAX) GO TO 2450
      DO 2430 J=1,NDPOR
      SUMR=SUMXR(J,2,IBACK1,1)
      SUMR2=SUMXR(J,2,IBACK1,NAST)
      DO 2420 I=1,IOL1
      K=IORBAK-I
      SUMR=SUMR+CPV(I)*XRDOT(J,K,1)
      SUMR2=SUMR2+CPV(I)*XRDOT(J,K,NAST)
 2420 END DO
      XRP(J,2,1)=SUMR*H
      XRP(J,2,NAST)=SUMR2*H
 2430 END DO
      CALL LOADAX(XRP(4,2,1),XRP(4,2,NAST))
 2450 CONTINUE
! INCREMENT TIME FOR ORBIT INTEGRATION
!!!!!!!!!!!!!!!!!!!!!!!DIR$ SUPPRESS FSEC
      FSEC=FSEC+FSH
      ISEC=FSEC
      FSEC=FSEC-ISEC
      MJDSEC=MJDSEC+ISH+ISEC
      NCORR=0
! START OF CORRECTOR LOOP
 2500 CONTINUE
      IF(LSTSNX) CALL GETAST(AA,IDA1,MJDSEC,FSEC,XPA)
      IF(LSTSNY) CALL GETAST(AA,IDA2,MJDSEC,FSEC,XPA(1,1,2))
      NCORR=NCORR+1
! EVALUATE ACCELERATION
      IFILL=IORDRV+IBACKV
      INTCRD=ISN*NTCRD+ISN0
      BDAST(1)=XPA(1,1,1)
      BDAST(2)=XPA(2,1,1)
      BDAST(3)=XPA(3,1,1)
      BDAST(4)=XPA(1,2,1)
      BDAST(5)=XPA(2,2,1)
      BDAST(6)=XPA(3,2,1)
      XDDP(1)=0.D0
      XDDP(2)=0.D0
      XDDP(3)=0.D0
          IF(NAST.EQ.2) THEN
      CALL FASTIN(GM2,XPA(1,1,2),XDDP,                                  &
     &            XDDOTA(1,IORBAK,2),TRQP,TRQS,VMATA(1,1,2),0,          &
     &            AA,II,INTCRD,MJDSEC,FSEC,PXDTA3(1,1,IFILL,1),         &
     &            PXDTA3(1,1,IFILL,2),NEQNA,NEQNA)
      CALL TRQMAT(GM2,XPA(1,1,2),TRQP,TRQS,AA,II,INTCRD,MJDSEC,FSEC)
          ENDIF
!
      CALL FAST(MJDSEC,FSEC,AA,II,LL,NEQNA,XPA,VMATA,                   &
     &          PXDTA3(1,1,IFILL,1),XDDOTA(1,IORBAK,1),XDDSUN,XDDCMP,   &
     &          XDDOT(1,IORBAK),XP,XMNRT,XRP(4,2,1),XRP(1,2,1),         &
     &          XRDOT(4,IORBAK,1),XRDOT(1,IORBAK,1),.FALSE.,XDDTMC,     &
     &          .TRUE.,INTCRD,ONE,                                      &
!... Begin TJS...
! omega                           => XRP(  1,2) => length   3 \
! axis                            => XRP(  4,2) => length   9  \
!                                                               | Total
!                                                               | length = 228
! d(orientation)/d(orientation_0) => XRP( 13,2) => length 144  /
! d(orientation)/d(inertia)       => XRP(157,2) => length  72 /
     &        XRP(13,2,1),XRDOT(13,IORBAK,1),XRP(157,2,1),            &
     &        XRDOT(157,IORBAK,1),XDDP,1,TRQP,PXDDT3(1,1,IFILL),NEQN)
!... End TJS...
!
          IF(NAST.EQ.2) THEN
!
!  OTHER ACCELATIONS FOR SECOND ASTEROID
!  ALSO APPLY TORQUES FOR SECOND ASTEROID
!
      CALL FAST2(XPA(1,1,2),XDDOTA(1,IORBAK,2),XDDCM2,VMATA(1,1,2))
      CALL FAST(MJDSEC,FSEC,AA,II,LL,NEQNA,XPA,VMATA,                   &
     &          PXDTA3(1,1,IFILL,1),XDDOTA(1,IORBAK,1),XDDSUN,XDDCMP,   &
     &          XDDOT(1,IORBAK),XP,XMNRT,XRP(4,2,NAST),XRP(1,2,NAST),   &
     &          XRDOT(4,IORBAK,NAST),XRDOT(1,IORBAK,NAST),.FALSE.,      &
     &          XDDTMC,.TRUE.,INTCRD,ONE,                               &
!... Begin TJS...
! omega                           => XRP(  1,2) => length   3 \
! axis                            => XRP(  4,2) => length   9  \
!                                                               | Total
!                                                               | length = 228
! d(orientation)/d(orientation_0) => XRP( 13,2) => length 144  /
! d(orientation)/d(inertia)       => XRP(157,2) => length  72 /
     &          XRP(13,2,NAST),XRDOT(13,IORBAK,NAST),XRP(157,2,NAST),   &
     &          XRDOT(157,IORBAK,NAST),XDDP,2,TRQS,PXDDT3(1,1,IFILL),   &
     &          NEQN)
!... End TJS...
          ENDIF
!
88914 FORMAT(' COWLA0 1ST STEP ; ACC ',3D20.11)
! IF NSAT IS EXPECTED TO BE GREATER THAN 3; REPLACING LOOP 2800 WITH
! LOOPS NESTED INSIDE LOOPS 2600 AND 2700 ALONG WITH VECTORIZATION
! OF THESE INNERMOST LOOPS WOULD SPEED-UP RUNNING
! TIME SIGNIFICANTLY.
! CORRECT POSITION AND VELOCITY
      DO 2800 J=1,N3
      SUMA=SUMXA(J,1,IBACK1,1)
      SUMB=SUMXA(J,1,IBACK1,NAST)
      DO 2600 I=1,IOL2
      K=IORBAK-I+1
      SUMA=SUMA+CCP(I)*XDDOTA(J,K,1)
      SUMB=SUMB+CCP(I)*XDDOTA(J,K,NAST)
 2600 END DO
      XA(J,1,1)=SUMA*H2
      XA(J,1,NAST)=SUMB*H2
      SUMA=SUMXA(J,2,IBACK1,1)
      SUMB=SUMXA(J,2,IBACK1,NAST)
      DO 2700 I=1,IOL1
      K=IORBAK-I+1
      SUMA=SUMA+CCV(I)*XDDOTA(J,K,1)
      SUMB=SUMB+CCV(I)*XDDOTA(J,K,NAST)
 2700 END DO
      XA(J,2,1)=SUMA*H
      XA(J,2,NAST)=SUMB*H
 2800 END DO
      IF(LSTSNX) CALL GETAST(AA,IDA1,MJDSEC,FSEC,XA)
      IF(LSTSNY) CALL GETAST(AA,IDA2,MJDSEC,FSEC,XA(1,1,2))
      IF(.NOT.LINTAX) GO TO 2830
      DO 2820 J=1,NDPOR
      SUMR=SUMXR(J,2,IBACK1,1)
      SUMR2=SUMXR(J,2,IBACK1,NAST)
      DO 2810 I=1,IOL1
      K=IORBAK-I+1
      SUMR=SUMR+CCV(I)*XRDOT(J,K,1)
      SUMR2=SUMR2+CCV(I)*XRDOT(J,K,NAST)
 2810 CONTINUE
      XR(J,2,1)=SUMR*H
      XR(J,2,NAST)=SUMR2*H
 2820 CONTINUE
 2830 CONTINUE
!
! COMPUTE MAGNITUDE OF DIFFERENCE BETWEEN PREVIOUS
! AND CURRENT POSITIONS AND TEST FOR CONVERGENCE
      DO 2850 ISAT=1,NSAT
      I=(ISAT-1)*3+1
      RSQA=XA(I,1,1)**2+XA(I+1,1,1)**2+XA(I+2,1,1)**2
      DIFSQA=(XA(I,1,1)-XPA(I,1,1))**2+(XA(I+1,1,1)-XPA(I+1,1,1))**2    &
     &      +(XA(I+2,1,1)-XPA(I+2,1,1))**2
      IF(DIFSQA.GT.CTOL*RSQA) GO TO 2875
      RSQB=XA(I,1,NAST)**2+XA(I+1,1,NAST)**2+XA(I+2,1,NAST)**2
      DIFSQB=(XA(I,1,NAST)-XPA(I,1,NAST))**2+                           &
     &      +(XA(I+1,1,NAST)-XPA(I+1,1,NAST))**2                        &
     &      +(XA(I+2,1,NAST)-XPA(I+2,1,NAST))**2
      IF(DIFSQB.GT.CTOL*RSQB) GO TO 2875
 2850 END DO
      GO TO 3000
 2875 CONTINUE
!
!     ....NUMBER OF CORRECTIONS SHOULD NEVER BE > 1
!     ....IF NUMBER OF CORRECTIONS > 3, STOP PROGRAM
!
      IF(NCORR.GT.3) THEN
         WRITE(6,10211) NCORR
10211    FORMAT(///' COWELL: NCORR = ',I5/                              &
     &          ' TOO MANY CORRECTIONS IN COWELL INTEGRATOR.'/          &
     &          ' CHECK INTEGRATION STEP SIZE -- PROBABLY TOO LARGE.'/  &
     &          ' REDUCE STEP SIZE AND RE-SUBMIT.'///)
         CALL ERROR
      ENDIF
!
! NOT CONVERGED PERFORM ADDITIONAL CORRECTION
      DO 2900 J=1,N3
      XPA(J,1,1)=XA(J,1,1)
      XPA(J,2,1)=XA(J,2,1)
 2900 END DO
      IF(.NOT.LINTAX) GO TO 2500
      DO 2901 J=1,NDPOR
      XRP(J,2,1)=XR(J,2,1)
      IF(LBINAST) XRP(J,2,NAST)=XR(J,2,NAST)
 2901 END DO
      GO TO 2500
 3000 CONTINUE
! CONVERGENCE ACHIEVED
      IF(LINTAX) THEN
!  CORRECT ROTATIONAL DERIVATIVES
      CALL LOADAX(XR(4,2,1),XR(4,2,NAST))
      CALL FAST(MJDSEC,FSEC,AA,II,LL,NEQNA,XA,VMATX,                    &
     &          PXDTA3(1,1,IFILL,1),XDDOTA(1,IORBAK,1),XDDSUN,XDDDMP,   &
     &          XDDOT(1,IORBAK),X,XMNRT,XR(4,2,1),XR(1,2,1),            &
     &          XRDOT(4,IORBAK,1),XRDOT(1,IORBAK,1),.TRUE.,XDDTMC,      &
     &          .TRUE.,INTCRD,ONE,                                      &
!... Begin TJS...
     &          XR(13,2,1),XRDOT(13,IORBAK,1),XR(157,2,1),              &
     &          XRDOT(157,IORBAK,1),XDDP,1,TRQP,PXDDT3(1,1,IFILL),NEQN)
!... End TJS...
            IF(LBINAST) THEN
      CALL FAST(MJDSEC,FSEC,AA,II,LL,NEQNA,XA,VMATX,                    &
     &          PXDTA3(1,1,IFILL,1),XDDOTA(1,IORBAK,1),XDDSUN,XDDDMP,   &
     &          XDDOT(1,IORBAK),X,XMNRT,XR(4,2,NAST),XR(1,2,NAST),      &
     &          XRDOT(4,IORBAK,NAST),XRDOT(1,IORBAK,NAST),.TRUE.,XDDTMC,&
     &          .TRUE.,INTCRD,ONE,                                      &
!... Begin TJS...
     &          XR(13,2,NAST),XRDOT(13,IORBAK,NAST),XR(157,2,NAST),     &
     &          XRDOT(157,IORBAK,NAST),XDDP,2,TRQS,                     &
     &          PXDDT3(1,1,IFILL),NEQN)
!... End TJS...

            ENDIF
      ENDIF
      NOCORR=NOCORR+NCORR
      NOSTEP=NOSTEP+1
! PERFORM ACCELERATION EVALUATION*
      DO 3150 ISAT=1,NSAT
      IO=(ISAT-1)*3
      I=IO+1
      DO 3100 J=1,3
!
! PRIMARY ASTEROID
!
      R= SQRT(RSQA)
      XGMR3S=(GMS+GM)/RSQA
      XGMR3S=XGMR3S/R
      XDDOTA(IO+J,IORBAK,1)=-XA(IO+J,1,1)*XGMR3S+XDDCMP(IO+J)
!
      IF(NAST.EQ.1) GO TO 3100
!
! SECONDARY ASTEROID
!
      R= SQRT(RSQB)
      XGMR3S=(GM2+GM)/RSQB
      XGMR3S=XGMR3S/R
      XDDOTA(IO+J,IORBAK,NAST)=-XA(IO+J,1,NAST)*XGMR3S+XDDCM2(IO+J)
!
 3100 END DO
 3150 END DO
      LSVSTP=.FALSE.
! INCREMENT BACK VALUE POINTER
      IBACK=IBACK+1
      IBACK1=IBACK+1
!!!!! IBCKNC=IBCKNC+1
! UPDATE SUMS
      DO 3200 J=1,N3
      SUMXA(J,2,IBACK1,1)=SUMXA(J,2,IBACK,1)                            &
     &                +XDDOTA(J,IORBAK,1)
      SUMXA(J,1,IBACK1,1)=SUMXA(J,2,IBACK1,1)                           &
     &                +SUMXA(J,1,IBACK,1)
 3200 END DO
      IF(LBINAST) THEN
        DO 3201 J=1,N3
        SUMXA(J,2,IBACK1,NAST)=SUMXA(J,2,IBACK,NAST)                    &
     &                        +XDDOTA(J,IORBAK,NAST)
        SUMXA(J,1,IBACK1,NAST)=SUMXA(J,2,IBACK1,NAST)                   &
     &                        +SUMXA(J,1,IBACK,NAST)
 3201   END DO


      ENDIF
      IF(LINTAX) THEN
        DO 3205 J=1,NDPOR
        SUMXR(J,2,IBACK1,1)=SUMXR(J,2,IBACK,1)                          &
     &                  +XRDOT(J,IORBAK,1)
        SUMXR(J,1,IBACK1,1)=SUMXR(J,2,IBACK1,1)                         &
     &                  +SUMXR(J,1,IBACK,1)
 3205   END DO
        IF(LBINAST) THEN
          DO 3206 J=1,NDPOR
          SUMXR(J,2,IBACK1,NAST)=SUMXR(J,2,IBACK,NAST)                  &
     &                    +XRDOT(J,IORBAK,NAST)
          SUMXR(J,1,IBACK1,NAST)=SUMXR(J,2,IBACK1,NAST)                 &
     &                    +SUMXR(J,1,IBACK,NAST)
 3206     END DO
        ENDIF
      ENDIF
!!!!
      IF(LSTINR) THEN
! CB OUTPUT FILE
        FSECS(1)=FSEC
        CALL UTCET(.FALSE.,1,MJDSEC,FSECS(1),FSCUTC(1),AA(KA1UT))
        CALL YMDHMS(MJDSEC,FSCUTC(1),IYMD,IHM,SEC,1)
        IF(IYMD(1).GT.1000000)IYMD(1)=IYMD(1)-1000000
        TQ=DBLE(MJDSEC)+FSCUTC(1)
        WRITE(CARD,70000) IYMD,IHM,SEC
        DO JJ=1,6
          IF(CARD(JJ:JJ).EQ.' ') CARD(JJ:JJ)='0'
        ENDDO
        DO JJ=8,11
          IF(CARD(JJ:JJ).EQ.' ') CARD(JJ:JJ)='0'
        ENDDO
        IF(CARD(14:14).EQ.' ') CARD(14:14)='0'
        IF(CARD(15:15).EQ.' ') CARD(15:15)='0'
        WRITE(77,70001) TQ,CARD,(XA(JJ,1,1),JJ=1,6)
! END CB OUTPUT FILE
      ENDIF
! IF ONLY ORBIT GENERATION BYPASS INTEGRATION
! OF VARIATIONAL PARTIALS AND RETURN
! TO START OF ORBIT INTEGRATION LOOP
      IF(LORBIT)GO TO 1500
 3300 CONTINUE
! INCREMENT TIME FOR VARIATIONAL EQUATION INTEGRATION
      FSECT=FSECV+FSHV
      ISEC=FSECT
      FSECT=FSECT-ISEC
      MJDST=MJDSV+ISHV+ISEC
! DETERMINE IF ORBIT HAS BEEN ADVANCED TO TIME
!     LATER THAN OR EQUAL TO TIME OF
!     VARIATIONAL EQUATIONS
      S=DBLE(MJDST-MJDSEC)+(FSECT-FSEC)
 3500 CONTINUE
! SAVE UPDATED VARIATIONAL EQUATION TIME
      MJDSV=MJDST
      FSECV=FSECT
      IBAKV1=IBACKV+1
      IOVBAK=IORDRV+IBAKV1
! EVALUATE FORCE MODEL PARTIAL DERIVATIVES
      NVSTEP=NVSTEP+1
! INTEGRATE VARIATIONAL EQUATIONS USING CORRECTOR FORMULAS
! POSITIONAL PARTIALS
!
! FIRST PREDICT THEN CORRECT
!
!
      DO 3601 N=1,NEQNA3
      PXA(N,1,1)=SUMPXA(N,1,IBAKV1,1)
      PXA(N,1,NAST)=SUMPXA(N,1,IBAKV1,NAST)
 3601 END DO
!
!
      DO 3800 I=1,IOVL2
! NOTE THAT IOVBAK IS 1 LARGER THAN THE CORRESPONDINF IORBAK
      K=IOVBAK-I-1
!
      DO 3701 N=1,NEQNA3
      PXA(N,1,1)=PXA(N,1,1)+CPP(I)*PXDDTA(N,K,1)
 3701 END DO
      IF(LBINAST) THEN
        DO 3702 N=1,NEQNA3
        PXA(N,1,NAST)=PXA(N,1,NAST)+CPP(I)*PXDDTA(N,K,NAST)
 3702   END DO
      ENDIF
!
!
 3800 END DO
!
      DO 3901 N=1,NEQNA3
      PXA(N,1,1)=PXA(N,1,1)*HV2
 3901 END DO
      IF(LBINAST) THEN
        DO 3902 N=1,NEQNA3
        PXA(N,1,NAST)=PXA(N,1,NAST)*HV2
 3902   END DO
      ENDIF
!
!
!!!!!      IF(LNDRAG)GO TO 4350
! VELOCITY PARTIALS
!
      DO 4001 N=1,NEQNA3
      PXA(N,2,1)=SUMPXA(N,2,IBAKV1,1)
      PXA(N,2,NAST)=SUMPXA(N,2,IBAKV1,NAST)
 4001 END DO
!
!
      DO 4200 I=1,IOVL1
! NOTE THAT IOVBAK IS 1 LARGER THAN THE CORRESPONDINF IORBAK
      K=IOVBAK-I-1
!
      DO 4101 N=1,NEQNA3
      PXA(N,2,1)=PXA(N,2,1)+CPV(I)*PXDDTA(N,K,1)
 4101 END DO
      IF(LBINAST) THEN
        DO 4102 N=1,NEQNA3
        PXA(N,2,NAST)=PXA(N,2,NAST)+CPV(I)*PXDDTA(N,K,NAST)
 4102   END DO
      ENDIF
!
!
 4200 END DO
!
      DO 4301 N=1,NEQNA3
      PXA(N,2,1)=PXA(N,2,1)*HV
      HOLDV(N,1)=PXDTA3(N,1,IOVBAK-1,1)
 4301 END DO
      IF(LBINAST) THEN
        DO 4302 N=1,NEQNA3
        PXA(N,2,NAST)=PXA(N,2,NAST)*HV
        HOLDV(N,NAST)=PXDTA3(N,1,IOVBAK-1,NAST)
 4302   END DO
      ENDIF
!
!4350  CONTINUE
!
!
      CALL VEVALA(PXA,PXDTA3(1,1,IOVBAK-1,1),NEQNA,.TRUE.,VMATA,1,      &
     &            PXDDT3(1,1,IOVBAK-1),.TRUE.,1)
             IF(LBINAST) THEN
      CALL VEVALA(PXA(1,1,NAST),PXDTA3(1,1,IOVBAK-1,NAST),NEQNA,.TRUE., &
     &            VMATA(1,1,NAST),1,PXDDT3(1,1,IOVBAK-1),.TRUE.,2)
             ENDIF
!
!
! CORRECT
!
!
      DO 5601 N=1,NEQNA3
      PXA(N,1,1)=SUMPXA(N,1,IBAKV1,1)
      PXA(N,1,NAST)=SUMPXA(N,1,IBAKV1,NAST)
 5601 END DO
!
!
      DO 5800 I=1,IOVL2
! NOTE THAT IOVBAK IS 1 LARGER THAN THE CORRESPONDINF IORBAK
      K=IOVBAK-I
!
      DO 5701 N=1,NEQNA3
      PXA(N,1,1)=PXA(N,1,1)+CCP(I)*PXDDTA(N,K,1)
 5701 END DO
      IF(LBINAST) THEN
        DO 5702 N=1,NEQNA3
        PXA(N,1,NAST)=PXA(N,1,NAST)+CCP(I)*PXDDTA(N,K,NAST)
 5702   END DO
      ENDIF
!
!
 5800 END DO
!
      DO 5901 N=1,NEQNA3
      PXA(N,1,1)=PXA(N,1,1)*HV2
      IF(LBINAST) PXA(N,1,NAST)=PXA(N,1,NAST)*HV2
 5901 END DO
!
!
!!!!!!!!      IF(LNDRAG)GO TO 6350
! VELOCITY PARTIALS
!
      DO 6004 N=1,NEQNA3
      PXA(N,2,1)=SUMPXA(N,2,IBAKV1,1)
      PXA(N,2,NAST)=SUMPXA(N,2,IBAKV1,NAST)
 6004 END DO
!
!
      DO 6200 I=1,IOVL1
! NOTE THAT IOVBAK IS 1 LARGER THAN THE CORRESPONDINF IORBAK
      K=IOVBAK-I
!
      DO 6005 N=1,NEQNA3
      PXA(N,2,1)=PXA(N,2,1)+CCV(I)*PXDDTA(N,K,1)
 6005 END DO
      IF(LBINAST) THEN
        DO 6006 N=1,NEQNA3
        PXA(N,2,NAST)=PXA(N,2,NAST)+CCV(I)*PXDDTA(N,K,NAST)
 6006   END DO
      ENDIF
!
!
 6200 END DO
!
      DO 6301 N=1,NEQNA3
      PXA(N,2,1)=PXA(N,2,1)*HV
      PXDTA3(N,1,IOVBAK-1,1)=HOLDV(N,1)
 6301 END DO
      IF(LBINAST) THEN
        DO 6302 N=1,NEQNA3
        PXA(N,2,NAST)=PXA(N,2,NAST)*HV
        PXDTA3(N,1,IOVBAK-1,NAST)=HOLDV(N,NAST)
 6302   END DO
      ENDIF
!
!
!6350 CONTINUE
!
      CALL VEVALA(PXA,PXDTA3(1,1,IOVBAK-1,1),NEQNA,.TRUE.,VMATA,1,      &
     &            PXDDT3(1,1,IOVBAK-1),.TRUE.,1)
          IF(LBINAST) THEN
      CALL VEVALA(PXA(1,1,NAST),PXDTA3(1,1,IOVBAK-1,NAST),NEQNA,.TRUE., &
     &            VMATA(1,1,2),1,PXDDT3(1,1,IOVBAK-1),.TRUE.,2)
          ENDIF
!
!
!
!
! INCREMENT VARIATIONAL BACK VALUE POINTER
      IBACKV=IBACKV+1
      IBAKV1=IBACKV+1
      IOVBAK=IOVL1+IBACKV
! UPDATE SUMS FOR VARIATIONAL EQUATIONS
!
      DO 7601 N=1,NEQNA3
      SUMPXA(N,2,IBAKV1,1)=SUMPXA(N,2,IBACKV,1)                         &
     &                 +PXDDTA(N,IOVBAK,1)
      SUMPXA(N,1,IBAKV1,1)=SUMPXA(N,2,IBAKV1,1)                         &
     &                 +SUMPXA(N,1,IBACKV,1)
 7601 END DO
      IF(LBINAST) THEN
        DO 7602 N=1,NEQNA3
        SUMPXA(N,2,IBAKV1,NAST)=SUMPXA(N,2,IBACKV,NAST)                 &
     &                   +PXDDTA(N,IOVBAK,NAST)
        SUMPXA(N,1,IBAKV1,NAST)=SUMPXA(N,2,IBAKV1,NAST)                 &
     &                   +SUMPXA(N,1,IBACKV,NAST)
 7602 END DO
      ENDIF
!
!
      NSTEPC=NSTEPC+1
      IF(NSTEPC.GE.IW1.AND.NSTEPC.LE.IWL) THEN
!!!    INDXQ=NSTEPC-IW1+1
!!!    HOLDA2(1,INDXQ,NTIMSF+1)=XDDOTA(1,IORBAK)
!!!    HOLDA2(2,INDXQ,NTIMSF+1)=XDDOTA(2,IORBAK)
!!!    HOLDA2(3,INDXQ,NTIMSF+1)=XDDOTA(3,IORBAK)
!!!    DO N=1,NEQNA3
!!!      HOLDA5(N,INDXQ,NTIMSF+1)=PXDDTA(N,IOVBAK)
!!!    ENDDO
!!!    DO N=1,12
!!!      HOLDA8(N,INDXQ,NTIMSF+1)=XRDOT(N,IORBAK)
!!!    ENDDO
       IF(NSTEPC.EQ.IWE) THEN
         DO N=1,6
           HOLDA1(N,1,NTIMSF+1,1)=XA(N,1,1)
           HOLDA1(N,1,NTIMSF+1,NAST)=XA(N,1,NAST)
         ENDDO
         IQP=NTIMSF+1
         DO N=1,NEQNA3
           HOLDA4(N,1,NTIMSF+1,1)=PXA(N,1,1)
           HOLDA4(N,2,NTIMSF+1,1)=PXA(N,2,1)
         ENDDO
         IF(LBINAST) THEN
           DO N=1,NEQNA3
             HOLDA4(N,1,NTIMSF+1,NAST)=PXA(N,1,NAST)
             HOLDA4(N,2,NTIMSF+1,NAST)=PXA(N,2,NAST)
           ENDDO
         ENDIF
         IF(LINTAX) THEN
            DO N=1,NDPOR*2
              HOLDA7(N,1,NTIMSF+1,1)=XR(N,1,1)
              IF(LBINAST) HOLDA7(N,1,NTIMSF+1,NAST)=XR(N,1,NAST)
            ENDDO
         ENDIF
       ENDIF
       IF(NSTEPC.EQ.IWL) THEN
!!!      DO N=1,6
!!!        HOLDA3(N,1,NTIMSF+1)=SUMXA(N,1,IBACK1)
!!!      ENDDO
!!!      DO N=1,NEQNA3
!!!        HOLDA6(N,1,NTIMSF+1)=SUMPXA(N,1,IBAKV1)
!!!        HOLDA6(N,2,NTIMSF+1)=SUMPXA(N,2,IBAKV1)
!!!      ENDDO
!!!      DO N=1,24
!!!        HOLDA9(N,1,NTIMSF+1)=SUMXR(N,1,IBACK1)
!!!      ENDDO
         NTIMSF=NTIMSF+1
         IF(NTIMSF.EQ.NTIMES1) RETURN
         IW1=NSSAVE(NTIMSF+1)-MB
         IWL=NSSAVE(NTIMSF+1)+MF
         IWE=NSSAVE(NTIMSF+1)
       ENDIF
      ENDIF
!
!
!
!
! INTEGRATION STEP COMPLETED RETURN TO
!             START OF INTEGRATION LOOP
      GO TO 1000
!
 6000 FORMAT(' EXECUTION TERMINATING IN COWELA DURING SHIFTING')
 6001 FORMAT(' OF "NC" ACCELERATIONS')
 6002 FORMAT(' SATELLITE ID ',I10,' AT TIME ',I10,F15.3)
 6003 FORMAT(' IBCKNC, IORDER, NSAVES, NRAT,IDXDDN ',5I8)
 6011 FORMAT(' OF "NC" INTEGRATION SUMS')
 6013 FORMAT(' IBCKNC, IORDER, NSAVES, NRAT,IDSMXN ',5I8)
 6020 FORMAT(' EXECUTION TERMINATING IN COWELA. MULTI-RATE INTEGRATION')
 6021 FORMAT(' BOT ALLOWED FOR DUAL ASTEROID CAPABILITY')
 6030 FORMAT(' EXECUTION TERMINATING IN COWELA. VARIATIONAL TIME')
 6031 FORMAT(' OFFSET FROM ORBIT TIME ; NOT ALLOWD IN DUAL AST')
 6100 FORMAT(' EXECUTION TERMINATING IN COWLA0 ')
 6101 FORMAT(' IORDER ',I7,' NE IORDRV ',I7)
 6102 FORMAT(' H  ',F15.3,' NE HV ',F15.3)
70000 FORMAT(I6,1X,I4,F7.2)
70001 FORMAT(F15.2,2X,A18,6D25.16)
      END
