!$SUNPO
      SUBROUTINE SUNPO(MJDSEC,FSEC  ,SUNXYZ,XYZLUN,TOBLQ ,XYZIN ,XYZOUT,&
     &                 PROT,LNAABR,LTRUED,LNPREC,L50EQT,LMATRX,AA,II  )
!********1*********2*********3*********4*********5*********6*********7**
! SUNPO            00/00/00            0000.0    PGMR - ?
!
! FUNCTION:  GET TRUE OF DATE SUN POSITION & TRUE OBLIQUITY
!            AND ROTATE OBSERVATION COORDINATE SYSTEM TO
!            TRUE OF DATE.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSEC   I         INTEGER ET SECONDS SINCE GEODYN REF. TIME
!   FSEC     I         FRACTIONAL REMAINING SECONDS
!   SUNXYZ   O         TRUE OF DATE SUN POSITION
!   XYZLUN   O         TRUE OF DATE MOON POSITION
!   TOBLQ    O         TRUE OBLIQUITY
!   XYZIN    I         COORDINATES TO BE ROTATED
!   XYZOUT   O         ROTATED COORDINATES
!   PROT     O         ROTATION MATRIX FOR MEAS PARTIALS (WRT XYZ)
!                      THIS IS THE TANSPOSE OF THE MATRX USED FOR
!                      DATA IN XYZ
!   LNAABR   I         .TRUE. INDICATES SUN POS. AND
!                      OBLIQUITY NOT REQUIRED
!   LTRUED   I         .TRUE. INDICATES DATA REQUIRES NO ROTATION
!                      AND NO ROT MATRIX NEEDS TO BE LOADED
!   LNPREC   I         .TRUE. INDICATES PRECESSION NOT REQUIRED IN
!                      DATA ROTATION (REF FOR DATA IS
!                      MEAN OF DATE)
!   L50EQT   I         .TRUE. INDICATES 1950 REFERENCE FOR DATA
!                      INSTEAD OF 2000 OR MEAN OF DATE
!   LMATRX   I         .TRUE. INDICATES A ROTATION MATRIX FOR
!                      MEAS PARTIALS WILL BE FILLED AND NO DATA
!                      ROTATION IS TO BE DONE IN THIS ROUTINE
!   AA            A
!
! COMMENTS:
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      COMMON/CBDSTA/BDSTAT(7,999),XBDSTA
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CRDDIM/NDCRD2,NDCRD3,NDCRD4,NDCRD5,NDCRD6,NDCRD7,          &
     &              NDCRD8,NDCRD9,NXCRDM
      COMMON/CRM5OE/RM5OE(9)
      COMMON/EPHMPT/NTOT,NTOTS,NNPDPR,NUTORD,IBODDG(8),IGRPDG(4),       &
     &              NENPD,INRCD(2),KPLAN(11),NINEP,NEPHMR,NEPHEM,       &
     &              IBHINT,NINTBH,NXEPHP
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/PLNETI/IPLNET(999),IPLNIN(999),MPLNGD(999),MPLNGO(999),   &
     &              IPLNZ(999),NXPLNI
!
      DIMENSION SUNXYZ(3),XYZLUN(3),FSECS(1),AA(1)
      DIMENSION PROT(9),RTEMP(9),R50200(9),XYZIN(3),XYZOUT(3)
      DIMENSION II(1)
      DIMENSION DUM(3),DUM2(3,2,1)
!
! (APPROX) ROTATION MEAN OF 50 TO MEAN OF 2000 GIVEN BY BIH CIRULAR 163
! "ERRORS OF UP TO 1 ARC SECOND"
      DATA R50200/+.9999257080D0,+.0111789381D0,+.0048590038D0,         &
     &            -.0111789381D0,+.9999375133D0,-.0000271579D0,         &
     &            -.0048590038D0,-.0000271626D0,+.9999881946D0/
      DATA ZERO/0.D0/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
!
      IF(LNAABR.AND.LTRUED) RETURN
!  GET SUN POSITION
      IF(.NOT.LNAABR) CALL PLANPO(MJDSEC,FSEC,.FALSE.,.FALSE.,AA,II)
!  GET TRUE OBLIQUITY AND UPDATE MATRIX FROM MEAN 50 TO EPOCH
      IF(LNAABR.AND.LNPREC) GO TO 200
      FSECS(1)=FSEC
      CALL PRECSS(MJDSEC,FSECS,AA(KETA),AA(KZTA),AA(KTHTA),             &
     &   AA(KSRTCH),1)
      CALL NUVECT(MJDSEC,FSECS,AA(KDPSI),AA(KEPST),AA(KEPSM),1,         &
     &   AA(KSRTCH))
      TOBLQ=AA(KEPST)
      CALL NPVECT(MJDSEC,FSECS,AA(KDPSI),AA(KEPST),AA(KEPSM),AA(KETA),  &
     &   AA(KTHTA),AA(KZTA),1,AA(KSRTCH),AA(KROTMT),AA(KEQN),           &
     &   NDCRD2,.FALSE.,                                                &
     &   AA(KPDPSI),AA(KPEPST),AA(KNUTIN),AA(KNUTMD),.FALSE.,           &
     &   AA(KDXDNU),AA(KDPSIE),AA(KEPSTE),DUM,DUM2)
!   UPDATE  TO TRUE OF DATE FROM MEAN OF EPHEMERIS REFERENCE
      IF(LNAABR) GO TO 75
! IN INTERPLANTARY CASE TRANSLATE CIG COORDINATES OF MOON & SUN
! TO TRACKING BODY COORDINATES
      IF(ICBDGM.EQ.ITBDGM) GO TO 70
      IXPTK=IPLNIN(ITBDGM)
      DO 50 J=1,3
      BDSTAT(J,11)=BDSTAT(J,11)-BDSTAT(J,IXPTK)
      BDSTAT(J,8)=BDSTAT(J,8)-BDSTAT(J,IXPTK)
   50 END DO
   70 CONTINUE
      SUNXYZ(1)=AA(KROTMT       )*BDSTAT(1,8)                           &
     &         +AA(KROTMT+NDCRD4)*BDSTAT(2,8)                           &
     &         +AA(KROTMT+NDCRD7)*BDSTAT(3,8)
      SUNXYZ(2)=AA(KROTMT+NDCRD2)*BDSTAT(1,8)                           &
     &         +AA(KROTMT+NDCRD5)*BDSTAT(2,8)                           &
     &         +AA(KROTMT+NDCRD8)*BDSTAT(3,8)
      SUNXYZ(3)=AA(KROTMT+NDCRD3)*BDSTAT(1,8)                           &
     &         +AA(KROTMT+NDCRD6)*BDSTAT(2,8)                           &
     &         +AA(KROTMT+NDCRD9)*BDSTAT(3,8)
      XYZLUN(1)=AA(KROTMT       )*BDSTAT(1,11)                          &
     &         +AA(KROTMT+NDCRD4)*BDSTAT(2,11)                          &
     &         +AA(KROTMT+NDCRD7)*BDSTAT(3,11)
      XYZLUN(2)=AA(KROTMT+NDCRD2)*BDSTAT(1,11)                          &
     &         +AA(KROTMT+NDCRD5)*BDSTAT(2,11)                          &
     &         +AA(KROTMT+NDCRD8)*BDSTAT(3,11)
      XYZLUN(3)=AA(KROTMT+NDCRD3)*BDSTAT(1,11)                          &
     &         +AA(KROTMT+NDCRD6)*BDSTAT(2,11)                          &
     &         +AA(KROTMT+NDCRD9)*BDSTAT(3,11)
      IF(LTRUED) RETURN
   75 CONTINUE
      IF(LNPREC) GO TO 200
! AT THIS POINT DATA NEEDS TO BE ROTATED (IN OR OUT OF ROUTINE) AND
! THE REFERENCE FOR THE DATA IS MEAN OF 50 OR MEAN OF 2000
!
!
      LXTRAW=(NEPHEM.GE.200.AND.L50EQT).OR.                             &
     &       (NEPHEM.LT.200.AND..NOT.L50EQT)
      IF(LXTRAW) GO TO 100
!
!   REFERENCE OF DATA IS SAME AS THAT OF EPHEMERIS
!       (50-50 OR 2000-2000)
      IF(LMATRX) GO TO 90
! ROTATE DATA
      XYZOUT(1)=AA(KROTMT       )*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD4)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD7)*XYZIN(3)
      XYZOUT(2)=AA(KROTMT+NDCRD2)*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD5)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD8)*XYZIN(3)
      XYZOUT(3)=AA(KROTMT+NDCRD3)*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD6)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD9)*XYZIN(3)
      RETURN
   90 CONTINUE
!
! FILL MATRIX TO ROTATE PARTIALS WRT XYZ   (NOT XYZ  DATA)
!
      PROT(1)=AA(KROTMT       )
      PROT(2)=AA(KROTMT+NDCRD4)
      PROT(3)=AA(KROTMT+NDCRD7)
      PROT(4)=AA(KROTMT+NDCRD2)
      PROT(5)=AA(KROTMT+NDCRD5)
      PROT(6)=AA(KROTMT+NDCRD8)
      PROT(7)=AA(KROTMT+NDCRD3)
      PROT(8)=AA(KROTMT+NDCRD6)
      PROT(9)=AA(KROTMT+NDCRD9)
      RETURN
  100 CONTINUE
!
!  DATA IS IN DIFFERENT REF THAN EPHEMERIS (50-2000 OR 2000-50)
!  THIS REQUIRES AN EXTRA STEP
!  WILL NEED TO GO FROM MEAN 2000 TO MEAN 50 OR OTHER WAY AROUND
!
      IF(L50EQT) GO TO 110
!
!  DATA IS IN 2000 EPHEMERIS IS IN 50
!  PREMULT THE MATRIX TO GO FROM 50 TO TRUE OF DATE  BY THE MATRIX
!  TO GO FROM 2000 TO 50
!
      RTEMP(1)=AA(KROTMT       )*R50200(1)+AA(KROTMT+NDCRD4)*R50200(4)  &
     &        +AA(KROTMT+NDCRD7)*R50200(7)
      RTEMP(2)=AA(KROTMT+NDCRD2)*R50200(1)+AA(KROTMT+NDCRD5)*R50200(4)  &
     &        +AA(KROTMT+NDCRD8)*R50200(7)
      RTEMP(3)=AA(KROTMT+NDCRD3)*R50200(1)+AA(KROTMT+NDCRD6)*R50200(4)  &
     &        +AA(KROTMT+NDCRD9)*R50200(7)
      RTEMP(4)=AA(KROTMT       )*R50200(2)+AA(KROTMT+NDCRD4)*R50200(5)  &
     &        +AA(KROTMT+NDCRD7)*R50200(8)
      RTEMP(5)=AA(KROTMT+NDCRD2)*R50200(2)+AA(KROTMT+NDCRD5)*R50200(5)  &
     &        +AA(KROTMT+NDCRD8)*R50200(8)
      RTEMP(6)=AA(KROTMT+NDCRD3)*R50200(2)+AA(KROTMT+NDCRD6)*R50200(5)  &
     &        +AA(KROTMT+NDCRD9)*R50200(8)
      RTEMP(7)=AA(KROTMT       )*R50200(3)+AA(KROTMT+NDCRD4)*R50200(6)  &
     &        +AA(KROTMT+NDCRD7)*R50200(9)
      RTEMP(8)=AA(KROTMT+NDCRD2)*R50200(3)+AA(KROTMT+NDCRD5)*R50200(6)  &
     &        +AA(KROTMT+NDCRD8)*R50200(9)
      RTEMP(9)=AA(KROTMT+NDCRD3)*R50200(3)+AA(KROTMT+NDCRD6)*R50200(6)  &
     &        +AA(KROTMT+NDCRD9)*R50200(9)
  110 CONTINUE
!
!  DATA IS IN 50 EPHEMERIS IS IN 2000
!  PREMULT THE MATRIX TO GO FROM 50 TO TRUE OF DATE  BY THE MATRIX
!  TO GO FROM 50  TO 2000
!
      RTEMP(1)=AA(KROTMT       )*R50200(1)+AA(KROTMT+NDCRD4)*R50200(2)  &
     &        +AA(KROTMT+NDCRD7)*R50200(3)
      RTEMP(2)=AA(KROTMT+NDCRD2)*R50200(1)+AA(KROTMT+NDCRD5)*R50200(2)  &
     &        +AA(KROTMT+NDCRD8)*R50200(3)
      RTEMP(3)=AA(KROTMT+NDCRD3)*R50200(1)+AA(KROTMT+NDCRD6)*R50200(2)  &
     &        +AA(KROTMT+NDCRD9)*R50200(3)
      RTEMP(4)=AA(KROTMT       )*R50200(4)+AA(KROTMT+NDCRD4)*R50200(5)  &
     &        +AA(KROTMT+NDCRD7)*R50200(6)
      RTEMP(5)=AA(KROTMT+NDCRD2)*R50200(4)+AA(KROTMT+NDCRD5)*R50200(5)  &
     &        +AA(KROTMT+NDCRD8)*R50200(6)
      RTEMP(6)=AA(KROTMT+NDCRD3)*R50200(4)+AA(KROTMT+NDCRD6)*R50200(5)  &
     &        +AA(KROTMT+NDCRD9)*R50200(6)
      RTEMP(7)=AA(KROTMT       )*R50200(7)+AA(KROTMT+NDCRD4)*R50200(8)  &
     &        +AA(KROTMT+NDCRD7)*R50200(9)
      RTEMP(8)=AA(KROTMT+NDCRD2)*R50200(7)+AA(KROTMT+NDCRD5)*R50200(8)  &
     &        +AA(KROTMT+NDCRD8)*R50200(9)
      RTEMP(9)=AA(KROTMT+NDCRD3)*R50200(7)+AA(KROTMT+NDCRD6)*R50200(8)  &
     &        +AA(KROTMT+NDCRD9)*R50200(9)
      IF(LMATRX) GO TO 130
! ROTATE THE DATA
      XYZOUT(1)=RTEMP(1)*XYZIN(1)+RTEMP(4)*XYZIN(2)+RTEMP(7)*XYZIN(3)
      XYZOUT(2)=RTEMP(2)*XYZIN(1)+RTEMP(5)*XYZIN(2)+RTEMP(8)*XYZIN(3)
      XYZOUT(3)=RTEMP(3)*XYZIN(1)+RTEMP(6)*XYZIN(2)+RTEMP(9)*XYZIN(3)
      RETURN
  130 CONTINUE
!
! FILL MATRIX TO ROTATE PARTIALS WRT XYZ   (NOT XYZ  DATA)
!
      PROT(1)=RTEMP(1)
      PROT(2)=RTEMP(4)
      PROT(3)=RTEMP(7)
      PROT(4)=RTEMP(2)
      PROT(5)=RTEMP(5)
      PROT(6)=RTEMP(8)
      PROT(7)=RTEMP(3)
      PROT(8)=RTEMP(6)
      PROT(9)=RTEMP(9)
      RETURN
  200 CONTINUE
!
! REFERENCE IS MEAN OF DATE JUST NEED NUTATION
!
      FSECS(1)=FSEC
      AA(KETA)=ZERO
      AA(KZTA)=ZERO
      AA(KTHTA)=ZERO
      CALL NUVECT(MJDSEC,FSECS,AA(KDPSI),AA(KEPST),AA(KEPSM),1,         &
     &   AA(KSRTCH))
      CALL NPVECT(MJDSEC,FSECS,AA(KDPSI),AA(KEPST),AA(KEPSM),AA(KETA),  &
     &   AA(KTHTA),AA(KZTA),1,AA(KSRTCH),AA(KROTMT),AA(KEQN),           &
     &   NDCRD2,.FALSE.,                                                &
     &   AA(KPDPSI),AA(KPEPST),AA(KNUTIN),AA(KNUTMD),.FALSE.,           &
     &            AA(KDXDNU),AA(KDPSIE),AA(KEPSTE),DUM,DUM2)
      IF(LMATRX) GO TO 230
! ROTATE DATA AND RETURN
      XYZOUT(1)=AA(KROTMT       )*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD4)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD7)*XYZIN(3)
      XYZOUT(2)=AA(KROTMT+NDCRD2)*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD5)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD8)*XYZIN(3)
      XYZOUT(3)=AA(KROTMT+NDCRD3)*XYZIN(1)                              &
     &         +AA(KROTMT+NDCRD6)*XYZIN(2)                              &
     &         +AA(KROTMT+NDCRD9)*XYZIN(3)
      RETURN
  230 CONTINUE
! FILL MATRIX TO ROTATE PARTIALS WRT XYZ   (NOT XYZ  DATA)
      PROT(1)=AA(KROTMT       )
      PROT(2)=AA(KROTMT+NDCRD4)
      PROT(3)=AA(KROTMT+NDCRD7)
      PROT(4)=AA(KROTMT+NDCRD2)
      PROT(5)=AA(KROTMT+NDCRD5)
      PROT(6)=AA(KROTMT+NDCRD8)
      PROT(7)=AA(KROTMT+NDCRD3)
      PROT(8)=AA(KROTMT+NDCRD6)
      PROT(9)=AA(KROTMT+NDCRD9)
      RETURN
      END
