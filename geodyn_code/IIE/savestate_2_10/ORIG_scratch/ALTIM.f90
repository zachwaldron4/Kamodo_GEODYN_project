!$ALTIM
      SUBROUTINE ALTIM(AA,II,LL, FSECN,FSECM,FSECK,OBS,                 &
     &   XSN,VSN,XSM,VSM,XSK,VSK,                                       &
     &   SATLAT,SATLON,SATH,RESID,PMPXI,PMPXG,WORK,TPARTL,              &
     &   GEOIDS,ETIDES,OTIDES,THETAG,COSTHG,SINTHG,ZT,XY2,              &
     &   R,RT,UZ,UZSQ,RDOT,TEMP,C3,PMPA,OBSMET,OCDRYT,OCWETT,           &
     &   OCIONO,OCTPC,XYZCG1,XYZCG2,XYZOFF,SUMCOR,OCEANP,               &
     &   N3,NEQN,IPTFMG,ILNFMG,NFMG,INDSAT,INDSET,INPSAT,               &
     &   LELEVS,SSTS,INDSTA,PARMV,ISATID,ISATOF,FRQOFF,RA,XSCR,VARR,    &
     &   XTRA,FSECNN,UTDT,UNQNDX,RLAND)
!********1*********2*********3*********4*********5*********6*********7**
! ALTIM            83/05/25            8304.0    PGMR - TOM MARTIN
!                  86/06/01            8606.0    PGMR - DAVE ROWLANDS
!                  86/06/24            8606.0    PGMR - TOM MARTIN
!                  89/03/22            8901.0    PGMR - A. MARSHALL
!
! FUNCTION: COMPUTE ALTIMETER HEIGHT MEASUREMENTS.
!           COMPUTATIONS START AT THE FINAL RECEIVED TIME
!           MJDSn+FSECn AND PROCEED BACKWARDS UNTIL THE MODEL
!           IS COMPLETE. IF THE "LIGHT" SWITCH IS .FALSE.
!           SOLUTIONS FOR THE LIGHT TIME ARE PERFORMED.
!           OTHERWISE, THE MEASUREMENT EVENT TIMES ARE
!           CONSIDERED TO BE KNOWN.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   AA      I/O   A
!   II      I/O   A
!   LL      I/O   A
!   FSECN    I         ELAPSED SECONDS FROM MJDSBL OF THE TIMES
!                      ASSOCIATED WITH OBSERVATION TRANSMIT
!   FSECNN  I/O        MODIFIED RECEIVE TIME FOR THE COMPUTED MODEL
!   FSECM   I/O        ELAPSED SECONDS FROM MJDSBL OF THE SURFACE
!                      REFLECTION TIMES OF THE OBSERVATIONS
!   FSECK   I/O        ELAPSED SECONDS FROM MJDSBL OF THE TIMES
!                      ASSOCIATED WITH OBSERVATION TRANSMIT
!   OBS      I         THE OBSERVED S/C ALTITUDE
!   XSM      O         TRUE OF DATE INERT. COORD. OF SATELLITE
!   VSM      O         TRUE OF DATE INERT. VELOCITY OF SATELLITE
!   SATLAT   O         SATELLITE GEODETIC LATITUDES
!   SATLON   O         SATELLITE EAST LONGITUDES
!   SATH     O         SATELLITE HEIGHT ABOVE REF. ELLIPSOID
!   RESID    O         OBSERVED MINUS COMPUTED OBSERVATION
!   PMPXI    O         PARTIAL OF OBS. W.R.T. INERTIAL S/C POS.
!   PMPXG    O         PARTIAL OF OBS. W.R.T. THE GEOID
!   WORK          A    PARTIAL OF OBS. W.R.T. AEG
!   TPARTL   O         PARTIAL OF OBS. W.R.T. TIME
!   GEOIDS  I\O        EARTH GEOID HEIGHTS W.R.T. REF. ELLIPSOID
!   ETIDES  I\O        SOLID EARTH TIDE HEIGHTS
!   OTIDES  I\O        OCEAN TIDE HEIGHTS
!   THETAG   O         VECTOR OF VALUES OF RIGHT ASCENSION OF
!                      GREENWICH
!   COSTHG   O         COSINES OF RIGHT ASCENSION OF GREENWICH
!   SINTHG   O         SINES  OF RIGHT ASCENSION OF GREENWICH
!   ZT            A
!   XY2           A
!   R             A
!   RT            A
!   UZ            A
!   UZSQ          A
!   RDOT          A
!   TEMP          A
!   C3            A
!   PMPA
!   OBSMET
!   OCDRYT
!   OCWETT
!   OCIONO
!   OCTPC
!   XYZCG1
!   XYZCG2
!   XYZOFF
!   SUMCOR
!   OCEANP
!   N3
!   NEQN
!   IPTFMG
!   ILNFMG
!   NFMG
!   INDSAT
!   INDSET
!   INPSAT
!   LELEVS
!   SSTS
!   INDSTA
!   NM       I         NUMBER OF MEASUREMENTS
!   LIGHT    I         .TRUE. IF LIGHT TIMES HAVE BEEN DETERMINED
!   LGPART   I         .TRUE. IF GEOID PARTIALS REQUIRED
!   LGEOID   I         .TRUE. IF GEOID EVALUATION REQUIRED
!   LETIDE   I         .TRUE. IF SOLID TIDE EVALUATION REQUIRED
!   LOTIDE   I         .TRUE. IF OCEAN TIDE EVALUATION REQUIRED
!
!                      RECEIVED TIME OF THE FIRST OBSERVATION IN
!                      THE BLOCK
!   XSCR     I/O   A   SCRATCH ARRAY FOR CROSSOVERS
!   UNQNDX   I     A   INDEXNO FOR ALTIMETRY OBSERVATOION
!   RLAND    I     A   FLAG FOR WHETHER ALTIMETRY IS OVER LAND OR OCEAN
!                      (0=>DON'T KNOW ;1=>LAND; 2=>OCEAN)
!
! COMMENTS:
!
!********1*********2*********3*********4*********5*********6*********7**

      USE MSSGFC_MOD

      IMPLICIT DOUBLE PRECISION (A-H,O-Z), LOGICAL (L)
      SAVE
!
      COMMON/CALTOP/LADYNO,LAGEOO,LRGEOT,LRETDT,LROTDT,LRSSTT,LCOTRM,   &
     &              LFILOT,LATCOR,LFIRIT,LX1ALT,LX2ALT,LMSSWG,LATMOD,   &
     &              LG1BOT,LG1B,LONEG1,LXATTD,LXBEAM,NXALTO
      COMMON/CBINRL/LBINR,LLOCR,LODR,LBNCR,LBINRI,LLOCRI,LODRI,LBNCRI,  &
     &              NXCBIN
      COMMON/CBLOKA/FSECBL,SIGNL ,VLITEC,SECEND,BLKDAT(6,4),DOPSCL(5,4)
      COMMON/CBLOKI/MJDSBL,MTYPE ,NM    ,JSTATS,NPSEG ,JSATNO(3),ITSYS ,&
     &       NHEADB,NELEVS,ISTAEL(12),INDELV(3,4),JSTANO(3),ITARNO,     &
     &       KTARNO
      COMMON/CBLOKL/LIGHT ,LNRATE,LNREFR,LPOLAD,LTDRIV,LNANT ,LNTRAK,   &
     &       LASER ,LGPART,LGEOID,LETIDE,LOTIDE,LNTIME,LAVGRR,LRANGE,   &
     &       LSSTMD,LSSTAJ,LNTDRS,LPSBL,LACC,LAPP,LTARG,LTIEOU,LEOTRM,  &
     &       LSURFM,LGEOI2,LSSTM2,LOTID2,LOTRM2,LETID2,LNUTAD
      COMMON/CEARTH/AEG,AEGSQ,FGINV,FG,EGSQ,EGSQP1,C1,C2,FOURC1,TWOC2,  &
     &              XH2,XL2,WREF,RMEAN,REFC20,REFC40,REFC60,BEG,CBLTC,  &
     &              WAE2,GAMMAA,FSTAR,F4
      COMMON/CEBODY/APL(11),APLSQ,FINVPL(11),FGP,EGSQP,EGSQPP,C1P,C2P,  &
     &              FOURCP,TWOC2P,WREFP(11),RPMEAN,RFPC20,              &
     &              RFPC40,RFPC60,BEGP,CBLTCP,                          &
     &              WAE2P,GAMMAP,FSTARP,F4P
      COMMON/CEGREL/LGRELE,LRLCLK,LGRELR,LXPCLK,LBPCLK,NXEGRL
      COMMON/CESTIM/MPARM,MAPARM,MAXDIM,MAXFMG,ICLINK,IPROCS,NXCEST
      COMMON/CESTML/LNPNM ,NXCSTL
      COMMON/CIOTMD/NOTPT,NOTPRF,NODEG,NXCIOT
      COMMON/CIOCON/NUMCON(15),NESCON(15),NUMIND,NXCON
      COMMON/CISSTM/NSSTPT,NSSTF,NSDEG,NXCISS
      COMMON/CITER /NINNER,NARC,NGLOBL
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CLIGHT/VLIGHT,ERRLIM,XCLITE
      COMMON/CLSSOT/LSSTMO,LOTMOD,LPRDES,NXLSST
      COMMON/CMET/P0,T0,RELHUM,E0,WAVLEN
      COMMON/CNIARC/NSATA,NSATG,NSETA,NEQNG,NMORDR,NMORDV,NSORDR,       &
     &              NSORDV,NSUMX,NXDDOT,NSUMPX,NPXDDT,NXBACK,NXI,       &
     &              NXILIM,NPXPF,NINTIM,NSATOB,NXBCKP,NXTIMB,           &
     &              NOBSBK,NXTPMS,NXCNIA
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/COBLOC/KXMN  (3,4)  ,KENVN (3,4)  ,KSTINF(3,4)  ,          &
     &       KOBS  ,KDTIME,KSMCOR,KSMCR2,KTMCOR,KOBTIM,KOBSIG,KOBSG2,   &
     &       KIAUNO,KOBCOR(9,7)  ,KFSECS(6,8)  ,KOBSUM(8)    ,          &
     &       KEDSIG,KEDSG2
      COMMON/COFFST/JXYZOF(2),JSADLY(2),JSTDLY(2),JXYZCG(2,2),          &
     &              MJDFCG(2,2),JXYOF2(2),JEXTOF(2),JXYOF3(2)
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA05/KOBTYP,KDSCRP,KGMEAN,KGLRMS,KWGMEA,KWGRMS,KTYMEA,   &
     &       KTYRMS,KWTMTY,KWTYRM,KTMEAN,KTRMS ,KWMEAN,KWTRMS,KWTRND,   &
     &       KPRVRT,KEBSTT,KVLOPT,NXCA05
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI03/KICRD ,KICON ,KISTNO,KINDPI,KMJDPL,KIPOLC,          &
     &              KNDOLA,KIOLPA,KKIOLA,KIP0OL,KNDOLM,KIOLPM,          &
     &              KKIOLM,KIPVOL,KICNL2,KICNH2,                        &
     &              KSTMJD, KNUMST, KITAST, KSTNRD, KICNV,              &
     &              KTIDES,KFODEG,KFOORD,KRDEGR,KRORDR,                 &
     &              KPHINC,KDOODS,KOTFLG,KJDN  ,KPTDN ,                 &
     &              KATIND,KPRESP,KMP2RS,KSITE,KPTOLS,NXCI03
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORI06/KPTRAU,KPTRUA,KNFMG ,KIPTFM,KILNFM,KIGPC ,          &
     &              KIGPS ,KIGPCA,KIGPSA,KIELMT,KMFMG ,KTPGPC,          &
     &              KTPGPS,KTPUC ,KTPUS,                                &
     &              KLINK,KPTFAU,KPTFUA,NXCI06
      COMMON/CORL01/KLORBT,KLORBV,KLNDRG,KLBAKW,KLSETS,KLAFRC,KLSTSN,   &
     &              KLSNLT,KLAJDP,KLAJSP,KLAJGP,KLTPAT,KEALQT,KLRDGA,   &
     &              KLRDDR,KLRDSR,KFHIRT,KLSURF,KHRFON,KLTPXH,KSETDN,   &
     &              KTALTA,NXCL01
      COMMON/CORL02/KLNDTT,KLWSTR,KLNDTR,KLEVMF,KLTPMS,NXCL02
      COMMON/CORL04/KLEDIT,KLBEDT,KLEDT1,KLEDT2,KNSCID,KEXTOF,KLSDAT,   &
     &              KLRDED,KLAVOI,KLFEDT,KLANTC,NXCL04
      COMMON/CPMPA /KTMPAR(3)    ,KMBPAR(2)    ,KRFPAR(2)    ,          &
     &              KAEPAR,KFEPAR,KFPPAR,KVLPAR,KETPAR(2,2)  ,          &
     &              KPMPAR,KUTPAR,KSTPAR(3,4)  ,NADJST       ,          &
     &              NDIM1 ,NDIM2 ,NXDIM1,NXDIM2
      COMMON/CPRESW/LPRE9 (24),LPRE  (24,3),LSWTCH(10,8),LOBSIN,LPREPW, &
     &              LFS   (40)
      COMMON/CRELAT/AER(11),GRLFC2(11),GRLFC3(11),SECCOR
      COMMON/CSTA/RLAT,COSLAT,SINLAT,RLON,COSLON,SINLON,HEIGHT,         &
     &   TMOUNT,DISP,WAVREC,WAVXMT,ELCUT,PLATNO,SITNOL,SDTLRA,ANTTNO
      COMMON/CTIDES/NTIDE,NSTADJ,NET,NETADJ,NETUN,NOT,NOTADJ,           &
     &   NOTUN ,NETUNU,NETADU,NOTUNU,NOTADU,NBSTEP,KTIDA(3),            &
     &   ILLMAX,NUNPLY,NNMPLY,NDOODN,MXTMRT,NRESP ,NXCTID
      COMMON/CVIEW /IOUT6 ,ILINE6,IPAGE6,MLINE6,                        &
     &              IOUT8 ,ILINE8,IPAGE8,MLINE8,                        &
     &              IOUT9 ,ILINE9,IPAGE9,MLINE9,                        &
     &              IOUT10,ILIN10,IPAG10,MLIN10,                        &
     &              IOUT15,ILIN15,IPAG15,MLIN15,                        &
     &              IOUT16,ILIN16,IPAG16,MLIN16,                        &
     &              IOUT7 ,NXCVUE
      COMMON/DTMGDN/TGTYMD,TMGDN1,TMGDN2,REPDIF,XTMGN
      COMMON/EXATGI/MEASAT,MEAFIL,MEAMEM,MEAPLA,MEAANT,NXEAGI
      COMMON/EXATGL/LEXATT,NXEAGL
      COMMON/DELOFF/NOFFST,NSATDL,NSTADL,NCGMAS,NXDELO
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988), &
     &              NXEPH2
      COMMON/ION2EL/LIONC,LFRQOP,LFRQOF,NXIONL
      COMMON/IONO2E/IONNDX(12),IONRZ(12),IONOYM(12),IONYMS,IONYME,IURSI,&
     &              INTERP,NXIONO
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/MREFDT/DMESRF,RMESRF,XMREF
      COMMON/PLTOPO/IBDTOP,NXPLTP
      COMMON/SSTCOM/NCBAR, NSBAR ,NCDOT ,NSDOT ,NCAPRD,NCBPRD,NSAPRD,   &
     &              NSBPRD,NCBARA,NSBARA,NCDOTA,NSDOTA,NCAPDA,NCBPDA,   &
     &              NSAPDA,NSBPDA,ISSTEP,NXSST
      COMMON/QQTIDE/IQMAX,IQMIN,IQDIF,NUMFRQ,NBAND
      COMMON/TDELEM/XMEAN(2),XNODE(2),OMEGA(2),A(2),XINCL(2),E(2),      &
     &   EPSLON,RMASS,XLONG,TANPSI,THETG,RHO3,CC(3,3),B(2)
      COMMON/UNITS/IUNT11,IUNT12,IUNT13,IUNT19,IUNT30,IUNT71,IUNT72,    &
     &             IUNT73,IUNT05,IUNT14,IUNT65,IUNT88,IUNT21,IUNT22,    &
     &             IUNT23,IUNT24,IUNT25,IUNT26
      COMMON/VMATFL/LVMTF,LVMTFO
      COMMON/VRBLOK/SINPSI,COSPSI,XLAMDA,GMR,AOR
      COMMON/XOVER /KXKNT,KXBST,KXOBL,KXBUP,KXBPA,IAPLSC,IAPLL
      COMMON/XOVERS/NRXTOT,NXBLK,NUSIDE,NDEGX2,NDEGXX,NUCON,ITERNU,     &
     &              IPEDIT,IDEDIT,NXXOVR
      COMMON/IOS/ISTOS1,ISTOS2,ISTOS3,ISTLST,INTSUB(3),JNTSUB(3),      &
     &        ILSTSG(80),INTOSP,MAPSAT(3,4)
!
      DIMENSION FSECN(NM),FSECNN(NM),FSECM(NM),FSECK(NM),OBS(NM),       &
     &   XSN(MINTIM,3),VSN(MINTIM,*),XSM(MINTIM,3),VSM(MINTIM,3),       &
     &   XSK(MINTIM,3),VSK(MINTIM,3),SATLAT(NM),SATLON(NM),SATH(NM),    &
     &   RESID(NM),PMPXI(NM,3),PMPXG(NM,3),WORK(NM),TPARTL(NM),         &
     &   THETAG(NM),COSTHG(NM),SINTHG(NM),                              &
     &   ZT(NM),XY2(NM),R(NM),RT(NM),UZ(NM),UZSQ(NM),                   &
     &   TEMP(NM),RDOT(NM),C3(NM),GEOIDS(NM),OTIDES(NM),ETIDES(NM),     &
     &   SSTS(NM),AA(1),II(1),LL(1)
      DIMENSION PARMV(1)
      DIMENSION INDSTA(3,4),INPSAT(3,4)
      DIMENSION N3(MSETA),NEQN(MSETA),IPTFMG(MAXFMG,MSATA),             &
     &   ILNFMG(MAXFMG,MSATA),NFMG(MSATA),SUMCOR(NM),OCEANP(NM),        &
     &   OBSMET(NM),OCDRYT(NM),OCWETT(NM),OCIONO(NM),OCTPC(NM)
      DIMENSION XYZCG1(3),XYZCG2(3),XYZOFF(3),OFFSET(3,2)
      DIMENSION PMPA(NDIM1,NDIM2),INDSAT(1),INDSET(1),LELEVS(1)
      DIMENSION CIN(3),XYZECF(3,1),X1(3),X2(3),RA(NM,3)
      DIMENSION ISATOF(NOFFST),FRQOFF(NOFFST)
      DIMENSION XSCR(20,MINTIM),VARR(MINTIM)
      DIMENSION XTRA(MINTIM,33)
      DIMENSION UTDT(NM,4)
      DIMENSION UNQNDX(NM),RLAND(NM)
      DIMENSION DUM(3),DUM1(3,2,1)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      DIMENSION XQ(100000)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
      DATA ZERO/0.0D0/,ONE/1.0D0/,DNINTY/90.0D0/,HALF/.5D0/
      DATA LSIMND/.FALSE./
!  GRLFC2 IS 2*GM/(C**2)   ; AER IS 1/6372000  (ONE OVER MEAN EARTH
!  RADIUS)
!     DATA GRLFC2/.8870056D-2/,AER/.156937D-6/ NOW IN CB CRELAT
!
      DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE :: ZEROV
      LOGICAL, DIMENSION(:), ALLOCATABLE :: LEDIT_EXTRA
!**********************************************************************
!* START OF EXECUTABLE CODE *******************************************
!**********************************************************************
!
!      print *,''
!      print *,'altim: NM,MAPARM,NDIM1,NDIM2: ',NM,MAPARM,NDIM1,NDIM2
!      print *,''
!
! NOTE: TO DISTINGUISH BETWEEN OCEAN AND LAND DATA CHECK BLKDAT(1,2)
! BLKDAT(1,2)=0.0 DENOTES OCEAN DATA
! BLKDAT(1,2)=1.0 DENOTES LAND  DATA

       ALLOCATE(LEDIT_EXTRA(NM))
       LEDIT_EXTRA(:) = .FALSE.

       LDIRALT = .FALSE. ! SET TO TRUE WHEN DIRALT IS CALLED
!
!      INITIALIZE THE LAND AND OCEAN FLAGS:
       LAND=.FALSE.
       LOCEAN=.FALSE.
       IF(BLKDAT(1,2).EQ.1.D0) THEN
       LAND=.TRUE.
       ELSE
       LOCEAN=.TRUE.
       ENDIF

      IF(NINTOT.GT.0) THEN
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF

!  SET FSECNN TO RECEIVE TIME
!  ASSUMES FSECN IS TRANSMIT

      DO I=1,NM
       FSECNN(I)=FSECN(I)+2.0D0*ABS(OBS(I))/VLIGHT
      ENDDO
!
      LDIOUT=.FALSE.
      LXGOUT=.FALSE.
      LDIOUT=LFILOT.AND.LATMOD.AND.LSTINR
      LXGOUT=LFILOT.AND.LX2ALT.AND.LSTINR
!      LALTMD=LFILOT.OR.LX2ALT
      LALTMD=LX2ALT
!      print *,'altim: begin '
!      print *,'altim: lx2alt,lnadj: ',lx2alt,lnadj
!      print *,'altim: ldiout,lxgout,laltmd: ',ldiout,lxgout,laltmd
!      print *,'altim: lfilot,latmod,lstinr: ',lfilot,latmod,lstinr
!  INITIALIZE SCRATCH ARRAY FOR CROSSOVERS 2
      IF(LX2ALT) THEN
      DO 100 I=1,MINTIM
      DO 100 J=1,20
      XSCR(J,I)=0.D0
  100 CONTINUE
      ENDIF
!
      DO JJ=1,MINTIM
      VARR(JJ)=0.D0
      ENDDO
!  write out the LOCATION DATA HEADER RECORD for binary file of altemetr
!  (mtype=99)
!
!      print *,'altim: call to althd'
      IF(LLOCRI)CALL ALTHD
!
!     write(6,*)' dbg  # of ocean tide mod grid points ',notpt
!     write(6,*)' dbg  # of ocean tide mod Pr functions ',notprf
!     write(6,*)' dbg  # of sst  mod grid points ',nsstpt
!     write(6,*)' dbg  # of sst  mod   functions ',nsstf
!     write(6,*)'dbg enterind ALTIM',NPVAL(IXSSTF),NPVAL0(IXSSTF)
!     do 911 i=1,npval(ixsstf)
!     write(6,*)'dbg ALTIM',PARMV(IPVAL(IXSSTF)+i-1)
!911   continue
!     do 912 i=1,npval(ixotpc)
!     write(6,*)'p',PARMV(IPVAL(IXOTPC)+i-1)
!912   continue
!     do 913 i=1,npval(ixotps)
!     write(6,*)'p',PARMV(IPVAL(IXOTPS)+i-1)
!913   continue
!
      KTRJX=KXTKP+3*MINTIM
      KTRJV=KVTKP+3*MINTIM
      ISET=INDSET(1)
      ISAT=INDSAT(1)
      LELEVS(1)=.TRUE.
      INELEV=KELEVS
!     INITIALIZE  LL(KLSDAT) ARRAY FOR NEW SEA SURFACE TOPOGRAPHY MODEL
      DO 200 N=1,NM
      AA(INELEV)=DNINTY
      INELEV=INELEV+1
      LL(KLSDAT+N-1)=.TRUE.
  200 END DO
!
      IF(LNADJ) GO TO 400
! CLEAR PARTIAL DERIVATIVE ARRAY
      NCLEAR=NM*NADJST
      CALL CLEARA(PMPA,NCLEAR)
  400 CONTINUE
!
! CALCULATE GROUND BOUNCE
!
      DO N=1,NM
       FSECM(N)=FSECNN(N)-ABS(OBS(N))/VLIGHT
      ENDDO
!      print *,'altim: obs(1): ',obs(1)
!      print *,'altim: fsecn(1): ',fsecn(1)
!      print *,'altim: mjdsbl: ',mjdsbl
!
! PLEASE NOTE THAT FOR ALTIMETRY THE MEASUREMENT IS TIME TAGGED
! AT GROUND BOUNCE TIME.  WE EVALUATE AND PRINT OUT SATELLITE POSITION
! AT GROUND BOUNCE TIME, WHICH IS ACTUALLY INCORRECT SINCE IT SHOULD
! BE EVALUATED AT SATELLITE RECEIVE TIME.  HOWEVER, THE ALTIMETRY
! MEASUREMENT MODEL DOES NOT ALLOW PROPER FORMULATION IN ITS
! PRESENT FORM.
! OBTAIN SATELLITE POSITION
!     IF(LALTMD.OR.LDIOUT) THEN
       IF(LALTMD) THEN
! THIS SUBROUTINE CALLED FOR HANGING GEOLOCATION  AND CROSSOVERS
!      print *,'altim: call to ltalto'
         CALL LTALTO(AA,II,LL,LNADJ,MJDSBL,FSECNN,FSECM,FSECK,NM,MTYPE, &
     &               ISAT,ISET,OBS,XSN,XSM,XSK,VSN,VSK,AA(KXSJ),THETAG, &
     &               COSTHG,SINTHG,OBSMET,OCDRYT,OCWETT,OCIONO,         &
     &               OTIDES,XSCR,LNPNM,LDIOUT,LXGOUT,AA(KPMATT),        &
     &               AA(KXHOLD),SSTS,AA(KXRNDX),SATLAT,SATLON,SATH,     &
     &               XY2,ZT,RT,RA,XTRA,AA(KATROT),UTDT,UNQNDX,ETIDES,   &
     &               ISATID,RLAND)
! DEP XSN IS S/C TOD INERTIAL AT ALTIM RECEIVE
! DEP  XSM HERE IS TOR BOUNCE POINT
! DEP VSN (10,11,12) HERE IS EF BOUNCE POINT
! SAVE BELOW FOR CROSSOVERS
!      print *,'altim: after ltalto'
!      print *,'altim: lx2alt: ',lx2alt
         IF(LX2ALT) THEN
         DO 409 I=1,NM
         XSCR(18,I)=XTRA(I,10)
         XSCR(19,I)=XTRA(I,11)
         XSCR(20,I)=XTRA(I,12)
  409  CONTINUE
!      print *,'altim: goto 49000 '
         GOTO 49000
         ENDIF
! CODE BELOW FOR HANGING GEOLOCATION
         IF(LFILOT) THEN
!      print *,'altim: inside lfilot if'
!      print *,'altim: setting resid to zero'
         DO 410 I=1,NM
         RESID(I)=0.D0
         AA(KOBSC-1+I)=OBS(I)
  410    CONTINUE
!      print *,'altim: being sent to 90000'
         GO TO 90000
         ELSE
! CALL ORBIT FOR CROSSOVERS TO RE-DEFINE XSM NEEDED FOR COMPUTATIONS
! LNADJ IS TRUE IN ORDER TO COMPUTE FORCE MODEL PARTIALS
!      print *,'altim: call to orbset orbit 1'
      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),ISAT,                 &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSBL,FSECM(1),      &
     &   FSECM(NM),NM,AA,II)
      CALL ORBIT(MJDSBL,FSECM,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),  &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSM,AA(KPXPFM),              &
     &   LNADJ,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),                &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)
      CALL SATUPD(MJDSBL,FSECM,XSM,XSM,AA,NM,MINTIM,.TRUE.,             &
     &           .FALSE.,II,0,1)
      CALL SATUPD(MJDSBL,FSECM,VSM,VSM,AA,NM,MINTIM,.FALSE.,            &
     &            .FALSE.,II,0,1)
        ENDIF
      ELSE
!
      IF(LATMOD.OR.LSIMND) THEN
!
! DIRECT ALTIMETRY MEASUREMENT MODELING
!
!...compute transmit time

      DO N=1,NM
       FSECK(N)=FSECNN(N)-2.D0*ABS(OBS(N))/VLIGHT
      ENDDO

!         write(6,*)'CALLING DIRALT '
      LDIRALT = .TRUE.
      IF(LSIMND) THEN
      CALL DIRALT(AA,II,LL,FSECNN,FSECM,FSECK,XSK,VSK,XSN,VSN,          &
     &           COSTHG,SINTHG,                                         &
     &           ISATID,ISAT,ISET,AA(KXSJ),PMPA,GEOIDS,SSTS,THETAG,     &
     &           OTIDES,ETIDES,SATH,OBS,OCDRYT,OCWETT,OCIONO,WORK,      &
     &           OCEANP,PMPXI,R,AA(KPMPAT),ZT,UZ,UZSQ,TPARTL,           &
!!!! &           C3,TEMP,XTRA,AA(KATPER),AA(KXHOLD),AA(KOBSC),RESID,    &
     &           C3,TEMP,XQ,AA(KATPER),AA(KXHOLD),AA(KOBSC),RESID,    &
     &           LL(KLAVOI),AA(KATROT),UNQNDX,RLAND,LEDIT_EXTRA)
      ELSE
      CALL DIRALT(AA,II,LL,FSECNN,FSECM,FSECK,XSK,VSK,XSN,VSN,          &
     &           COSTHG,SINTHG,                                         &
     &           ISATID,ISAT,ISET,AA(KXSJ),PMPA,GEOIDS,SSTS,THETAG,     &
     &           OTIDES,ETIDES,SATH,OBS,OCDRYT,OCWETT,OCIONO,WORK,      &
     &           OCEANP,PMPXI,R,AA(KPMPAT),ZT,UZ,UZSQ,TPARTL,           &
     &           C3,TEMP,XTRA,AA(KATPER),AA(KXHOLD),AA(KOBSC),RESID,    &
!!!! &           C3,TEMP,XQ,AA(KATPER),AA(KXHOLD),AA(KOBSC),RESID,    &
     &           LL(KLAVOI),AA(KATROT),UNQNDX,RLAND,LEDIT_EXTRA)
      ENDIF


! SKIP ALL THE CORRECTIONS FOR THE NEW ALTIMETER MODELING
      GOTO 49000
      ELSE
!
! SKIP  ORBIT IF DIRALT HAS BEEN CALLED
!      print *,'altim: call to orbset and orbit 2'
      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),ISAT,                 &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSBL,FSECM(1),      &
     &   FSECM(NM),NM,AA,II)
!
      CALL ORBIT(MJDSBL,FSECM,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),  &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSM,AA(KPXPFM),              &
     &   LNADJ,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),                &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)
      CALL SATUPD(MJDSBL,FSECM,XSM,XSM,AA,NM,MINTIM,.TRUE.,             &
     &           .FALSE.,II,0,1)
      CALL SATUPD(MJDSBL,FSECM,VSM,VSM,AA,NM,MINTIM,.FALSE.,            &
     &            .FALSE.,II,0,1)
      ENDIF
      ENDIF
! COMPUTE COSINES AND SINES OF RIGHT ASCENSION OF GREENWICH ACROSS
!         ENTIRE BLOCK OF DATA
      IF(ICBDGM.EQ.3) THEN
!     ....LEQN switch in GRHRAN changed to .TRUE. to calculate
!     ....equation of equinoxes at each point -- jjm 2/5/91
!LST  CALL GRHRAN(MJDSBL,FSECM,.TRUE.,.FALSE.,AA(KEQN),AA(KSRTCH),
      CALL GRHRAN(MJDSBL,FSECM,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),      &
     &   THETAG,COSTHG,SINTHG,NM,AA,II,UTDT(1,1),.FALSE.,DUM,DUM1)
      ELSE
      CALL ROTXTR(MJDSBL,FSECM,.TRUE.,AA(KEQN),AA(KSRTCH),              &
     &   THETAG,COSTHG,SINTHG,NM,AA,AA(KACOSW),AA(KBSINW),AA(KANGWT),   &
     &   AA(KWT),AA(KACOFW),AA(KBCOFW),II,1)
      ENDIF
! COMPUTE GEODETIC SATELLITE COORDINATES
      CALL SUBTRK(XSM,THETAG,XY2,ZT,RT,SATLAT,SATLON,SATH,NM)
!
!  WRITE OUT THE SATELLITE DATA RECORD FOR ALTEMERY RUN
!
       IF(LLOCRI)WRITE(IUNT19)(FSECN(JP),JP=1,NM),                      &
     &                   (XSM(JP,1),JP=1,NM),                           &
     &                   (XSM(JP,2),JP=1,NM),                           &
     &                   (XSM(JP,3),JP=1,NM),                           &
     &                   (VSM(JP,1),JP=1,NM),                           &
     &                   (VSM(JP,2),JP=1,NM),                           &
     &                   (VSM(JP,3),JP=1,NM)
! PRINT TRAJECTORY
      IF(LOBORB) CALL TRAJCT(AA(KA1UT),MJDSBL,FSECM,XSM,VSM,            &
     &   SATLAT,SATLON,SATH,II(KINDH),II(KNMH),AA(KS),                  &
     &   AA(KCIP  ),NM,INDSAT(1),AA,AA(KCOSTH),AA(KSINTH),AA(KDPSR),    &
     &  AA(KXPUT),AA(KYPUT),II)
      IF(LVMTFO) CALL VMATO(AA(KA1UT),MJDSBL,FSECM,XSM,VSM,             &
     &   AA(KPXPFM),II(KINDH),II(KNMH),AA(KS),AA(KCIP  ),NM,INDSAT(1),  &
     &   II)
!
! METDAT BELOW
      IF(LIONC)LPRE(6,1)=.FALSE.
      IF(LPRE(3,1).AND.LPRE(4,1).AND.LPRE(6,1)) GO TO 11800
! COMPUTE GROUND-TO-S/C DRY & WET TROPO REFRACTION AND IONO REFRACTION
      HEIGHT=0.D0
      CALL METDAT(BLKDAT(1,1))
      DO 11100 N=1,NM
      IF(LPRE(1,1)) CALL METDAT(OBSMET(N))
      TINV=ONE/T0
      WORK(N)=TROPRF(0,1,P0,TINV,E0,DUMMY,DUMMY,DUMMY,DUMMY,RESID(N))
11100 END DO
      IF(LPRE(3,1)) GO TO 11300
!.....DRY TROPOSPHERE
      DO 11200 N=1,NM
      OCDRYT(N)=WORK(N)
11200 END DO
11300 CONTINUE
      IF(LPRE(4,1)) GO TO 11500
!.....WET TROPOSPHERE
      DO 11400 N=1,NM
      OCWETT(N)=RESID(N)
11400 END DO
11500 CONTINUE
      IF(LPRE(6,1)) GO TO 80000
!.....IONOSPHERE
      IF(LIONC)THEN
       DO 11510 I=1,NOFFST
          IF(ISATID.EQ.ISATOF(I))THEN
          IF(LFRQOP)FRQLNK=FRQOFF(I)
          ENDIF
11510   CONTINUE
        LOGINT=.FALSE.
        IF(INTERP.EQ.1) LOGINT=.TRUE.
        DO 11520 N=1,NM
          CIN(1)=SATLAT(N)*DEGRAD
          CIN(2)=SATLON(N)*DEGRAD
          CIN(3)=0.D0
          CALL XYZOUT(1,CIN,XYZECF(1,1),AEG,FGINV)
          CALL INERTP(XYZECF,COSTHG(N),SINTHG(N),X2,1,1,1)
          DO 11530 JJ=1,3
            X1(JJ)=XSM(N,JJ)
11530     CONTINUE
! CONVERT POSITIONS FROM TRUE OF REFERENCE TO TRUE OF DATE
          CALL TDORTR(MJDSBL,FSECM(N),X1,X1,AA,1,1,.TRUE.,.FALSE.,II)
          CALL TDORTR(MJDSBL,FSECM(N),X2,X2,AA,1,1,.FALSE.,.FALSE.,II)
          MJDSV=MJDSBL
          TMJDSC=DBLE(MJDSV)+FSECM(N)
          CALL IONRC(AA,TMJDSC,X1,X2,RA(N,3),LOGINT)
11520   CONTINUE
        CFACI=1.D0
        ELCTOM=40.3*CFACI/FRQLNK**2
        DO 11540 N=1,NM
          OCIONO(N)=OCIONO(N)+RA(N,3)*ELCTOM
11540   CONTINUE
      ENDIF
!
80000 CONTINUE
!
11800 CONTINUE
!
      IF(LPRE(2,1)) GO TO 14000
      IF(JXYZOF(1).LE.KFRQOF) GO TO 14000
! COMPUTE S/C C. G. CORRECTION
      SCALE=ZERO
      IF(JXYZCG(1,1).GT.KFRQOF) SCALE=ONE
      OFFSET(3,1)=XYZOFF(3)+XYZCG1(3)*SCALE
      OFFSET(3,2)=XYZOFF(3)+XYZCG2(3)*SCALE
      IF(MJDFCG(2,1).GT.MJDFCG(1,1)) GO TO 13200
      OFFST0=-OFFSET(3,1)
      OFFDOT=ZERO
      GO TO 13500
13200 CONTINUE
      DENOM =MJDFCG(2,1)-MJDFCG(1,1)
      DIFSEC=MJDSBL   -MJDFCG(1,1)
      OFFDOT=(OFFSET(3,1)-OFFSET(3,2))/DENOM
      OFFST0=OFFDOT*DIFSEC-OFFSET(3,1)
13500 CONTINUE
      DO 13600 N=1,NM
      WORK(N)=OFFST0+OFFDOT*FSECM(N)
13600 END DO
      DO 13800 N=1,NM
      OCTPC(N)=WORK(N)
13800 END DO
14000 CONTINUE
! FORM OBSERVATION RESIDUALS
      DO 18000 N=1,NM
      RESID(N)=OBS(N)-SATH(N)
18000 END DO
18500 CONTINUE
          IF(.NOT.LGRELE) GO TO 20000
! DEP VCL
! HOW IS SATH CHANGING BELOW
!  COMPUTE GENERAL RELATIVITY LIGHT TIME CORRECTION
      DO 19000 N=1,NM
      WORK(N)=SATH(N)*AER(ICBDGM)
19000 END DO
      DO 19100 N=1,NM
      R(N)=(ONE-HALF*WORK(N))*WORK(N)
19100 END DO
      DO 19200 N=1,NM
      RESID(N)=RESID(N)-R(N)*GRLFC2(ICBDGM)
19200 END DO
20000 CONTINUE
! COMPUTE DISTANCE FROM EARTH CENTER TO SATELLITE
      DO 20100 N=1,NM
      WORK(N)=XY2(N)**2+XSM(N,3)**2
20100 END DO
      DO 20200 N=1,NM
      R(N)=SQRT(WORK(N))
20200 END DO
!
! DEP VCL
! I THINK THIS NEEDS TO CHANGE TOO
!     write(6,*)' dbg LTRIG ',LTRIG
!   GET SIN & COS OF GEOCENTRIC LATITUDE & LONGITUDE OF SUB SAT POINT
!   IF NECESSARY
          LTRIG=LGEOID.OR.LGPART.OR.LETIDE.OR.LOTIDE.OR.LSSTMD.OR.LSSTAJ
          IF(.NOT.LTRIG) GO TO 22100
!     LONGITUDE FIRST
      DO 21010 N=1,NM
      UZ(N)=XSM(N,1)/XY2(N)
21010 END DO
      DO 21020 N=1,NM
      UZSQ(N)=XSM(N,2)/XY2(N)
21020 END DO
      DO 21030 N=1,NM
      TEMP(N)=UZ(N)*COSTHG(N)+UZSQ(N)*SINTHG(N)
21030 END DO
      DO 21040 N=1,NM
      RDOT(N)=-UZ(N)*SINTHG(N)+UZSQ(N)*COSTHG(N)
21040 END DO
!      LATITUDE
      CALL GDSGCE(ZT,XY2,UZ,UZSQ,WORK,NM)
22100 CONTINUE
!
      IF(MTYPE.GT.100) THEN
      NXDIM1= NRXTOT
      NXDIM2= MAPARM
      IF(LNPNM) NXDIM1 = MAPARM
      IF(LNPNM) NXDIM2 = NRXTOT
      ENDIF
!     NDIM1=NM
!     NDIM2=MAPARM
!     IF(LNPNM) NDIM1=MAPARM
!     IF(LNPNM) NDIM2=NM
! EVALUATE GEOID AND/OR PARTIALS OF GEOID W.R.T. GRAVITY PARAMETERS
!
      LGESKP=.FALSE.
      IDXREP=ICBDGM-11
      IF(IDXREP.LE.0)IDXREP=1
      IF(ICBDGM.EQ.5 .OR. IREPL(IDXREP).EQ.5) THEN
      LGESKP=(LSSTAJ.OR.LSSTMD)
      ENDIF
      IF(LGESKP.OR.LSURFM) GO TO 22250
      IF(LGEOID.OR.LGPART) THEN
         IF(ICBDGM.EQ.3) THEN
          CALL GEOID(NM,UZ,UZSQ,TEMP,RDOT,                              &
     &    AA(KCN),AA(KSN),II(KICNT),II(KISNT),AA(KPN),AA(KCOSLM),       &
     &    AA(KSINLM),AA(KXPRFL),GEOIDS,PMPA,LNPNM,NDIM1,NDIM2,LGEOID,   &
     &    LGPART,AA(KWRK),AA)
         ELSE
          CALL REFGS(NM,UZ,UZSQ,TEMP,RDOT,                              &
     &    AA(KCN),AA(KSN),II(KICNT),II(KISNT),AA(KPN),AA(KCOSLM),       &
     &    AA(KSINLM),AA(KXPRFL),GEOIDS,PMPA,LNPNM,NDIM1,NDIM2,LGEOID,   &
     &    LGPART,AA(KWRK),AA)
         ENDIF
      ENDIF
! SKIP GEOID CORRECTION IF MEAN SEA SURFACE MODEL WAS REQUESTED
      IF(LSURFM) GO TO 22250
! CORRECT RESIDUALS FOR GEOID
      DO 22200 N=1,NM
      RESID(N)=RESID(N)+GEOIDS(N)
22200 END DO
22250 CONTINUE
!
!
! THE CODE BELOW IS SKIPPED IN CASE OF INTERPLANETARY RUNS
!
      IF(IBDTOP.EQ.1)GOTO 22224
         IF(ICBDGM.NE.ITBDGM) GOTO 23600
22224 CONTINUE
!
! EVALUATE SST AND/OR PARTIALS OF SST W.R.T. SST C&S PARAMETERS
      IF(.NOT.LSSTMD.AND..NOT.LSSTAJ.AND..NOT.LSSTMO) GO TO 22275
      IF(LITER1.AND..NOT.LPRE(14,1)) GO TO 22225
! REMOVE SSTS FROM OCEAN PARAMETERS SUMMATION
      DO 22220 N=1,NM
      OCEANP(N)=OCEANP(N)-SSTS(N)
22220 END DO
22225 CONTINUE
! DEP VCL MAYBE WE WANT TO REMOVE THE PROVIDED SST CORRECTION AND THEN U
!         THE GRID MODEL
      IF(LSURFM) GOTO 22260
      IF(.NOT.LACC.AND.LPSBL) GO TO 22260
!
          JCCOS=KSSTWT
          JCSIN=JCCOS+NCAPRD
          JSCOS=JCSIN+NCBPRD
          JSSIN=JSCOS+NSAPRD
      CALL SST(NM,UZ,UZSQ,TEMP,RDOT,                                    &
     &    AA(KSSTCC),AA(KSSTSS),AA(KPN),AA(KCOSLM),                     &
     &    AA(KSINLM),AA(KXPRFL),SSTS,PMPA,LNPNM,NDIM1,NDIM2,            &
     &    AA(KWRK),II(KPTRUA),II(KPTRAU),AA,II,MJDSBL,FSECM,II(KSSTNA), &
     &    AA(JCCOS),AA(JCSIN),AA(JSCOS),AA(JSSIN),XTRA(1,1),.TRUE.,     &
     &    LL(KLAVOI),.TRUE.)
22260 CONTINUE

      IF(.NOT.LMSSWG)GO TO 22265


      IF(LOCEAN.AND.LMSS) THEN
       JJ=1

      DO N=1,NM
      SSTS(N)=0.D0
      GEOIDS(N)=0.D0
      CALL GINTRP(4,5.D0,GRID1,XLATS(JJ),XLONW(JJ),DPHI(JJ),            &
     &  DPHI(JJ),NNL(JJ),NEW(JJ),NNL(JJ),NEW(JJ),                       &
     &  SATLAT(N),SATLON(N),                                            &
     &  SSTS(N))
      ENDDO
      ENDIF
!
!...COMPUTE DEM
!
      IF(LAND.AND.LDEM) THEN
       JJ=2

       DO N=1,NM

      CALL GINTRP(4,5.D0,GRID2,XLATS(JJ),XLONW(JJ),DPHI(JJ),            &
     &  DPHI(JJ),NNL(JJ),NEW(JJ),NNL(JJ),NEW(JJ),                       &
     &  SATLAT(N),SATLON(N),                                            &
     &  SSTS(N))

       END DO

      ENDIF
!      print *,'aldst2: SSTS 1: ',SSTS(1)


22265 CONTINUE

! SKIP SSTS CORRECTION IF MSS MODEL REQUIRED
      IF(LITER1) GO TO 22275
! ADD SST BACK ONTO OCEANP
      DO 22270 N=1,NM
      OCEANP(N)=OCEANP(N)+SSTS(N)
22270 END DO
22275 CONTINUE
!     if(ninner.eq.1)then
!     write(6,*)'ninner,lcotrm,lrotdt',ninner,lcotrm,lrotdt
!     write(6,*)'lotide,lotmod,leotrm',lotide,lotmod,leotrm
!     endif
      IF(.NOT.LOTIDE.AND..NOT.LOTMOD.AND..NOT.LEOTRM) GO TO 22600
      LBOTHN=(.NOT.LPRE(12,1)).AND.(.NOT.LPRE(13,1))
!     write(6,*)'liter1,lbothn',liter1,lbothn
      IF(LITER1.AND.LBOTHN) GO TO 22400
! REMOVE OCEAN TIDES FROM OCEAN PARAMETERS SUMMATION
      DO 22300 N=1,NM
      OCEANP(N)=OCEANP(N)-OTIDES(N)
22300 END DO
22400 CONTINUE
! EVALUATE OCEAN TIDES
!     write(6,*)'ninner,lstinr',ninner,lstinr
      IF(NINNER .NE. 1 .AND. .NOT. LSTINR) GOTO 22450
      IF(LEOTRM) THEN
      IF(LALTMD) GOTO 22460
!  ATTENTION FSECN IS NOT A GOOD CHOICE TO STORE THE UTC SECONDS. IN THE
!  FURURE WE SHOULD USE A SCRATCH ARRAY
      CALL UTCET(.FALSE.,NM,MJDSBL,FSECM,VARR,AA(KA1UT))

        DO 22290 N=1,NM
        TIME=DBLE(MJDSBL)+VARR(N)
        RMJD =(TIME/86400.D0)+TMGDN2

        CALL PERTH2(SATLAT(N),SATLON(N),RMJD,TIDE,LSDATA,.FALSE.)

        IF(LSDATA) THEN
         CALL LPEQMT(RMJD*86400.0D0,SATLAT(N),TIDEL)
         OTIDES(N)=(TIDE+TIDEL)/100.0D0
        ELSE
         OTIDES(N)=-999999.9D0
        ENDIF

22290   CONTINUE

      ELSE IF(LOTIDE) THEN
! CHECK SPACE ALLOCATION IN 2S
        NPTIDE =ILLMAX*(ILLMAX-1)/2+3*ILLMAX
        NBB=NBAND+NET
        NBB2=NBB*2
        KSIZE1=8*NOT+NPTIDE+6*NBB+3*IQDIF+4*NUMFRQ+2
        KSIZE2=24*NTIDE+6*ILLMAX+ILLMAX*(ILLMAX-1)/2+2
        IF(KSIZE1.GT.KSIZE2) THEN
        WRITE(IOUT6,*) ' SPACE ALLOCATION EXCEEDED FOR TIDES IN ALTIM'
        WRITE(IOUT6,*) 'INCREASE SIZE OF KTWRK2 POINTER IN KORP01'
        STOP
        ENDIF
!
! DEFINE POINTERS FOR ARRAY ALLOCATION
        JAJ=KTWRK2
        JBJ=JAJ+NBB2
        JQXLON =JBJ+NBB2
        JSNQXL =JQXLON+IQDIF
        JCSQXL =JSNQXL+IQDIF
        JLEGDR =JCSQXL+IQDIF
        JAAA   =JLEGDR+NPTIDE
        JBBB   =JAAA+NOT
        JAB    =JBBB+NOT
        JBA    =JAB+NBB+1
        JOMEGA =JBA+NBB+1
        JMEANA =JOMEGA+NUMFRQ
        JNODE  =JMEANA+NUMFRQ
        JANARG =JNODE+NUMFRQ
        JSNARG =JOMEGA
        JCSARG =JMEANA
        JSNANG =JANARG+NUMFRQ
        JCSANG =JSNANG+NOT
        JSNQLN =JCSANG+NOT
        JCSQLN =JSNQLN+NOT
        JSNTOT =JCSQLN+NOT
        JCSTOT =JSNTOT+NOT
        JACPBS =JSNANG
        JASMBC =JCSANG
        JPPPPP =JSNQLN
        JATERM =JCSQLN
        JBTERM =JAAA
        JALPHA =JBBB
!
!        print *,'altim: call to altotd'
        CALL ALTOTD(MJDSBL,FSECM,UZ,UZSQ,SATLON,THETAG,AA(KTIDE),       &
     &           AA(KTIDE+NTIDE),                                       &
     &           AA(KFI),AA(KGE),II(KMM),II(KKK),II(KHH),II(KJJ),       &
     &           II(KIBDY),II(KSIGN1),II(KLL),II(KQQ),                  &
     &           AA(KTXQQ),II(KTIPPT),AA(KTIEXP),AA(KTXMM),AA(KTXSN1),  &
     &           AA(KT2M2H),AA(KT2MHJ),AA(KTXKK),II(KTCNTR),II(KTNN),   &
     &           AA(KTXSN2),II(KTIPTT),II(KTQNDX),II(KTJJBD),II(KTITDE),&
     &           AA(JAB),AA(JBA),AA(JAJ),AA(JBJ),AA(JAAA),AA(JBBB),     &
     &           AA(JOMEGA),AA(JMEANA),AA(JNODE),AA(JANARG),AA(JSNARG), &
     &           AA(JCSARG),AA(JSNANG),AA(JCSANG),                      &
     &           AA(JQXLON),AA(JSNQXL),AA(JCSQXL),AA(JSNQLN),           &
     &           AA(JCSQLN),AA(JSNTOT),AA(JCSTOT),AA(JACPBS),           &
     &           AA(JASMBC),AA(JLEGDR),AA(JPPPPP),AA(JATERM),           &
     &           AA(JBTERM),AA(JALPHA),OTIDES,PMPA,NM,NDIM1,NDIM2,      &
     &           NPTIDE,NBB,NBB2,LNPNM,AA(KUNORM),AA,II)
      ENDIF
22450   CONTINUE
!
22460   CONTINUE
      IF(LITER1) GO TO 22600
! ADD OCEAN TIDES TO OCEAN PARAMETERS SUMMATION
      DO 22500 N=1,NM
      OCEANP(N)=OCEANP(N)+OTIDES(N)
22500 END DO
22600 CONTINUE
      LPART=LSTINR.AND.NPVAL0(IXH2LV).GT.0
      IF(.NOT.LETIDE.AND..NOT.LPART) GO TO 23600
      IF(LITER1.AND..NOT.LPRE(11,1)) GO TO 23400
!
! REMOVE EARTH TIDES FROM OCEAN PARAMETERS SUMMATION
      DO 23300 N=1,NM
      OCEANP(N)=OCEANP(N)-ETIDES(N)
23300 END DO
23400 CONTINUE
!
! EVALUATE EARTH TIDES
!        print *,'altim: call to altetd'
      CALL ALTETD(XSM(1,1),XSM(1,2),XSM(1,3),SATH,MJDSBL,FSECM,NM,      &
     &            AA(KSRTCH),ETIDES,LPART,PMPA,LNPNM,NDIM1,NDIM2,       &
     &            XY2,R,UZ,UZSQ,AA,II)
      IF(LITER1) GO TO 23600
!
! ADD EARTH TIDES TO OCEAN PARAMETERS SUMMATION
      DO 23500 N=1,NM
      OCEANP(N)=OCEANP(N)+ETIDES(N)
23500 END DO
!
23600 CONTINUE
!
! pd %%%%%% CALL FOR SATELLITE LOCATION OUTPUT%%%%%%
!    ZEROV is set to zero and then passed on as the parameter
!    ETCOR in LATLON. no earth tide correction output is required
!    for the altim case.
      IF(LG1BOT) THEN
         ALLOCATE(ZEROV(NM))
         DO I=1,NM
            ZEROV(I) = 0.0
         END DO
         CALL LATLON(.TRUE.,AA,II,LL,MJDSBL,NM,FSECN,XSN,VSN,SSTS,      &
     &        OCDRYT,OCWETT,ZEROV,OTIDES,UTDT,ISATID)
         DEALLOCATE(ZEROV)
      END IF
!
      IF(LNADJ) GO TO 90000
!
!*** BEGIN COMPUTATION OF ALTIMETER PARTIALS
!
! Z COMPONENT OF UNIT SATELLITE DIRECTION
      DO 24100 N=1,NM
      UZ(N)=XSM(N,3)/R(N)
24100 END DO
! UNIT Z SQUARED
      DO 24200 N=1,NM
      UZSQ(N)=UZ(N)**2
24200 END DO
! EARTH FLATTENING TERMS
! (OR PLANET)
      IF(ICBDGM.NE.ITBDGM) THEN
         FRC1=FOURCP
         TC2 =TWOC2P
      ELSE
         FRC1=FOURC1
         TC2 =TWOC2
      ENDIF
      DO 26100 N=1,NM
      C3(N)=FRC1*UZSQ(N)-TC2
26100 END DO
      DO 26200 N=1,NM
      C3(N)=C3(N)/R(N)
26200 END DO
      DO 26300 N=1,NM
      TEMP(N)=ONE+C3(N)*UZSQ(N)
26300 END DO
      DO 26400 N=1,NM
      TEMP(N)=-TEMP(N)/R(N)
26400 END DO
!
! INERTIAL PARTIALS
      DO 28200 J=1,3
      DO 28100 N=1,NM
      PMPXI(N,J)=TEMP(N)*XSM(N,J)
28100 END DO
28200 END DO
      DO 28300 N=1,NM
      TEMP(N)=C3(N)*UZ(N)
28300 END DO
      DO 28400 N=1,NM
      PMPXI(N,3)=PMPXI(N,3)+TEMP(N)
28400 END DO
28500 CONTINUE
!
! TIME RATE OF CHANGE OF DISTANCE FROM EARTH CENTER
      DO 30100 N=1,NM
      RDOT(N)=XSM(N,1)*VSM(N,1)
30100 END DO
      DO 30300 J=2,3
      DO 30200 N=1,NM
      RDOT(N)=RDOT(N)+XSM(N,J)*VSM(N,J)
30200 END DO
30300 END DO
      DO 30400 N=1,NM
      RDOT(N)=RDOT(N)/R(N)
30400 END DO
!
!??????? MOST LIKELY PLANET DEPENDENT ?
      NAEG  =NPVAL0(IXSMA )
      LAEADJ=LSTINR.AND.NAEG  .GT.0
      IF(.NOT.LAEADJ) GO TO 33000
!
! PARTIAL OF ALT OBS W.R.T. EARTH SEMI-MAJOR AXIS
      DO 32100 N=1,NM
      TPARTL(N)=ZT(N)/RT(N)
32100 END DO
      DO 32200 N=1,NM
      WORK(N)=TPARTL(N)**2
32200 END DO
      IF(ICBDGM.NE.ITBDGM) THEN
         EGSQR=EGSQP
      ELSE
         EGSQR=EGSQ
      ENDIF
      DO 32300 N=1,NM
      TPARTL(N)=ONE-EGSQR*WORK(N)
32300 END DO
      DO 32400 N=1,NM
      WORK(N)=SQRT(TPARTL(N))
32400 END DO
!
!????? MOST LIKELY PLANET DEPENDENT ?
      INDAEG=IPVAL0(IXSMA )
!
      IF(LNPNM) GO TO 32800
!...PMPA DIMENSIONED BY (NM,NP)
      DO 32500 N=1,NM
      PMPA(N,INDAEG)=-WORK(N)
32500 END DO
      GO TO 33000
32800 CONTINUE
!
      DO 32900 N=1,NM
      WORK(N)=-WORK(N)
32900 END DO
!...PMPA DIMENSIONED BY (NP,NM)
      CALL PMNPNM(PMPA,NDIM1,NDIM2,WORK,NM,INDAEG)
33000 CONTINUE
!
! TIME DERIVATIVE OF ALT OBS
      DO 34400 N=1,NM
      TPARTL(N)=VSM(N,3)-RDOT(N)*UZ(N)
34400 END DO
      DO 34800 N=1,NM
      TPARTL(N)=RDOT(N)-TEMP(N)*TPARTL(N)
34800 END DO
!
!      print *,' Before 49000 continue'
49000 CONTINUE
!      print *,' after 49000 continue'
! CHAIN FORCE MODEL PARTIALS
      IF(LNADJ) GO TO 50000
      NDIMX1=NEQN(ISET)
      NDIMX2=N3(ISET)
      NDIMX3=NM
      N2=NM
      N1=3
      IF(LNPNM) GO TO 45000
      NDIMX1=NM
      NDIMX2=NEQN(ISET)
      NDIMX3=N3(ISET)
      N2=3
      N1=NM
45000 CONTINUE
      IF(LAGEOO) CALL ALTCS0(AA(KPXPFM),AA(KPXPFM),NEQN(ISET),NM,       &
     & N3(ISET),LNPNM)
!
! CHAIN MEASUREMENT POSITION PARTIALS WITH FORCE MODEL PARTIALS
      IF (.NOT. LDIRALT) THEN
          ! GET PMPXI BACK INTO TRUE OF REF
          ! (IN THE DIRALT CASE PMPXI IS ALREADY IN TRUE OF REF, SO
          ! DON'T CALL SATUPD)
          CALL SATUPD(MJDSBL,FSECM,PMPXI,PMPXI,AA,NM,NM,                &
     &                .TRUE.,.TRUE.,II,0,1)
      END IF
      CALL CHAIN (PMPXI,NM,3,1,AA(KPXPFM),NDIMX1,NDIMX2,NDIMX3,         &
     &    NEQN(ISET),N3(ISET),IPTFMG(1,ISAT),ILNFMG(1,ISAT),NFMG(ISAT), &
     &    PMPA,NDIM1,NDIM2,LNPNM,.TRUE.,.FALSE.,SCALE,LL(KLAVOI))
!      print *,' before 50000 continue'
50000 CONTINUE
      IF(LX2ALT.OR.LATMOD) GOTO 90000
!
! SUM COMPUTED OBSERVATION CORRECTIONS AND OCEAN PARAMETERS CORRECTIONS
      CALL SUMALT(AA,NM)
!
! RESIDUALS WILL BE CORRECTED FOR OBSERVATION CORRECTIONS IN PROCES
! CORRECT RESIDUALS FOR OCEAN PARAMETERS
!
      DO 78000 N=1,NM
      RESID(N)=RESID(N)+OCEANP(N)
78000 END DO
!
!      print *,' before lnadj if ',lnadj
      IF(LNADJ) GO TO 90000
! LOAD BIAS AND TIMING BIAS PARTIALS
      CALL BIASP (AA,PMPA,NDIM1,NDIM2,OBS,TPARTL,AA(KOBTIM),            &
     &   AA(KDTIME),AA(KPRML0),1,LNPNM,LL(KLAVOI),AA(KOBSC))
      NVLITE=NPVAL0(IXVLIT)
      LITADJ=LSTINR.AND.NVLITE.GT.0
      IF(.NOT.LITADJ) GO TO 90000
! COMPUTE SPEED OF LIGHT PARTIAL
      INVLIT=IPVAL0(IXVLIT)
      CALL PLIGHT(PMPA,NDIM1,NDIM2,AA(KOBS),NM,INVLIT,LNPNM)
90000 CONTINUE
!      DO N=1,NM
!      ENDDO
!
!      print *,'altim: lacc and lpsbl: ',lacc,lpsbl
!      print *,'altim: mtype,NM: ',mtype,NM
      IF(.NOT.LACC.AND.LPSBL) GO TO 90100
! EDIT, PRINT, SUM STATISTICS AND SUM INTO NORMAL EQUATIONS
      IF(MTYPE.EQ.101) THEN

      NARCP=NPVAL0(IXARC)
      IF(NINNER.GT.ITERNU) NUSIDE=NUCON/2
      NU=NUSIDE*2+1
      IF(LNPNM) THEN
      NDM1=NEQNG
      NDM2=N3(ISET)
      NDM3=NUCON
      ELSE
      NDM1=NUCON
      NDM2=NEQNG
      NDM3=N3(ISET)
      ENDIF
      NREDUC=NUCON*NXBLK/2
!      print *,' before call to procx'
      CALL PROCX(AA,II,LL,AA(KRESID),AA(KSIGMA),AA(KRATIO),             &
     &          AA(KPMPA ),AA(KOBS  ),AA(KOBSIG),                       &
     &          AA(KS0   ),AA(KS1   ),                                  &
     &          JSTATS    ,MTYPE     ,                                  &
     &          AA(KX2TIM),AA(KX2OBS),AA(KXRNDX),                       &
     &          XSCR,II(KXOBLK),XSN,AA(KXXBM),AA(KX2PAR),               &
     &          NEQN,AA(KPXPFM),NDIMX1,NDIMX2,NDIMX3,N3(ISET),          &
     &          II(KPARTP),ISAT,ISET,R,AA(KX2AUX),NU,AA(KX2VPR),        &
     &          AA(KX2VPA),NDM1,NDM2,NDM3,                              &
     &          AA(KPMATT),AA(KX2PAT),NREDUC)

      ELSE IF(LATMOD) THEN


!      print *,' before call to procla',pmpa(1,9),pmpa(2,9)
!      print *,'AA(KOBS),AA(KOBSC): ',AA(KOBS),AA(KOBSC)
!      print *,'AA(KOBS+1),AA(KOBSC+1): ',AA(KOBS+1),AA(KOBSC+1)
!      print *,'AA(KOBS+NM),AA(KOBSC+NM): ',AA(KOBS+NM),AA(KOBSC+NM)
!      print *,'AA(KRESID): ',AA(KRESID)
!      print *,'AA(KRESID+1): ',AA(KRESID+1)
!      print *,'AA(KRESID+NM): ',AA(KRESID+NM)
      CALL PROCLA(AA,II,LL,AA(KOBSC ),AA(KRESID),AA(KSIGMA),AA(KRATIO), &
     &          AA(KPMPA ),AA(KOBS  ),AA(KSMCOR),AA(KOBTIM),AA(KOBSIG), &
     &          AA(KIAUNO),AA(KEDSIG),II(KINDH ),II(KNMH  ),AA(KS    ), &
     &          AA(KS0   ),AA(KS1   ),LL(KLEDIT),AA(KELEVS),AA(KDSCRP), &
     &          JSTATS    ,MTYPE     ,INDSTA    ,INDSAT    ,LELEVS   ,  &
     &          II(KISTNO),AA(KSTNAM),AA(KXPMPA),LL(KLSDAT),NXDIM1,     &
      &          NXDIM2,LL(KLRDED),LL(KLFEDT),LEDIT_EXTRA  )
!      print *,' after call to procla'
!      print *,'AA(KOBS),AA(KOBSC): ',AA(KOBS),AA(KOBSC)
!      print *,'AA(KOBS+1),AA(KOBSC+1): ',AA(KOBS+1),AA(KOBSC+1)
!      print *,'AA(KOBS+NM),AA(KOBSC+NM): ',AA(KOBS+NM),AA(KOBSC+NM)
!      print *,'AA(KRESID): ',AA(KRESID)
!      print *,'AA(KRESID+1): ',AA(KRESID+1)
!      print *,'AA(KRESID+NM): ',AA(KRESID+NM)

!       stop 69

      ELSE

!      print *,' before call to proces'
!      print *,'AA(KOBS),AA(KOBSC): ',AA(KOBS),AA(KOBSC)
!      print *,'AA(KOBS+1),AA(KOBSC+1): ',AA(KOBS+1),AA(KOBSC+1)
!      print *,'AA(KOBS+NM),AA(KOBSC+NM): ',AA(KOBS+NM),AA(KOBSC+NM)
!      print *,'AA(KRESID): ',AA(KRESID)
!      print *,'AA(KRESID+1): ',AA(KRESID+1)
!      print *,'AA(KRESID+NM): ',AA(KRESID+NM)
      CALL PROCES(AA,II,LL,AA(KOBSC ),AA(KRESID),AA(KSIGMA),AA(KRATIO), &
     &          AA(KPMPA ),AA(KOBS  ),AA(KSMCOR),AA(KOBTIM),AA(KOBSIG), &
     &          AA(KIAUNO),AA(KEDSIG),II(KINDH ),II(KNMH  ),AA(KS    ), &
     &          AA(KS0   ),AA(KS1   ),LL(KLEDIT),AA(KELEVS),AA(KDSCRP), &
     &          JSTATS    ,MTYPE     ,INDSTA    ,INDSAT    ,LELEVS   ,  &
     &          II(KISTNO),AA(KSTNAM),AA(KXPMPA),LL(KLSDAT),NXDIM1,     &
     &          NXDIM2,LL(KLRDED),LL(KLFEDT),LEDIT_EXTRA )
!      print *,' after call to proces'
!      print *,'AA(KOBS),AA(KOBSC): ',AA(KOBS),AA(KOBSC)
!      print *,'AA(KOBS+1),AA(KOBSC+1): ',AA(KOBS+1),AA(KOBSC+1)
!      print *,'AA(KOBS+NM),AA(KOBSC+NM): ',AA(KOBS+NM),AA(KOBSC+NM)
!      print *,'AA(KRESID): ',AA(KRESID)
!      print *,'AA(KRESID+1): ',AA(KRESID+1)
!      print *,'AA(KRESID+NM): ',AA(KRESID+NM)

      ENDIF

90100 CONTINUE
      DEALLOCATE(LEDIT_EXTRA)
      RETURN
      END
