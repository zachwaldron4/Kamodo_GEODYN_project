!$CHNAT1
      SUBROUTINE CHNAT1(PXEPAN,PXEPA,NDM1,NDM2,NDM3,LNPNM,NM,JP0AT,    &
     &           TIME, PER,LAVOID,IS,IPT)
!********1*********2*********3*********4*********5*********6*********7**
! CHNAT              00/00/00            0000.0    PGMR -DAVE ROWLANDS
!
! FUNCTION:
!              CHAIN AND INSERT PARTIALS OF ECF COORDINATES WRT ROLL PIT
!              INTO THE THE ARRAY OF ARRAY OF PARTIALS OF ECF COORDINATE
!              WRT ALL ADJUSTING PARAMETERS. ROUTINE IS CALLED FOR EACH
!              ECF COORDINATE. PARTIALS WRT ANGLES ARE ALSO EXPANDED FOR
!              LINEAR AND QUADRATIC TERMS
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!
!     PXEPAN        PARTIALS OF ECF COORDINATE WRT ROLL PITCH YAW
!     PXEPA         PARTIALS OF ECF COORDINATE WRT ALL ADJUSTING PARAMTE
!     NDM1          FIRST DIMENSION OF PXEPA ARRAY (NADJST IF LNPNM IS T
!                   NM OTHERWISE)
!     NDM2          SECOND DIMENSION OF PXEPA ARRAY (NM IF LNPNM IS TRUE
!                   NADJST OTHERWISE)
!     NDM3          FIRST DIMENSION OF PXEPAN ARRAY (GREATER THAN OR EQ
!     LNPNM         IF TRUE PARTIALS HAVE NADJST  AS FIRST DIMENSION
!     NM            NUMBER OF TIMES BEING USED
!     JP0AT         STARTING LOCATION OF ATTITUDE PARTIALS IN ADJUSTED P
!                   ARRAY (THIS ROUTINE LOADS 9 PARAMETERS (PARTIALS) AT
!     TIME          TIMES AT WHICH THE ATTITUDE PARTIALS ARE BEING APPLI
!                   REFERENCED FROM START OF ATTITUDE PERIOD
!
!********1*********2*********3*********4*********5*********6*********7**
!
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
!
      DIMENSION PXEPAN(NDM3,3)
      DIMENSION PXEPA(NDM1,NDM2)
      DIMENSION TIME(NM)
      DIMENSION LAVOID(1)
!
!
!**********************************************************************
! START OF EXECUTABLE CODE ********************************************
!**********************************************************************
!
!     IPD=(JP0AT-IPVAL0(IXATUD))/90
      IPD=(JP0AT-IPVAL0(IXATUD))/120
      ILAS=(JP0AT-IPVAL0(IXATUD)-IPD*120)/15
!     IP0AT=IPVAL0(IXATUD)+ILAS*15+IPD*120
      IP0AT=IPT
!     write(6,*)' dbg IP0AT in CHNAT ',IP0AT,NDM1,NDM2,NDM3
       DO IQP=1,15
         LAVOID(IP0AT-1+IQP)=.FALSE.
       ENDDO
      IF(LNPNM) GO TO 300
      DO 200 K=1,3
      IPT1=IP0AT+(K-1)*5
      IPT2=IP0AT+(K-1)*5+1
      IPT3=IP0AT+(K-1)*5+2
      IPT4=IP0AT+(K-1)*5+3
      IPT5=IP0AT+(K-1)*5+4
      DO 100 I=1,NM
      IF(PER.GT.0.D0) THEN
      WT=(TWOPI/PER)*TIME(I)
      SINWT=SIN(WT)
      COSWT=COS(WT)
      ELSE
      SINWT=0.D0
      COSWT=0.D0
      ENDIF
      PXEPA(I,IPT1)=PXEPA(I,IPT1)+IS*PXEPAN(I,K)
      PXEPA(I,IPT2)=PXEPA(I,IPT2)+IS*PXEPA(I,IPT1)*TIME(I)
      PXEPA(I,IPT3)=PXEPA(I,IPT3)+IS*PXEPA(I,IPT2)*TIME(I)
      PXEPA(I,IPT4)=PXEPA(I,IPT4)+IS*PXEPA(I,IPT1)*SINWT
      PXEPA(I,IPT5)=PXEPA(I,IPT5)+IS*PXEPA(I,IPT1)*COSWT
  100 END DO
  200 END DO
      RETURN
!
  300 CONTINUE
      DO 500 K=1,3
      IPT1=IP0AT+(K-1)*5
      IPT2=IP0AT+(K-1)*5+1
      IPT3=IP0AT+(K-1)*5+2
      IPT4=IP0AT+(K-1)*5+3
      IPT5=IP0AT+(K-1)*5+4
      DO 400 I=1,NM
      IF(PER.GT.0.D0) THEN
      WT=(TWOPI/PER)*TIME(I)
      SINWT=SIN(WT)
      COSWT=COS(WT)
      ELSE
      SINWT=0.D0
      COSWT=0.D0
      ENDIF
      PXEPA(IPT1,I)=PXEPA(IPT1,I)+IS*PXEPAN(I,K)

!     write(6,*)' dbg CHNAT ', PXEPA(IPT1,I),IPT1,PXEPAN(I,K),I,K

      PXEPA(IPT2,I)=PXEPA(IPT2,I)+IS*PXEPA(IPT1,I)*TIME(I)

!     write(6,*)' dbg CHNAT2', PXEPA(IPT2,I),TIME(I),IPT2

      PXEPA(IPT3,I)=PXEPA(IPT3,I)+IS*PXEPA(IPT2,I)*TIME(I)

!     write(6,*)' dbg CHNAT3', PXEPA(IPT3,I),IPT3

      PXEPA(IPT4,I)=PXEPA(IPT4,I)+IS*PXEPA(IPT1,I)*SINWT

!     write(6,*)' dbg CHNAT4', PXEPA(IPT4,I),IPT4

      PXEPA(IPT5,I)=PXEPA(IPT5,I)+IS*PXEPA(IPT1,I)*COSWT

!     write(6,*)' dbg CHNAT5', PXEPA(IPT5,I),IPT5

  400 END DO
  500 END DO
      RETURN
      END
