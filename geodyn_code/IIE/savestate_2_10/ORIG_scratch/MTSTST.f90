!$MTSTST
      SUBROUTINE MTSTST(MJDSN,FSECN,FSECM,FSECK,FSECJ,FSECI,            &
     &   XTN,XSM,XTK,XSJ,XTI,VTN,VSM,VTK,VSJ,VTI,XMN,XMK,XMI,           &
     &   XTNPC,XSMPC,XTKPC,XSJPC,XTIPC,                                 &
     &   RNM,RKM,RKJ,RIJ,RRNM,RRKM,RRKJ,RRIJ,URNM,URKM,URKJ,URIJ,       &
     &   PRRPNM,PRRPKM,PRRPKJ,PRRPIJ,NMP,INDSTA,INDP,RPOLE,PXPOLE,      &
     &   NINTPL,MINTPL,S,S1,XTP,RELV,PXSPXP,PXSPLV,COSTHG,SINTHG,       &
     &   INDSAT,SIGNL,NM,LPOLAD,LIGHT,LRANGE,LSKIP1,IEXIT,LTDRSS,       &
     &   GRELT1,GRELT2,GRELT3,GRELT4,DELCTN,DELCTK,DELCTI,PSTAT,        &
     &   RSUNST,CHEMR,CHMOR,EPOSR,CHEMT,CHMOT,EPOST,CHCBS,CPOSS,SCRTM,  &
     &   XSTT,XSTR,XSS,MTYPE,INDSET,BRTS,BRTSV,AA,II,LL,                &
     &   LYARA, ISNUMB, LADD, XDPOLE,PXSPXD,UTDT,LSVLBI,FSECS,LNUTAD)
!********1*********2*********3*********4*********5*********6*********7**
! MTSTST           83/04/07            8304.0    PGMR - TOM MARTIN
!                  88/09/26                      PGMR - A. MARSHALL
!                  89/09/20            8906.0    PGMR - J. MCCARTHY
!
! FUNCTION:  COMPUTE RANGES AND/OR RANGE RATES WHICH FOLLOW
!            THE PATTERN:
!
!                 Ti-->Sj-->Tk-->Sm-->Tn
!
!                 COMPUTATIONS START AT THE FINAL RECEIVED TIME
!                 MJDSn+FSECn AND PROCEED BACKWARDS UNTIL THE MODEL
!                 IS COMPLETE. IF THE "LIGHT" SWITCH IS .FALSE.
!                 ITERATIVE SOLUTIONS FOR THE LIGHT TIME ARE
!                 PERFORMED. OTHERWISE, THE MEASUREMENT EVENT TIMES
!                 ARE CONSIDERED TO BE KNOWN.
!                 THE SET OF RANGES AND RANGE RATES WHICH FALL INTO
!                 THIS PATTERN INCLUDE TYPES AS FOLLOWS:
!
!                 TYPES  PATTERN
!                 _____  ______________________
!
!                 59/60  T1-->S1-->T3-->S2-->T2
!                 53/54            T2-->S1-->T1
!                 51/52            T1-->S1-->T1
!                 41/42                 S1-->T1
!
!                 THE IEXIT ARGUMENT IS USED TO DESCRIMINATE
!                 BETWEEN SUB-PATTERNS
!
!                 THE LRANGE SWITCH IS USED TO DISCRIMINATE
!                 BETWEEN RANGES AND RANGE RATES
!                 NOTE: LRANGE is true for ranges and average
!                       range rates.  LRANGE is LNRATE in ROBS
!                       which is set if time derivatives are
!                       required.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSN    I    S    MODIFIED JULIAN DAY SECONDS OF THE FINAL
!                      RECEIVED TIME OF THE FIRST OBSERVATION IN
!                      THE BLOCK
!   FSECN    I    A    ELAPSED SECONDS FROM MJDSN OF THE EVENT
!                      TIMES ASSOCIATED WITH TRACKING STATION Tn
!   FSECM   I/O   A    ELAPSED SECONDS FROM MJDSN OF THE EVENT
!                      TIMES ASSOCIATED WITH SATELLITE Sm
!   FSECK   I/O   A    ELAPSED SECONDS FROM MJDSN OF THE EVENT
!                      TIMES ASSOCIATED WITH TRACKING STATION Tk
!   FSECJ   I/O   A    ELAPSED SECONDS FROM MJDSN OF THE EVENT
!                      TIMES ASSOCIATED WITH SATELLITE Sj
!   FSECI   I/O   A    ELAPSED SECONDS FROM MJDSN OF THE EVENT
!                      TIMES ASSOCIATED WITH TRACKING STATION Ti
!   XTN      O    A    TRUE OF REFERENCE INERT. COORD. OF TRACKING STA.
!   XSM      O    A    TRUE OF REFERENCE INERT. COORD. OF SATELLITE Sm
!   XTK      O    A    TRUE OF REFERENCE INERT. COORD. OF TRACKING STA.
!   XSJ      O    A    TRUE OF REFERENCE INERT. COORD. OF SATELLITE Sj
!   XTI      O    A    TRUE OF REFERENCE INERT. COORD. OF TRACKING STA.
!   VTN      O    A    TRUE OF REFERENCE INERT. VEL. OF TRACKING STA. Tn
!   VSM      O    A    TRUE OF REFERENCE INERT. VEL. OF SATELLITE Sm
!   VTK      O    A    TRUE OF REFERENCE INERT. VEL. OF TRACKING STA. Tk
!   VSJ      O    A    TRUE OF REFERENCE INERT. VEL. OF SATELLITE Sj
!   VTI      O    A    TRUE OF REFERENCE INERT. VEL. OF TRACKING STA. Ti
!   XMN      I    A    MEAN POLE COORDINATES OF TRACKING STATION Tn
!   XMK      I    A    MEAN POLE COORDINATES OF TRACKING STATION Tk
!   XMI      I    A    MEAN POLE COORDINATES OF TRACKING STATION Ti
!   XTNPC    O    A    SAME AS XTN BUT PLANET CENTERED
!   XSMPC    O    A    SAME AS XSM BUT PLANET CENTERED
!   XTKPC    O    A    SAME AS XTK BUT PLANET CENTERED
!   XSJPC    O    A    SAME AS XSJ BUT PLANET CENTERED
!   XTIPC    O    A    SAME AS XTI BUT PLANET CENTERED
!   RNM      O    A    SLANT RANGE FROM Tn TO Sm
!   RKM      O    A    SLANT RANGE FROM Tk TO Sm
!   RKJ      O    A    SLANT RANGE FROM Tk TO Sj
!   RIJ      O    A    SLANT RANGE FROM Ti TO Sj
!   RRNM     O    A    RANGE RATE BETWEEN Tn AND Sm
!   RRKM     O    A    RANGE RATE BETWEEN Tk AND Sm
!   RRKJ     O    A    RANGE RATE BETWEEN Tk AND Sj
!   RRIJ     O    A    RANGE RATE BETWEEN Ti AND Sj
!   URNM     O    A    UNIT VECTOR FROM Tn TO Sm
!   URKM     O    A    UNIT VECTOR FROM Tk TO Sm
!   URKJ     O    A    UNIT VECTOR FROM Tk TO Sj
!   URIJ     O    A    UNIT VECTOR FROM Ti TO Sj
!   PRRPNM   O    A    PARTL. OF RNG. RATE W.R.T. Tn-->Sm VECTOR
!   PRRPKM   O    A    PARTL. OF RNG. RATE W.R.T. Tk-->Sm VECTOR
!   PRRPKJ   O    A    PARTL. OF RNG. RATE W.R.T. Tk-->Sj VECTOR
!   PRRPIJ   O    A    PARTL. OF RNG. RATE W.R.T. Ti-->Sj VECTOR
!   NMP      O    A    INDEX OF THE LAST MEASUREMENT ASSOCIATED WITH
!                      EACH INTERPOLATION INTERVAL
!   INDSTA   O    A    POINTER TO INTERNAL STATION NUMBER
!   INDP     O    A    POINTER TO ADJUSTED POLAR MOTION VALUES
!                      ASSOCIATED WITH EACH INTERPOLATION INTERVAL
!   RPOLE    O    A    POLAR MOTION ROTATION MATRICES AT EACH END
!                      OF EACH INTERPOLATION INTERVAL
!   PXPOLE   O    A    PARTIALS OF THE TRUE POLE STATION LOCATION
!                      W.R.T. THE POLAR MOTION X & Y PARAMETERS AT
!                      EACH END OF EACH INTERPOLATION INTERVAL
!   XDPOLE   O    A    PARTIALS OF THE TRUE POLE STATION RATE
!                      W.R.T. THE POLAR MOTION X & Y PARAMETERS AT
!                      EACH END OF EACH INTERPOLATION INTERVAL
!   NINTPL   I    S
!   MINTPL   I    S    MAXIMUM NUMBER OF INTERPOLATION INTERVALS
!   S        O    A    INTERPOLATION FRACTIONS
!   S1       O    A    1.0-S
!   XTP      O    A    TRUE POLE COORDINATES OF A TRACKING STATION
!   RELV     O    A    VELOCITY OF SATELLITE W.R.T. TRACKING STATION
!   PXSPXP   O    A    PARTIALS OF TRUE POLE STATION COORDINATES
!                      W.R.T. POLAR MOTION FOR EACH OF "NM"
!                      MEASUREMENT TIMES
!   PXSPLV   O    A
!   COSTHG   O    A    COSINES OF RIGHT ASCENSION OF GREENWICH
!   SINTHG   O    A    SINES  OF RIGHT ASCENSION OF GREENWICH
!   INDSAT   I    A
!   SIGNL    I    S    SIGN OF THE LIGHT TIME (+1. OR -1.)
!   NM       I    S    NUMBER OF MEASUREMENTS
!   LPOLAD   I    S    SWITCH INDICATING IF POLAR MOTION ADJUST.
!                      PARTIALS ARE REQUIRED FOR EACH INTERP.
!                      INTERVAL
!   LIGHT    I    S    .TRUE. IF LIGHT TIMES HAVE BEEN DETERMINED
!   LRANGE   I    S    .FALSE. WHEN RANGE RATES TO BE COMPUTED
!   LSKIP1   I    S    .TRUE. WHEN 1ST LINE IS TO BE SKIPPED
!   IEXIT    I    S    NUMBER OF LINKS IN MEASUREMENT
!   LTDRSS   I    S    LOGICAL FLAG FOR TDRSS MEASUREMENTS
!   GRELT1-4 O    A    GENERAL REL LIGHT TIME CORRECTION FOR
!                      EACH LINK
!   DELCTN   O    A    DELTA COORDINATE TIME- ET
!   DELCTK   O    A    DELTA COORDINATE TIME- ET
!   DELCTI   O    A    DELTA COORDINATE TIME- ET
!   PSTAT    O    A    SPACE TO HOLD PLANET POSITIONS
!   RSUNST   O    A    DISTANCE BETWEEN SATELLITE AND SUN
!   CHEMR    O    A    EARTH-MOON CHEBYSHEV POLY. FOR RECEIVING
!                      STATION
!   CHMOR    O    A    MOON CHEBYSHEV POLY. FOR RECEIVING
!                      STATION
!   EPOSR    O    A    EARTH POSITION FOR RECEIVING STATION
!   CHEMT    O    A    EARTH-MOON CHEBYSHEV POLY. FOR TRANSMITTING
!                      STATION
!   CHMOT    O    A    MOON CHEBYSHEV POLY. FOR TRANSMITTING
!                      STATION
!   EPOST    O    A    EARTH POSITION FOR TRANSMITTING STATION
!   CHCBS    O    A    CENTRAL BODY CHEBYSHEV POLY. FOR
!                      SATELLITE
!   CPOSS    O    A    CENTRAL BODY POSITION FOR SATELLITE
!   SCRTM    O    A    SCRATCH SPACE
!   XSTT     I    A    TRANSMITTING STATION OFFSET W.R.T. EARTH CENTER
!                      IN THE TRUE OF REFERENCE BARYCENTRIC FRAME
!   XSTR     I    A    RECEIVING STATION OFFSET W.R.T. EARTH CENTER
!                      IN THE TRUE OF REFERENCE BARYCENTRIC FRAME
!   XSS      I    A    SATELLITE OFFSET W.R.T. MARS CENTER IN THE TRUE
!                      OF REFERENCE BARYCENTRIC FRAME
!   BRTS     W    A    BINARY RESIDUAL FILE STATION COOR.
!   BRTSV    W    A    BINARY RESIDUAL FILE STATION VELOCITIES
!   AA      I/O   A    REAL DYNAMIC ARRAY
!   II      I/O   A    INTEGER DYNAMIC ARRAY
!   LL      I/O   A    LOGICAL DYNAMIC ARRAY
!   MTYPE              MEASUREMENT TYPE
!   INDSET             FOR A GIVEN INTERNAL SAT. NUMBER THIS TELLS
!                      WHICH SET THE SAT. BELONGS TO.
!
! COMMENTS:
!    OCT 2012, MODIFIED BY JOSEPH NICHOLAS TO WORK WITH ASTEROID RUNS
!              (WHEN LASTSN IS TRUE)
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      PARAMETER(MOBS=1000)
      COMMON/CBINRL/LBINR,LLOCR,LODR,LBNCR,LBINRI,LLOCRI,LODRI,LBNCRI,  &
     &              NXCBIN
      COMMON/CEGREL/LGRELE,LRLCLK,LGRELR,LXPCLK,LBPCLK,NXEGRL
      COMMON/CHCOEF/ COEFM(3,15),COEFJ(3,15),COEFSA(3,15),COEFS(3,15),  &
     &               COEFEM(3,15),COEFMO(3,15),COEF(3,15)
      COMMON/CHCOFX/ COEFX(3,25),COEFXX(3,25,988),RLVAL(988)
      COMMON/CIMDST/IDRLTM(200),ITRLTM(200),IRELON,IRLONA,NRLTMC,       &
     & IDRCK4(200),IRKONA,NROCK4,IRKRAD,NXIRTM
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CLIGHT/VLIGHT,ERRLIM,XCLITE
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/CONTRL/LSIMDT,LOBS  ,LORB  ,LNOADJ,LNADJL,LORFST,LORLST,   &
     &              LORALL,LORBOB,LOBFST,LOBLST,LOBALL,LPREPO,LORBVX,   &
     &              LORBVK,LACC3D,LSDATA,LCUTOT,LACCEL,LDYNAC,LFRCAT,   &
     &              LNIAU, NXCONT
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI03/KICRD ,KICON ,KISTNO,KINDPI,KMJDPL,KIPOLC,          &
     &              KNDOLA,KIOLPA,KKIOLA,KIP0OL,KNDOLM,KIOLPM,          &
     &              KKIOLM,KIPVOL,KICNL2,KICNH2,                        &
     &              KSTMJD, KNUMST, KITAST, KSTNRD, KICNV,              &
     &              KTIDES,KFODEG,KFOORD,KRDEGR,KRORDR,                 &
     &              KPHINC,KDOODS,KOTFLG,KJDN  ,KPTDN ,                 &
     &              KATIND,KPRESP,KMP2RS,KSITE,KPTOLS,NXCI03
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORL01/KLORBT,KLORBV,KLNDRG,KLBAKW,KLSETS,KLAFRC,KLSTSN,   &
     &              KLSNLT,KLAJDP,KLAJSP,KLAJGP,KLTPAT,KEALQT,KLRDGA,   &
     &              KLRDDR,KLRDSR,KFHIRT,KLSURF,KHRFON,KLTPXH,KSETDN,   &
     &              KTALTA,NXCL01
      COMMON/CORL02/KLNDTT,KLWSTR,KLNDTR,KLEVMF,KLTPMS,NXCL02
      COMMON/CPARFL/LPARFI,LPFEOF,LARCNU,LRORR
      COMMON/CSBSAT/KR,KRT,KZT,KXY2,KUZ,KUZSQ,KTEMP,KC3,KTHETG
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IORCHB/ IORM,IORJ,IORSA,IORSUN,IOREM,IORMO,IORCB,IORTB,    &
     &               IGRP,ICHBOG(2,14),IORSCB(988),NXORCH
      COMMON/LDUAL/LASTSN,LSTSNX,LSTSNY
      COMMON/LEPHM2/LXEPHM
      COMMON/LOLOAD/LOLMD,LOLAJ,L2FOLT,LAPLOD
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/OCCLTL/LOCCLT(200),LMSHD(200)
      COMMON/OLDADJ/NPV0OL(3,3),JPV0OL(3,3),NYZ0OL(3,3),JYZ0OL(3,3),    &
     &              NEO0OL(3,3),JEO0OL(3,3)
      COMMON/OLDMOD/NTOLFR,NTOLF2,NTOLMD,NSTAOL,NSITOL,NTOLAJ,MXOLSA,   &
     &              NPOLSH,                                             &
     &              NXOLMD
      COMMON/OLOADA/LXYZCO,LEOPTO
      COMMON/POLESW/LDNPOL,NXPOLS
      COMMON/SETDI /NSETDP,NFRSED,NFRSDI,NFRSLN,NXSETI
      COMMON/TIDEOP/EOPTID(2,3)
      COMMON/UNITS/IUNT11,IUNT12,IUNT13,IUNT19,IUNT30,IUNT71,IUNT72,    &
     &             IUNT73,IUNT05,IUNT14,IUNT65,IUNT88,IUNT21,IUNT22,    &
     &             IUNT23,IUNT24,IUNT25,IUNT26
      COMMON/XLITSD/DELULT,DDLULT,UNVLTU(3),DELDLT,DDLDLT,UNVLTD(3),    &
     &              GRELLT,TOLLTX,GRLFCT,FCTJUP,FCTSAT
      COMMON/XTRAOR/T0XTRO,T0XTRO2,CVENUS,CLIBMN,CMARS,CMERC,XXTRAO
      COMMON/IOS/ISTOS1,ISTOS2,ISTOS3,ISTLST,INTSUB(3),JNTSUB(3),      &
     &        ILSTSG(80),INTOSP,MAPSAT(3,4)
!
      DIMENSION FSECN(NM),FSECM(NM),FSECK(NM),FSECJ(NM),FSECI(NM),      &
     &   XTN(MINTIM,3),XSM(MINTIM,3),XTK(MINTIM,3),XSJ(MINTIM,3),       &
     &   XTI(MINTIM,3),VTN(MINTIM,3),VSM(MINTIM,3),VTK(MINTIM,3),       &
     &   VSJ(MINTIM,3),VTI(MINTIM,3),                                   &
     &   XMN(3),XMK(3),XMI(3),RNM(NM),RKM(NM),RKJ(NM),RIJ(NM),          &
     &   XMN1(3),XMK1(3),XMI1(3), &
     &   RRNM(NM),RRKM(NM),RRKJ(NM),RRIJ(NM),                           &
     &   URNM(NM,3,2),URKM(NM,3,2),URKJ(NM,3,2),URIJ(NM,3,2),           &
     &   NMP(MINTPL,4),                                                 &
     &   PRRPNM(NM,3),PRRPKM(NM,3),PRRPKJ(NM,3),PRRPIJ(NM,3),NINTPL(4), &
     &   INDSTA(3),INDP(MINTPL,4),RPOLE(3,3,MINTPL),PXPOLE(3,2,MINTPL), &
     &   S(NM),S1(NM),XTP(NM,3),RELV(NM,3),PXSPXP(NM,3,2,4),            &
     &   PXSPLV(NM,3,NSETDP,4),COSTHG(NM,4),SINTHG(NM,4),INDSAT(3),     &
     &   GRELT1(NM),GRELT2(NM),GRELT3(NM),GRELT4(NM),DELCTN(NM),        &
     &   DELCTK(NM),DELCTI(NM),PSTAT(NM,6),RSUNST(NM),BRTS(MINTIM,3),   &
     &   BRTSV(MINTIM,3),AA(1),II(1),LL(1),                             &
     &   CHEMR(NM,15),CHMOR(NM,12),EPOSR(NM,3),CHEMT(NM,15),            &
     &   CHMOT(NM,15),EPOST(NM,3),CHCBS(NM,*),CPOSS(NM,3),              &
     &   SCRTM(NM,90),XSTT(MINTIM,3),XSTR(MINTIM,3),XSS(MINTIM,3),      &
     &   INDSET(3),XDPOLE(3,2,MINTPL),PXSPXD(NM,3,2,4),UTDT(NM,4),      &
     &   XTNPC(MINTIM,3),XSMPC(MINTIM,3),XTKPC(MINTIM,3),               &
     &   XSJPC(MINTIM,3),XTIPC(MINTIM,3)
      DIMENSION FSECS(NM),FSECNL(MOBS),FSECNU(MOBS),ZR(MOBS)
      DIMENSION FSECX(MOBS)
      DIMENSION DUM(3),DUM1(3,2,1)
      DIMENSION COF_COM(3)
!
! THE ORDER OF THE FOLLOWING SAT AND STATION ARRAYS MUST BE MAINTAINED
! IN THE ARGUMENT LIST OF THIS ROUTINE.  INDEXING IN LITEUP AND LITEDN
! FOR THE S/C ARRAY DEPENDS ON THIS ORDER.
!
      DIMENSION XENV(3,3)
!
!
      DATA J1,J2P,J3,J4/1,2,3,4/
      DATA TWO/2.0D0/,ZERO/0.D0/
!
!********1*********2*********3*********4*********5*********6*********7**
! START OF EXECUTABLE CODE
!********1*********2*********3*********4*********5*********6*********7**
!
      DO I=1,6
        EOPTID(I,1)=0.D0
      ENDDO

      ! INITIALIZE BODY FIXED COM-COF OFFSET
      COF_COM(1:3) = 0.D0
      DO I=1,3
      XMN1(I)=XMN(I)
      XMK1(I)=XMK(I)
      XMI1(I)=XMI(I)
      ENDDO
      IF (NPVAL(IXCOFF) > 0) THEN
          INDX = IPVAL(IXCOFF)
          DO I = 1, 3
              COF_COM(I) = AA(KPRMV-2+INDX+I)
              XMN1(I)=XMN1(I)+COF_COM(I)
              XMK1(I)=XMK1(I)+COF_COM(I)
              XMI1(I)=XMI1(I)+COF_COM(I)
          END DO
      END IF

!     ....set switch to indicate range rate measurement
      IF(LSVLBI.OR.LBPCLK) THEN
        IF(NM.GT.MOBS) THEN
           WRITE(6,60000)
           WRITE(6,60001) MOBS
           STOP
        ENDIF
        DO I=1,NM
          FSECNL(I)=-9.D9
          FSECNU(I)=+9.D9
          ZR(I)=0.D0
        ENDDO
        LCONS=.FALSE.
      ENDIF
      XADD=0.D0
      IF(LBPCLK) THEN
        XADD=DELDLT
        DO N=1,NM
           FSECX(N)=FSECN(N)
           FSECN(N)=FSECN(N)+DELDLT+DELULT
        ENDDO
      ENDIF
!
       LTDR1W=MTYPE.EQ.56
      LRRATE = MOD( MTYPE,2 ) .EQ. 0
      LSIMX=LSIMDT
      IF(ICBDGM.EQ.ITBDGM) LSIMX=.FALSE.
      KTRJX=KVTKP+3*MINTIM
      KTRJV=KTRJX+3*MINTIM
!
!
!
      IF(LTDRSS) GO TO 2900
      IF(LSKIP1) GO TO 2000
!
!
!
      IF(LOLMD) THEN
        CALL OLDSET(J1,INDSTA(J1),NM,AA(KSTAIN),II(KIP0OL),II(KNDOLA),  &
     &              II(KKIOLA),LOLAJ,LOLMDS,                            &
     &              JABCOF,JPXSPA,JOLPAE,JOLPAN,JOLPAV,JXLOCV,          &
     &              JABCCM,JPXSP1,JOLPXC,JOLPYC,JOLPZC,                 &
     &              JABCEO,JPXSP2,JOLPXP,JOLPYP,JOLPUP,LALOAD,ISITA,    &
     &              XENV)
      ENDIF
      IF(LEOPTO.OR.LOLMDS.OR.LXYZCO) THEN
         CALL OLTIME(MJDSN,FSECN,NM,AA(KANGFC),AA(KSPEED),AA(KSCROL),   &
     &               AA(KSCROL+4*NTOLFR),II(KPTOLS),AA(KANGT),          &
     &               AA(KCONAM),AA(KTWRK1),AA(KGRDAN),AA(KUANG),        &
     &               AA(KFAMP),II(KJDN))
      ENDIF
      IF(LEOPTO) THEN
         CALL OLDEOP(MJDSN,FSECN,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),   &
     &              AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,         &
     &              AA(JPXSPA),NPV0OL(1,J1),NPV0OL(2,J1),NPV0OL(3,J1),  &
     &              II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),        &
     &              AA(JPXSP1),NYZ0OL(1,J1),NYZ0OL(2,J1),NYZ0OL(3,J1),  &
     &              II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),        &
     &              AA(JPXSP2),NEO0OL(1,J1),NEO0OL(2,J1),NEO0OL(3,J1),  &
     &              II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,     &
     &              LEOPTO,XMN1)
      ENDIF
 10   CONTINUE

!        FROM WHICH TO INTERPOLATE ACROSS THE ENTIRE BLOCK OF DATA

      NINTP2=NINTPL(J1)*2

      CALL STATPVP(AA,II,LL,LDNPOL,LPOLAD,MJDSN,FSECN,NM,XMN1,&
     &  NINTPL(J1),&
     &   NMP(1,J1),INDP(1,J1),PXPOLE,RPOLE,S,XDPOLE,XTP,PXSPXP(1,1,1,J1)&
     &   ,PXSPLV(1,1,1,J1),NINTP2,.TRUE.,INDSTA(J1),.FALSE.,            &
     &   LYARA,ISNUMB,PXSPXD(1,1,1,J1),COSTHG(1:NM,J1),SINTHG(1:NM,J1), &
     &   AA(KSRTCH),UTDT(1,J1),S1,FSECN,AA(KDXDNU),LNUTAD)


      CALL GRHRAP(MJDSN,FSECN,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),       &
     &     AA(KTHETG),COSTHG(1,J1),SINTHG(1,J1),NM,AA,II,UTDT(1,J1),    &
     &     .FALSE.,XMN1,DUM1)

      IF(.NOT.LOLMDS.AND..NOT.LXYZCO) GO TO 500
      CALL OLOAD(MJDSN,FSECN,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),       &
     &           AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,            &
     &           AA(JPXSPA),NPV0OL(1,J1),NPV0OL(2,J1),NPV0OL(3,J1),     &
     &           II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),           &
     &           AA(JPXSP1),NYZ0OL(1,J1),NYZ0OL(2,J1),NYZ0OL(3,J1),     &
     &           II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),           &
     &           AA(JPXSP2),NEO0OL(1,J1),NEO0OL(2,J1),NEO0OL(3,J1),     &
     &           II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,LEOPTO, &
     &           isnumb,.FALSE.,NM,LALOAD,AA(KALCOF),II(KSITE),ISITA,   &
     &           XENV)
  500 CONTINUE

! ROTATE TRUE POLE STATION COORDINATES TO TRUE OF DATE ACROSS ENTIRE
!        BLOCK OF DATA
!     PRINT 12349
!2349 FORMAT(' ** MTSTST **  CALL INERTP')
      CALL INERTP(XTP,COSTHG(1,J1),SINTHG(1,J1),XTN,NM,MINTIM,NM)
! STORE OFF TOD TRACKING STATION COORDINATES FOR BINRES FILE
            DO 510 IS=1,3
            DO 510 NN=1,NM
            BRTS(NN,IS)=XTN(NN,IS)
  510       CONTINUE
! COMPUTE INERTIAL STATION VELOCITIES IF NECESSARY
      IF(.NOT.LRANGE)                                                   &
     &CALL INRTSV(COSTHG(1,J1),SINTHG(1,J1),XTN,VTN,NM,MINTIM)
      CALL TDORTR(MJDSN,FSECN,XTN,XTN,AA,NM,MINTIM,.TRUE.,.TRUE.,II)
      IF(.NOT.LRANGE)                                                   &
     &CALL TDORTR(MJDSN,FSECN,VTN,VTN,AA,NM,MINTIM,.FALSE.,.TRUE.,II)
!
!***** INERTIAL TRACKING STATION #n POSITIONS NOW COMPUTED *************
!
! IF TRANSIT TIME CORRECTIONS ARE NOT REQUIRED SKIP TO 2000
!     PRINT 12351
!2351 FORMAT(' ** MTSTST **  CALL ORBSET')

      IF(NINTOT.GT.0) THEN
      ISATID=II(KISATN+INDSAT(1)-1)
      IF(INTOSP.EQ.0) INTOSP=1
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF

      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),INDSAT(J1),           &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSN,FSECN(1),       &
     &   FSECN(NM),NM,AA,II)
!
! SAVE STATION OFFSETS(IN PLANET CENTERED COORDINATES)
      MIN3 = MINTIM*3
      IF (ITBDGM .EQ. ICBDGM) GOTO 1100
      DO 1050 I=1,3
      DO 1050 J=1,MINTIM
      XSTR(J,I)=XTN(J,I)
 1050 CONTINUE
 1100 CONTINUE
!
      IF(LIGHT) GO TO 2000
!
!***** START HERE TO COMPUTE LINK #1 TRANSIT TIMES TO SATELLITE ********
!
      IF(LSVLBI) THEN
         LCONS=.FALSE.
!
!        ITERATIVELY COMPUTE STATION TIMES TIMES SO THAT SATELLITE TIME
!        MATCHES FSECS
         DO N=1,NM
           FSECM(N)=FSECS(N)
         ENDDO
      ELSE
!        INITIALIZE SATELLITE Sm TIMES TO EQUAL STATION Tn TIMES
         DO 1000 N=1,NM
         FSECM(N)=FSECN(N)
 1000    END DO
      ENDIF
! ITERATIVELY COMPUTE SATELLITE TIMES
      CALL LITEUP(XTN,XSM,XSMPC,RNM,URNM,URNM(1,2,1),URNM(1,3,1),S,     &
     &         MJDSN,FSECN,FSECM,SIGNL,DELCTN,RSUNST,GRELT1,PSTAT,NM,   &
     &         SCRTM,AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),ISATID,    &
     &         AA,II,LL,.FALSE.)
      IF(LSVLBI) CALL ADJSTM(NM,FSECS,FSECM,FSECNL,FSECNU,FSECN,LCONS)
      IF(LSVLBI.AND..NOT.LCONS) GO TO 10
!
!***** TRANSIT TIMES FOR LINK #1 COMPUTED ******************************
!
 2000 CONTINUE
!
! SET UP FOR DORIS DATA (MEASUREMENT TYPE 40) IF NECESSARY
! .............................................................
      IF(LSKIP1.AND.(.NOT.LIGHT)) THEN
!      ....moved call to ORBSET to precede ORBIT - jjm 12/20/93
!      ....this fixes problem where ORBFIL call resets KIVSAT
!      ....and DORIS measurements are affected.
!      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),INDSAT(J1))
!
! IF DORIS DATA (MEASUREMENT TYPE 40) THEN
! INITIALIZE SATELLITE Sm TIMES TO EQUAL STATION Tn TIMES
! AND INITIALIZE STATION Tk TIMES TO EQUAL SATELLITE Sm TIMES
!
      DO 2001 N=1,NM
      FSECK(N)=FSECN(N)
      FSECM(N)=FSECN(N)
 2001 END DO
      ENDIF

! .............................................................
! END OF DORIS SETUP

      ISATID=II(KISATN+INDSAT(1)-1)
      IF(NINTOT.GT.0) THEN
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF
!
! OBTAIN SATELLITE POSITIONS AT CORRECT SATELLITE TIMES
      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),INDSAT(J1),           &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSN,FSECM(1),       &
     &   FSECM(NM),NM,AA,II)

      CALL ORBIT(MJDSN,FSECM,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),   &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSM,AA(KPXPFM),              &
     &   LNADJ,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),                &
     &   AA(KTPMES+2*MINTIM),LL(KLTPMS+3*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)

!     KPXPFJ=KPXPFM+II(KIPXPF+1)-II(KIPXPF)
      KPXPFK=KPXPFM+II(KIPXPF+1)-II(KIPXPF)
!
      IF(LBPCLK.AND..NOT.LCONS) GO TO 2102
      IF(.NOT.(LOBORB.OR.(LPARFI.AND..NOT.LRORR))) GO TO 2100
! GET POS & VEL IN TRUE OF DATE SYSTEM
      CALL SATUPD(MJDSN,FSECM,XSM,AA(KTRJX),AA,NM,MINTIM,.TRUE.,.FALSE. &
     &,II,0,1)
      CALL SATUPD(MJDSN,FSECM,VSM,AA(KTRJV),AA,NM,MINTIM,.FALSE.,       &
     &                                                   .FALSE.,II,0,1)
! COMPUTE RIGHT ASCENSION OF GREENWICH ACROSS ENTIRE BLOCK OF DATA
!
      IF(ICBDGM.EQ.3) THEN
      CALL GRHRAN(MJDSN,FSECM,.FALSE.,.FALSE.,AA(KEQN),AA(KSRTCH),      &
     &   AA(KTHETG),COSTHG(1,J2P),SINTHG(1,J2P),NM,AA,II,UTDT(1,J2P),   &
     &   .FALSE.,DUM,DUM1)
      ELSE
      CALL ROTXTR(MJDSN,FSECM,.FALSE.,AA(KEQN),AA(KSRTCH),              &
     &   AA(KTHETG),COSTHG(1,J2P),SINTHG(1,J2P),NM,AA,AA(KACOSW),       &
     &   AA(KBSINW),AA(KANGWT),AA(KWT),AA(KACOFW),AA(KBCOFW),II,1)
      ENDIF
!
! COMPUTE S/C HEIGHT ABOVE ELLIPSOID AND SUB-SATELLITE LAT & LON
      CALL SUBTRK(AA(KTRJX),AA(KTHETG),AA(KXY2),AA(KZT),AA(KRT),        &
     &   AA(KSATLT),AA(KSATLN),AA(KSATH),NM)
!
      IF(.NOT.LOBORB) GO TO 2100
! PRINT TRAJECTORY
      CALL TRAJCT(AA(KA1UT),MJDSN,FSECM,AA(KTRJX),AA(KTRJV),            &
     &   AA(KSATLT),AA(KSATLN),AA(KSATH),II(KINDH),II(KNMH),AA(KS),     &
     &   AA(KCIP  ),NM,INDSAT(J1),AA,AA(KCOSTH),AA(KSINTH),AA(KDPSR),   &
     &   AA(KXPUT),AA(KYPUT),II)
 2100 CONTINUE
!
      IF(LVMTFO) CALL VMATO(AA(KA1UT),MJDSN,FSECM,XSM,VSM,AA(KPXPFM),   &
     &   II(KINDH),II(KNMH),AA(KS),AA(KCIP  ),NM,INDSAT(J1),II)
 2102 CONTINUE
!
      IF(ICBDGM.EQ.ITBDGM) GO TO 2200
!  STORE STATION OFFSETS FOR INPUT TO BARYC
      IF(ICBDGM .NE. ITBDGM) THEN
      DO 2105 I=1,3
      DO 2105 J=1,MINTIM
      XTN(J,I)=XSTR(J,I)
 2105 CONTINUE
      ENDIF
!
! GET COORDINATE EPHEMERIS TIME AT TRACKING STATION TIME
      DO 2110 N=1,NM
      RNM(N)=FSECN(N)+DELCTN(N)
 2110 END DO
!
! GET TRACKING BODY BARYCENTRIC (ASSUME EARTH)

      CALL BARYC(MJDSN,RNM,XTN,VTN,MINTIM,IGRP,IORTB,IORMO,IORSUN,      &
     &           IOREM,COEFEM,COEFMO,COEFS,COEFEM,                      &
     &           NM,NDIM1,NDIM2,.FALSE.,.TRUE.,.FALSE.,AA(KPRCBD),      &
     &           AA(KPRTBD),SCRTM(1,1),SCRTM(1,7),SCRTM(1,10),          &
     &           CHEMR,SCRTM(1,16),SCRTM(1,31),SCRTM(1,46),CHMOR,       &
     &           SCRTM(1,16),SCRTM(1,74),SCRTM(1,75),SCRTM(1,76),AA,II)
!    5           SCRTM(1,61),SCRTM(1,74),SCRTM(1,75),SCRTM(1,76))
! PUT EARTH POSITION IN THE OUTPUT ARRAY EPOSR(NM,3)
      DO 2112 N=1,NM
      DO 2112 JC=1,3
      EPOSR(N,JC)=SCRTM(N,JC)
!     WRITE(6,*) ' MTSTST : EPOSR ',EPOSR(N,JC)
 2112 CONTINUE
 2115 CONTINUE
!
!     ....SAVE SAT COORDINATES IN CENTER OF INTEGRATION SYSTEM
!
      IF(ICBDGM .NE. ITBDGM) THEN
      DO 2125 I=1,3
      DO 2125 J=1,MINTIM
      XSS(J,I)=XSM(J,I)
 2125 CONTINUE
      ENDIF
!
! GET SAT BARYCENTRIC
!
! NOTE THAT HERE IT IS ASSUMED THAT THE SATELLITE TIME TAG IS SS
! BARYCENTRIC. THAT WILL BE TRUE BY VIRTUE OF THE LIGHT TIME PROCEDURE
! IF AND ONLY IF THE OBS TIME TAG IS AT A STATION. IN THE CASE OF MT 39
! OR MT 40, LBPCLK HAS TO BE TRUE OR ELSE CODE HAS TO BE ADDED TO GET SS
! BARCENTRIC TIME, GIVEN THE SATELLITE'S LOCAL TIME
!
      IF (.NOT. LASTSN) THEN
        IF (.NOT. (LXEPHM.AND.ICBDGM.GT.11)) THEN
          CALL BARYC(MJDSN,FSECM,XSM,VSM,MINTIM,IGRP,IORCB,IORMO,       &
     &               IORSUN,IOREM,COEF,COEFMO,COEFS,COEFEM,             &
     &               NM,NDIM1,NDIM2,.FALSE.,.FALSE.,.FALSE.,AA(KPRCBD), &
     &               AA(KPRTBD),SCRTM(1,1),SCRTM(1,7),SCRTM(1,10),      &
     &               CHCBS,SCRTM(1,16),SCRTM(1,31),SCRTM(1,46),         &
     &               SCRTM(1,31),SCRTM(1,46),SCRTM(1,74),SCRTM(1,75),   &
     &               SCRTM(1,76),AA,II)
        ELSE
          CALL BARYCX(MJDSN,FSECM,XSM,VSM,MINTIM,IGRP,IORCB,IORMO,      &
     &               IORSUN,IOREM,COEFX,COEFMO,COEFS,COEFEM,            &
     &               NM,NDIM1,NDIM2,.FALSE.,.FALSE.,.FALSE.,AA(KPRCBD), &
     &               AA(KPRTBD),SCRTM(1,1),SCRTM(1,7),SCRTM(1,10),      &
     &               CHCBS,SCRTM(1,16),SCRTM(1,31),SCRTM(1,46),         &
     &               SCRTM(1,31),SCRTM(1,46),SCRTM(1,74),SCRTM(1,75),   &
     &               SCRTM(1,76),AA,II)
        END IF
      ELSE
        CALL BARYCA(MJDSN,FSECM,XSM,VSM,MINTIM,IGRP,IORCB,IORMO,        &
     &             IORSUN,IOREM,COEFX,COEFMO,COEFS,COEFEM,              &
     &             NM,NDIM1,NDIM2,.FALSE.,.FALSE.,.TRUE.,AA(KPRCBD),    &
     &             AA(KPRTBD),SCRTM(1,1),SCRTM(1,7),SCRTM(1,10),        &
     &             CHCBS,SCRTM(1,16),SCRTM(1,31),SCRTM(1,46),           &
     &             SCRTM(1,31),SCRTM(1,46),SCRTM(1,74),SCRTM(1,75),     &
     &             SCRTM(1,76),AA,II)
      END IF

! PUT SATELLITE POSITION IN THE OUTPUT ARRAY CPOSS(NM,3)
      DO 2119 N=1,NM
      DO 2119 JC=1,3
      CPOSS(N,JC)=SCRTM(N,JC)
!     WRITE(6,*) ' MTSTST : CPOSS ',CPOSS(N,JC)
 2119 CONTINUE
! IF PLANET ORIENTATION PARAMTERS ARE BEING CUT, TRAP TRUE OF REF
! MARS CENTER MINUS STATION COORDINATES IN URKJ (THIS ASSUMES
! AT MOST 2 GROUND LINKS)
      IF(T0XTRO.GT.0.AND.LSTINR) THEN
         DO 2130 N=1,NM
         URKJ(N,1,1)=-XTN(N,1)+XSM(N,1)-XSS(N,1)
         URKJ(N,2,1)=-XTN(N,2)+XSM(N,2)-XSS(N,2)
         URKJ(N,3,1)=-XTN(N,3)+XSM(N,3)-XSS(N,3)
 2130 END DO
      ENDIF
!
!
!     ....XSM NOW HAS BARYCENTRIC SAT COORDINATES
!   END INTERPLANETARY
!
 2200 CONTINUE
!
      IF(LSKIP1) GO TO 2750
!
!***** START HERE TO COMPUTE LINK #1 MEASUREMENT ***********************
!
! COMPUTE RANGES AND UNIT VECTORS FROM STATION TO SATELLITE
      CALL RANGE(XSM,XTN,URNM(1,1,2),RNM,S,NM,.TRUE.)
!
! COMPUTE PERIODIC SPACECRAFT RELATIVISTIC CLOCK CORRECTION
! AND APPLY THE CORRECTION TO THE RANGE.
!
      IF(LITER1) THEN
      IF((IEXIT.EQ.1).AND.(IRLONA.GT.0)) THEN
        IF(NRLTMC.GT.0) THEN
          ISATID=II(KISATN+INDSAT(1)-1)
          DO 2460 ISTID=1,NRLTMC
            IF(ISATID.EQ.IDRLTM(ISTID)) THEN
             ITRL=ITRLTM(ISTID)
             GOTO 2470
            ENDIF
 2460     CONTINUE
          GOTO 2490
        ELSE
         ITRL=IRLONA-1
        ENDIF
 2470   CONTINUE
        LRLCLK=.TRUE.
        CALL RELTMC(XSM,XTN,VSM,MJDSN,FSECM,NM,AA(KRLCOR),              &
     &   ITRL,LRRATE,LADD)
      ENDIF
      ENDIF
 2490 CONTINUE
!
      IF(ITBDGM.NE.ICBDGM) THEN
      IF(LSIMX) CALL OCCULT(MJDSN,FSECM,NM,AA(KAESHD),XSMPC,XSM,        &
     &                       URNM(1,1,2),RSUNST,LOCCLT,LMSHD,.TRUE.,    &
     &                       PSTAT,AA,II)
      ENDIF
! GET TOD UNIT VECTOR AT STATION TIME
      CALL TDORTR(MJDSN,FSECN,URNM(1,1,2),URNM(1,1,1),AA,NM,NM,.TRUE.,  &
     &            .FALSE.,II)
! IF RANGE RATES NOT REQUIRED, SKIP TO 2500
      IF(LRANGE) GO TO 2500
! COMPUTES RANGE RATES AND PARTIALS OF RANGE RATES W.R.T. SAT. POSITIONS
      CALL RNGRAT(VSM,VTN,URNM,RNM,RRNM,RELV,PRRPNM,NM,.TRUE.)
 2500 CONTINUE
!
!***** LINK #1 MEASUREMENT COMPUTED ************************************
!
! IF ONE-WAY SATELLITE TO STATION MEAS., COMPUTATIONS ARE COMPLETE.
!    PATTERN: S1-->T1
      IF(IEXIT.EQ.1.AND..NOT.LLOCRI) RETURN
!
 2750 CONTINUE
      IF(.NOT.LLOCRI) GO TO 2900
!
!  BINRES ALL STATIONS AND SATELLITES IN BLOCK
!
      IF(LSKIP1) GO TO 2890
      CALL INRTSV(COSTHG(1,J1),SINTHG(1,J1),BRTS,BRTSV,NM,MINTIM)
!
! WRITE OUT ALL STATION AND ALL SATELLITE
      CALL UTCET(.FALSE.,NM,MJDSN,FSECN,AA(KCFSC),AA(KA1UT))
!
!     ....STATION COORDINATES RECORD ON BINARY RESIDUAL FILE
!
      IF(.NOT.LBPCLK.OR.LCONS) THEN
      WRITE(IUNT19) (AA(KCFSC-1+JP),JP=1,NM),(COSTHG(JP,J1),JP=1,NM),   &
     &              (SINTHG(JP,J1),JP=1,NM),(BRTS(JP,1),JP=1,NM),       &
     &              (BRTS(JP,2),JP=1,NM), (BRTS(JP,3),JP=1,NM),         &
     &              (BRTSV(JP,1),JP=1,NM),(BRTSV(JP,2),JP=1,NM),        &
     &              (BRTSV(JP,3),JP=1,NM)
      ENDIF
!
 2890 CONTINUE
!
!     ....CONVERT SAT TIME TO UTC FROM ET
!
      CALL UTCET(.FALSE.,NM,MJDSN,FSECM,AA(KCFSC),AA(KA1UT))
!
!-----------------------------------------------------------------------
!
!     ....FOR INTERPLANETARY ONLY, WRITE A SATELLITE RECORD WITH
!     ....COORDINATES WRT CENTER OF INTEGRATION, AND GIVE LAT, LON, HT
!     ....XSS HAS SAVED SAT COORD WRT CENTER OF INTEGRATION
!
      IF( ICBDGM .NE. ITBDGM) THEN
!
         IF( .NOT. LOBORB ) THEN
!
!           GET POS & VEL IN TRUE OF DATE SYSTEM
!
            CALL SATUPD(MJDSN,FSECM,XSS,AA(KTRJX),                      &
     &               AA,NM,MINTIM,.TRUE.,.FALSE.,II,0,1)
            CALL SATUPD(MJDSN,FSECM,VSM,AA(KTRJV),                      &
     &               AA,NM,MINTIM,.FALSE.,.FALSE.,II,0,1)
!
!           COMPUTE RIGHT ASCENSION OF GREENWICH
!           ACROSS ENTIRE BLOCK OF DATA
!
            IF(ICBDGM.EQ.3) THEN
            CALL GRHRAN(MJDSN,FSECM,.FALSE.,.FALSE.,AA(KEQN),AA(KSRTCH),&
     &               AA(KTHETG),COSTHG(1,J2P),SINTHG(1,J2P),NM,AA,II,   &
     &               UTDT(1,J2P),.FALSE.,DUM1)
            ELSE
            CALL ROTXTR(MJDSN,FSECM,.FALSE.,AA(KEQN),AA(KSRTCH),        &
     &               AA(KTHETG),COSTHG(1,J2P),SINTHG(1,J2P),NM,AA,      &
     &               AA(KACOSW),AA(KBSINW),AA(KANGWT),AA(KWT),          &
     &               AA(KACOFW),AA(KBCOFW),II,1)
            ENDIF
!
!           COMPUTE S/C HEIGHT ABOVE ELLIPSOID AND SUB-SAT LAT & LON
!
            CALL SUBTRK(AA(KTRJX),AA(KTHETG),AA(KXY2),AA(KZT),AA(KRT),  &
     &               AA(KSATLT),AA(KSATLN),AA(KSATH),NM)
!
         ENDIF
!
      IF(.NOT.LBPCLK.OR.LCONS) THEN
         WRITE(IUNT19)   (AA(KCFSC-1+JP),JP=1,NM),                      &
     &                   (AA(KTRJX-1+JP),JP=1,NM),                      &
     &                   (AA(KTRJX-1+MINTIM+JP),JP=1,NM),               &
     &                   (AA(KTRJX-1+2*MINTIM+JP),JP=1,NM),             &
     &                   (AA(KSATLT-1+JP),JP=1,NM),                     &
     &                   (AA(KSATLN-1+JP),JP=1,NM),                     &
     &                   (AA(KSATH-1+JP),JP=1,NM)
      ENDIF
!
!     ....IF INTERPLANETARY, XSM COORDINATES ARE BARYCENTRIC NOW
!     ....COMPUTE TRUE OF DATE BARYCENTRIC SAT COORDINATES FOR NEXT
!     ....BINARY RESIDUAL FILE RECORD
!
         IF(LOBORB) THEN
            CALL SATUPD(MJDSN,FSECM,XSM,AA(KTRJX),                      &
     &                               AA,NM,MINTIM,.TRUE.,.FALSE.,II,0,1)
            CALL SATUPD(MJDSN,FSECM,VSM,AA(KTRJV),                      &
     &                              AA,NM,MINTIM,.FALSE.,.FALSE.,II,0,1)
         ENDIF
!
!
      ENDIF
!     ....END OF (ICBDGM .NE. ITBDGM) IF-THEN
!
!-----------------------------------------------------------------------
!
!     ....FOR BOTH INTERPLANETARY AND NON-INTERPLANETARY CASE
!
      IF( .NOT. LOBORB ) THEN
         CALL SATUPD(MJDSN,FSECM,XSM,AA(KTRJX),                         &
     &                            AA,NM,MINTIM,.TRUE.,.FALSE.,II,0,1)
         CALL SATUPD(MJDSN,FSECM,VSM,AA(KTRJV),                         &
     &                            AA,NM,MINTIM,.FALSE.,.FALSE.,II,0,1)
      ENDIF
!
!     ....SATELLITE COORDINATES RECORD ON BINARY RESIDUAL FILE
!     ....IF INTERPLANETARY, COORDINATES ARE BARYCENTRIC ON THIS RECORD
!
      IF(.NOT.LBPCLK.OR.LCONS) THEN
      WRITE(IUNT19)   (AA(KCFSC-1+JP),JP=1,NM),(AA(KTRJX-1+JP),JP=1,NM),&
     &(AA(KTRJX+MINTIM-1+JP),JP=1,NM),(AA(KTRJX+2*MINTIM-1+JP),JP=1,NM),&
     &(AA(KTRJV-1+JP),JP=1,NM),(AA(KTRJV+MINTIM-1+JP),JP=1,NM),         &
     &(AA(KTRJV+2*MINTIM-1+JP),JP=1,NM)
      ENDIF
!
      IF(IEXIT.EQ.1) RETURN
!
!  END BINRES 1ST STA & 1ST SAT
!
 2900 CONTINUE
      J2=J2P
      J2S=J2P
      IF(LTDRSS) J2=J4
      IF(LTDRSS) J2S=J1
!
!***** START HERE TO COMPUTE INERTIAL TRACKING STATION #k POSITIONS ****
!
! IF TRANSIT TIME CORRECTIONS ARE NOT REQUIRED SKIP TO 4000
      IF(LIGHT) GO TO 4000
!
!***** START HERE TO COMPUTE LINK #2 TRANSIT TIMES TO STATION **********
!
! INITIALIZE STATION TIMES TO EQUAL SATELLITE TIMES LESS PREVIOUS
!            TRANSIT TIME
      DO 3000 N=1,NM
      FSECK(N)=TWO*FSECM(N)-FSECN(N)
 3000 END DO
!
      NINTP2=NINTPL(J2)*2

       CALL STATPV(AA,II,LL,LDNPOL,LPOLAD,MJDSN,FSECK,NM,XMK1,&
     &  NINTPL(J2),&
     &   NMP(1,J2),INDP(1,J2),PXPOLE,RPOLE,S,XDPOLE,XTP,PXSPXP(1,1,1,J2)&
     &   ,PXSPLV(1,1,1,J2),NINTP2,.FALSE.,INDSTA(J2S),.FALSE.,          &
     &   LYARA,ISNUMB,PXSPXD(1,1,1,J2),COSTHG(1:NM,J2),SINTHG(1:NM,J2), &
     &   AA(KSRTCH),UTDT(1,J2),S1,FSECK,AA(KDXDNU),LNUTAD)

      CALL GRHRAN(MJDSN,FSECK,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),       &
     &   AA(KTHETG),COSTHG(1,J2),SINTHG(1,J2),NM,AA,II,UTDT(1,J2),      &
     &   .FALSE.,XMK1,DUM1)
! ITERATIVELY COMPUTE STATION TIMES
      IF(LBPCLK) THEN
      CALL LITEDN(AA,XSM,XSS,XTP,XTK,VTK,COSTHG(1,J2),SINTHG(1,J2),   &
     &   RKM,URKM,URKM(1,2,1),URKM(1,3,1),S,MJDSN,ZR,FSECM,FSECK,       &
     &   SIGNL,ZR,DELCTK,RSUNST,GRELT2,PSTAT,NM,SCRTM,II,UTDT(1,J2))
      IF(LCONS) GO TO 3900
      DIFQ=0.D0
      DO IQP=1,NM
        XIFQ=ABS(FSECX(IQP)-FSECK(IQP))
        IF(XIFQ.GT.DIFQ) DIFQ=XIFQ
      ENDDO
      IF(DIFQ.LT.1.D-8) LCONS=.TRUE.
      DO IQP=1,NM
        FSECN(IQP)=FSECN(IQP)+(FSECX(IQP)-FSECK(IQP))
      ENDDO
      GO TO 10
      ENDIF
 3900 CONTINUE
      CALL LITEDN(AA,XSM,XSMPC,XTP,XTK,VTK,COSTHG(1,J2),SINTHG(1,J2),   &
     &   RKM,URKM,URKM(1,2,1),URKM(1,3,1),S,MJDSN,FSECN,FSECM,FSECK,    &
     &   SIGNL,DELCTN,DELCTK,RSUNST,GRELT2,PSTAT,NM,SCRTM,II,UTDT(1,J2))
!
!***** TRANSIT TIMES FOR LINK #2 COMPUTED ******************************
!
 4000 CONTINUE
!
      IF(LOLMD) THEN
        CALL OLDSET(J2,INDSTA(J2S),NM,AA(KSTAIN),II(KIP0OL),II(KNDOLA), &
     &              II(KKIOLA),LOLAJ,LOLMDS,                            &
     &              JABCOF,JPXSPA,JOLPAE,JOLPAN,JOLPAV,JXLOCV,          &
     &              JABCCM,JPXSP1,JOLPXC,JOLPYC,JOLPZC,                 &
     &              JABCEO,JPXSP2,JOLPXP,JOLPYP,JOLPUP,LALOAD,ISITA,    &
     &              XENV)
      ENDIF
      IF(LEOPTO.OR.LOLMDS.OR.LXYZCO) THEN
         CALL OLTIME(MJDSN,FSECK,NM,AA(KANGFC),AA(KSPEED),AA(KSCROL),   &
     &               AA(KSCROL+4*NTOLFR),II(KPTOLS),AA(KANGT),          &
     &               AA(KCONAM),AA(KTWRK1),AA(KGRDAN),AA(KUANG),        &
     &               AA(KFAMP),II(KJDN))
      ENDIF
      IF(LEOPTO) THEN
         CALL OLDEOP(MJDSN,FSECK,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),   &
     &              AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,         &
     &              AA(JPXSPA),NPV0OL(1,J2),NPV0OL(2,J2),NPV0OL(3,J2),  &
     &              II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),        &
     &              AA(JPXSP1),NYZ0OL(1,J2),NYZ0OL(2,J2),NYZ0OL(3,J2),  &
     &              II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),        &
     &              AA(JPXSP2),NEO0OL(1,J2),NEO0OL(2,J2),NEO0OL(3,J2),  &
     &              II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,     &
     &              LEOPTO,XMK1)
      ENDIF


! OBTAIN POLAR MOTION ROTATION MATRICES AND PARTIAL DERIVATIVE MATRICES
!        FROM WHICH TO INTERPOLATE ACROSS THE ENTIRE BLOCK OF DATA

      NINTP2=NINTPL(J2)*2

      CALL STATPVP(AA,II,LL,LDNPOL,LPOLAD,MJDSN,FSECK,NM,XMK1,&
     &  NINTPL(J2),&
     &   NMP(1,J2),INDP(1,J2),PXPOLE,RPOLE,S,XDPOLE,XTP,PXSPXP(1,1,1,J2)&
     &   ,PXSPLV(1,1,1,J2),NINTP2,.TRUE.,INDSTA(J2S),.FALSE.,           &
     &   LYARA,ISNUMB,PXSPXD(1,1,1,J2),COSTHG(1:NM,J2),SINTHG(1:NM,J2), &
     &   AA(KSRTCH),UTDT(1,J2),S1,FSECK,AA(KDXDNU),LNUTAD)

!     DO I=1,NM
!     DO J=1,3
!     XTP(I,J)=XTP(I,J)+COF_COM(J)
!     ENDDO
!     ENDDO

      CALL GRHRAP(MJDSN,FSECK,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),       &
     &   AA(KTHETG),COSTHG(1,J2),SINTHG(1,J2),NM,AA,II,UTDT(1,J2),      &
     &    .FALSE.,XMK1,DUM1)

      IF(.NOT.LOLMDS.AND..NOT.LXYZCO) GO TO 4100
      CALL OLOAD(MJDSN,FSECK,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),       &
     &           AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,            &
     &           AA(JPXSPA),NPV0OL(1,J2),NPV0OL(2,J2),NPV0OL(3,J2),     &
     &           II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),           &
     &           AA(JPXSP1),NYZ0OL(1,J2),NYZ0OL(2,J2),NYZ0OL(3,J2),     &
     &           II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),           &
     &           AA(JPXSP2),NEO0OL(1,J2),NEO0OL(2,J2),NEO0OL(3,J2),     &
     &           II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,LEOPTO, &
     &           isnumb,.FALSE.,NM,LALOAD,AA(KALCOF),II(KSITE),ISITA,   &
     &           XENV)
 4100 CONTINUE
! ROTATE TRUE POLE STATION COORDINATES TO TRUE OF DATE ACROSS ENTIRE
!        BLOCK OF DATA
      CALL INERTP(XTP,COSTHG(1,J2),SINTHG(1,J2),XTK,NM,MINTIM,NM)
! STORE OFF TOD TRACKING STATION COORDINATES FOR BINRES FILE
            DO 4105 IS=1,3
            DO 4105 NN=1,NM
            BRTS(NN,IS)=XTK(NN,IS)
 4105       CONTINUE
! COMPUTE INERTIAL STATION VELOCITIES IF NECESSARY
      IF(.NOT.LRANGE)                                                   &
     &CALL INRTSV(COSTHG(1,J2),SINTHG(1,J2),XTK,VTK,NM,MINTIM)
      CALL TDORTR(MJDSN,FSECK,XTK,XTK,AA,NM,MINTIM,.TRUE.,.TRUE.,II)
      IF(.NOT.LRANGE)                                                   &
     &CALL TDORTR(MJDSN,FSECK,VTK,VTK,AA,NM,MINTIM,.FALSE.,.TRUE.,II)
!
      IF(ICBDGM.EQ.ITBDGM) GO TO 4200
      DO 4107 I=1,3
      DO 4107 J=1,MINTIM
      XSTT(J,I)=XTK(J,I)
 4107 CONTINUE
!
!  PUT PLANET CENTERED COORDINATES INTO BARYCENTRIC
! GET COORDINATE EPHEMERIS TIME AT TRACKING STATION TIME
      DO 4110 N=1,NM
      RKM(N)=FSECK(N)+DELCTK(N)
 4110 END DO
! GET TRACKING BODY BARYCENTRIC
!
      CALL BARYC(MJDSN,RKM,XTK,VTK,MINTIM,IGRP,IORTB,IORMO,IORSUN,      &
     &           IOREM,COEFEM,COEFMO,COEFS,COEFEM,                      &
     &           NM,NDIM1,NDIM2,.FALSE.,.TRUE.,.FALSE.,AA(KPRCBD),      &
     &           AA(KPRTBD),SCRTM(1,1),SCRTM(1,7),SCRTM(1,10),          &
     &           CHEMT,SCRTM(1,16),SCRTM(1,31),SCRTM(1,46),CHMOT,       &
     &           SCRTM(1,16),SCRTM(1,74),SCRTM(1,75),SCRTM(1,76),AA,II)
!    4           SCRTM(1,61),SCRTM(1,74),SCRTM(1,75),SCRTM(1,76))
!
! PUT EARTH POSITION IN THE OUTPUT ARRAY EPOST(NM,3)
      DO 4114 N=1,NM
      DO 4114 JC=1,3
      EPOST(N,JC)=SCRTM(N,JC)
!     WRITE(6,*) ' MTSTST : EPOST ',EPOST(N,JC)
 4114 CONTINUE
! IF PLANET ORIENTATION PARAMTERS ARE BEING CUT, TRAP TRUE OF REF
! MARS CENTER MINUS STATION COORDINATES IN URIJ (THIS ASSUMES
! AT MOST 2 GROUND LINKS)
      IF(T0XTRO.GT.0.AND.LSTINR) THEN
         DO 4130 N=1,NM
         URIJ(N,1,1)=-XTK(N,1)+XSM(N,1)-XSS(N,1)
         URIJ(N,2,1)=-XTK(N,2)+XSM(N,2)-XSS(N,2)
         URIJ(N,3,1)=-XTK(N,3)+XSM(N,3)-XSS(N,3)
 4130 END DO
      ENDIF
!
!   END INTERPLANETARY
!
 4200 CONTINUE
!
!***** INERTIAL TRACKING STATION #k POSITIONS NOW COMPUTED *************
!
!
!***** START HERE TO COMPUTE LINK #2 MEASUREMENT ***********************
!
! COMPUTE RANGES AND UNIT VECTORS FROM STATION TO SATELLITE
      CALL RANGE(XSM,XTK,URKM(1,1,2),RKM,S,NM,.TRUE.)
!
! COMPUTE PERIODIC SPACECRAFT RELATIVISTIC CLOCK CORRECTION
! ONLY IF MEASUREMENT TYPES 39 OR 40 FOR THIS LINK
!
      IF(LITER1) THEN
!
! Specifically state which measurement types to apply correction to.
! Can not use IEXIT=2 and LSKIP1 since this is also done for the
! pilot links for TDRSS type measurements (56 & 58) that should not have
! the correction.
!      IF((IEXIT.EQ.2).AND.(IRLONA.GT.0).AND.LSKIP1) THEN
!
      IF(((MTYPE.EQ.39).OR.(MTYPE.EQ.40)).AND.(IRLONA.GT.0)) THEN
        IF(NRLTMC.GT.0) THEN
          ISATID=II(KISATN+INDSAT(1)-1)
          DO 4260 ISTID=1,NRLTMC
            IF(ISATID.EQ.IDRLTM(ISTID)) THEN
             ITRL=ITRLTM(ISTID)
             GOTO 4270
            ENDIF
 4260     CONTINUE
          GOTO 4290
        ELSE
         ITRL=IRLONA-1
        ENDIF
 4270   CONTINUE
        LRLCLK=.TRUE.
        CALL RELTMC(XSM,XTK,VSM,MJDSN,FSECM,NM,AA(KRLCOR),              &
     &   ITRL,LRRATE,LADD)
      ENDIF
      ENDIF
 4290 CONTINUE
!
      IF(ITBDGM.NE.ICBDGM) THEN
! XSMPC WAS UPDATED IN LITEUP BUT NOT IN LITEDN. IN THE CASE OF LBPCLK
! IT IS STORED IN XSS. THEREFORE, WE NEED TO UPDATE XSMPC WHICH WILL BE
! USED IN OCCULT.
        IF(LBPCLK) THEN
          DO IQP=1,NM
            XSMPC(IQP,1) = XSS(IQP,1)
            XSMPC(IQP,2) = XSS(IQP,2)
            XSMPC(IQP,3) = XSS(IQP,3)
          ENDDo
        ENDIF
      IF(LSIMX) CALL OCCULT(MJDSN,FSECM,NM,AA(KAESHD),XSMPC,XSM,        &
     &                       URKM(1,1,2),RSUNST,LOCCLT,LMSHD,.FALSE.,   &
     &                       PSTAT,AA,II)
      ENDIF
! GET TOD UNIT VECTOR AT STATION TIME
      CALL TDORTR(MJDSN,FSECM,URKM(1,1,2),URKM(1,1,1),                  &
     &            AA,NM,NM,.FALSE.,.FALSE.,II)
! IF RANGE RATES NOT REQUIRED, SKIP TO 4500
      IF(LRANGE) GO TO 4500
! COMPUTES RANGE RATES AND PARTIALS OF RANGE RATES W.R.T. SAT. POSITIONS
      CALL RNGRAT(VSM,VTK,URKM,RKM,RRKM,RELV,PRRPKM,NM,.TRUE.)
 4500 CONTINUE
      IF(.NOT.LLOCRI) GO TO 4900
! WRITE OUT SECOND STATION
      CALL INRTSV(COSTHG(1,J2),SINTHG(1,J2),BRTS,BRTSV,NM,MINTIM)
!
! WRITE OUT FIRST STATION AND FIRST SATELLITE
      CALL UTCET(.FALSE.,NM,MJDSN,FSECK,AA(KCFSC),AA(KA1UT))
!
      IF(LTDR1W)GO TO 4900
!
!     ....STATION COORDINATES RECORD ON BINARY RESIDUAL FILE
!
      WRITE(IUNT19) (AA(KCFSC-1+JP),JP=1,NM),(COSTHG(JP,J2),JP=1,NM),   &
     &              (SINTHG(JP,J2),JP=1,NM),(BRTS(JP,1),JP=1,NM),       &
     &              (BRTS(JP,2),JP=1,NM), (BRTS(JP,3),JP=1,NM),         &
     &              (BRTSV(JP,1),JP=1,NM),(BRTSV(JP,2),JP=1,NM),        &
     &              (BRTSV(JP,3),JP=1,NM)
 4900 CONTINUE
!
!***** LINK #2 MEASUREMENT COMPUTED ************************************
!
! IF 2/3-WAY STA. TO SAT. TO STA. MEASUREMENT, COMPUTATIONS ARE COMPLETE
!    PATTERN: Tk-->Sm-->Tn
      IF(IEXIT.EQ.2) RETURN
! IF TRANSIT TIME CORRECTIONS ARE NOT REQUIRED SKIP TO 6000

      ISATID=II(KISATN+INDSAT(1)-1)
      IF(NINTOT.GT.0) THEN
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF

      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),INDSAT(J2),           &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSN,FSECJ(1),       &
     &   FSECJ(NM),NM,AA,II)
      IF(LIGHT) GO TO 6000
!
!***** START HERE TO COMPUTE LINK #3 TRANSIT TIMES TO SATELLITE ********
!
! INITIALIZE SATELLITE Sj TIMES TO EQUAL STATION Tk TIMES LESS PREVIOUS
!            TRANSIT TIME
      DO 5000 N=1,NM
      FSECJ(N)=TWO*FSECK(N)-FSECM(N)
 5000 END DO
! ITERATIVELY COMPUTE SATELLITE TIMES
      CALL LITEUP(XTK,XSJ,XSJPC,RKJ,URKJ,URKJ(1,2,1),URKJ(1,3,1),S,     &
     &         MJDSN,FSECK,FSECJ,SIGNL,DELCTK,RSUNST,GRELT3,PSTAT,NM,   &
     &         SCRTM,AA(KTPMES+4*MINTIM),LL(KLTPMS+12*MINTIM),ISATID,   &
     &         AA,II,LL,.FALSE.)
!
!***** TRANSIT TIMES FOR LINK #3 COMPUTED ******************************
!
 6000 CONTINUE

      ISATID=II(KISATN+INDSAT(1)-1)
      IF(NINTOT.GT.0) THEN
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF

! OBTAIN SATELLITE POSITIONS AT CORRECT SATELLITE TIMES
      CALL ORBIT(MJDSN,FSECJ,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),   &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSJ,AA(KPXPFK),              &
     &   LNADJ,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),                &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)

!
!     IF(.NOT.LOBORB) GO TO 6100
! GET POS & VEL IN TRUE OF DATE SYSTEM
      CALL TDORTR(MJDSN,FSECJ,XSJ,AA(KTRJX),AA,NM,MINTIM,.TRUE.,        &
     &           .FALSE.,II)
      CALL TDORTR(MJDSN,FSECJ,VSJ,AA(KTRJV),AA,NM,MINTIM,.FALSE.,       &
     &           .FALSE.,II)
! COMPUTE RIGHT ASCENSION OF GREENWICH ACROSS ENTIRE BLOCK OF DATA
      CALL GRHRAN(MJDSN,FSECJ,.FALSE.,.FALSE.,AA(KEQN),AA(KSRTCH),      &
     &   AA(KTHETG),COSTHG(1,J3),SINTHG(1,J3),NM,AA,II,UTDT(1,J3),      &
     &   .FALSE.,DUM,DUM1)
! COMPUTE S/C HEIGHT ABOVE ELLIPSOID AND SUB-SATELLITE LAT & LON
      CALL SUBTRK(AA(KTRJX),AA(KTHETG),AA(KXY2),AA(KZT),AA(KRT),        &
     &   AA(KSATLT),AA(KSATLN),AA(KSATH),NM)
! PRINT TRAJECTORY
      CALL TRAJCT(AA(KA1UT),MJDSN,FSECJ,AA(KTRJX),AA(KTRJV),            &
     &   AA(KSATLT),AA(KSATLN),AA(KSATH),II(KINDH),II(KNMH),AA(KS),     &
     &   AA(KCIP  ),NM,INDSAT(J2),AA,AA(KCOSTH),AA(KSINTH),AA(KDPSR),   &
     &   AA(KXPUT),AA(KYPUT),II)
 6100 CONTINUE
      IF(LVMTFO) CALL VMATO(AA(KA1UT),MJDSN,FSECJ,XSJ,VSJ,AA(KPXPFK),   &
     &   II(KINDH),II(KNMH),AA(KS),AA(KCIP  ),NM,INDSAT(J2),II)
!     IF(LVMTFO) CALL VMATO(AA(KA1UT),MJDSN,FSECJ,XSJ,VSJ,AA(KPXPFJ),
!
!***** START HERE TO COMPUTE LINK #3 MEASUREMENT **********************
!
! COMPUTE RANGES AND UNIT VECTORS FROM STATION TO SATELLITE
      CALL RANGE(XSJ,XTK,URKJ(1,1,2),RKJ,S,NM,.TRUE.)
! GET TOD UNIT VECTOR AT SATION TIME
      CALL TDORTR(MJDSN,FSECK,URKJ(1,1,2),URKJ(1,1,1),AA,NM,NM,         &
     &           .TRUE.,.FALSE.,II)
! IF RANGE RATES NOT REQUIRED, SKIP TO 6500
      IF(LRANGE) GO TO 6500
! COMPUTES RANGE RATES AND PARTIALS OF RANGE RATES W.R.T. SAT. POSITIONS
      CALL RNGRAT(VSJ,VTK,URKJ,RKJ,RRKJ,RELV,PRRPKJ,NM,.TRUE.)
 6500 CONTINUE
      IF(.NOT.LLOCRI) GO TO 6900
!
!
! WRITE OUT SECOND SATELLITE
!
!     ....CONVERT SAT TIME TO UTC FROM ET
!
      CALL UTCET(.FALSE.,NM,MJDSN,FSECJ,AA(KCFSC),AA(KA1UT))
      IF(LOBORB) GO TO 6895
      CALL SATUPD(MJDSN,FSECJ,XSJ,AA(KTRJX),AA,NM,MINTIM,.TRUE.,.FALSE. &
     &,II,0,1)
      CALL SATUPD(MJDSN,FSECJ,VSJ,AA(KTRJV),AA,NM,MINTIM,.FALSE.,       &
     &            .FALSE.,II,0,1)
 6895 CONTINUE
      WRITE(IUNT19)   (AA(KCFSC-1+JP),JP=1,NM),(AA(KTRJX-1+JP),JP=1,NM),&
     &(AA(KTRJX+MINTIM-1+JP),JP=1,NM),(AA(KTRJX+2*MINTIM-1+JP),JP=1,NM),&
     &(AA(KTRJV-1+JP),JP=1,NM),(AA(KTRJV+MINTIM-1+JP),JP=1,NM),         &
     &(AA(KTRJV+2*MINTIM-1+JP),JP=1,NM)
!
 6900 CONTINUE
!
!***** LINK #3 MEASUREMENT COMPUTED ************************************
!
! IF SAT. TO STA. TO SAT. TO STA. MEASUREMENT, COMPUTATIONS ARE COMPLETE
!    PATTERN: Sj-->Tk-->Sm-->Tn
      IF(IEXIT.EQ.3) RETURN
!
!***** START HERE TO COMPUTE INERTIAL TRACKING STATION #i POSITIONS ****
!
! IF TRANSIT TIME CORRECTIONS ARE NOT REQUIRED SKIP TO 8000
      IF(LIGHT) GO TO 8000
!
!***** START HERE TO COMPUTE LINK #4 TRANSIT TIMES TO STATION **********
!
! INITIALIZE STATION Ti TIMES TO EQUAL SATELLITE Sj TIMES LESS PREVIOUS
!            TRANSIT TIME
      DO 7000 N=1,NM
      FSECI(N)=TWO*FSECJ(N)-FSECK(N)
 7000 END DO
!
      NINTP2=NINTPL(J3)*2
       CALL STATPV(AA,II,LL,LDNPOL,LPOLAD,MJDSN,FSECI,NM,XMK1,&
     &  NINTPL(J2),&
     &   NMP(1,J2),INDP(1,J2),PXPOLE,RPOLE,S,XDPOLE,XTP,PXSPXP(1,1,1,J2)&
     &   ,PXSPLV(1,1,1,J2),NINTP2,.FALSE.,INDSTA(J2S),.FALSE.,          &
     &   LYARA,ISNUMB,PXSPXD(1,1,1,J2),COSTHG(1:NM,J2),SINTHG(1:NM,J2), &
     &   AA(KSRTCH),UTDT(1,J2),S1,FSECI,AA(KDXDNU),LNUTAD)

      CALL GRHRAN(MJDSN,FSECI,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),       &
     &   AA(KTHETG),COSTHG(1,J3),SINTHG(1,J3),NM,AA,II,UTDT(1,J3),      &
     &   .FALSE.,XMK1,DUM1)
! ITERATIVELY COMPUTE STATION TIMES
      CALL LITEDN(AA,XSJ,XSJPC,XTP,XTI,VTI,COSTHG(1,J3),SINTHG(1,J3),   &
     &   RIJ,URIJ,URIJ(1,2,1),URIJ(1,3,1),S,MJDSN,FSECK,FSECJ,FSECI,    &
     &   SIGNL,DELCTK,DELCTI,RSUNST,GRELT4,PSTAT,NM,SCRTM,II,UTDT(1,J3))
!
!***** TRANSIT TIMES FOR LINK #4 COMPUTED ******************************
!
 8000 CONTINUE
!
      IF(LOLMD) THEN
        CALL OLDSET(J3,INDSTA(J3),NM,AA(KSTAIN),II(KIP0OL),II(KNDOLA),  &
     &              II(KKIOLA),LOLAJ,LOLMDS,                            &
     &              JABCOF,JPXSPA,JOLPAE,JOLPAN,JOLPAV,JXLOCV,          &
     &              JABCCM,JPXSP1,JOLPXC,JOLPYC,JOLPZC,                 &
     &              JABCEO,JPXSP2,JOLPXP,JOLPYP,JOLPUP,LALOAD,ISITA,    &
     &              XENV)
      ENDIF
      IF(LEOPTO.OR.LOLMDS.OR.LXYZCO) THEN
         CALL OLTIME(MJDSN,FSECI,NM,AA(KANGFC),AA(KSPEED),AA(KSCROL),   &
     &               AA(KSCROL+4*NTOLFR),II(KPTOLS),AA(KANGT),          &
     &               AA(KCONAM),AA(KTWRK1),AA(KGRDAN),AA(KUANG),        &
     &               AA(KFAMP),II(KJDN))
      ENDIF
      IF(LEOPTO) THEN
         CALL OLDEOP(MJDSN,FSECI,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),   &
     &              AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,         &
     &              AA(JPXSPA),NPV0OL(1,J3),NPV0OL(2,J3),NPV0OL(3,J3),  &
     &              II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),        &
     &              AA(JPXSP1),NYZ0OL(1,J3),NYZ0OL(2,J3),NYZ0OL(3,J3),  &
     &              II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),        &
     &              AA(JPXSP2),NEO0OL(1,J3),NEO0OL(2,J3),NEO0OL(3,J3),  &
     &              II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,     &
     &              LEOPTO,XMI1)
      ENDIF


! OBTAIN POLAR MOTION ROTATION MATRICES AND PARTIAL DERIVATIVE MATRICES
!        FROM WHICH TO INTERPOLATE ACROSS THE ENTIRE BLOCK OF DATA

      NINTP2=NINTPL(J3)*2

      CALL STATPVP(AA,II,LL,LDNPOL,LPOLAD,MJDSN,FSECI,NM,XMI1,&
     &  NINTPL(J3),&
     &   NMP(1,J3),INDP(1,J3),PXPOLE,RPOLE,S,XDPOLE,XTP,PXSPXP(1,1,1,J3)&
     &   ,PXSPLV(1,1,1,J3),NINTP2,.TRUE.,INDSTA(J3),.FALSE.,            &
     &   LYARA,ISNUMB,PXSPXD(1,1,1,J3),COSTHG(1:NM,J3),SINTHG(1:NM,J3), &
     &   AA(KSRTCH),UTDT(1,J3),S1,FSECI,AA(KDXDNU),LNUTAD)


      CALL GRHRAP(MJDSN,FSECI,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),       &
     &   AA(KTHETG),COSTHG(1,J3),SINTHG(1,J3),NM,AA,II,UTDT(1,J3),      &
     &   .FALSE.,XMI1,DUM1)

      IF(.NOT.LOLMDS.AND..NOT.LXYZCO) GO TO 8050
      CALL OLOAD(MJDSN,FSECI,NM,AA(JABCOF),AA(KANGFC),AA(KSPEED),       &
     &           AA(JXLOCV),XTP,AA(KSCROL),AA(KROTMT),LOLAJ,            &
     &           AA(JPXSPA),NPV0OL(1,J3),NPV0OL(2,J3),NPV0OL(3,J3),     &
     &           II(JOLPAE),II(JOLPAN),II(JOLPAV),AA(JABCCM),           &
     &           AA(JPXSP1),NYZ0OL(1,J3),NYZ0OL(2,J3),NYZ0OL(3,J3),     &
     &           II(JOLPXC),II(JOLPYC),II(JOLPZC),AA(JABCEO),           &
     &           AA(JPXSP2),NEO0OL(1,J3),NEO0OL(2,J3),NEO0OL(3,J3),     &
     &           II(JOLPXP),II(JOLPYP),II(JOLPUP),LOLMDS,LXYZCO,LEOPTO, &
     &           isnumb,.FALSE.,NM,LALOAD,AA(KALCOF),II(KSITE),ISITA,   &
     &           XENV)
 8050 CONTINUE
! ROTATE TRUE POLE STATION COORDINATES TO TRUE OF DATE ACROSS ENTIRE
!        BLOCK OF DATA
      CALL INERTP(XTP,COSTHG(1,J3),SINTHG(1,J3),XTI,NM,MINTIM,NM)
! STORE OFF TOD TRACKING STATION FOR BINRES COMPUTATIONS
            DO 8060 IS=1,3
            DO 8060 NN=1,NM
            BRTS(NN,IS)=XTI(NN,IS)
 8060       CONTINUE
      IF(.NOT.LRANGE)                                                   &
     &CALL INRTSV(COSTHG(1,J3),SINTHG(1,J3),XTI,VTI,NM,MINTIM)
      CALL TDORTR(MJDSN,FSECI,XTI,XTI,AA,NM,MINTIM,.TRUE.,.TRUE.,II)
!
!***** INERTIAL TRACKING STATION #i POSITIONS NOW COMPUTED *************
!
!
!***** START HERE TO COMPUTE LINK #4 MEASUREMENT ***********************
!
! COMPUTE RANGES AND UNIT VECTORS FROM STATION TO SATELLITE
      CALL RANGE(XSJ,XTI,URIJ(1,1,2),RIJ,S,NM,.TRUE.)
! GET TOD UNIT VECTOR AT STATION TIME
      CALL TDORTR(MJDSN,FSECI,URIJ(1,1,2),URIJ,AA,NM,NM,.FALSE.,        &
     &            .FALSE.,II)
! IF RANGE RATES NOT REQUIRED, RETURN
      IF(LRANGE) GO TO 8100
! COMPUTE INERTIAL STATION VELOCITIES
      CALL TDORTR(MJDSN,FSECI,VTI,VTI,AA,NM,MINTIM,.FALSE.,.TRUE.,II)
! COMPUTES RANGE RATES AND PARTIALS OF RANGE RATES W.R.T. SAT. POSITIONS
      CALL RNGRAT(VSJ,VTI,URIJ,RIJ,RRIJ,RELV,PRRPIJ,NM,.TRUE.)
 8100 CONTINUE
      IF(.NOT.LLOCRI) RETURN
! WRITE OUT THIRD STATION
      CALL INRTSV(COSTHG(1,J3),SINTHG(1,J3),BRTS,BRTSV,NM,MINTIM)
!
! WRITE OUT FIRST STATION AND FIRST SATELLITE
      CALL UTCET(.FALSE.,NM,MJDSN,FSECI,AA(KCFSC),AA(KA1UT))
!
!     ....STATION COORDINATES RECORD ON BINARY RESIDUAL FILE
!
      WRITE(IUNT19) (AA(KCFSC-1+JP),JP=1,NM),(COSTHG(JP,J3),JP=1,NM),   &
     &              (SINTHG(JP,J3),JP=1,NM),(BRTS(JP,1),JP=1,NM),       &
     &              (BRTS(JP,2),JP=1,NM), (BRTS(JP,3),JP=1,NM),         &
     &              (BRTSV(JP,1),JP=1,NM),(BRTSV(JP,2),JP=1,NM),        &
     &              (BRTSV(JP,3),JP=1,NM)
!
!***** LINK #4 MEASUREMENT COMPUTED ************************************
!
      RETURN
60000 FORMAT(' EXECUTION TERMINATING IN MTSTST')
60001 FORMAT(' NM GT ',I10,' FOR SAT VLBI ')
      END
