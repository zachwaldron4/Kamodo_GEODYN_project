      SUBROUTINE SHOGPS(AA,II)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      CHARACTER*96 CARD,CARD2
      DIMENSION AA(12,1),A(12),II(1)
      EQUIVALENCE (A(1),CARD)
!
      REWIND 43
      OPEN(UNIT=42,FILE='ftn42',STATUS='NEW',FORM='FORMATTED')
      NCARDS=0
   10 CONTINUE
      READ(43,5000,END=100) CARD
      READ(CARD(22:30),5002) OA
      READ(CARD(33:41),5002) RATIO
      IF(OA.LT.300.D0) THEN
         WRITE(42,5000) CARD
         IF(RATIO.GT..999999D0) GO TO 10
      ENDIF
      NCARDS=NCARDS+1
      DO 20 IQP=1,12
      AA(IQP,NCARDS)=A(IQP)
   20 END DO
      GO TO 10
  100 CONTINUE
      CLOSE(UNIT=43)
      OPEN(UNIT=44,FILE='ftn44',STATUS='NEW',FORM='FORMATTED')
      OPEN(UNIT=45,FILE='ftn45',STATUS='NEW',FORM='FORMATTED')
      IF(NCARDS.EQ.0) THEN
       WRITE(6,6000)
       WRITE(6,6000)
       WRITE(6,6000)
       WRITE(6,6001)
        RETURN
      ENDIF
      IF(NCARDS.EQ.1) THEN
       NSAT=1
       MAXTIM=1
       GO TO 605
      ENDIF
!
! SORT THE SHADOWING INFORMATION BY SATID, THEN BY TIME
!
!  THIS IS PROBABLY NOT NECESSARY
!
      LNEC=.FALSE.
      IF(.NOT.LNEC) GO TO 505
!
      NCARD1=NCARDS-1
      DO 500 I=1,NCARD1
      DO 110 IQP=1,3
      A(IQP)=AA(IQP,I)
  110 END DO
      READ(CARD,5001) ISAT1,ITM1
      J1=I+1
      DO 400 J=J1,NCARDS
      DO 120 IQP=1,3
      A(IQP)=AA(IQP,J)
  120 END DO
      READ(CARD,5001) ISAT2,ITM2
      LSORT=(ISAT2.LT.ISAT1).OR.((ISAT1.EQ.ISAT2).AND.(ITM2.LT.ITM1))
      IF(LSORT) THEN
        DO 130 IQP=1,12
        A(IQP)=AA(IQP,J)
        AA(IQP,J)=AA(IQP,I)
        AA(IQP,I)=A(IQP)
  130   CONTINUE
        ISAT1=ISAT2
        ITM1=ITM2
        GO TO 400
      ENDIF
  400 END DO
  500 END DO
!
  505 CONTINUE
!
! COUNT SHADOWED SATELLITES AND MAX TIMES PER SATELLITE
! AND OUTPUT SORTED FILE
      WRITE(6,6000)
      WRITE(6,6000)
      WRITE(6,6000)
      WRITE(6,6000)
      WRITE(6,6002)
      WRITE(6,6000)
      IDP=-99
      MAXTIM=-99
      NTM=0
      NSAT=0
      DO 600 I=1,NCARDS
      DO 510 IQP=1,12
      A(IQP)=AA(IQP,I)
  510 END DO
      READ(CARD,5001) ISAT1,ITM1
      IF(ISAT1.NE.IDP) THEN
        NSAT=NSAT+1
        NTST=MAXTIM
        IF(NTM.GT.NTST) MAXTIM=NTM
        IDP=ISAT1
        NTM=0
      WRITE(6,6003) ISAT1
      ENDIF
      NTM=NTM+1
  600 END DO
  605 CONTINUE
      WRITE(6,6000)
      WRITE(6,6004) NSAT,MAXTIM
!
!
      IDP=-99
      MAXTM=-99
      NTM=0
      NSAT=0
      NSATOK=0
      DO 800 I=1,NCARDS
      DO 710 IQP=1,12
      A(IQP)=AA(IQP,I)
  710 END DO
      READ(CARD,5001) ISAT1,ITM1
      IF(ISAT1.NE.IDP) THEN
        IF(NSAT.GE.1) THEN
          IIPNT=2*NCARDS*12+(NSAT-1)*3
          IP2=I-1
          IP1=I-NTM
          CALL SHDCUL(IDP,NTM,AA(1,IP1),II(IIPNT),NTMO,LOK)
          IF(LOK.AND.NTMO.GT.MAXTM) MAXTM=NTMO
          IF(LOK) NSATOK=NSATOK+1
        ENDIF
        NSAT=NSAT+1
        IDP=ISAT1
        NTM=0
      ENDIF
      NTM=NTM+1
  800 END DO
      IIPNT=2*NCARDS*12+(NSAT-1)*3
      IP1=NCARDS+1-NTM
      CALL SHDCUL(ISAT1,NTM,AA(1,IP1),II(IIPNT),NTMO,LOK)
      IF(LOK.AND.NTMO.GT.MAXTM) MAXTM=NTMO
      IF(LOK) NSATOK=NSATOK+1
!
!
      WRITE(6,6000)
      WRITE(6,6000)
      WRITE(6,6000)
      REWIND 44
      REWIND 45
      OPEN(UNIT=46,FILE='ftn46',STATUS='NEW',FORM='FORMATTED')
      OPEN(UNIT=47,FILE='ftn47',STATUS='NEW',FORM='FORMATTED')
      IF(NSATOK.LE.0) THEN
         WRITE(6,6000)
         WRITE(6,6000)
         WRITE(6,6010)
         WRITE(6,6011)
      ELSE
         WRITE(6,6012) NSATOK
         WRITE(6,6013)
         DO 810 I=1,96
         CARD(I:I)=' '
  810    CONTINUE
         CARD(1:6)='GSHAD '
         WRITE(CARD(6:17),7000) NSATOK,MAXTM
         WRITE(46,5000) CARD
         NTM=0
         ISATP=-99
         DO 815 I=1,96
         CARD2(I:I)=' '
  815    CONTINUE
  820    CONTINUE
         READ(44,5000,END=900) CARD
         READ(CARD,5001) ISATN
         IF(ISATN.NE.ISATP.AND.ISATP.NE.-99) THEN
           WRITE(6,6003) ISATP
           NX=MAXTM-NTM
           IF(NX.GT.0) THEN
             DO 830 I=1,NX
             WRITE(46,5000) CARD2
  830        CONTINUE
           ENDIF
           NTM=0
         ENDIF
         NTM=NTM+1
         ISATP=ISATN
         WRITE(46,5000) CARD
         GO TO 820
  900    CONTINUE
         WRITE(6,6003) ISATP
         NX=MAXTM-NTM
         IF(NX.GT.0) THEN
           DO 930 I=1,NX
           WRITE(46,5000) CARD2
  930      CONTINUE
         ENDIF
         CALL YPOLY
         CLOSE (44)
         CLOSE (46)
      ENDIF
!
!
      NSATP=NSAT-NSATOK
      IF(NSATP.LE.0) THEN
         WRITE(6,6000)
         WRITE(6,6000)
         WRITE(6,6020)
         WRITE(6,6021)
      ELSE
         WRITE(6,6022) NSATP
         WRITE(6,6023)
         DO 1810 I=1,96
         CARD(I:I)=' '
 1810    CONTINUE
         NTM=0
         ISATP=-99
         DO 1815 I=1,96
         CARD2(I:I)=' '
 1815    CONTINUE
 1820    CONTINUE
         READ(45,5000,END=1900) CARD
         READ(CARD,5001) ISATN
         IF(ISATN.NE.ISATP.AND.ISATP.NE.-99) THEN
           WRITE(6,6003) ISATP
           NTM=0
         ENDIF
         NTM=NTM+1
         ISATP=ISATN
         WRITE(47,5000) CARD
         GO TO 1820
 1900    CONTINUE
         WRITE(6,6003) ISATP
      ENDIF
      CLOSE (45)
      CLOSE (47)
      RETURN
 5000 FORMAT(A96)
 5001 FORMAT(I7,2X,I10)
 5002 FORMAT(F9.5)
 6000 FORMAT(' ')
 6001 FORMAT(' GPSSHD OPTION SELECTED BUT NO SHADOWING OCCURRED')
 6002 FORMAT(' THE FOLLOWING IS A LIST OF SATELLITES THAT IS SHADOWED')
 6003 FORMAT(' ',I10)
 6004 FORMAT(' THERE ARE ',I4,' SATELLITES SHADOWED. MAX # EVENTS:',I5)
 6010 FORMAT(' NO SATELLITES ARE CLEANLY SHADOWED.')
 6011 FORMAT(' UNIT 46 WILL BE NULL.')
 6012 FORMAT(' THERE ARE,', I3,' SATELLITES  CLEANLY SHADOWED:')
 6013 FORMAT(' UNIT 46 WILL CONTAIN MORE INFORMATION.')
 6020 FORMAT(' ALL SATELLITES ARE CLEANLY SHADOWED.')
 6021 FORMAT(' UNIT 47 WILL BE NULL.')
 6022 FORMAT(' THERE ARE,', I3,' SATELLITES NOT CLEANLY SHADOWED:')
 6023 FORMAT(' UNIT 47 WILL CONTAIN MORE INFORMATION.')
 6024 FORMAT(' CHECK UNIT 43 FOR COMPLETE HISTORY.')
 7000 FORMAT(2I6)
      END
