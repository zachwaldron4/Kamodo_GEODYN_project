!$NPVECT
      SUBROUTINE NPVECT(MJDSC,FSEC,DPSI,EPST,EPSM,ETA,THTA,Z,NM,        &
     &                  SCRTCH,ROTMAT,EQN,NMA,LONLEQ,                   &
     &                  DPSIIN,EPSTIN,TNTINT,TNTMID,LPART,DXDNUT,       &
     &                  DPSIEP,EPSTEP,XMN,TN)
!********1*********2*********3*********4*********5*********6*********7**
! NPVECT           83/03/31            8303.0    PGMR - D. ROWLANDS
!
!  FUNCTION:  CALL SUBROUTINE DEQN WITH A VECTOR OF TIMES
!             SELECTED FROM THE VECTOR FSEC. EACH CALL TO DEQN
!             MUST HAVE ITS VECTOR OF TIMES COMPLETELY WITHIN
!             A NUTATION MATRIX INTERPOLATION PERIOD.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSC    I    S    NUMBER OF SECONDS SINCE XXX 243000.5.
!                      ALL TIMES IN FSEC ARE TIMES SINCE MJDSC
!   FSEC     I    A    TIME SINCE MJDSC
!   DPSI     I    A    NUTATION IN LONGITUDE
!   EPST     I    A    TRUE OBLIQUITY
!   EPSM     I    A    MEAN OBLIQUITY
!   ETA      I    A    PRECESSION ELEMENT
!   THTA     I    A    PRECESSION ELEMENT
!   Z        I    A    PRECESSION ELEMENT
!   NM       I    S    NUMBER OF ROTMAT AND EQUATION OF
!                      EQUINOX REQUESTED.
!   SCRTCH        A    11 TIMES NM
!   ROTMAT   O    A    NP ROTATION MATRIX, MEAN OF 50 TO TRUE
!                      OF FSEC.
!   EQN      O    A    EQUATION OF EQUINOX AT FSEC
!   NMA      I    S    ACTUAL FIRST DIMENSION OF ROTMAT
!   LONLEQ   I         .TRUE. IF ONLY EQUATION OF EQUINOX REQUEST
!   LPART    I    S    IN THIS CALL WE WILL COMPUTE PARTIALS OF
!                      STATION COORDINATES/WRT NUTATION CORRECTIONS
!
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      DIMENSION ILP(4),FSEC(NM),EPST(NM),ETA(NM),THTA(NM),Z(NM),       &
     &          EPSM(NM),SCRTCH(NM,11),ROTMAT(NMA,9),EQN(NM),DPSI(NM)
      DIMENSION DPSIIN(NNUT),EPSTIN(NNUT),TNTINT(NNUT),TNTMID(NNUT)
      DIMENSION DXDNUT(3,2,NM),DPSIEP(NNUT),EPSTEP(NNUT),XMN(3)
      DIMENSION R1(3,3),R2(3,3)
      DIMENSION TN(3,2,2)
! VECTORS OF PARTIALS XNM/DPSI XNM/EPST PER OBS
      DIMENSION VPDPST1(3),VPEPST1(3)
      DIMENSION VPDPST2(3),VPEPST2(3)
      COMMON/CBLOKL/LIGHT ,LNRATE,LNREFR,LPOLAD,LTDRIV,LNANT ,LNTRAK,   &
     &       LASER ,LGPART,LGEOID,LETIDE,LOTIDE,LNTIME,LAVGRR,LRANGE,   &
     &       LSSTMD,LSSTAJ,LNTDRS,LPSBL,LACC,LAPP,LTARG,LTIEOU,LEOTRM,  &
     &       LSURFM,LGEOI2,LSSTM2,LOTID2,LOTRM2,LETID2,LNUTAD
      COMMON/EPHMPT/NTOT,NTOTS,NNPDPR,NUTORD,IBODDG(8),IGRPDG(4),       &
     &              NENPD,INRCD(2),KPLAN(11),NINEP,NEPHMR,NEPHEM,       &
     &              IBHINT,NINTBH,NXEPHP
      COMMON/EPHSET/EMFACT,DTENPD,DTINPD,FSC1EN,FSCENP(2),FSCINP(4),    &
     &   FSDINP(4),XEPHST
      COMMON/NUTINF/NNUT,NNUTAA,NXNUTA
      COMMON/NUTFAC/SYNT
      COMMON/NUTHLD /NUTLST
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************

! DEBUG
!     DO JJ=1,NNUT
!     write(6,*)'NPVECT',DPSIIN(JJ),EPSTIN(JJ),TNTINT(JJ),TNTMID(JJ)
!     ENDDO
!     WRITE(6,*)' NP1 OBS TIME', MJDSC,FSEC(1),NM
! DEBUG
!
      IFPD=1
      NPD=1
      IAPD=1
! IF THE NUMBER OF INTERPOLATION PERIODS IS ONE, THEN ONE VECTOR CALL
      IF(NINEP.EQ.1) GO TO 60
! CALCULATE FIRST INTERVAL
      TEST=MJDSC+FSEC(1)
      DO 10 IFPD=1,3
      IF(TEST.LT.FSCINP(IFPD+1)) GO TO 15
   10 END DO
      WRITE(6,12345) TEST
      WRITE(6,12346) FSCINP
      STOP
   15 CONTINUE
! CALCULATE LAST INTERVAL
      TEST=MJDSC+FSEC(NM)
      DO 20 ILPD=IFPD,3
      IF(TEST.LE.FSCINP(ILPD+1)) GO TO 25
   20 END DO
      WRITE(6,12347) TEST
      WRITE(6,12346) FSCINP
      STOP
   25 CONTINUE
      NPD=ILPD-IFPD+1
      IF(NPD.EQ.1) GO TO 60
      IFPT=1
      ILM1=ILPD-1
      DO 50 IPD=IFPD,ILM1
      DO 40 I=IFPT,NM
      TTEST=MJDSC+FSEC(I)
      IF(TTEST.GT.FSCINP(IPD+1)) GO TO 45
   40 END DO
      WRITE(6,12348) I,TEST
      WRITE(6,12346) FSCINP
      STOP
   45 ILP(IAPD)=I-1
      IFPT=I
      IAPD=IAPD+1
   50 END DO
   60 ILP(IAPD)=NM
      IFPT=1
      IPD=IFPD
! CALL DEQN FOR EACH INTERPOLATION PERIOD
      DO 100 IAPD=1,NPD
      NMT=ILP(IAPD)-IFPT+1
      CALL DEQN(IPD,LONLEQ,MJDSC,FSEC(IFPT),THTA(IFPT),Z(IFPT),         &
     &   ETA(IFPT),EPST(IFPT),EPSM(IFPT),DPSI(IFPT),ROTMAT(IFPT,1),     &
     &   ROTMAT(IFPT,2),ROTMAT(IFPT,3),ROTMAT(IFPT,4),ROTMAT(IFPT,5),   &
     &   ROTMAT(IFPT,6),ROTMAT(IFPT,7),ROTMAT(IFPT,8),ROTMAT(IFPT,9),   &
     &   EQN(IFPT),SCRTCH,NMT)
      IFPT=ILP(IAPD)+1
      IPD=IPD+1
  100 END DO


!   HERE FOR USER INPUT DEPS EPST CORRECTION
      IF(NNUT.LE.0) GO TO 600
!   INTERPOLATE AND POPULATE DPSI,EPST
      TTEST=MJDSC+FSEC(1)
      DO I=2,NNUT
      IF(TNTMID(I).GT.TTEST) GO TO 115
      ENDDO
      NNUT1=NNUT
      NNUT2=NNUT
  115 NNUT1=I-1
      NNUT2=NNUT1

      IF(NM.EQ.1) GOTO 130
!   WHEN MORE THAN ONE INTERVAL, CALCULATE LAST INTERVAL
      TTEST=MJDSC+FSEC(NM)
      II=0
      DO 120 I=NNUT1,NNUT
      III=NNUT-II
      II=II+1
      IF(TTEST.GE.TNTMID(III)) GO TO  125
  120 END DO
      write(6,99999) MJDSC,FSEC
99999 FORMAT('NPVECT : TERMINATING WITH STOP 6969  MJDSC,FSEC= ',      &
     &   I12/(1X,3G24.16))
      STOP 6969
  125 NNUT2=III
      NUTVN=NNUT2
  130 NINTNU=NNUT2-NNUT1+1
!   NOW FIND LATEST MEASUREMENT IN EACH GROUP``
!     write(6,*)' dbg summary ',NNUT,NNUT1,NNUT2,NUTVN,LPART

!   Re-EVALUATE ROTATION MATRICES
!   FORM PARTIALS
!  WE ARE ASSUMING THAT THERE IS ONLY ONE OBSERVATION IN THE CALLS FOR PARTIALS

      NNUT1=NNUT2
      NNUT2=NNUT2+1
      NUTLST=NNUT2
! NUTATION CORRECTIONS FROM INPUT
      DPSI1=DPSIIN(NNUT1)
      EPST1=EPSTIN(NNUT1)
      DPSI2=DPSIIN(NNUT2)
      EPST2=EPSTIN(NNUT2)
      IF(TTEST.LE.TNTMID(NNUT1).OR.TTEST.GT.TNTMID(NNUT2)) THEN
      WRITE(6,*)'dbg OUT RANGE ',TNTMID(NNUT1),TTEST,TNTMID(NNUT2)
      ENDIF
      FACT=(TNTMID(NNUT2)-TNTMID(NNUT1))/(TTEST-TNTMID(NNUT1))
      SYNT=1.D0/FACT
      DPSIO=(DPSI2+(FACT-1.D0)*DPSI1)/FACT
      EPSTO=(EPST2+(FACT-1.D0)*EPST1)/FACT

!  CORRECT EPHEMERIS VALUES BY NUTATE CORRECTION
      DO JJ=1,NM
      DPSI(JJ)=DPSI(JJ)+DPSIO
      EPST(JJ)=EPST(JJ)+EPSTO
      ENDDO

      CALL DEQN(IPD,LONLEQ,MJDSC,FSEC,THTA,Z, ETA,EPST,EPSM,DPSI,       &
     &   ROTMAT(1,1),ROTMAT(1,2),ROTMAT(1,3),ROTMAT(1,4),ROTMAT(1,5),   &
     &   ROTMAT(1,6),ROTMAT(1,7),ROTMAT(1,8),ROTMAT(1,9),EQN,SCRTCH,NM)

!      write(6,*)' dbg  rot ',ROTMAT(1,1),ROTMAT(1,2),ROTMAT(1,3)
!      write(6,*)' dbg  rot ',ROTMAT(1,4),ROTMAT(1,5),ROTMAT(1,6)
!      write(6,*)' dbg  rot ',ROTMAT(1,7),ROTMAT(1,8),ROTMAT(1,9)


! PARTIAL DERIVATIVES

      IF(LPART.AND.LNUTAD.AND.LSTINR) THEN

! TOTAL  NUTATION VALUES AT TWO NEIGHBORING MID POINTS

      DPSIT1=DPSIEP(NNUT1)+DPSI1
      EPSTT1=EPSTEP(NNUT1)+EPST1
      DPSIT2=DPSIEP(NNUT2)+DPSI2
      EPSTT2=EPSTEP(NNUT2)+EPST2

! PARTIALS AT THE TWO NEIGHBORING POINTS
      CALL VTD_ROTMAT_DER(3,-DPSIT1,1.D0,R1)
      CALL VTD_ROTMAT_DER(1, EPSTT1,1.D0,R2)
      CALL MULTI(R1,XMN,VPDPST1,3,3,1)
      CALL MULTI(R2,XMN,VPEPST1,3,3,1)

      CALL VTD_ROTMAT_DER(3,-DPSIT2,1.D0,R1)
      CALL VTD_ROTMAT_DER(1, EPSTT2,1.D0,R2)
      CALL MULTI(R1,XMN,VPDPST2,3,3,1)
      CALL MULTI(R2,XMN,VPEPST2,3,3,1)

      DO KK=1,3
      TN(KK,1,1)=VPDPST1(KK)
      TN(KK,2,1)=VPEPST1(KK)
      TN(KK,1,2)=VPDPST2(KK)
      TN(KK,2,2)=VPEPST2(KK)
      ENDDO


      ENDIF


 600  CONTINUE
      RETURN
12345 FORMAT(' TERMINATION IN NPVECT;FIRST REQUESTED TIME= ',D25.16)
12346 FORMAT(' INTERPOLATION ENDPOINT TIMES=   ',4D25.16)
12347 FORMAT(' TERMINATION IN NPVECT;LAST REQUESTED TIME= ',D25.16)
12348 FORMAT(' TERMINATION IN NPVECT;NTH REQUESTED TIME= ',I10,D25.16)
      END
