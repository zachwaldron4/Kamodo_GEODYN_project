!$DRGPCN
      SUBROUTINE DRGPCN(PMPP,RESID,WT,NP,NRMTOT,NM,ATPA,ATPL,SCRTCH,    &
     &                 PARMVC,NREDDR,LREDDR,IREDDR,WTADRG,CTMDRG,       &
     &                 RTGDRG,IDIM2,IDIMT,IDIM4,IK,LAVOID,IFWEDR,ICALL)
!********1*********2*********3*********4*********5*********6*********7**
! GA9PCN
!
! FUNCTION:  CALL SUMNM WITH THE RIGHT CONSTRAINT INFORMATION
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   PMPP     I         FULL ARRAY OF PARTIALS(INCLUDING ZEROS WHERE
!                      NECCESSARY) FOR EACH MEASUREMENT.SOMETIMES A
!                      INCLUDES ONLY ARC,SOMTIMES ARC&COMMON.
!   RESID    I         RESIDUAL ARRAY
!   WT       I         MEASUREMENT WEIGHT ARRAY
!   NP       I         NUMPER OF PARAMETERS
!   NRMTOT   I         MAXIMUM DIMENSION OF NORMAL MATRIX
!   NM       I         NUMBER OF MEASUREMENTS
!   ATPA     O         NORMAL MATRIX
!   ATPL     O         RIGHT HAND SIDE OF NORMAL EQUATIONS
!   SCRTCH       A     SCRATCH ARRAY
!   LREDDR  I     A    FLAGS FOR CONSTRAINTS APPLICATION (ISAT)
!   NREGDA  I     A    NUMBER OF CONTINUOUS TIME PERIODS (ISET,IDIR,ICON
!                      ISAT)
!   IREDDR  0     A    ARRAY OF POINTERS TO ADJUSTED PARAMETERS
!   WTADRG  I     A    ARRAY OF WEIGHTS FOR ON CONSTRAINTS
!   CTMDRG  I     A    ARRAY OF CORRELATION TIMES FOR ACCELERARTION
!                      CONSTRAINTS
!   RTGDRG  I     A    ARRAY OF TIMES
!   IDIM2   I     S    FIRST DIMENSION OF NREDRD
!   IDIM4   I     S    FOURTH  DIMENSION OF NREDRD
!   IDIMT   I     S    FIRST DIMENSION OF RTDRGG
!   ICALL   I     S    1 - CALLED FROM ENDITR, 2 - CALLED FROM ESTIMA
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION  (A-H,O-Z),LOGICAL(L)
      SAVE
!
      COMMON/BIAOR/NAMBB,NCYCB,NAMBBH
      COMMON/CGLBAR/LGDRAG,NXGLAR
      COMMON/CNIARC/NSATA,NSATG,NSETA,NEQNG,NMORDR,NMORDV,NSORDR,       &
     &              NSORDV,NSUMX,NXDDOT,NSUMPX,NPXDDT,NXBACK,NXI,       &
     &              NXILIM,NPXPF,NINTIM,NSATOB,NXBCKP,NXTIMB,           &
     &              NOBSBK,NXTPMS,NXCNIA
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CORL04/KLEDIT,KLBEDT,KLEDT1,KLEDT2,KNSCID,KEXTOF,KLSDAT,   &
     &              KLRDED,KLAVOI,KLFEDT,KLANTC,NXCL04
      COMMON/EMAT  /EMTNUM,EMTPRT,EMTCNT,VMATRT,VMATS,VMATFR,FSCVMA,    &
     &              XEMAT
!
      DIMENSION PMPP(NP),RESID(1),WT(1),ATPA(1),ATPL(NP),SCRTCH(NP)
      DIMENSION PARMVC(NP)
      DIMENSION LREDDR(1)
      DIMENSION NREDDR(IDIM2,IDIM4),IFWEDR(IDIM2,IDIM4)
      DIMENSION RTGDRG(IDIMT,IDIM2,IDIM4)
      DIMENSION IREDDR(IDIMT,IDIM2,IDIM4)
      DIMENSION WTADRG(IDIM2,IDIM4)
      DIMENSION CTMDRG(IDIM2,IDIM4)
      DIMENSION FSEC(1),IYMD(1),IHM(1),SEC(1)
      DIMENSION LL(1), LAVOID(1)
!
!
      DATA ZERO/0.0D0/,ONE/1.D0/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
      DO 5000 IL=1,IDIM2
! CHECK FOR THE EMATRIX INDICATOR FOR THIS DRAG CONSTRAINT
!!
!!  want to leave code alone if col9=1 (updates in enditr, not estima)
!!  if col9=0, want to skip if called by enditr, but process in estima
!!
      IF(LSTINR) THEN
! NOTE IF IFWEDR IS -1, DRGPCN HAS ALREADY BEEN CALLED FOR THE LAST INNER
! ITERATION, NO NEED TO CALL IT AGAIN.
        IF(IFWEDR(IL,IK).EQ.0) THEN
          IF(ICALL.EQ.1) GOTO 5000
        END IF
        IF(IFWEDR(IL,IK).LT.0) THEN
          GOTO 5000
        ELSE IF(IFWEDR(IL,IK).EQ.1) THEN
! HERE WE SET THE FLAG INDICATOR TO -1 TO MAKE THAT DRGPCN WILL NOT
! BE CALLED TWICE DURING THE LAST INNER ITERATION.
          IFWEDR(IL,IK)=-1
        ENDIF
      ENDIF

!     print*, 'dbg cone: ',lstinr,ifwedr(il,ik),il,ik,idim2
      IF(.NOT.LREDDR(IK)) GO TO 5000
      SCAL=EXP(1.D0)
      WTB=SCAL/(WTADRG(IL,IK)*WTADRG(IL,IK))
      NTR=NREDDR(IL,IK)
!     write(6,*)' dbg NTR WTADRG ',NTR, il,ik,wtadrg(il,ik),
!    .scal,wtb
      IF(NTR.LE.1) THEN
!     WRITE(6,*)' SKIP THIS PARAMETER IT CANNOT BE CONSTRAINED '
      GOTO 5000
      ENDIF
      NTR1=NTR-1
      DO 500 J=1,NTR1
      J1=IREDDR(J,IL,IK)
!     write(6,*)' DRAG IREDDR ',ireddr(j,il,ik),j,il,ik
      TJ=RTGDRG(J,IL,IK)
      ITAG=TJ
      CALL YMDHMS(ITAG,FSEC,IYMD,IHM,SEC,1)
      ITAG=SEC(1)
      IHMS=IHM(1)*100+ITAG
!     WRITE(6,34571) IREDDR(J,IL,IK),IYMD(1),IHMS
      K1=J+1
      DO 100 K=K1,NTR
      K2=IREDDR(K,IL,IK)
!     write(6,*)' DRAG IREDDR 2  ',ireddr(k,il,ik),k,il,ik
      TK=RTGDRG(K,IL,IK)
      ITAG=TK
      CALL YMDHMS(ITAG,FSEC,IYMD,IHM,SEC,1)
      ITAG=SEC(1)
      IHMS=IHM(1)*100+ITAG
!     WRITE(6,34571) IREDDR(K,IL,IK),IYMD(1),IHMS
      VAL=ABS(TK-TJ)
!     WRITE(6,*)' dbg TIME DIFF ',VAL
!     WRITE(6,*)' SAT PARAM INTERVAL  ',IK,J
!
!     write(6,*)' dbg ctmdrg ',ctmdrg(il,ik),il,ik
      EARG=-ABS(TK-TJ)/CTMDRG(IL,IK)
      WW=EXP(earg)
      WT(1)=WTB*EXP(EARG)
!     WRITE(6,*)' dbg WEIGHT ',WT(1),WTB,EARG,WW,ctmdrg(il,ik)
      RESID(1)=PARMVC(K2)-PARMVC(J1)
!     WRITE(6,*)' dbg RESID ',RESID(1),PARMVC(K2),K2,PARMVC(J1),J1
      DO 60 KK=1,NP
      LAVOID(KK)=.TRUE.
      PMPP(KK)=ZERO
   60 END DO
      LAVOID(K2+NAMBB)=.FALSE.
      LAVOID(J1+NAMBB)=.FALSE.
      PMPP(K2+NAMBB)=-ONE
      PMPP(J1+NAMBB)=ONE
      CALL SUMNM(PMPP,RESID,WT,NP,NRMTOT,1,ATPA,ATPL,SCRTCH,LAVOID)
  100 END DO
  500 END DO
 5000 END DO
      RETURN
34571 FORMAT('  ADJUSTED PARM NUM:',I8,' TIME TAG ',I8,3X,I6)
      END
