!$ROTXT3
      SUBROUTINE ROTXT3(MJDSEC,FSEC,LEQC,EQN,SCRTCH,THETAG,COSTHG,      &
     &                  SINTHG,NM,AA,ACOSW,BSINW,ANGWT,WT,ACOEFW,       &
     &                  BCOEFW,II,INDX)
!********1*********2*********3*********4*********5*********6*********7**
! ROTXTR           86/12/24            8701.0    PGMR - D. ROWLANDS
!
! FUNCTION:  COMPUTE THE ANGLE BETWEEN THE IAU VECTOR AND
!            THE PRIME MERIDIAN FOR A PLANET AT
!            A VECTOR OF TIMES OF LENGTH "NM".
!            ALSO COMPUTE THE COSINES AND SINES OF THIS
!            ANGLE. THIS SUBROUTINE PARALLELS GRHRAN. IT
!            THEREFORE HAS DUMMY ARGUMENTS.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSEC   I    S    MODIFIED JULIAN DAY SECONDS OF THE VECTOR
!                      OF TIMES OF INTEREST (EPHEMERIS TIME)
!   FSEC     I    A    THE FRACTION OF SECONDS OF THE VECTOR OF
!                      TIMES OF INTEREST (EPHEMERIS TIME)
!   LEQC     I    S    .TRUE. IF IT IS NECCESSARY TO CALCULATE EQN
!                      OF THE EQUINOX IN ROUTINE
!   EQN     I/O   A    EQUATION OF THE EQUINOX (INPUT IF LEQC=.FALSE.)
!                      EQN OF THE EQUINOX (OUTPUT IF LEQC=.TRUE.)
!   SCRTCH  I/O    A   5*NM
!   THETAG   O     A   VECTOR OF VALUES OF RIGHT ASCENSION OF
!                      GREENWICH
!   COSTHG   O     A   COSINES OF THETAG
!   SINTHG   O     A   SINES OF THETAG
!   NM       I     S   NUMBER OF TIMES OF INTEREST
!   AA      I/O    A   DYNAMIC REAL SPACE
!   ACOSW   I/O    A   ARRAY FOR SINE TIME DEP TERMS FOR PLANET ROTATION
!   BSINW   I/O    A   ARRAY FOR COSINE TIME DEP TERMS FOR PLANET ROTATI
!   ANGWT   I/O    A   ARRAY FOR FREQUENCIES FOR TIME DEP PLANET ROTATIO
!   WT      I/O    A   ANGLE WT
!   II       I     A   DYNANIC INTEGER ARRAY
!   INDX     I     S   INDEX TO PLANETARY BODY
!                      =1 PRIMARY BODY
!                      =2 SECOND BODY (IN A BIBARY ASTEROID CASE)
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
!      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
!      SAVE
       IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
!
      COMMON/DPLNOR/DXGEO1,DXGEO2,DXFRC1,DXFRC2,XPLNOR
      DIMENSION FSEC(NM),THETAG(NM),COSTHG(NM),SINTHG(NM),EQN(NM),      &
     &          SCRTCH(NM,11),AA(1)
      DIMENSION ACOSW(1),BSINW(1),ANGWT(1),WT(1)
      DIMENSION ACOEFW(1),BCOEFW(1)
      DIMENSION XLLIB(3),XLLIBV(3)
      DIMENSION II(1)
!     DIMENSION XLLIB(500,3),XLLIBV(500,3)
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA07/KELEVT,KSRFEL,KTINT,KFSCSD,KXTIM,KFSDM,             &
     & KSGM1,KSGM2,KNOISE,KEPHMS,NXCA07
      COMMON/CORI07/KSMSA1,KSMSA2,KSMSA3,KSMST1,KSMST2,KSMST3,KSMTYP,   &
     &              KSMT1,KSMT2,KMSDM,KIOUT,KISUPE,NXCI07
      COMMON/CRDDIM/NDCRD2,NDCRD3,NDCRD4,NDCRD5,NDCRD6,NDCRD7,          &
     &              NDCRD8,NDCRD9,NXCRDM
      COMMON/CTHDXT/THDXT
      COMMON/DTMGDN/TGTYMD,TMGDN1,TMGDN2,REPDIF,XTMGN
      COMMON/EPHSET/EMFACT,DTENPD,DTINPD,FSC1EN,FSCENP(2),FSCINP(4),    &
     &   FSDINP(4),XEPHST
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988), &
     &              NXEPH2
      COMMON/LCBODY/LEARTH,LMOON,LMARS
      COMMON/LEPHM2/LXEPHM
      COMMON/THXTGC/THXTGC(3,2)
      COMMON/XTRAOR/T0XTRO,T0XTRO2,CVENUS,CLIBMN,CMARS,CMERC,XXTRAO
      COMMON/XPCNT /NXTRAC,NXFLAG,NXALLC,NCPPER,NMINRT,NDPOR,NXXTRA
!
      DATA ONE/1.D+00/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
!
!
!
      IF(CMARS.GT.1.9D0.AND.CMARS.LT.2.1D0) THEN
      CALL ROTYTR(MJDSEC,FSEC,THETAG,NM,THTDX)
      DO I=1,NM
       THETAG(I)=THETAG(I)+DEGRAD*DXGEO2
      ENDDO
      DO I=1,NM
        COSTHG(I)=COS(THETAG(I))
        SINTHG(I)=SIN(THETAG(I))
      ENDDO
      RETURN
      ENDIF
!
!
!
! GET EQN OF EQUINOX IF NECESSARY
      IF(.NOT.LEQC) GO TO 500
      CALL BUFXTR(MJDSEC,FSEC(1),MJDSEC,FSEC(NM),1,MJDDUM,FSCDM,LDUM,   &
     &            AA)
!
      IF(LXEPHM) THEN
      DO IJ=1,ICBODY
      CALL BUFSUP(AA,MJDSEC,FSEC(1),MJDSEC,FSEC(NM),                    &
     &II(KISUPE),AA(KEPHMS),IJ,1)
      ENDDO
      ENDIF
!
!     IF(ICBDGM.EQ.5) THEN
!     CALL NUVMCT(MJDSEC,FSEC,AA(KDPSI),AA(KEPST),AA(KEPSM),
!    .            NM,SCRTCH)
!       ENDIF
!     CALL NUVECT(MJDSEC,FSEC,AA(KDPSI),AA(KEPST),AA(KEPSM),
!    .            NM,SCRTCH)
!     CALL NPVECT(MJDSEC,FSEC,AA(KDPSI),AA(KEPST),AA(KEPSM),
!    .            AA(KETA),AA(KTHTA),AA(KZTA),NM,SCRTCH,
!    .            AA(KROTMT),EQN,NDCRD2,.TRUE.)
!
! GET UT TIMES FROM ET TIMES;PUTIT INTO SCRTCH( ,3)
  500 CONTINUE
!     CALL ETUT(MJDSEC,FSEC,AA(KDPSR),AA(KXPUT),SCRTCH(1,3),SCRTCH(1,5),
!    .          AA(KA1UT),NM)
!
      IF(LMOON) GOTO 6000
      XJDSC0=DBLE(MJDSEC)-FSDINP(1)
      THDXT=THXTGC(2,INDX)
      X0=THXTGC(1,INDX)+TWOPI
      IF(T0XTRO.GT.0.D0) THEN
      TIMEC=DBLE(MJDSEC)-T0XTRO
      DO 1000 I=1,NM
      SCRTCH(I,1)=XJDSC0+FSEC(I)
      TIMEAB=TIMEC+FSEC(I)
! RE-COMPUTE ACOSW BSINW
      SUMAC=0.D0
      SUMBS=0.D0
      DO 400 J=1,NXALLC
      WT(J)=ANGWT(J)*TIMEAB
      WT(J)=MOD(WT(J),TWOPI)
      ACOSW(J)=COS(WT(J))*ACOEFW(J)
      SUMAC=SUMAC+ACOSW(J)
      BSINW(J)=SIN(WT(J))*BCOEFW(J)
      SUMBS=SUMBS+BSINW(J)
  400 END DO
      THETAG(I)=X0+SCRTCH(I,1)*THXTGC(2,INDX)+THXTGC(3,INDX)+SUMAC+SUMBS
      THETAG(I)=MOD(THETAG(I),TWOPI)
 1000 END DO
      ELSE
      DO 2000 I=1,NM
      SCRTCH(I,1)=XJDSC0+FSEC(I)
      THETAG(I)=X0+SCRTCH(I,1)*THXTGC(2,INDX)
      THETAG(I)=MOD(THETAG(I),TWOPI)
 2000 END DO
      ENDIF
! EVALUATE COSINES OF THETAG
      DO I=1,NM
       THETAG(I)=THETAG(I)+DEGRAD*DXGEO2
      ENDDO
      DO 4000 N=1,NM
      COSTHG(N)=COS(THETAG(N))
 4000 END DO
! EVALUATE SINES OF THETAG
      DO 5000 N=1,NM
      SINTHG(N)=SIN(THETAG(N))
 5000 END DO
      RETURN
 6000 CONTINUE
!
      IF(CLIBMN.EQ.ONE)THEN
      DO 6010 K=1,NM
      CALL CMNLIB(MJDSEC,FSEC(K),XLLIB,XLLIBV)
      THETAG(K)=XLLIB(3)
 6010 END DO
      THXTGC(2,INDX)=XLLIBV(3)
      THDXT=THXTGC(2,INDX)
      GO TO 7099
      ENDIF
!
      XJDSC0=DBLE(MJDSEC)
      DO 7000 I=1,NM
      SCRTCH(I,1)=XJDSC0+FSEC(I)
      DW = SCRTCH(I,1) / SECDAY - (51544.5D0-TMGDN2)
!     DW = SCRTCH(I,1) / SECDAY - 21544.5D0
      D=DW
      CALL NLUNCN( D,DW, ALF, ALFD,                                     &
     &             DEC, DECD, THETAG(I), THXTGC(2,INDX) )
!     THXTGC(1,INDX)=DMOD(THXTGC(1,INDX)+TWOPI,TWOPI)
      THXTGC(2,INDX)=MOD(THXTGC(2,INDX)+TWOPI,TWOPI)
      THDXT=THXTGC(2,INDX)
      THETAG(I)=MOD(THETAG(I),TWOPI)
      IF(I.EQ.1)TAG2=THETAG(I)/DEGRAD
 7000 END DO
! EVALUATE COSINES OF THETAG
 7099 CONTINUE
      DO I=1,NM
       THETAG(I)=THETAG(I)+DEGRAD*DXGEO2
      ENDDO
      DO 8000 N=1,NM
      COSTHG(N)=COS(THETAG(N))
 8000 END DO
! EVALUATE SINES OF THETAG
      DO 9000 N=1,NM
      SINTHG(N)=SIN(THETAG(N))
 9000 END DO
      RETURN
      END
