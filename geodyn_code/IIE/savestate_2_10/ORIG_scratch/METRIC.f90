!$METRIC
      SUBROUTINE METRIC(AA,II,LL,INDSTA,INDSAT,INDSET,INPSTA,INPSAT,    &
     &   LELEVS,ILCORR,PARMVC,PARMV,LANTCT)
!********1*********2*********3*********4*********5*********6*********7**
! METRIC           00/00/00            0000.0    PGMR - T. MARTIN
!
! FUNCTION:  CONTROLS THE PROCESSING OF METRIC (RANGE) OBSERVATIONS
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   AA      I/O   A    DYNAMIC ARRAY FOR REAL VARIABLES.
!   II      I/O   A    DYNAMIC ARRAY FOR INTEGER VARIABLES
!   LL      I/O   A    DYNAMIC ARRAY FOR LOGICAL VARIABLES
!   INDSTA   I    A    FOR A GIVEN INTERNAL STA NO (1,2,3) INDSTA
!                      GIVES THE ACTUAL LOCATION IN THE STATION
!                      RELATED ARRAYS FOR THIS STATION.
!                      (EG.   STA NO=ISTANO(INDSTA(1,2,OR 3))
!   INDSAT   I    A    FOR A GIVEN INTERNAL SAT NO (1,2,3) INDSAT
!                      GIVES THE ACTUAL LOCATION IN THE SATELLITE
!                      RELATED ARRAYS FOR THIS SATELLITE.
!                      (EG.   SAT ID=ISATNO(INDSAT(1,2,OR 3))
!   INDSET   I    A    FOR A GIVEN INTERNAL SATELLITE NUMBER INDSET TELL
!                      WHICH SAT SET THAT THE GIVEN SAT BELONGS TO.
!   INPSTA   I    A    POINTER ARRAY THAT RELATES THE INTERNAL STATION
!                      NUMBER (1,2,3) TO THE STATIONS DEFINED IN THE
!                      DATA HEADER RECORDS (N=1,2,3). (EG.
!                      ISTAP=INPSTA(1) WOULD TELL WHICH OF THE THREE
!                      POSSIBLE STATIONS DEFINED IN THE DATA HEADER
!                      RECORDS PERTAINED TO INTERNAL STATION NO. 1)
!   INPSAT   I    A    POINTER ARRAY THAT RELATES THE INTERNAL SATELLITE
!                      NUMBER (1,2,3) TO THE SATELLITES DEFINED IN THE
!                      DATA HEADER RECORDS (N=1,2,3). (EG.
!                      ISATP=INPSAT(1) WOULD TELL WHICH OF THE THREE
!                      POSSIBLE SATELLITES DEFINED IN THE DATA HEADER
!                      RECORDS PERTAINED TO INTERNAL SATELLITE NO. 1)
!   LELEVS   I    A    INDICATES WHICH ELEVATION ANGLES NEED TO BE
!                      COMPUTED FOR THE THREE POSSIBLE STATION SATELLITE
!                      CONFIGURATIONS DEFINED IN THE BLOCK HEADER
!                      RECORDS
!   LANTCT   I    A    ANTENNA CUTOFF LOGICAL ARRAY
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      use cgmass_module

      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      COMMON/CBINRL/LBINR,LLOCR,LODR,LBNCR,LBINRI,LLOCRI,LODRI,LBNCRI,  &
     &              NXCBIN
      COMMON/CBLOKA/FSECBL,SIGNL ,VLITEC,SECEND,BLKDAT(6,4),DOPSCL(5,4)
      COMMON/CBLOKI/MJDSBL,MTYPE ,NM    ,JSTATS,NPSEG ,JSATNO(3),ITSYS ,&
     &       NHEADB,NELEVS,ISTAEL(12),INDELV(3,4),JSTANO(3),ITARNO,     &
     &       KTARNO
      COMMON/CBLOKL/LIGHT ,LNRATE,LNREFR,LPOLAD,LTDRIV,LNANT ,LNTRAK,   &
     &       LASER ,LGPART,LGEOID,LETIDE,LOTIDE,LNTIME,LAVGRR,LRANGE,   &
     &       LSSTMD,LSSTAJ,LNTDRS,LPSBL,LACC,LAPP,LTARG,LTIEOU,LEOTRM,  &
     &       LSURFM,LGEOI2,LSSTM2,LOTID2,LOTRM2,LETID2,LNUTAD
      COMMON/CEGREL/LGRELE,LRLCLK,LGRELR,LXPCLK,LBPCLK,NXEGRL
      COMMON/CESTIM/MPARM,MAPARM,MAXDIM,MAXFMG,ICLINK,IPROCS,NXCEST
      COMMON/CESTML/LNPNM ,NXCSTL
      COMMON/CHCOEF/ COEFM(3,15),COEFJ(3,15),COEFSA(3,15),COEFS(3,15),  &
     &               COEFEM(3,15),COEFMO(3,15),COEF(3,15)
      COMMON/CHCOFX/ COEFX(3,25),COEFXX(3,25,988),RLVAL(988)
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CLIGHT/VLIGHT,ERRLIM,XCLITE
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/COBGLO/MABIAS,MCBIAS,MPVECT,MINTPL,MPARAM,MSTA,MOBBUF,     &
     &       MNPITR,MWIDTH,MSIZE ,MPART ,MBUF  ,NXCOBG
      COMMON/COBLOC/KXMN  (3,4)  ,KENVN (3,4)  ,KSTINF(3,4)  ,          &
     &       KOBS  ,KDTIME,KSMCOR,KSMCR2,KTMCOR,KOBTIM,KOBSIG,KOBSG2,   &
     &       KIAUNO,KOBCOR(9,7)  ,KFSECS(6,8)  ,KOBSUM(8)    ,          &
     &       KEDSIG,KEDSG2
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA05/KOBTYP,KDSCRP,KGMEAN,KGLRMS,KWGMEA,KWGRMS,KTYMEA,   &
     &       KTYRMS,KWTMTY,KWTYRM,KTMEAN,KTRMS ,KWMEAN,KWTRMS,KWTRND,   &
     &       KPRVRT,KEBSTT,KVLOPT,NXCA05
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI03/KICRD ,KICON ,KISTNO,KINDPI,KMJDPL,KIPOLC,          &
     &              KNDOLA,KIOLPA,KKIOLA,KIP0OL,KNDOLM,KIOLPM,          &
     &              KKIOLM,KIPVOL,KICNL2,KICNH2,                        &
     &              KSTMJD, KNUMST, KITAST, KSTNRD, KICNV,              &
     &              KTIDES,KFODEG,KFOORD,KRDEGR,KRORDR,                 &
     &              KPHINC,KDOODS,KOTFLG,KJDN  ,KPTDN ,                 &
     &              KATIND,KPRESP,KMP2RS,KSITE,KPTOLS,NXCI03
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORI06/KPTRAU,KPTRUA,KNFMG ,KIPTFM,KILNFM,KIGPC ,          &
     &              KIGPS ,KIGPCA,KIGPSA,KIELMT,KMFMG ,KTPGPC,          &
     &              KTPGPS,KTPUC ,KTPUS,                                &
     &              KLINK,KPTFAU,KPTFUA,NXCI06
      COMMON/CORL04/KLEDIT,KLBEDT,KLEDT1,KLEDT2,KNSCID,KEXTOF,KLSDAT,   &
     &              KLRDED,KLAVOI,KLFEDT,KLANTC,NXCL04
      COMMON/CONTRL/LSIMDT,LOBS  ,LORB  ,LNOADJ,LNADJL,LORFST,LORLST,   &
     &              LORALL,LORBOB,LOBFST,LOBLST,LOBALL,LPREPO,LORBVX,   &
     &              LORBVK,LACC3D,LSDATA,LCUTOT,LACCEL,LDYNAC,LFRCAT,   &
     &              LNIAU, NXCONT
      COMMON/CPARFI/IUNPF1,IUNPF2,IUNPFI,ISZPFI,NBLKPF,NWRDPF,MTCALL(4)
      COMMON/CPMPA /KTMPAR(3)    ,KMBPAR(2)    ,KRFPAR(2)    ,          &
     &              KAEPAR,KFEPAR,KFPPAR,KVLPAR,KETPAR(2,2)  ,          &
     &              KPMPAR,KUTPAR,KSTPAR(3,4)  ,NADJST       ,          &
     &              NDIM1 ,NDIM2 ,NXDIM1,NXDIM2
      COMMON/CPRESW/LPRE9 (24),LPRE  (24,3),LSWTCH(10,8),LOBSIN,LPREPW, &
     &              LFS   (40)
      COMMON/CVIEW /IOUT6 ,ILINE6,IPAGE6,MLINE6,                        &
     &              IOUT8 ,ILINE8,IPAGE8,MLINE8,                        &
     &              IOUT9 ,ILINE9,IPAGE9,MLINE9,                        &
     &              IOUT10,ILIN10,IPAG10,MLIN10,                        &
     &              IOUT15,ILIN15,IPAG15,MLIN15,                        &
     &              IOUT16,ILIN16,IPAG16,MLIN16,                        &
     &              IOUT7 ,NXCVUE
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988), &
     &              NXEPH2
      COMMON/IOBTYP/NDXST(2,35),NDXSAT(2,35),                           &
     &      NDRSTA(50),NDRSAT(50),NDRST2(50),NDRSA2(50),                &
     &      ITMBIT(999),IOETR(999),MTYPED(11),NTYPES,                   &
     &      NM0112(4),NM1314(4),NM1522(4),NM2330(4),                    &
     &      NM3138(4),NM3997(4),NM4098(4),NM9900(4),NMT199(4),NMT203(4),&
     &      NS0112(4),NS1314(4),NS1522(4),NS2330(4),                    &
     &      NS3138(4),NS3997(4),NS4098(4),NS9900(4),NST199(4),NST203(4),&
     &      ITYPD(12,2),ITYPDD(7,2),ILINKF(5),ISTAFN(5,3),              &
     &      ISATFN(5,3),ILINKT(5),ISTATN(5,3),ISATTN(5,3),              &
     &      MGOTO(12),MENTER(12),MEXIT(12),                             &
     &      NDST60(3,24),NDST82(6,12),NDST92(12,7),NTDRSS,              &
     &      NDSA60(3,24),NDSA82(6,12),NDSA92(12,7),                     &
     &      MTDRSS(7),KTDRSS(7),ITDRSS(4,7),JTDRSS(4,7),                &
     &      NLLC60(5,24),NLLC82(10,12),NLLC98(20,7),NNBIA,              &
     &      NXMTYP
      COMMON/ION2EL/LIONC,LFRQOP,LFRQOF,NXIONL
      COMMON/IORCHB/ IORM,IORJ,IORSA,IORSUN,IOREM,IORMO,IORCB,IORTB,    &
     &               IGRP,ICHBOG(2,14),IORSCB(988),NXORCH
      COMMON/IRAMPS/INDRAM,KKRAMP
      COMMON/KINETEX/ORBIAS
      COMMON/KIX/KINDXC
      COMMON/LEPHM2/LXEPHM
      COMMON/LCBODY/LEARTH,LMOON,LMARS
      COMMON/LDUAL/LASTSN,LSTSNX,LSTSNY
      COMMON/LOBTYP/L2WAYS(31),LODD(11),NXLTYP
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/PLNTRR/JCHEMR,JCHMOR,JEPOSR,JCHEMT,JCHMOT,JEPOST,JCHCBS,   &
     &              JCPOSS,JXSTT,JXSTR,JXSS,JFSCN1,JFSCN2,JFSCK1,       &
     &              JFSCK2,JFSCM1,JFSCM2
      COMMON/PYUA  /XGPSTB,WVL3,VHIGH(3,3,4),VLOW(3,3,4),PYUSQ(5),      &
     &              VISATH(4),VISATL(4),XANTSL(4),XCUTSL(4),XANTSH(4)
      COMMON/RAMPA/SF1,SF2,FREQO,RBIAS
      COMMON/RAMPI/MJDRMP,NRAMPS
      COMMON/RAMPRL/LRAMPR
      COMMON/RAMPS/TRINT(1000,2,2),FRINT(1000,2,2),TRAMP(1000,2),       &
     &             FRAMP(1000),FDRAMP(1000),RSCALX(1000),SCALX(1000),   &
     &             XINTS(1000),XINTB(1000),XINTS2(1000),RSCALY(1000)
      COMMON/ROBTYP/CONVRT(999),OBSCAL(999),RESCAL(999),                &
     &              XMTYP
      COMMON/RRAMPS/RINDM1,RINDM2,RINDD,RININD,AVFREQ
      COMMON/STATN /NSTA,NSTAE,NMSTA,NCSTA,NSTAV,NSTLV,NSTEL2,          &
     &              NSTEH2,                                             &
     &              NPH2L2,                                             &
     &              NSTNUM, NSTIME, NALLST,KCONAD, NXSTAT
      COMMON/TARGET/NLXYZ(200000),NPLTAR,NTARG,NATARG,NXTARG
!
      DIMENSION AA(1),II(1),LL(1),INDSAT(3,4),INDSET(3,4),INDSTA(3,4),  &
     &   LELEVS(3,4),INPSTA(3,4),INPSAT(3,4),ILCORR(5,4)
      DIMENSION XTARG(3)
      DIMENSION PARMVC(1)
      DIMENSION PARMV(1)
!      DIMENSION UMV(200,3),UM1(200,3),UM2(200,3)   !original
      DIMENSION UMV(2000,3),UM1(2000,3),UM2(2000,3) ! jjm 9/98
      DIMENSION LANTCT(1)
      double precision, dimension( ndim_cgmass, MINTIM ) :: cg_par_array
      LOGICAL, DIMENSION(:), ALLOCATABLE :: LEDIT_EXTRA


      DATA METRIX/37/
      DATA kentry/0/
!**********************************************************************
! START OF EXECUTABLE CODE ********************************************
!**********************************************************************
!
      kentry = kentry + 1
!
       CALL CLEARL(LANTCT,NM)
!
! INITIALIZE KLREDT FOR RAMPED DOPPLER
      IF(INDRAM.NE.0) THEN
      DO 1201 I=1,NM
      LL(KLRDED+I-1)=.FALSE.
 1201 END DO
      ENDIF

      LDDOR=.FALSE.
!
! CLEAR ARRAY INDICATING WHICH MEASUREMENT LINK ROUTINES ARE CALLED
      CALL CLEARI(MTCALL,4)
! CLEAR TIME DERIVATIVE ARRAY
      CALL CLEARA(AA(KTPRTL),NM*2)


      ! clear the cg FANTOM array

      !write(6,*)'metric: NPVAL0(IXFAGM) ',  NPVAL0(IXFAGM)
      if( NPVAL0( IXFAGM ) > 0 )then
          call cleara( cg_par_array, ndim_cgmass*MINTIM )    ! cgmass
      endif


!     IF(MTYPE.EQ.56) THEN
      IF(LAPP) THEN
! CLEAR THE OBSTRL ARRAY
      CALL CLEARA(AA(KOBSTR),NM)
      ENDIF
!
      IF(LNADJ) GO TO 1000
! CLEAR PARTIAL DERIVATIVE ARRAY
      NCLEAR=NM*NADJST
      CALL CLEARA(AA(KPMPA),NCLEAR)
 1000 CONTINUE
! SET ADD SWITCH .TRUE. SO THAT FIRST SIDE OF DIFFERENCE IS POSITIVE
      LADD=.TRUE.
! SET LINK TYPE INDICATOR
      ITYPE=(MTYPE-METRIX+2)/2
      IF(MTYPE.EQ.36) ITYPE=13
! SET TWO-WAY INDICATOR
      L2WAY=L2WAYS(ITYPE)
! SET INDICATOR OF APPROPRIATE SUBROUTINE TO CALL
      ICALL=(MTYPE-13)/24
      ICALL=MAX(ICALL,1)
!DEP DDOR
      IF(MTYPE.EQ.36) THEN
      LDDOR=.TRUE.
      ICALL=4
      ENDIF
!DEP DDOR
      NTPRTL=1
      IF(ICALL.GT.1.AND..NOT.LDDOR) NTPRTL=2
      CALL METHD(ITYPE,MTYPE,ICALL,INDSAT,INDSTA)
      CALL HLPYU(MTYPE,AA(KXLOCV))
! LOOP THRU POSITIVE (AND OPTIONALLY NEGATIVE SIDES OF DIFFERENCE)
      ILOOP=1
      MSEQ=0
      IF(.NOT.LAVGRR) GO TO 5000
      ILOOP=2
      MSEQ=4
 5000 CONTINUE
      DO 50000 I=1,ILOOP
! SET SEQUENCE NUMBER TO ZERO
      ISEQ=0
! CALL APPROPRIATE SUMMING SUBROUTINE BASED UPON MEASUREMENT TYPE

      GO TO (10000,20000,30000,35000),ICALL

! COMPUTE AND SUM LINK OBSERVATIONS, PARTIALS, AND CORRECTIONS
10000 CONTINUE
      NM3=NM*3
      ISEQ=ISEQ+1
!     ....sname  is current station name
!     ....isnumb is current station number
      sname = aa(kstnam-1+indsta(1,1) )
      isnumb = ii(kistno-1+ indsta(1,1))
!
      lyara = NPH2L2 .gt. 0
!
      DO 3450 N=1,NTARG
      IF(ITARNO.EQ.II(KTARID-1+N)) GOTO 3460
 3450 END DO
 3460 CONTINUE
      KTARNO=N
      DO 3500 I1=1,3
      XTARG(I1)=0.D0
 3500 END DO
      IF(LTARG) THEN
      N1=(KTARNO-1)*3
      DO 3510 I1=1,3
      XTARG(I1)=PARMV(IPVAL(IXTARG)-1+I1+N1)
 3510 END DO
      IF(NPVAL0(IXTARG).GT.0) THEN
      DO 3520 I1=1,3
      XTARG(I1)=PARMVC(IPVAL0(IXTARG)-1+I1+N1)
 3520 END DO
      ENDIF
      ENDIF

      CALL ROBS(AA        ,II        ,LL        ,AA(KTPRTL),            &
     &   AA(KSTAIN),II(KN3   ),II(KNEQN ),II(KIPTFM),II(KILNFM),        &
     &   II(KNFMG ),INDSTA    ,INDSAT    ,INDSET    ,INPSTA    ,        &
     &   INPSAT    ,LELEVS    ,ITYPE     ,ISEQ      ,MSEQ      ,        &
     &   LADD      ,ILCORR,    LYARA     ,ISNUMB    ,I         ,        &
     &   II(KTMRA1),II(KTMRA2),AA(KFRSTR),AA(KFRRAT),AA(KPRL1) ,        &
     &   AA(KPRL2),                                                     &
     &   AA(KRL1)  ,AA(KT1SE) ,AA(KTCP)  ,AA(KRATDR),AA(KFQT1S),        &
     &   AA(KFQT1E),AA(KT1STR),AA(KFTTSE),II(KIND1) ,LL(KLRDED),        &
     &   AA(KSV1+KINDXC),AA(KSV2+KINDXC),NM3    ,AA(KRDS1L),            &
     &   AA(KFT1AV),AA(KDFQP) ,AA(KFREQ1),AA(KFREQ3),AA(KSAVD1),        &
     &   AA(KSAVD2),XTARG,UMV,UM1,UM2, cg_par_array )

      GO TO 40000
! COMPUTE AND SUM LINK OBSERVATIONS, PARTIALS, AND CORRECTIONS
20000 CONTINUE
      CALL ROBSD (AA,II,LL,AA(KTPRTL),INDSTA,INDSAT,INDSET,INPSTA,      &
     &  INPSAT,LELEVS,MTYPE,ISEQ,MSEQ,LADD,.FALSE.,ILCORR,              &
     &   AA(KSV1+KINDXC),AA(KSV2+KINDXC),NM3,I,                         &
     &   XTARG,UMV,UM1,UM2, cg_par_array )
      GO TO 40000
! COMPUTE AND SUM LINK OBSERVATIONS, PARTIALS, AND CORRECTIONS
30000 CONTINUE
      CALL ROBSDD(AA,II,LL,AA(KTPRTL),INDSTA,INDSAT,INDSET,INPSTA,      &
     &            INPSAT,LELEVS,MTYPE,ISEQ,MSEQ,LADD,ILCORR,            &
     &   AA(KSV1+KINDXC),AA(KSV2+KINDXC),NM3,I,                         &
     &   XTARG,UMV,UM1,UM2, cg_par_array )
      GO TO 40000
35000 CONTINUE
      CALL DLTDOR(AA,II,LL,AA(KTPRTL),INDSTA,INDSAT,INDSET,INPSTA,      &
     &   INPSAT,LELEVS,MTYPE,ISEQ,MSEQ,LADD,.FALSE.,ILCORR,             &
     &   AA(KSV1+KINDXC),AA(KSV2+KINDXC),NM3,I,                         &
     &   XTARG,UMV,UM1,UM2)
40000 CONTINUE
! REVERSE SIGN OF NEXT COMPONENT
      LADD=.FALSE.
      IF(ITBDGM.EQ.ICBDGM) GO TO 49000
! ONLY FOR INTERPLANETARY DOPPLER MEASUREMENT
!**********************************************************************
!
      JDXET =KSCRTM
      JDXER =JDXET +NM*3
      JDXM  =JDXER +NM*3
      JDXTMO=JDXM  +NM*3
      JDXRMO=JDXTMO+NM*3
      JDSTT =JDXRMO+NM*3
      JDSTR =JDSTT +NM*3
      JDS   =JDSTR +NM*3
      JVECT =JDS   +NM*3
      JVECR =JVECT +NM*3
      JDVECT=JVECR +NM*3
      JDVECR=JDVECT+NM*3
      JDVCT2=JDVECR+NM*3
      JDVCR2=JDVCT2+NM
      JBETAT=JDVCR2+NM
      JBETAR=JBETAT+NM
      JAT   =JBETAR+NM
      JAR   =JAT   +NM*3
      JSUMT =JAR   +NM*3
      JSUMR =JSUMT +NM
      JFT   =JSUMR +NM
      JFR   =JFT   +NM*3
      JRANG2=JFR   +NM*3
      JRANG4=JRANG2+NM
      JTWOT =JRANG4+NM
      JRRR  =JTWOT +NM
      JDELTT=JRRR  +NM
      JDELTR=JDELTT+NM
      JDELTS=JDELTR+NM
      JDLMOT=JDELTS+NM
      JDLMOR=JDLMOT+NM
      JDLEMT=JDLMOR+NM
      JDLEMR=JDLEMT+NM
!
      IF(MSEQ .GT. 0) THEN
      DO 4500 K=1,NM
      AA(KRANGT+(K-1)) = AA(KRKM+(K-1))
      AA(KRANGR+(K-1)) = AA(KRNM+(K-1))
 4500 END DO
      ENDIF
49000 CONTINUE
      MSEQ=0
50000 END DO
      IF(INDRAM.NE.0) GO TO 60000
      IF(.NOT.L2WAY) GO TO 60000
      IF(LBPCLK) GO TO 60000
! DIVIDE MEASUREMENTS, PARTIAL DERIVATIVES AND CORRECTIONS BY TWO
      CALL TWOWAY(AA,AA(KPMPA),AA(KOBSC),AA(KTPRTL),NTPRTL,NM,          &
     &            NDIM1,NDIM2)
60000 CONTINUE
      INDRAM=0
      IF(LRAMPR.AND.(MTYPE.EQ.53.OR.MTYPE.EQ.54)) INDRAM=1
      IF(LRAMPR.AND.MTYPE.EQ.42) INDRAM=1
      JNDRAM=INDRAM
      INDRAH=INDRAM
      IF(MTYPE.EQ.42) JNDRAM=0
      INDRAM=0
      IF(.NOT.LAVGRR) GO TO 70000
! COMPUTE RANGE DIFFERENCES FOR INTERPLANETARY SATELLITE
!!!!! IF(ITBDGM .NE. ICBDGM.AND..NOT.LMOON.AND.MTYPE.NE.42) THEN
!!!!! IF(ITBDGM .NE. ICBDGM) THEN
      IF(ITBDGM .NE. ICBDGM.AND..NOT.LASTSN) THEN

!***DEBUG***************
!     WRITE(6,*)' POINT ',KXSTT,JXSTT,KXSTR,JXSTR,KXSS
!     WRITE(6,*)     JXSS ,COEFEM,COEFMO,COEF
!     WRITE(6,*)  IGRP,IORCB,IORTB,IORMO,NM,KRANGT
!     WRITE(6,*)  KRANGR,JRANG2,JRANG4,KOBSC
!     WRITE(6,*)  JRRR,KCHCBS,JCHCBS,KCHEMT,JCHEMT
!     WRITE(6,*)  KCHEMR,JCHEMR,KCHMOT,JCHMOT
!     WRITE(6,*)  KCHMOR,JCHMOR,KEPOST,KEPOSR
!     WRITE(6,*)  KCPOSS
!     WRITE(6,*)  JDXET,JDXER,JDXM,JDXTMO,JDXRMO
!     WRITE(6,*)  JDSTT,JDSTR,JDS,JVECT,JVECR
!     WRITE(6,*)  JDVECT,JDVECR,JDVCT2,JDVCR2
!     WRITE(6,*)  JBETAT,JBETAR,JAT,JAR
!     WRITE(6,*)  JSUMT,JSUMR,JFT,JFR,JDELTT
!     WRITE(6,*)  JDELTR,JDELTS,JDLMOT,JDLMOR
!     WRITE(6,*)  JDLEMT,JDLEMR
!     WRITE(6,*) ' VALUES'
!     WRITE(6,*)  AA(KXSTT),AA(JXSTT),AA(KXSTR),AA(JXSTR),AA(KXSS)
!     WRITE(6,*)  AA(JXSS),COEFEM,COEFMO,COEF
!     WRITE(6,*)  IGRP,IORCB,IORTB,IORMO,1.E00,NM,AA(KRANGT)
!     WRITE(6,*)  AA(KRANGR),AA(JRANG2),AA(JRANG4),AA(KOBSC)
!     WRITE(6,*)  AA(JRRR),AA(KCHCBS),AA(JCHCBS),AA(KCHEMT),AA(JCHEMT)
!     WRITE(6,*)  AA(KCHEMR),AA(JCHEMR),AA(KCHMOT),AA(JCHMOT)
!     WRITE(6,*)  AA(KCHMOR),AA(JCHMOR),AA(KEPOST),AA(KEPOSR)
!     WRITE(6,*)  AA(KCPOSS)
!     WRITE(6,*)  AA(JDXET),AA(JDXER),AA(JDXM),AA(JDXTMO),AA(JDXRMO)
!************************
      IF(LXEPHM.AND.ICBDGM.GT.11) GOTO 30100
      IF(LMOON) GOTO 30099
      CALL INTPRR(AA(KXSTT),AA(JXSTT),AA(KXSTR),AA(JXSTR),AA(KXSS),     &
     &           AA(JXSS),COEFEM,COEFMO,COEF,                           &
     &           IGRP,IORCB,IORTB,IORMO,1.D00,L2WAY,NM,AA(KRANGT),      &
     &           AA(KRANGR),AA(JRANG2),AA(JRANG4),AA(JRRR),             &
     &           AA(KOBSC) ,AA(KCHCBS),AA(JCHCBS),AA(KCHEMT),AA(JCHEMT),&
     &           AA(KCHEMR),AA(JCHEMR),AA(KCHMOT),AA(JCHMOT),           &
     &           AA(KCHMOR),AA(JCHMOR),AA(KEPOST),AA(KEPOSR),           &
     &           AA(KCPOSS),                                            &
     &           AA(JDXET),AA(JDXER),AA(JDXM),AA(JDXTMO),AA(JDXRMO),    &
     &           AA(JDSTT),AA(JDSTR),AA(JDS) ,AA(JVECT) ,AA(JVECR) ,    &
     &           AA(JDVECT),AA(JDVECR),AA(JDVCT2),AA(JDVCR2),           &
     &           AA(JBETAT),AA(JBETAR),AA(JAT),AA(JAR),                 &
     &           AA(JSUMT),AA(JSUMR),AA(JFT),AA(JFR),AA(JDELTT),        &
     &           AA(JDELTR),AA(JDELTS),AA(JDLMOT),AA(JDLMOR),           &
     &           AA(JDLEMT),AA(JDLEMR),AA)
      GOTO 30150
30099 CONTINUE
      CALL INTPRM(AA(KXSTT),AA(JXSTT),AA(KXSTR),AA(JXSTR),AA(KXSS),     &
     &           AA(JXSS),COEFEM,COEFMO,COEF,                           &
     &           IGRP,IORCB,IORTB,IORMO,1.D00,L2WAY,NM,AA(KRANGT),      &
     &           AA(KRANGR),AA(JRANG2),AA(JRANG4),AA(JRRR),             &
     &           AA(KOBSC) ,AA(KCHCBS),AA(JCHCBS),AA(KCHEMT),AA(JCHEMT),&
     &           AA(KCHEMR),AA(JCHEMR),AA(KCHMOT),AA(JCHMOT),           &
     &           AA(KCHMOR),AA(JCHMOR),AA(KEPOST),AA(KEPOSR),           &
     &           AA(KCPOSS),                                            &
     &           AA(JDXET),AA(JDXER),AA(JDXM),AA(JDXTMO),AA(JDXRMO),    &
     &           AA(JDSTT),AA(JDSTR),AA(JDS) ,AA(JVECT) ,AA(JVECR) ,    &
     &           AA(JDVECT),AA(JDVECR),AA(JDVCT2),AA(JDVCR2),           &
     &           AA(JBETAT),AA(JBETAR),AA(JAT),AA(JAR),                 &
     &           AA(JSUMT),AA(JSUMR),AA(JFT),AA(JFR),AA(JDELTT),        &
     &           AA(JDELTR),AA(JDELTS),AA(JDLMOT),AA(JDLMOR),           &
     &           AA(JDLEMT),AA(JDLEMR),AA)
      GOTO 30150
30100 CONTINUE
      ! for Sun
      CALL INTPRX(AA(KXSTT),AA(JXSTT),AA(KXSTR),AA(JXSTR),AA(KXSS),     &
     &           AA(JXSS),COEFEM,COEFMO,COEFX,                          &
     &           IGRP,IORCB,IORTB,IORMO,1.D00,L2WAY,NM,AA(KRANGT),      &
     &           AA(KRANGR),AA(JRANG2),AA(JRANG4),AA(JRRR),             &
     &           AA(KOBSC) ,AA(KCHCBS),AA(JCHCBS),AA(KCHEMT),AA(JCHEMT),&
     &           AA(KCHEMR),AA(JCHEMR),AA(KCHMOT),AA(JCHMOT),           &
     &           AA(KCHMOR),AA(JCHMOR),AA(KEPOST),AA(KEPOSR),           &
     &           AA(KCPOSS),                                            &
     &           AA(JDXET),AA(JDXER),AA(JDXM),AA(JDXTMO),AA(JDXRMO),    &
     &           AA(JDSTT),AA(JDSTR),AA(JDS) ,AA(JVECT) ,AA(JVECR) ,    &
     &           AA(JDVECT),AA(JDVECR),AA(JDVCT2),AA(JDVCR2),           &
     &           AA(JBETAT),AA(JBETAR),AA(JAT),AA(JAR),                 &
     &           AA(JSUMT),AA(JSUMR),AA(JFT),AA(JFR),AA(JDELTT),        &
     &           AA(JDELTR),AA(JDELTS),AA(JDLMOT),AA(JDLMOR),           &
     &           AA(JDLEMT),AA(JDLEMR),AA)
30150 CONTINUE
      ENDIF

!     IF(JNDRAM.NE.0.AND.LAVGRR) THEN
!        IF (LASTSN) THEN
!
! SUBROUTINE RAMPRR IS FOR MT 52 & 54. THESE ARE NATURALLY TWO WAY
! MEASURMENTS IN GEODYN (L2WAY=.TRUE.). ALTHOUGH THE RAMPED
! DOPPLER MEASUREMENT IS TREATED AS A ROUND TRIP MEASUREMENT, RAMPRR
! EXPECTS THAT THE INPUT COMPUTED NEASUREMENT (THE DIFFERNCE BETWEEN
! ROUND TRIP RANGES (INCLUDING CORRECTIONS)  AT ENDS OF THE COUNTING
! INTERVAL) HAS BEEN
! DIVIDED BY TWO. IF INTPRR, INTPRM OR INTPRX HAVE BEEN CALLED THEN
! THE DIVISION BT TWO WILL HAVE BEEN DONE (BUT NOT FOR THE CORRECTIONS)
! THE CODE BELOW  ADDS IN THE CORRECTIONS DIVIDED BY TWO. OT ALSO
! DIVIDES THE COMPUTED MEAS BY TWO FOR THE CASES WHEN THE INTPR?
! ROUTINES WERE NOT CALLED
!
!
      IF(L2WAY.AND.JNDRAM.NE.0.AND.LAVGRR) THEN
         IF (LASTSN.OR.(ICBDGM.EQ.ITBDGM)) THEN
           DO N=1,NM
             AA(KOBSC-1+N)=AA(KOBSC-1+N)/2.D+0
           ENDDO
         ENDIF
         !write(6,'(A,1x,I5)')'metric:1 call sumcor  mtype =', mtype
         !write(6,'(A,1x,E24.16)')'metric:1 bef call sumcor AA(KOBSC) ',&
         !

         CALL SUMCOR(AA,NM,MTYPE)

         DO N=1,NM
          AA(KOBSC-1+N)=AA(KOBSC-1+N)+AA(KSMCOR-1+N)/2.D0
         ENDDO

         !write(6,'(A,1x,E24.16)')'metric:1 aft call sumcor AA(KOBSC) ',&
         !                                                  AA(KOBSC)
      ENDIF !  JNDRAM.NE.0.AND.LAVGRR

      IF(INDRAM.NE.0) THEN
      DO 30101 N=1,NM
      SMC=AA(KSV1+KINDXC-1+N)+AA(KSV2+KINDXC-1+N)
      AA(KOBSC-1+N)=-((AA(KOBSC-1+N)*2.D0)-SMC)/VLIGHT
      TERM1=RINDM2*AA(KFT1AV-1+N)*AA(KOBSC-1+N)
      TERM2=RINDM2*AA(KDFQP-1+N)*AA(KTCP-1+N)
      TERM3=RINDM2*AA(KDFQP-1+N)*AA(KOBSC-1+N)
      AA(KOBSC-1+N)=(TERM1+TERM2+TERM3)/AA(KDTIME-1+N)
30101 END DO
      ENDIF
      IF(JNDRAM.NE.0) THEN
        CALL RAMPRR(AA(KOBSC),MJDSBL,TRINT,1000,MJDRMP,TRAMP,FRAMP,     &
     &              FDRAMP,NRAMPS,FREQO,RBIAS,VLIGHT,SF1,SF2,           &
     &              AA(KDTIME),XINTS,XINTB,XINTS2,NM)
      ENDIF
      RBIAS=ORBIAS
! DIVIDE MEASUREMENT, PARTIAL DERIVATIVE AND CORRECTION
!        DIFFERENCES BY TIME INTERVAL
      IF(INDRAM.NE.0) GOTO 75000
      CALL AVGRR (AA,AA(KPMPA),NDIM1,NDIM2,AA(KOBSC),AA(KTPRTL),        &
     &   AA(KDTIME),NM,NADJST,NTPRTL,LNPNM)
70000 CONTINUE
!     LAMB=.FALSE.
!     LAMBV=.FALSE.
      LAMB=.NOT.LPRE9(20)
      LAMBV=.NOT.LPRE9(21)
      IF(JNDRAM.GT.0) LAMB=.TRUE.
      IF(JNDRAM.GT.0) LAMBV=.TRUE.
      IF(JNDRAM.GT.0.AND.MTYPE.EQ.53) THEN
         CALL RAMPR(AA(KOBSC),MJDSBL,TRINT,1000,MJDRMP,TRAMP,FRAMP,     &
     &              FDRAMP,NRAMPS,FREQO,BIAS,VLIGHT,SF1,SF2,            &
     &              AA(KDTIME),XINTS,XINTB,XINTS2,LAMB,LAMBV,           &
     &              BLKDAT(2,1),AA(KDTIME),NM)
      ENDIF
      IF(ICBDGM.NE.ITBDGM.AND.MTYPE.EQ.42) THEN
         CALL IP1WAY(AA,II,LL,INDSAT(1,1),NM,NADJST,AA(KOBSC),          &
     &               AA(KPMPA),LNPNM,NDIM1,NDIM2,AA(KPRML0),MJDSBL,     &
     &               AA(KFSECS(2,5)),AA(KFSECS(2,1)),                   &
     &               AA(KDTIME),AA(KOBCOR(8,1)),LL(KLAVOI))
      ENDIF

      !write(6,*) 'metric: LITER1 ', LITER1

      IF(.NOT.LITER1) GO TO 75000
! ZERO OUT SUMCOR
       IF(LIONC.AND.LSIMDT)THEN
         DO 71000 K=1,NM
           AA(KSMCOR+K-1)=0.
71000    CONTINUE
       ENDIF
! SUM COMPUTED OBSERVATION CORRECTIONS (IF NOT RAMPED DOPPLER)

      IF(JNDRAM.GT.0.AND..NOT.LAVGRR)then
           !write(6,*) 'metric: call pcormp '
           CALL PCORMP(AA,MTYPE,NM,FREQO, FRINT,1000,SF2,VLIGHT)
      endif !  JNDRAM.GT.0.AND..NOT.LAVGRR


      IF(JNDRAM.LE.0.OR..NOT.LAVGRR) then

          !write(6,'(A,1x,I5)')'metric:2 call sumcor  mtype =', mtype
          CALL SUMCOR(AA,NM,MTYPE)

      endif ! JNDRAM.LE.0.OR..NOT.LAVGRR


      IF(MOD(MTYPE,2).EQ.0) GO TO 75000
      IF(LPRE9(20)) GO TO 75000
      LVAMB=.NOT.LPRE9(21)
! RESOLVE RANGE AMBIGUITIES. NOTE: THIS IS THE ONLY INSTANCE IN WHICH
!         THE OBSERVATION IS ACTUALLY ALTERED.
! IF SIMULATED DATA CARDS ARE PRESENT AND THE IONOSPHERIC OPTION IS
! SELECTED DO NOT OVERWRITE OBSERVATION WITH OBSERVATION AFTER ABIGUITIE
! HAVE BEEN REMOVED.
      IF(JNDRAM.GT.0) GO TO 75000
      IF(LIONC.AND.LSIMDT)GO TO 75000
      IF(.NOT.LVAMB) CALL AMBIG(AA(KOBS),AA(KOBSC),BLKDAT(2,1),NM,LVAMB,&
     &L2WAY,AA)
      IF(     LVAMB) CALL AMBIG(AA(KOBS),AA(KOBSC),AA(KDTIME ),NM,LVAMB,&
     &L2WAY,AA)
75000 CONTINUE

      IF(LNADJ) GO TO 90000
! set flag indicating that this is one way tdrss doppler data
      INDRAM=JNDRAM
      CALL BIASP (AA,AA(KPMPA),NDIM1,NDIM2,AA(KOBS),AA(KTPRTL),         &
     &            AA(KOBTIM),AA(KDTIME),AA(KPRML0),1,LNPNM,LL(KLAVOI),  &
     &            AA(KOBSC))
      INDRAM=0
      NVLITE=NPVAL0(IXVLIT)
      LITADJ=LSTINR.AND.NVLITE.GT.0
      IF(.NOT.LITADJ) GO TO 90000
! COMPUTE SPEED OF LIGHT PARTIAL
      INVLIT=IPVAL0(IXVLIT)
      CALL PLIGHT(AA(KPMPA),NDIM1,NDIM2,AA(KOBS),NM,INVLIT,LNPNM)
90000 CONTINUE
      IF(.NOT.LACC.AND.LPSBL)GOTO 90100
! EDIT, PRINT, SUM STATISTICS AND SUM INTO NORMAL EQUATIONS
      INDRAM=INDRAH

      !write(6,*)'metric:bef proces AA(KOBSC) ', (AA(KOBSC+j),j=0,NM-1)

      ALLOCATE(LEDIT_EXTRA(NM))
      LEDIT_EXTRA(:) = .FALSE.
      CALL PROCES(AA,II,LL,AA(KOBSC ),AA(KRESID),AA(KSIGMA),AA(KRATIO), &
     &          AA(KPMPA ),AA(KOBS  ),AA(KSMCOR),AA(KOBTIM),AA(KOBSIG), &
     &          AA(KIAUNO),AA(KEDSIG),II(KINDH ),II(KNMH  ),AA(KS    ), &
     &          AA(KS0   ),AA(KS1   ),LL(KLEDIT),AA(KELEVS),AA(KDSCRP), &
     &          JSTATS    ,MTYPE     ,INDSTA    ,INDSAT    ,LELEVS    , &
     &          II(KISTNO),AA(KSTNAM),AA(KXPMPA),LL(KLSDAT), 1,1      , &
     &          LL(KLRDED),LL(KLFEDT),LEDIT_EXTRA  )
      DEALLOCATE(LEDIT_EXTRA)
      INDRAM=0
90100 CONTINUE
      IF(INDRAM.NE.0) THEN
      KINDXC=KINDXC+NM
      ENDIF
      INDRAM=INDRAH
      RETURN
      END
