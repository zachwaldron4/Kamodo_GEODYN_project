      SUBROUTINE QUATBK(MJDSBL,FSECN,NM,AA,II,SCR,COSTHG,SINTHG,QUAT1,  &
     &                  QUAT2,QUAT3,QUAT4,IAST)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      COMMON/AXIS/LINTAX
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CRDDIM/NDCRD2,NDCRD3,NDCRD4,NDCRD5,NDCRD6,NDCRD7,          &
     &              NDCRD8,NDCRD9,NXCRDM
      COMMON/CSBSAT/KR,KRT,KZT,KXY2,KUZ,KUZSQ,KTEMP,KC3,KTHETG
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/RIMAGE/VIMAGE(6),QUCAM(4),QURSYS,TLBOD2
      DIMENSION AA(1),II(1),FSECN(NM),SCR(MINTIM,11)
      DIMENSION COSTHG(NM),SINTHG(NM)
      DIMENSION QUAT1(NM),QUAT2(NM),QUAT3(NM),QUAT4(NM)
      DIMENSION DUM(3),DUM1(3,2,1)
      DIMENSION RMAT1(3,3),RMAT2(3,3),RMAT3(3,3),QS(4)
!!
!!
!     GET THE PLANETARY ORIRNTATION ANGLES
!!
!!
      DO I=1,NM
        SCR(I,1)=0.D0
        SCR(I,2)=0.D0
        SCR(I,3)=0.D0
      ENDDO
! CALL SATUPD TO GET J2000 TO PLANET TOD MATRIX
      CALL SATUPD(MJDSBL,FSECN,SCR,SCR,AA,NM,MINTIM,.TRUE.,             &
     &           .FALSE.,II,0,IAST)
! COMPUTE THE PRIME MERIDIAN ANGLE

      IF(ICBDGM.EQ.3) THEN
      CALL GRHRAN(MJDSBL,FSECN,.FALSE.,.FALSE.,AA(KEQN),AA(KSRTCH),     &
     &  AA(KTHETG),COSTHG,SINTHG,NM,AA,II,AA(KXUTDT),.FALSE.,DUM,DUM1)


      ELSE
        IF (LINTAX) THEN
!!! NOTE THAT THE CALL TO GETCWS ONLY WORKS IF ORBIT HAS BEEN CALLED
!!! JUST PRIOR TO THE CALLING OF THIS ROUTINE @ MEASUREMENT TIMES
          CALL GETWCS (NM,AA(KDPOR),COSTHG,SINTHG,IAST)
        ELSE
          CALL ROTXTR(MJDSBL,FSECN,.FALSE.,AA(KEQN),AA(KSRTCH),         &
     &      AA(KTHETG),COSTHG,SINTHG,NM,AA,AA(KACOSW),                  &
     &      AA(KBSINW),AA(KANGWT),AA(KWT),AA(KACOFW),AA(KBCOFW),II,IAST)

        ENDIF
      ENDIF
!!
!!
!!
!!
! RECONSTRUCT THE SBF TO J2000 QUATERNION FROM THE SBF TO PLANET FIXED
! QUATERNION AND THE PLANETARY ORRIENTATION WRT J2000
!
      DO 1000 N=1,NM
!  FIRST CONSTRUCT J2000 TO PLANET
      RMAT1(1,1)=COSTHG(N)*AA(KROTMT+N-1)                               &
     &          +SINTHG(N)*AA(KROTMT+NDCRD2+N-1)
      RMAT1(1,2)=COSTHG(N)*AA(KROTMT+NDCRD4+N-1)                        &
     &          +SINTHG(N)*AA(KROTMT+NDCRD5+N-1)
      RMAT1(1,3)=COSTHG(N)*AA(KROTMT+NDCRD7+N-1)                        &
     &          +SINTHG(N)*AA(KROTMT+NDCRD8+N-1)
!
      RMAT1(2,1)=-SINTHG(N)*AA(KROTMT+N-1)                              &
     &           +COSTHG(N)*AA(KROTMT+NDCRD2+N-1)
      RMAT1(2,2)=-SINTHG(N)*AA(KROTMT+NDCRD4+N-1)                       &
     &           +COSTHG(N)*AA(KROTMT+NDCRD5+N-1)
      RMAT1(2,3)=-SINTHG(N)*AA(KROTMT+NDCRD7+N-1)                       &
     &           +COSTHG(N)*AA(KROTMT+NDCRD8+N-1)
!
      RMAT1(3,1)=AA(KROTMT+NDCRD3+N-1)
      RMAT1(3,2)=AA(KROTMT+NDCRD6+N-1)
      RMAT1(3,3)=AA(KROTMT+NDCRD9+N-1)
!
!
! NOW USE THE PROVIDED QUATERBNON FOR SBF TO PLANET TO GET THE
! IMPLIED ROTATION MATRIX
!
      CALL QATROT(QUCAM,RMAT2)
!
! NOW CONSTRUCT THE SBF TO J2000 MATRIX
      RMAT3(1,1)=RMAT1(1,1)*RMAT2(1,1)+RMAT1(2,1)*RMAT2(2,1)            &
     &          +RMAT1(3,1)*RMAT2(3,1)
      RMAT3(2,1)=RMAT1(1,2)*RMAT2(1,1)+RMAT1(2,2)*RMAT2(2,1)            &
     &          +RMAT1(3,2)*RMAT2(3,1)
      RMAT3(3,1)=RMAT1(1,3)*RMAT2(1,1)+RMAT1(2,3)*RMAT2(2,1)            &
     &          +RMAT1(3,3)*RMAT2(3,1)
!
      RMAT3(1,2)=RMAT1(1,1)*RMAT2(1,2)+RMAT1(2,1)*RMAT2(2,2)            &
     &          +RMAT1(3,1)*RMAT2(3,2)
      RMAT3(2,2)=RMAT1(1,2)*RMAT2(1,2)+RMAT1(2,2)*RMAT2(2,2)            &
     &          +RMAT1(3,2)*RMAT2(3,2)
      RMAT3(3,2)=RMAT1(1,3)*RMAT2(1,2)+RMAT1(2,3)*RMAT2(2,2)            &
     &          +RMAT1(3,3)*RMAT2(3,2)
!
      RMAT3(1,3)=RMAT1(1,1)*RMAT2(1,3)+RMAT1(2,1)*RMAT2(2,3)            &
     &          +RMAT1(3,1)*RMAT2(3,3)
      RMAT3(2,3)=RMAT1(1,2)*RMAT2(1,3)+RMAT1(2,2)*RMAT2(2,3)            &
     &          +RMAT1(3,2)*RMAT2(3,3)
      RMAT3(3,3)=RMAT1(1,3)*RMAT2(1,3)+RMAT1(2,3)*RMAT2(2,3)            &
     &          +RMAT1(3,3)*RMAT2(3,3)
!
! TURN THE MATRIX INTO A QUATERNION
      CALL ROTQAT(RMAT3,QS)
      QUAT1(N)=QS(1)
      QUAT2(N)=QS(2)
      QUAT3(N)=QS(3)
      QUAT4(N)=QS(4)
 1000 CONTINUE
      RETURN
      END
