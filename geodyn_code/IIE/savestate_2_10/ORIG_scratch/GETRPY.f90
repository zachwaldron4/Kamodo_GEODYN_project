!$GETRPY
      SUBROUTINE GETRPY(AA,II,MJDSIN,FSECIN,IATSAT,KVLAS,ATIME,         &
     &                  ISEQ,ISATID,IITERP,ATROT3,ATPER,ISET1,ROLL,     &
     &                  PITCH,YAW,TDIF,SINWT,COSWT,LCALLF,LMB,XSAT,VSAT)
!*******************************************************************
!  ROUTINE NAME:   GETRPY   DATE: 04/27/98      PGMR: D. E. PAVLIS
!
!   FUNCTION -  GET A ROTATION MATRIX TO AUGMENT THE TOR--->SBF MATRIX
!               TOR (USUALLY J2000)--->SBF MATRIX. THE AUGMENTATION
!               MATRIX MAY HAVE TWO PARTS. THE FIRST PART IS ALWAYS
!               PRESENT AND REPRESENTS OFF-NOMINAL ROTATIONS IN ROLL,
!               PITCH AND YAW OF THE SPACECRAFT BODY. THERE MAY BE A
!               A SECOND MATRIX WHICH REPRESENTS ROATIONS OF A LASER
!               OR A CAMERA IN THE SPACECRAFT FRAME. DEPENDING ON
!               THE VALUE OF THE ARGUMENT ITERP, ONE OF THE THREE
!               VALUES OF ONE OR THE OTHER OF THE TWO MATRICES MAY BE
!               PERTURBED FOR THE SAKE OF NUMERICAL PARTIAL EVALUATION.
!
!  I/O PARAMETERS:
!
!   NAME    A/S    I/O   DESCRIPTION OF I/O PARAMETERS IN ARGUMENT LIST
!   -----  ------ -----  -----------------------------------------------
!   AA       A     I/O   REAL DYNAMIC ARRAY
!   II       A     I/O   INTEGER DYNAMIC ARRAY
!   MJDSIN   S      I    MJDSEC FOR BLOCK START
!   FSECIN   A      I    FRACTIONAL SECONDS FOR EACH OBSERVATION
!   ISATID   S      I    SATELLIT ID FOR THIS BLOCK
!   IATSAT   A      I    ARRAY OF SATELLITES WITH ATITUDE PARAMETERS
!   KVLAS    A      I    ARRAY OF INSTRUMENT IDS
!   ATIME    A      I    TIMES FOR ATTITUDE PARAMETERS
!   ISEQ     A      I    ARRAY OF ROTATION SEQUENCE
!   ISATID   S      I    SATELLIT ID
!   IITERP   S      I    INDICATES IF ANY OF THE ANGLES OF THE TWO
!                        AUGMENTATION MATRICES ARE TO BE PERTURBED.
!                        0==> NO PERTURBATION
!                        4-9 ARE FOR PERTURBATIONS MADE FROM LASER
!                            ROUTINES
!                        11-16 ARE FOR PERTURBATIONS MADE FROM CAMERA
!                            ROUTINES
!                        4 OR 11==> PERTURB ROLL OF SC BODY MATRIX
!                        5 OR 12==> PERTURB PITCH OF SC BODY MATRIX
!                        6 OR 13==> PERTURB YAW OF SC BODY MATRIX
!                        7 OR 14==> PERTURB ROLL OF LASER/CAMERA MATRIX
!                        8 OR 15==> PERTURB PITCH OF LASER/CAMERA MATRIX
!                        9 OR 16==> PERTURB YAW OF LASER/CAMERA MATRIX
!
!   ATROT3   A      O    TOTAL ROTATION FOR AUGMENTATION MATRICES
!   ATPER    A      I    ARRAY OF ATTITUD PERIODS (FOR PERIODIC TERMS)
!                        FIVEN BY SATELLITE
!   LCALLF   S      I    .TRUE. IF THE CALL IS FOR MULTIPLE TIMES. THIS
!                        WILL BE THE CASE FROM MEASURMENT MODELING
!                        ROUTINES AND FALSE FOR FORCE MODEL CALLS FROM
!                        SUBROUINE F
!   LMB      S      I    TRUE WHEN ATTITUDE FOR MAIN BODY IS DESIRED
!                        EVEN WHEN MAXLAS.GT.0 . THIS WOULD BE TRUE
!                        WHEN THE CALL IS BEING MADE fOR SOME REASON
!                        OTHER THAN A CAMERA OR LASER
!   XSAT     A      I    SATELLITE POSITIONS (USED IF ATTITUDE
!                        PARAMETERS ARE IN ORBIT ANGLE MODE)
!   VSAT     A      I    SATELLITE VELOCITIES (USED IF ATTITUDE
!                        PARAMETERS ARE IN ORBIT ANGLE MODE)
!
!
!***********************************************************************
!
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      COMMON/LIMAGE/LIMG,LIMCALL,LIMAT,LIMCAM
      COMMON/ATTCB /KPAT,MAXAT,MAXLAS,IBLAS,                            &
     &              NASAT,IATCNT,NXATT
      COMMON/IATTCB/INDXAT
      COMMON/ATTCBD/BATPER,ATTPRT
      COMMON/CALTOP/LADYNO,LAGEOO,LRGEOT,LRETDT,LROTDT,LRSSTT,LCOTRM,   &
     &              LFILOT,LATCOR,LFIRIT,LX1ALT,LX2ALT,LMSSWG,LATMOD,   &
     &              LG1BOT,LG1B,LONEG1,LXATTD,LXBEAM,NXALTO
      COMMON/CBLOKA/FSECBL,SIGNL ,VLITEC,SECEND,BLKDAT(6,4),DOPSCL(5,4)
      COMMON/CBLOKI/MJDSBL,MTYPE ,NM    ,JSTATS,NPSEG ,JSATNO(3),ITSYS ,&
     &       NHEADB,NELEVS,ISTAEL(12),INDELV(3,4),JSTANO(3),ITARNO,     &
     &       KTARNO
      COMMON/CPMPA /KTMPAR(3)    ,KMBPAR(2)    ,KRFPAR(2)    ,          &
     &              KAEPAR,KFEPAR,KFPPAR,KVLPAR,KETPAR(2,2)  ,          &
     &              KPMPAR,KUTPAR,KSTPAR(3,4)  ,NADJST       ,          &
     &              NDIM1 ,NDIM2 ,NXDIM1,NXDIM2
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
!!    ....added CORA04 because KPMPA was undefined    ! jjm 9/98
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/OASAT/IOASAT(100),NOASAT
      COMMON/XOVER /KXKNT,KXBST,KXOBL,KXBUP,KXBPA,IAPLSC,IAPLL
      COMMON/XOVERR/XBTIME
!
      DIMENSION ATROT1(3,3),ATROT2(3,3),ATROT3(3,3,MINTIM)
      DIMENSION AA(1),II(1)
      DIMENSION FSECIN(1)
      DIMENSION IATSAT(NASAT)
      DIMENSION KVLAS(10,NASAT)
      DIMENSION ATIME(NASAT,MAXAT)
      DIMENSION ISEQ(MAXAT,MAXLAS+1,NASAT),JSEQ(6)
      DIMENSION IRETB(2)
      DIMENSION ATPER(1)
      DIMENSION XSAT(MINTIM,3),VSAT(MINTIM,3)
!
      DATA JSEQ/123,132,213,231,312,321/
!!!!  DATA LOA/.TRUE./
!
!********1*********2*********3*********4*********5*********6*********7**
! START OF EXECUTABLE CODE
!********1*********2*********3*********4*********5*********6*********7**
      LOA=.FALSE.
      DO I=1,NOASAT
        IF(ISATID.EQ.IOASAT(I)) THEN
          LOA=.TRUE.
          GO TO 5
        ENDIF
      ENDDO
  5   CONTINUE
!
! SET ITERP FROM IITERP TO BE CONSISTENT WITH LASER
!
       ITERP=IITERP
       IF(IITERP.EQ.11) ITERP=4
       IF(IITERP.EQ.12) ITERP=5
       IF(IITERP.EQ.13) ITERP=6
       IF(IITERP.EQ.14) ITERP=7
       IF(IITERP.EQ.15) ITERP=8
       IF(IITERP.EQ.16) ITERP=9
!
       IF(LCALLF) THEN
       JNM=NM
       ELSE
       JNM=1
       ENDIF
!
! INTIALIZE ATROT3
       DO I=1,JNM
         ATROT3(1,1,I)=1.D0
         ATROT3(2,1,I)=0.D0
         ATROT3(3,1,I)=0.D0
         ATROT3(1,2,I)=0.D0
         ATROT3(2,2,I)=1.D0
         ATROT3(3,2,I)=0.D0
         ATROT3(1,3,I)=0.D0
         ATROT3(2,3,I)=0.D0
         ATROT3(3,3,I)=1.D0
       ENDDO
! CORRECT ROT FOR ROLL PITCH YAW IF APPLICABLE
! IF MAXLAS IS ZERO THEN ONLY THE S/C NEEDS TO BE CORRECTED
! IF MAXLAS IS N THEN THIS SUBROUTINE NEEDS TO BE CALLED 2 TIMES
! FOR  THE S/C AND FOR THE LASER
!
      DO  I=1,2
       IRETB(I)=0
      ENDDO
!
! MAXAT IS THE MAXIMUM # OF ATITUDE PERIODS. IF THERE ARE ANY
! ATITUDE PARAMETRS MAXAT MUST BE AT LEAST 1
!
      IF(MAXAT.LE.0) THEN
! THERE ARE NO ATITUDE PARAMETERS IN THE RUN.
! THIS IS OK ONLY IF LMB=.TRUE. IN THAT CASE
! ATROT3 IS THE IDENTY MATRIX (ALREADY INTIALIZED)
        IF(LMB) THEN
          RETURN
        ELSE
          WRITE(6,6000)
          WRITE(6,6001) MTYPE
          WRITE(6,6002)
          STOP
        ENDIF
      ENDIF
!
! AT THIS POINT IT HAS BEEN DETERMINED THAT THERE ARE ATITUDE
! PARAMETERS IN THE RUN (MAXAT.GT.0)
!
! SEE IF THE SAT HAS ATTITIDE PARAMETERS (IRETB(1).GT.0)
!
      CALL FNDNUM(ISATID,IATSAT,NASAT,IRETB(1))
      IF(IRETB(1).EQ.0) THEN
! THIS SAT HAS NO ATITUDE PARMS
! OK IF LMB TRUE. JUST USE THE IDENTY MATRIX FOR ATROT3
        IF(LMB) RETURN
        WRITE(6,6000)
        WRITE(6,6001) MTYPE
        WRITE(6,6003) ISATID
        WRITE(6,6004)
        STOP
      ENDIF
!
! AT THIS POINT SATELLITE HAS ATITUDE PARAMETERS
!
!
!  CHECK LASER (OR CAMERA TRACKING PT) ID
      IF(.NOT.LMB.AND.MAXLAS.LE.0) THEN
         WRITE(6,6000)
         WRITE(6,6001) MTYPE
         WRITE(6,6005)
         STOP
      ENDIF
! AT THIS POINT, IF LMB IS FALSE, THEN MAXLAS>0
      ILASID=-9999
      LLASER=.FALSE.
      IF(.NOT.LMB) THEN
       JLASID=INT(BLKDAT(4,1)+0.01D0)
       JLASID=MOD(JLASID,10)
       IF(JLASID.GT.0) ILASID=JLASID
       CALL FNDNUM(ILASID,KVLAS(1,IRETB(1)),10,IRETB(2))
       IF(IRETB(2).EQ.0) THEN
          WRITE(6,6000)
          WRITE(6,6001) MTYPE
          WRITE(6,6006) ISATID
          WRITE(6,6007) JLASID
          WRITE(6,6008)
          STOP 16
       ENDIF
       LLASER=.TRUE.
      ENDIF
!
! IF LLASER IS TRUE, THE ROTATION MATRIX HAS TWO COMPONENTS ; OTHERWISE ONLY 1
!
!
!
!
! THE FOLLOWING IS AN APPROXIMATE  WAY TO DEAL WITH POINTERS INDEXED BY
! TIME PERIODS, BUT WE DO IT ANYWAY.
! DETERMINE TIME PERIOD USING MID POINT OF BLOCK AND NOT EACH OBS
!
      IMID=(JNM/2)+1
      TBEST=DBLE(MJDSIN)+FSECIN(IMID)
!
      IF(.NOT.LOA) THEN
!  STANDARD TIME ARGUMENT FOR ATTITUDE PERIODS
!
!... STARTING EPOCH USED FOR BASE FOR FIRST TIME PERIOD
      EPOCH=DBLE(II(KMJDS0+ISET1-1))+AA(KFSEC0+ISET1-1)
        DO J=1,MAXAT
         IF(TBEST.LE.ATIME(IRETB(1),J)) THEN
          INDXX=J
          IF(INDXX.EQ.1) THEN
           XBTIME=EPOCH
          ELSE
           XBTIME=ATIME(IRETB(1),J-1)
          ENDIF
          EXIT
         ENDIF
        END DO
      ELSE
!  ORBIT ANGLE ARGUMENT FOR ATTITUDE PERIODS
!
!... STARTING EPOCH USED FOR BASE FOR FIRST TIME PERIOD
        EPOCH=0.D0
        CALL OA(TBEST,XSAT(IMID,1),XSAT(IMID,2),XSAT(IMID,3),           &
     &          VSAT(IMID,1),VSAT(IMID,2),VSAT(IMID,3),AA,II,OATS)
        DO J=1,MAXAT
         TC=MOD(ATIME(IRETB(1),J),86400.D0)
         IF(OATS.LE.TC) THEN
          INDXX=J
          IF(INDXX.EQ.1) THEN
           XBTIME=EPOCH
          ELSE
           XBTIME=MOD(ATIME(IRETB(1),J-1),86400.D0)
          ENDIF
          EXIT
         ENDIF
        END DO
! ENDIF FOR IF(.NOT.LOA) THEN
      ENDIF
!
!
! INDXAT IS THE ATTITUDE PERIOD NUMBER
      INDXAT=INDXX
      MAXBOD=MAXLAS+1
! IADD IS THE STARTING LOCATION IN THE ATTITUDE PARAMETER ARRAY FOR THIS SAT
      IADD=MAXAT*MAXBOD*15*(IRETB(1)-1)
! BATPER IS THE PERIOD ASSOCIATED WITH THE PERIODIC ATTITUDE PARAMETERS FOR THIS
      BATPER=ATPER(IRETB(1))
!
!
      DO 1000 INMNDX=1,JNM

       JJ=1
       IF(LLASER) JJ=2

       OBSTIM=DBLE(MJDSIN)+FSECIN(INMNDX)
       TDIF=OBSTIM-XBTIME
!
! SEQUENCE FOR THIS BODY IS
!
       DO I=1,6
        IF(ISEQ(INDXAT,IRETB(2)+1,IRETB(1)).EQ.JSEQ(I)) THEN
         INDS=I
         EXIT
        ENDIF
       END DO

!
! FORM THE ATROT3 MATRIX  WHICH ALWAYS HAS A COMPONENT OF THE SPACECRAFT BODY
! AND MAY ALSO HAVE A 2ND COMPNENT FROM A LASER OR CAMERA
!
      DO 1500 IJ=1,JJ
!
      JTERP=ITERP
      IF(IJ.EQ.1.AND.ITERP.GT.6) JTERP=0
      IF(IJ.EQ.2.AND.ITERP.LT.7) JTERP=0
!
      CALL RPY(AA,II,AA(KPRMV),AA(KPRMV0),                              &
     &MAXBOD,TDIF,IRETB(IJ),INDXAT,IADD,                                &
     &INMNDX,ATROT1,JTERP,IJ,INDS,BATPER,ROLL,PITCH,YAW,                &
     &SINWT,COSWT)
!
      IF(JJ.EQ.1) THEN
! IN THIS CASE THERE IS ONLY THE SC BODY
       DO 1505 I=1,3
       DO 1505 K=1,3
        ATROT3(I,K,INMNDX)=ATROT1(I,K)
 1505  CONTINUE
       GOTO 1500
      ENDIF

      IF(IJ.EQ.1)  THEN
       DO 1510 I=1,3
       DO 1510 K=1,3
        ATROT2(I,K)=ATROT1(I,K)
 1510  CONTINUE
       GOTO 1500
      ENDIF

      CALL MATPRD(ATROT2,ATROT1,ATROT3(1,1,INMNDX),3,3,3)

 1500 END DO


 1000 END DO
 3000 CONTINUE
      RETURN
6000  FORMAT(' EXCUTION TERMINATING IN SUBROUTINE GETRPY')
6001  FORMAT(' CALL MADE FOR MTYPE ',I5,' (LASER OR CAMERA)')
6002  FORMAT(' BUT THERE ARE NO ATTITUDE PARAMETERS IN THE RUN')
6003  FORMAT(' FOR SATID: ',I8' BUT THERE ARE NO ATITUDE PARAMETERS')
6004  FORMAT(' ASSOCIATED WITH THIS SATELLITE ')
6005  FORMAT(' BUT THERE ARE NO LASER ATTITUDE PARAMETERS IN THE RUN')
6006  FORMAT(' AND FOR SATID: ',I10)
6007  FORMAT(' LASER ID ON WORD 4 OF BLOCK HEADER : ',I6)
6008  FORMAT(' NOT AVAILABLE FOR THIS SATELLITE')
      END
