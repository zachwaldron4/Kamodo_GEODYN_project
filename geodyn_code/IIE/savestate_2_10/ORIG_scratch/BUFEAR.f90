!$BUFEAR
      SUBROUTINE BUFEAR(MJD1,FSC1,MJD2,FSC2,MSIGN,MJDR,FSECR,LRECAL,AA, &
     &                  II)
!********1*********2*********3*********4*********5*********6*********7**
! BUFEAR           87/12/24            8701.0    PGMR - D. ROWLANDS
!
! FUNCTION:  FILL EPHEMERIS & INTERPOLATION ENPOINT COMMON BLOCKS
!            WITH PROPER INFORMATION FOR TIMES SPECIFIED IN
!            CALLING SEQUENCE FOR EARTH.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJD1     I    S    ENDPOINT TIME IN EPHEMERIS SECONDS FROM
!                      GEODYN REFERENCE TIME
!   FSC1     I    S    REMAINING SECONDS FROM MJD1
!   MJD2     I    S    ENDPOINT TIME
!   FSC2    I\O   S    REMAINING SECONDS FROM MJD2
!   MSIGN    I    S    POSITIVE # IF (MJD2+FSC2)>(MJD1+FSC1);
!                      OTHERWISE NGEATIVE
!   MJDR     O    S    OUTPUT ENDPOINT TIME WHICH POSSIBLY REPLACES
!                      MJD2 IF REQUESTED INTERVAL IS TOO LARGE
!   FSECR         S    REMAINING SECONDS FROM MJOR
!   LRECAL   O    S    TRUE IF REQUESTED INTERVAL IS TOO LARGE.
!   AA      I/O   A    REAL DYNAMIC ARRAY
!
! COMMENTS:  COMMON BLOCKS WILL BE FILLED WITH INFORMATION
!            ALLOWING COORDINATE SYSTEM CALLS BETWEEN ENPOINT
!            TIMES.IN THE CASE THAT THE REQUESTED INTERVAL IS
!            TOO LARGE,THE INTERVAL WILL INCLUDE TIME MJD1+FSC1
!            GOING FORWARD/BACKWARD IN THE DIRECTION OF MSIGN
!            UP TO/BACK MJDR+FSECR.
!            THIS ROUTINE REPLACES BUFPOS. BUFPOS WAS MODIFIED SO THAT
!            EARTH PRECESSION/NUTATION INFORMATION  COULD BE CALCULATED
!            IN THE SAME ARC AS PLANET PRECESSION/NUTATION INFORMATION
!            WITHOUT MOVING JPL EPHEMERIS INFORMATION ANY MORE THAN IS
!            NECESSARY.
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      DIMENSION SCRTCH(5),HOLD(264),AA(1),II(1)
      DIMENSION DPSIR(500),EPSTR(500)
!
      COMMON/BUFOPT/LADRAG,LXTIDE,LPOLTI,NXBUFO
      COMMON/CNUTAT/SINEM(1),COSEM(1),SINDP(1),COSDP(1),SINET(1),       &
     &   COSET(1),SINZ(1),COSZ(1),SINTH(1),COSTH(1),SINEA(1),COSEA(1),  &
     &   SDSE(1),SDCE(1),CDSE(1),CDCE(1),SESD(1),SECD(1),CESD(1),       &
     &   CECD(1),SESE(1),SECE(1),CESE(1),CECE(1),CECT(1),SEST(1),       &
     &   CEST(1),SECT(1),CECZ(1),CESZ(1),SECZ(1),SESZ(1),STSZ(1),       &
     &   CTCZ(1),STCZ(1),CTSZ(1),CTCZCE(1),STSZSE(1),CTCZSE(1),         &
     &   CTSZCE(1),STCZCE(1),STSZCE(1),STCZSE(1),CTSZSE(1),SESDSE(1),   &
     &   SESDCE(1),SECDSE(1),SECDCE(1),CESDSE(1),CESDCE(1),CECDSE(1),   &
     &   CECDCE(1),EPSM(1),EPST(1),DPSI(1),Z(1),THTA(1),ETA(1),AK1(1),  &
     &   AK2(1),AK3(1),AK4(1),AK5(1),AK6(1),AK7(1),AK8(1),SUMMY(198)
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CTIDES/NTIDE,NSTADJ,NET,NETADJ,NETUN,NOT,NOTADJ,           &
     &   NOTUN ,NETUNU,NETADU,NOTUNU,NOTADU,NBSTEP,KTIDA(3),            &
     &   ILLMAX,NUNPLY,NNMPLY,NDOODN,MXTMRT,NRESP ,NXCTID
      COMMON/DYNPTR/KDEPHM,KDEPH2,KDAHDR(3,9),KDYNAP(3,9,2),KDNEXT(3),  &
     &NXDYNP
      COMMON/EPHM/FSECXY(1),XP(261),YP(261),A1UT(261),EP(261),EC(261),  &
     &            FSCFLX(1),FLUXS(36),AVGFLX(36),FLUXM(288),FSECEP(1),  &
     &            EPHP(816),EPHN(96),ELIB(120),BUFT(2700),FSECNP(4)
      COMMON/EPHMPT/NTOT,NTOTS,NNPDPR,NUTORD,IBODDG(8),IGRPDG(4),       &
     &              NENPD,INRCD(2),KPLAN(11),NINEP,NEPHMR,NEPHEM,       &
     &              IBHINT,NINTBH,NXEPHP
      COMMON/EPHSET/EMFACT,DTENPD,DTINPD,FSC1EN,FSCENP(2),FSCINP(4),    &
     &   FSDINP(4),XEPHST
      COMMON/LICASE/LINT(2),LCASE(18),NXLCAS
!
      DATA ONE/1.D0/,TWO/2.D0/,ZERO/0.D0/
      DATA MSIGNP/0/
      DATA KENTRY/0/
!
!**********************************************************************
! START OF EXECUTABLE CODE ********************************************
!**********************************************************************
!
!
!c      write(6,*) 'bufear: mjd1, fsc1, mjd2, fsc2, mjdsc2, fsec2 ',
!c     1                    mjd1, fsc1, mjd2, fsc2, mjdsc2, fsec2
      LTOP=.FALSE.
      DO 2 I=2,18
      IF(LINT(1).AND.LCASE(I)) LTOP=.TRUE.
    2 END DO
      IF(KENTRY.EQ.0) THEN
      LTOP=.FALSE.
      ENDIF
      KENTRY=KENTRY+1
      LRECAL=.FALSE.
      IF(MSIGN.LT.0) GO TO 10
      MJDSC1=MJD1
      FSEC1=FSC1
      MJDSC2=MJD2
      FSEC2=FSC2
      MJDR=MJDSC2
      FSECR=FSEC2
      GO TO 20
   10 CONTINUE
      MJDSC1=MJD2
      FSEC1=FSC2
      MJDSC2=MJD1
      FSEC2=FSC1
      MJDR=MJDSC1
      FSECR=FSEC1
   20 CONTINUE
      INIT1=(FSEC1+(MJDSC1-FSC1EN))/DTINPD+1
      INIT4=(FSEC2+(MJDSC2-FSC1EN))/DTINPD+2
      INIT1P=(FSCINP(1)-FSC1EN)/DTINPD+1
      INIT4P=(FSCINP(4)-FSC1EN)/DTINPD+1
      INDX1=(FSEC1+(MJDSC1-FSC1EN))/DTENPD+1
      INDX2=(FSEC2+(MJDSC2-FSC1EN))/DTENPD+1
      INDX1P=(FSCENP(1)-FSC1EN)/DTENPD+1
      INDX2P=(FSCENP(2)-FSC1EN)/DTENPD+1
      ITEST1=(MSIGN-MSIGNP)**2
      ITEST2=(INIT1-INIT1P)**2+(INIT4-INIT4P)**2
      ITEST3=(INDX1-INDX1P)**2+(INDX2-INDX2P)**2
      ITEST=ITEST1+ITEST2+ITEST3
      IF(ITEST.EQ.0) RETURN
      NBSTEP=0
      NENPD=INDX2-INDX1+1
      NENPD=MIN(NENPD,2)
      IF(MSIGN.LT.0) GO TO 50
      INDX2=INDX1+NENPD-1
      GO TO 60
   50 INDX1=INDX2-(NENPD-1)
   60 CONTINUE
      FSCENP(1)=FSC1EN+(INDX1-1)*DTENPD
      FSCENP(2)=FSC1EN+(INDX2-1)*DTENPD
      IF(ITEST1.EQ.0.AND.ITEST2.EQ.0) GO TO 425
      NINEP=INIT4-INIT1+1
      NINEP=MIN(NINEP,4)
      IF(MSIGN.LT.0) GO TO 105
      INIT4=INIT1+(NINEP-1)
      GO TO 108
  105 INIT1=INIT4-(NINEP-1)
  108 CONTINUE
      NB1=MAX(0,INIT1P-INIT1)
      NB2=MAX(0,INIT4-INIT4P)
      IFGN=MIN(1+NB1,NINEP+1)
      ILGN=MAX(NINEP-NB2,0)
      IFGN1=IFGN-1
      NGOOD=-1
      IF(IFGN.GT.ILGN) GO TO 300
!   TRANSFER GOOD INFORMATION IN CNUTAT
      NB11=MAX(0,INIT1-INIT1P)
      IFGO=1+NB11
      IFGN1=IFGN-1
      NGOOD=ILGN-IFGN1
      NSPOT2=(IFGO-1)*66
      NTRANS=NGOOD*66
      NSPOT1=IFGN1*66
      DO 150 I=1,NTRANS
  150 HOLD(I)=SINEM(I+NSPOT2)
      DO 200 I=1,NTRANS
  200 SINEM(I+NSPOT1)=HOLD(I)
      IF(LXTIDE) CALL MNSNBF(NGOOD,IFGO,IFGN)
  300 CONTINUE
!   GET NEW INTERP TIMES
      DO 380 I=1,NINEP
  380 FSCINP(I)=FSC1EN+(INIT1+I-2)*DTINPD
      NLEFT=4-NINEP
      IF(NLEFT.LE.0) GO TO 390
      DO 385 I=1,NLEFT
      FSCINP(I+NINEP)=FSCINP(NINEP)
  385 END DO
  390 CONTINUE
      IF(MSIGN.LT.0) GO TO 395
      MJDR=FSCINP(NINEP)
      FSECR=FSCINP(NINEP)-MJDR
      TQ1=MJDR+FSECR
      TQ2=MJD2+FSC2
      IF(TQ1.LT.TQ2) LRECAL=.TRUE.
      GO TO 400
  395 CONTINUE
      MJDR=FSCINP(1)
      FSECR=FSCINP(1)-MJDR
      TQ1=MJDR+FSECR
      TQ2=MJD2+FSC2
      IF(TQ1.GT.TQ2) LRECAL=.TRUE.
  400 CONTINUE
!   NOW COMPUTE QUANTITIES NOT AVAILABLE FROM LAST CALL
!
      IF(NEPHEM.GE.200) THEN
      CALL NPNCON
      ELSE
      CALL PNCON
      ENDIF
!
  425 CONTINUE
      IF(.NOT.LTOP) GOTO 426
      JSIGNP=MSIGNP
  426 CONTINUE
      MSIGNP=MSIGN
      IERCD1=(INDX1-1)/NNPDPR+1
      IERCD2=IERCD1
      INRCD(1)=1+MOD((INDX1-1),NNPDPR)
      ICHK=INRCD(1)+NENPD-1
      IF(ICHK.GT.NNPDPR) IERCD2=IERCD1+1
!***** DEBUG *****
!     PRINT 12345,KDEPHM
!2345 FORMAT(' **BUFPOS**  KDEPHM=',I12)
!***** END DEBUG *
!c      write(6,*) 'bufear: iercd1, iercd2, nnpdpr, kdephm ',
!c     1                    iercd1, iercd2, nnpdpr, kdephm
      CALL FILEPH(IERCD1,IERCD2,AA(KDEPHM))
! IN CASE OF DTM APPLICATION IN THE INTERCOMPARISON USE CONSTANT
! FLUXES , CONSTANT AVERAGE FLUX VALUE AND CONSTANT 3-HOURLY KP
! VALUES
      IF(.NOT.LTOP) GOTO 442
      IF(.NOT.LCASE(15).AND..NOT.LCASE(16)) GOTO 432
      DO 430 K=1,36
      FLUXS(K)=250.D0
      AVGFLX(K)=200.D0
  430 END DO
      DO 431 K=1,288
      FLUXM(K)=2.5D0
  431 END DO
  432 CONTINUE
      IF(ITEST1.EQ.0.AND.ITEST2.EQ.0) RETURN
      IF(JSIGNP.EQ.0) THEN
      DO 433 IND=1,80
      EPHN(IND)=ZERO
  433 END DO
      NTOT1=1+NTOT
      DO 440 IND=NTOT1,NTOT1+79
      EPHN(IND)=ZERO
  440 END DO
      ENDIF
  442 CONTINUE
      INRCD(1)=(INRCD(1)-1)*NUTORD*2+1
      INRCD(2)=INRCD(1)+(NENPD-1)*2*NUTORD
      IF(IERCD2.GT.IERCD1) INRCD(2)=NTOT+1
      IF(ITEST1.EQ.0.AND.ITEST2.EQ.0) RETURN
      IF(LADRAG) CALL D71BF1(NGOOD,IFGO,IFGN)
      ILGN1=ILGN+1
      IF=0
      IF(IFGN1.LT.1) GO TO 550
      IS=1
      IF=IFGN1
  450 DO 500 I=IS,IF
      N=(I-1)*66+1
      KDEX=2
      IF(FSCINP(I).LE.FSCENP(2)) KDEX=1
      KPOINT=INRCD(KDEX)
      DT=FSCINP(I)-FSCENP(KDEX)
      DT=TWO*DT/DTENPD-ONE
      CALL NUINT(EPHN(KPOINT),DT,0,FSCINP(I),DPSI(N),EPST(N), &
     &   EPSM(N),DPSIR,EPSTR,SCRTCH,1)
      SINEM(N)=SIN(EPSM(N))
      COSEM(N)=COS(EPSM(N))
      SINDP(N)=SIN(DPSI(N))
      COSDP(N)=COS(DPSI(N))
      SINET(N)=SIN(EPST(N))
      COSET(N)=COS(EPST(N))
      SINZ(N)=SIN(Z(N))
      COSZ(N)=COS(Z(N))
      SINTH(N)=SIN(THTA(N))
      COSTH(N)=COS(THTA(N))
      SINEA(N)=SIN(ETA(N))
      COSEA(N)=COS(ETA(N))
      CDCE(N)=COSDP(N)*COSET(N)
      CDSE(N)=COSDP(N)*SINET(N)
      SDSE(N)=SINDP(N)*SINET(N)
      SDCE(N)=SINDP(N)*COSET(N)
      SESD(N)=SINEM(N)*SINDP(N)
      SECD(N)=SINEM(N)*COSDP(N)
      CECD(N)=COSEM(N)*COSDP(N)
      CESD(N)=COSEM(N)*SINDP(N)
      CESE(N)=COSEM(N)*SINET(N)
      SESE(N)=SINEM(N)*SINET(N)
      SECE(N)=SINEM(N)*COSET(N)
      CECE(N)=COSEM(N)*COSET(N)
      SECDCE(N)=SECD(N)*COSET(N)
      CESDCE(N)=CESD(N)*COSET(N)
      SESDCE(N)=SESD(N)*COSET(N)
      CECDCE(N)=CECD(N)*COSET(N)
      CECDSE(N)=CECD(N)*SINET(N)
      SESDSE(N)=SESD(N)*SINET(N)
      CESDSE(N)=CESD(N)*SINET(N)
      SECDSE(N)=SECD(N)*SINET(N)
      CECT(N)=COSEA(N)*COSTH(N)
      SEST(N)=SINEA(N)*SINTH(N)
      CEST(N)=COSEA(N)*SINTH(N)
      SECT(N)=SINEA(N)*COSTH(N)
      CECZ(N)=COSEA(N)*COSZ(N)
      CESZ(N)=COSEA(N)*SINZ(N)
      SECZ(N)=SINEA(N)*COSZ(N)
      SESZ(N)=SINEA(N)*SINZ(N)
      STSZ(N)=SINTH(N)*SINZ(N)
      CTCZ(N)=COSTH(N)*COSZ(N)
      STCZ(N)=SINTH(N)*COSZ(N)
      CTSZ(N)=COSTH(N)*SINZ(N)
      CTCZCE(N)=CTCZ(N)*COSEA(N)
      STSZSE(N)=STSZ(N)*SINEA(N)
      CTCZSE(N)=CTCZ(N)*SINEA(N)
      CTSZCE(N)=CTSZ(N)*COSEA(N)
      STCZCE(N)=STCZ(N)*COSEA(N)
      STSZCE(N)=STSZ(N)*COSEA(N)
      STCZSE(N)=STCZ(N)*SINEA(N)
      CTSZSE(N)=CTSZ(N)*SINEA(N)
      AK1(N)=CTCZCE(N)-SESZ(N)
      AK2(N)=CTSZCE(N)+SECZ(N)
      AK3(N)=CTCZSE(N)+CESZ(N)
      AK4(N)=CTSZSE(N)-CECZ(N)
      AK5(N)=SECDSE(N)+CECE(N)
      AK6(N)=SECDCE(N)-CESE(N)
      AK7(N)=CECDSE(N)-SECE(N)
      AK8(N)=CECDCE(N)+SESE(N)
      IF(LADRAG.OR.LXTIDE) CALL PLAN12(I,0,FSCINP(I),LXTIDE,AA,II,      &
     &AA(KXUTDT))
  500 END DO
  550 IF(IF.GE.NINEP) RETURN
      IF(ILGN1.GT.NINEP) RETURN
      IS=ILGN1
      IF=NINEP
      GO TO 450
      END
