!$BCARDC
      SUBROUTINE BCARDC
!********1*********2*********3*********4*********5*********6*********7**
!  BCARDC          00/00/00         0000.0      PGMR - ?
!
! FUNCTION: CHECKS THE SETUP DECK FOR MBIAS CARDS.
!           (1) CHECKS FOR NUMBER OF CARDS LESS THAN 28000
!           (2) CHANGES DATE/TIME CHARACTER STRING TO DATE TIME INTEGERS
!           (3) CHECKS FOR DUPLICATE MBIAS CARDS
!           (4) REWRITES MBIAS TO NEW SETUP DECK
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!
!                      THROUGH COMMON BLOCKS
!
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**

      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      CHARACTER*80 CARD
      CHARACTER*15 DT2,DT3
      CHARACTER*13 DATE1,DATE2
      CHARACTER*6 MBIAS,MBIAS2,MBIAS3
      COMMON/BIAOR/NAMBB,NCYCB,NAMBBH
      COMMON/CARDB/MCARDB,NCARDB,ITCARD(3,28000),ISTABC(3,28000),       &
     &             ISATBC(3,28000),ICRDBF(28000)
      COMMON/CARDBV/VCARDB(28000),SCARDB(28000)
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/XPARMB/MPARMB,NPARMB,MPOBS,JPAMB,ISKIPE,                   &
     &             ITPARM(5,28000),ISTABP(3,28000),                     &
     &             ISATBP(3,28000),IPRMBF(28000)
      COMMON/ZPARMB/MPARMZ,ITPRMZ(1000),ISTABZ(3,1000),                 &
     &             ISATBZ(3,1000),IPRMPY(1000),IPRMZ(1000),IUSECY(1000)
      DIMENSION FSEC(1),SEC(1),IYMD(1),IHM(1)
      DATA DATE1/'            .'/
      DATA DATE2/'            .'/
      DATA MBIAS/'MBIAS '/
      DATA MBIAS2/'MBIAS2'/
      DATA MBIAS3/'MBIAS3'/
      MCARDB=28000
      MPARMB=28000
      MPARMZ=1000
      NCARDB=0
      NPARMB=NPVAL0(IXBISA)
      DO 5 I=1,MCARDB
      ICRDBF(I)=-99
    5 END DO
      DO 6 I=1,MPARMB
      IPRMBF(I)=-99
      ITPARM(2,I)=2147483647
      ITPARM(3,I)=-99
    6 END DO
      DO 7 I=1,MPARMZ
      ITPRMZ(I)=-99
      IPRMPY(I)=0
      IPRMZ(I)=0
    7 END DO
      IF(NCYCB.GT.MPARMZ) THEN
        WRITE(6,6600)
        WRITE(6,6601) NCYCB
        WRITE(6,6602) MPARMZ
        STOP
      ENDIF
!
      REWIND 14
!
   10 CONTINUE
      READ(14,5000,END=500) CARD
      IF(CARD(1:5).NE.'MBIAS') GO TO 10
      NCARDB=NCARDB+1
      IF(NCARDB.GT.MCARDB) THEN
         WRITE(6,6000)
         WRITE(6,6001) MCARDB
         STOP
      ENDIF
      READ(CARD,5001) ISTABC(1,NCARDB),ITCARD(1,NCARDB),                &
     &                ISATBC(1,NCARDB),                                 &
     &                VCARDB(NCARDB),DT2,DT3(1:13),SCARDB(NCARDB)


      DT3(14:15)='XX'



      CALL DT2I2(DT2,IYIMID,IHIMIS,LPROB)
      IF(LPROB) THEN
         !write(6,'(A,1x,A)') 'bcardc: DT2 ', trim( DT2 )
         WRITE(6,6200)
         WRITE(6,6400) CARD
         STOP
      ENDIF
      CALL YMDTIS(IYIMID,IHIMIS,ITCARD(2,NCARDB))



      CALL DT2I2(DT3,IYIMID,IHIMIS,LPROB)
      IF(LPROB) THEN
         !write(6,'(A,1x,A)') 'bcardc: DT3 ', trim( DT3 )
         WRITE(6,6200)
         WRITE(6,6300) CARD
         STOP
      ENDIF
      CALL YMDTIS(IYIMID,IHIMIS,ITCARD(3,NCARDB))

      ISATBC(2,NCARDB)=0
      ISATBC(3,NCARDB)=0
      ISTABC(2,NCARDB)=0
      ISTABC(3,NCARDB)=0
      ISATBC(3,NCARDB)=0
      LX1=.FALSE.
      LX2=.FALSE.
      LX3=.FALSE.
      IF(ITCARD(1,NCARDB).EQ.156) LX1=.TRUE.
      IF(ITCARD(1,NCARDB).GE.700.AND.ITCARD(1,NCARDB).LE.703) LX2=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.185) LX3=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.187) LX3=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.165) LX3=.TRUE.
      LXCEP=LX1.OR.LX2.OR.LX3
      IF(.NOT.LXCEP) THEN
         IF(ITCARD(1,NCARDB).EQ.43) GOTO 11
         IF(ITCARD(1,NCARDB).LT.57) GO TO 10
         IF(ITCARD(1,NCARDB).GT.98) GO TO 10
   11 CONTINUE
      ENDIF
      READ(14,5000) CARD
      IF(LX2) THEN
        IF(CARD(6:6).NE.'M') GO TO 10
      ELSE
        IF(CARD(6:6).NE.'2') GO TO 10
      ENDIF
      READ(CARD,5002) ISTABC(2,NCARDB),ISATBC(2,NCARDB)
      LXM=.FALSE.
      IF(ITCARD(1,NCARDB).EQ.57) LXM=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.59) LXM=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.65) LXM=.TRUE.   ! ddr mod
      IF(ITCARD(1,NCARDB).EQ.85) LXM=.TRUE.
!DEP
      IF(ITCARD(1,NCARDB).EQ.185) LXM=.TRUE.
      IF(ITCARD(1,NCARDB).EQ.165) LXM=.TRUE.
      IF(.NOT.LXM) GO TO 10
      READ(14,5000) CARD
      IF(CARD(6:6).NE.'3') GO TO 10
      READ(CARD,5002) ISTABC(3,NCARDB),ISATBC(3,NCARDB)
      GO TO 10
  500 CONTINUE
      WRITE(6,6100) NCARDB
      REWIND 14

!ddr mod
      DO 549 I=1,NCARDB
      WRITE(6,6900) I,(ITCARD(K,I),K=1,3),(ISATBC(J,I),J=1,3)
6900  FORMAT(' CARD # ',I6,' CONTENT: ',6I12)
  549 CONTINUE
!ddr mod
!
!
! CHECK ON DUPLICATE PROBLEM IN MBIAS INPUT
!
      NDUP=0
      IF(NCARDB.GT.1.AND.NPARMB.GT.0) THEN
         IE=NCARDB-1
         DO 700 I=1,IE
         JS=I+1
         DO 600 J=JS,NCARDB
         ITPC=ITCARD(1,I)
         IF(ITPC.GT.900) ITPC=900
         ITPP=ITCARD(1,J)
         IF(ITPP.GT.900) ITPP=900
         IF(ITPC.NE.ITPP) GO TO 600
         DO 550 K=1,3
         IF(ISTABC(K,I).NE.ISTABC(K,J)) GO TO 600
         IF(ISATBC(K,I).NE.ISATBC(K,J)) GO TO 600
  550    CONTINUE
         ITC1=MAX(ITCARD(2,I),ITCARD(2,J))
         ITC2=MIN(ITCARD(3,I),ITCARD(3,J))-20
         IF(ITC1.GE.ITC2) GO TO 600
!
! DUP MBIAS IN INPUT DECK FOUND
!
         NDUP=NDUP+1
         IF(NDUP.EQ.1) THEN
            WRITE(6,6400)
            WRITE(6,6500)
            WRITE(6,6501)
         ENDIF
         WRITE(6,6502) NDUP
         FSEC(1)=0.D0
         CALL YMDHMS(ITCARD(2,I),FSEC,IYMD,IHM,SEC,1)
         IYMD1=IYMD(1)
         IHM1=IHM(1)
         IS=SEC(1)
         IHM1=100*IHM1+IS
         CALL NUMASC(IYMD1,DATE1,16,.TRUE.)
         CALL NUMASC(IHM1,DATE1(7:12),16,.TRUE.)
         FSEC(1)=0.D0
         CALL YMDHMS(ITCARD(3,I),FSEC,IYMD,IHM,SEC,1)
         IYMD1=IYMD(1)
         IHM1=IHM(1)
         IS=SEC(1)
         IHM1=100*IHM1+IS
         CALL NUMASC(IYMD1,DATE2,16,.TRUE.)
         CALL NUMASC(IHM1,DATE2(7:12),16,.TRUE.)
         WRITE(6,81680) MBIAS,ISTABC(1,I),ITCARD(1,I),ISATBC(1,I),      &
     &                  VCARDB(I),DATE1,DATE2,SCARDB(I)
         IF(ITCARD(1,I).LT.99.AND.ITCARD(1,I).GT.59) THEN
            WRITE(6,81681) MBIAS2,ISTABC(2,I),ISATBC(2,I)
         ENDIF
         IF(ITCARD(1,I).EQ.85) THEN
            WRITE(6,81681) MBIAS3,ISTABC(3,I),ISATBC(3,I)
         ENDIF

!ddr mod
         IF(ITCARD(1,I).EQ.65) THEN
            WRITE(6,81681) MBIAS3,ISTABC(3,I),ISATBC(3,I)
         ENDIF
!ddr mod
         FSEC(1)=0.D0
         CALL YMDHMS(ITCARD(2,J),FSEC,IYMD,IHM,SEC,1)
         IYMD1=IYMD(1)
         IHM1=IHM(1)
         IS=SEC(1)
         IHM1=100*IHM1+IS
         CALL NUMASC(IYMD1,DATE1,16,.TRUE.)
         CALL NUMASC(IHM1,DATE1(7:12),16,.TRUE.)
         FSEC(1)=0.D0
         CALL YMDHMS(ITCARD(3,J),FSEC,IYMD,IHM,SEC,1)
         IYMD1=IYMD(1)
         IHM1=IHM(1)
         IS=SEC(1)
         IHM1=100*IHM1+IS
         CALL NUMASC(IYMD1,DATE2,16,.TRUE.)
         CALL NUMASC(IHM1,DATE2(7:12),16,.TRUE.)
         WRITE(6,81680) MBIAS,ISTABC(1,J),ITCARD(1,J),ISATBC(1,J),      &
     &                  VCARDB(J),DATE1,DATE2,SCARDB(J)
         IF(ITCARD(1,J).LT.99.AND.ITCARD(1,J).GT.59) THEN
            WRITE(6,81681) MBIAS2,ISTABC(2,J),ISATBC(2,J)
         ENDIF
         IF(ITCARD(1,J).EQ.85) THEN
            WRITE(6,81681) MBIAS3,ISTABC(3,J),ISATBC(3,J)
         ENDIF
!ddr mod
         IF(ITCARD(1,J).EQ.65) THEN
             WRITE(6,81681) MBIAS3,ISTABC(3,J),ISATBC(3,J)
             ISTABC(1,J)=-99
             ISTABC(2,J)=-99
             ISTABC(3,J)=-99
             ISATBC(1,J)=-99
             ISATBC(2,J)=-99
             ISATBC(3,J)=-99
         ENDIF
!ddr mod
  600    CONTINUE
  700    CONTINUE
      ENDIF
!ddr mod
!!!      IF(NDUP.GT.0) STOP
!ddr mod
      RETURN
 5000 FORMAT(A80)
 5001 FORMAT(6X,I8,I3,I7,D20.8,A15,A13,D8.1)
 5002 FORMAT(6X,I8,3X,I7)
 6000 FORMAT(' EXECUTION TERMINATING IN BCARDC NUMBER OF MBIAS CARDS')
 6001 FORMAT(' INPUT IS GREATER THAN MAX ALLOWED : ',I6)
 6100 FORMAT(' THERE ARE ',I5,' BIASES IN THE INPUT DECK')
 6200 FORMAT(' PROBLEM WITH READING TIME FIELD 1 ON FOLLOWING CARD:')
 6300 FORMAT(' PROBLEM WITH READING TIME FIELD 2 ON FOLLOWING CARD:')
 6400 FORMAT(' ',A80)
 6500 FORMAT(' EXECUTION TERMINATING. THE FOLLOWING PAIRS OF MBIAS ')
 6501 FORMAT(' CARDS HAVE OVERLAPPING INTERVALS:')
 6502 FORMAT(' DUPLICATE PAIR # :',I10)
 6600 FORMAT(' EXECUTION TERMINATING IN BCARDC')
 6601 FORMAT(' NUMBER OF SCALE (CYCLE SLIP) BIASES: ',I10)
 6602 FORMAT(' GREATER THAN MAXIMUM ALLOWABLE:      ',I10)
81680 FORMAT(' ',A6,I8,I3,I7,D20.13,1X,A13,1X,A13,1PD8.1)
81681 FORMAT(' ',A6,I8,3X,I7)
      END
