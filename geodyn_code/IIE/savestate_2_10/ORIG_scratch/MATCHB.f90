      SUBROUTINE MATCHB(PRMLBL,PRMSG0,PARVAR,LPROBQ)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
!
      PARAMETER(MAXLNK=11)
!
      COMMON/BIAOR/NAMBB,NCYCB,NAMBBH
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/XPARMB/MPARMB,NPARMB,MPOBS,JPAMB,ISKIPE,                   &
     &             ITPARM(5,28000),ISTABP(3,28000),                     &
     &             ISATBP(3,28000),IPRMBF(28000)
      COMMON/ZPARMB/MPARMZ,ITPRMZ(1000),ISTABZ(3,1000),                 &
     &             ISATBZ(3,1000),IPRMPY(1000),IPRMZ(1000),IUSECY(1000)
      COMMON/ZSIGB /PARVRZ(1000)
!
      DIMENSION PRMLBL(3,1),PRMSG0(1),PARVAR(1)
      DIMENSION FSECIN(1)
      DIMENSION IYMD(2),IHM(2),SEC(2)
      DIMENSION ICHAIN(MAXLNK)
!
      LPROBQ=.FALSE.
!
! THIS SUBROUTINE SHOULD ONLY BE CALLED IF NAMBBH AND NCYCB ARE BOTH
! GREATER THAN 0
!
!
! FIRST LINK UP CYCLE SLIP BIASES TO THEIR LEFT HAND NEIGHBORS
!
!
      MAXL1=MAXLNK-1
      LSTOP=.FALSE.
!
      DO 500 ICB=1,NCYCB
      IUSECY(ICB)=0
      IPVPC=IPVAL0(IXBISA)-1+NAMBBH+ICB
!
! FIRST TRY TO FIND A MATCHING LEFT INTERVAL IN THE STANDARD
! AMBIGUITY BIASES
!
      DO 100 IAB=1,NAMBBH
!
      IF(ITPRMZ(ICB).NE.ITPARM(1,IAB)) GO TO 100
!
      IF(ISATBZ(1,ICB).NE.ISATBP(1,IAB)) GO TO 100
      IF(ISATBZ(2,ICB).NE.ISATBP(2,IAB)) GO TO 100
      IF(ISATBZ(3,ICB).NE.ISATBP(3,IAB)) GO TO 100
!
      IF(ISTABZ(1,ICB).NE.ISTABP(1,IAB)) GO TO 100
      IF(ISTABZ(2,ICB).NE.ISTABP(2,IAB)) GO TO 100
      IF(ISTABZ(3,ICB).NE.ISTABP(3,IAB)) GO TO 100
!
      IPVPA=IPVAL0(IXBISA)-1+IAB
      TDIF=PRMLBL(2,IPVPC)-PRMLBL(3,IPVPA)
      IF(TDIF.LT.-10.D0) GO TO 100
      IF(TDIF.GT.800.D0) GO TO 100
!
!   MATCH FOUND
      IPRMPY(ICB)=IAB
      GO TO 500
!
!
  100 END DO
!
!
!
! MATCHING LEFT INTERVAL NOT FOUND IN THE STANDARD AMBIGUITY BIASES
! NOW TRY THE CYCLE SLIP BIASES
!
!
!
      DO 200 IAB=1,NCYCB
      IF(IAB.EQ.ICB) GO TO 200
!
      IF(ITPRMZ(ICB).NE.ITPRMZ(IAB)) GO TO 200
!
      IF(ISATBZ(1,ICB).NE.ISATBZ(1,IAB)) GO TO 200
      IF(ISATBZ(2,ICB).NE.ISATBZ(2,IAB)) GO TO 200
      IF(ISATBZ(3,ICB).NE.ISATBZ(3,IAB)) GO TO 200
!
      IF(ISTABZ(1,ICB).NE.ISTABZ(1,IAB)) GO TO 200
      IF(ISTABZ(2,ICB).NE.ISTABZ(2,IAB)) GO TO 200
      IF(ISTABZ(3,ICB).NE.ISTABZ(3,IAB)) GO TO 200
!
      IPVPA=IPVAL0(IXBISA)-1+NAMBBH+IAB
      TDIF=PRMLBL(2,IPVPC)-PRMLBL(3,IPVPA)
      IF(TDIF.LT.-10.D0) GO TO 200
      IF(TDIF.GT.800.D0) GO TO 200
!
!   MATCH FOUND
      IPRMZ(ICB)=IPVPA
      GO TO 500
!
!
  200 END DO
!
!
  500 END DO
!
!
! AFTER CYCLE SLIP BIASES HAVE BEEN LINKED TO THEIR LEFT HAND NEIGHBORS
! PRINT OUT INFORMATION AND SHIFT SIGMA/WEIGHT INFORMATION
!
!
! RECONSTRUCT THE CHAINS. START WITH LEFT MOST CYCLE SLIP BIAS
!
      LHEAD=.TRUE.
      NCH=0
      DO 600 ICB=1,NCYCB
      LPROB=.FALSE.
      IF(IPRMPY(ICB).LE.0) GO TO 600
      IF(IUSECY(ICB).GT.0) GO TO 600
!
      DO ILNK=1,MAXLNK
        ICHAIN(ILNK)=0
      ENDDO
!
!  FIND THE RIGHT MOST INTERVAL ASSOCIATED WITH THIS INTERVAL
      ILNK=1
      ICHAIN(ILNK)=ICB
      IPVPC=IPVAL0(IXBISA)-1+NAMBBH+ICB
!
  510 CONTINUE
      IF(ILNK.EQ.MAXLNK) THEN
        LSTOP=.TRUE.
        LPROB=.TRUE.
        GO TO 525
      ENDIF
      DO 520 JCB=1,NCYCB
      IF(JCB.EQ.ICHAIN(ILNK)) GO TO 520
      IF(IUSECY(JCB).GT.0) GO TO 520
      IF(IPRMZ(JCB).NE.IPVPC) GO TO 520
      ILNK=ILNK+1
      ICHAIN(ILNK)=JCB
      IPVPC=IPVAL0(IXBISA)-1+NAMBBH+JCB
      GO TO 510
  520 END DO
  525 CONTINUE
!
! RIGHT MOST LINK FOUND
!
!
! A USEFUL ANCHORED CHAIN HAS BEEN FOUND
!
! MARK THE LINKS AS USED
! TRANSFER VARIANCE INFORMATION
! MAKE PRINTOUTS
!
!
      IF(LHEAD) WRITE(92,6000)
      LHEAD=.FALSE.
      NCH=NCH+1
      IPVPA=IPVAL0(IXBISA)-1+IPRMPY(ICHAIN(1))
      VARA=PARVAR(IPVPA)
      SG0A=PRMSG0(IPVPA)
      TM1=PRMLBL(2,IPVPA)
      TM2=PRMLBL(3,IPVPA)
      MJDSBL=TM1
      FSECIN(1)=TM1-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(1),IHM(1),SEC(1),1)
      IF(IYMD(1).GT.1000000)IYMD(1)=IYMD(1)-1000000
      MJDSBL=TM2
      FSECIN(1)=TM2-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(2),IHM(2),SEC(2),1)
      IF(IYMD(2).GT.1000000)IYMD(2)=IYMD(2)-1000000
!
      WRITE(92,6001) NCH
      WRITE(92,6002) ITPRMZ(ICB),(ISATBZ(IQP,ICB),IQP=1,3),             &
     &                           (ISTABZ(IQP,ICB),IQP=1,3)
      WRITE(92,6003) SG0A
      WRITE(92,6004) IYMD(1),IHM(1),SEC(1),IYMD(2),IHM(2),SEC(2)
!
!
      DO 530 IQP=1,ILNK
      IUSECY(ICHAIN(IQP))=1
      IPVPC=IPVAL0(IXBISA)-1+NAMBBH+ICHAIN(IQP)
      PARVRZ(ICHAIN(IQP))=PARVAR(IPVPC)
      PARVAR(IPVPC)=PARVAR(IPVPA)
      SGP=PRMSG0(IPVPC)
      PRMSG0(IPVPC)=PRMSG0(IPVPA)
      TM1=PRMLBL(2,IPVPC)
      TM2=PRMLBL(3,IPVPC)
      MJDSBL=TM1
      FSECIN(1)=TM1-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(1),IHM(1),SEC(1),1)
      IF(IYMD(1).GT.1000000)IYMD(1)=IYMD(1)-1000000
      MJDSBL=TM2
      FSECIN(1)=TM2-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(2),IHM(2),SEC(2),1)
      IF(IYMD(2).GT.1000000)IYMD(2)=IYMD(2)-1000000
      WRITE(92,6005) IQP,SGP
      WRITE(92,6004) IYMD(1),IHM(1),SEC(1),IYMD(2),IHM(2),SEC(2)
  530 END DO
!
!
      IF(LPROB) THEN
         WRITE(6,6020)
         WRITE(6,6021)
!
         WRITE(92,6020)
         WRITE(92,6022)
         WRITE(92,6023) MAXL1
      ENDIF
!
!
!
  600 END DO
!
!
!
      IF(LHEAD) THEN
         IF(.NOT.LSTOP) THEN
            WRITE(6,6020)
            WRITE(6,6021)
         ENDIF
!
         WRITE(92,6010)
         WRITE(92,6020)
         LSTOP=.TRUE.
      ENDIF
!
      LHEAD=.TRUE.
!
      NBC=0
      LSTOPP=.FALSE.
      LHEADD=.TRUE.
      DO 700 ICB=1,NCYCB
      IF(IUSECY(ICB).GT.0) GO TO 700
      IF(LHEADD) THEN
         IF(.NOT.LSTOPP) THEN
            WRITE(6,6040)
            WRITE(6,6041)
            WRITE(6,6042)
         ENDIF
         WRITE(92,6030)
      ENDIF
      LSTOPP=.TRUE.
      LHEADD=.FALSE.
      LPROBQ=.TRUE.
      NBC=NBC+1
      IPVPC=IPVAL0(IXBISA)-1+NAMBBH+ICB
      TM1=PRMLBL(2,IPVPC)
      TM2=PRMLBL(3,IPVPC)
      MJDSBL=TM1
      FSECIN(1)=TM1-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(1),IHM(1),SEC(1),1)
      IF(IYMD(1).GT.1000000)IYMD(1)=IYMD(1)-1000000
      MJDSBL=TM2
      FSECIN(1)=TM2-DBLE(MJDSBL)
      CALL YMDHMS(MJDSBL,FSECIN,IYMD(2),IHM(2),SEC(2),1)
      IF(IYMD(2).GT.1000000)IYMD(2)=IYMD(2)-1000000
!
      WRITE(92,6031) NBC,PRMSG0(IPVPC)
      WRITE(92,6002) ITPRMZ(ICB),(ISATBZ(IQP,ICB),IQP=1,3),             &
     &                           (ISTABZ(IQP,ICB),IQP=1,3)
      WRITE(92,6004) IYMD(1),IHM(1),SEC(1),IYMD(2),IHM(2),SEC(2)
  700 END DO
!
!
      IF(LSTOP) STOP
      RETURN
 6000 FORMAT(' CONSTRAINTS BETWEEN AMBIGUITY AND CYCLE SLIP BIASES')
 6001 FORMAT(' CHAIN # ',I6,' IS ANCHORED TO AN AMBIGUITY BIAS')
 6002 FORMAT(' MT ',I3,' SAT ',3I10,' STA ',3I10)
 6003 FORMAT(' BASE AMBIGUITY HAS A PRIORI STD DEV OF ',D15.6)
 6004 FORMAT(' L INT  ',I6,2X,I4,F10.3,' R INT  ',I6,2X,I4,F10.3)
 6005 FORMAT(' CYCLE SLIP BIAS # ',I3,' HAS A CONSTRAINT OF ',D15.6)
 6010 FORMAT(' NO CYCLE SLIP AMBIGUITY BIASES WERE LINKED INTO CHAINS')
 6020 FORMAT(' EXECUTION WILL TERMINATE IN SUBROUTINE MATCHB')
 6021 FORMAT(' CHECK UNIT 92')
 6022 FORMAT(' THE ABOVE CHAIN EXCEEDED THE MAX ALOWABLE')
 6023 FORMAT(' # CYC SLIP BIASES:',I10)
 6030 FORMAT(' THE FOLLOWING CYCLE SLIP BIASES WERE NOT LINKED')
 6031 FORMAT(' CYCLE SLIP BIAS # ',I3,' WITH A CONSTRAINT OF ',D15.6)
 6040 FORMAT(' WARNING: SOME CYCLE SLIP BIASES WERE NOT LINKED')
 6041 FORMAT(' THE DATA ASSOCIATED WITH THESE WILL BE DELETED')
 6042 FORMAT(' ITERATION # 1 WILL NOT HAVE AN ADJUSTMENT')
      END
