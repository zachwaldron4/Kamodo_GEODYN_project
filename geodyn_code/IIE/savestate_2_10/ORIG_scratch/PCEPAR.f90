!$PCEPAR
      SUBROUTINE PCEPAR(PKPX,PMPXI,NM,N,MTYPE,LPCETR,ROT1,              &
     &   ROT2, ROT3, ROT4, ROT5, ROT6, ROT7, ROT8, ROT9,LRADAL,         &
     &   X   , Y   , Z   ,RADXYZ, LGPS, ROTN )
!********1*********2*********3*********4*********5*********6*********7**
! PCEPAR           89/06/23            0000.0    PGMR - ???, SBL
!
! FUNCTION:  CALCULATES MEASUREMENT POSITION AND VELOCITY PARTIALS
!            FOR PCE DATA
!
!  I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   PKPX     I    A    PARTIALS OF KEPLERIAN MEASUREMENTS W.R.T.
!                      POS./VEL.
!   PMPXI    O    A    PARTIALS OF PCE MEASUREMENT W.R.T. POS./VEL. IN
!                      TRUE OF DATE
!   NM      I/O   S    THE NUMBER OF MEASUREMENTS IN THE BLOCK
!   N       I/O   S    THE PARTICULAR MEASUREMENT THAT THE PARTIALS WILL
!                      BE CALCULATED HERE.
!   MTYPE   I/O   S    TYPE OF MEASUREMENT (CARTESIAN OR KEPLERIAN)
!   LPCETR  I/O   S    LOGICAL FLAG TO FOR TRUE OF REFERENCE OR TRUE OF
!                      DATE DATA (TRUE IF DATA IS IN TRUE OF REFERENCE)
!   ROT1 -  I/O   S    ELEMENTS OF NUTATION ROTATION MATRIX FOR MEAN OF
!   ROT9               DATE TO TRUE OF DATE
!   LRADAL  I/O   S    LOGICAL FLAG TO INDICATE IF PCE DATA IS RADIAL
!                      TYPE (IF FALSE PCE DATA IS RADIAL)
!   X, Y, Z I/O   S    POSITION IN TRUE OF REFERENCE CARTESIAN
!   RADXYZ  I/O   S    THE MAGNITUDE OF THE X, Y, Z VECTOR ALSO IS THE
!                      RADIAL MEASUREMENT
!
! REFERENCES: PCEPAR FROM VERSION 8901.15
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      COMMON/CREFMT/REFMT(9)
      DIMENSION PKPX(6,6),PMPXI(NM,3,2),PARTL(3,2)
      DIMENSION ROTPCE(3,3)
      DIMENSION ROTN(3,3)
      DATA ZERO/0.0D0/,ONE/1.0D0/
!********1*********2*********3*********4*********5*********6*********7**
! START OF EXECUTABLE CODE
!********1*********2*********3*********4*********5*********6*********7**
!
      IF(LGPS) THEN
      PMPXI(N,1,2)=0.D0
      PMPXI(N,2,2)=0.D0
      PMPXI(N,3,2)=0.D0
      PMPXI(N,1,1)=ROTN(MTYPE,1)
      PMPXI(N,2,1)=ROTN(MTYPE,2)
      PMPXI(N,3,1)=ROTN(MTYPE,3)
      GOTO 9001
      ENDIF
! IF LRADAL IS FALSE THE PCE MEASUREMENT IS RADIAL SO CALCULATE THE
! THE PARTIALS OF A RADIAL MEASUREMENT W.R.T. POS./VEL.
!
      IF(.NOT.LRADAL) THEN
      PMPXI(N,1,1)=X/RADXYZ
      PMPXI(N,2,1)=Y/RADXYZ
      PMPXI(N,3,1)=Z/RADXYZ
      DO 100 IS=1,3
      PMPXI(N,IS,2)=ZERO
  100 END DO
      RETURN
      ENDIF
      IF(MTYPE.GT.6) GO TO 2000
! PARTIAL OF A CARTESIAN PCE MEASUREMENT W.R.T. POS./VEL.
      DO 1000 I=1,6
      PARTL(I,1)=ZERO
 1000 END DO
      PARTL(MTYPE,1)=ONE
      GO TO 4000
! PARTIAL OF A KEPLERIAN PCE MEASUREMENT W.R.T. POS./VEL.
 2000 CONTINUE
      MNTYPE=MTYPE-6
      DO 3000 I=1,6
      PARTL(I,1)=PKPX(MNTYPE,I)
 3000 END DO
      GOTO 4500
 4000 CONTINUE
      IF(.NOT.LPCETR) GO TO 6000
! IF PCE DATA IN TRUE-OF-REFERENCE THESE ARE THE INERTIAL PARTIALS
 4500 CONTINUE
      DO 5000 I=1,6
      PMPXI(N,I,1)=PARTL(I,1)
 5000 END DO
      RETURN
! PCE DATA IS NOT TRUE-OF-REFERENCE - CHAIN PARTIALS W/ ROTATION MATRIX
 6000 CONTINUE
!     CALCULATE ROTATION MATRIX TO GO FROM TRUE OF REFERENCE TO TRUE OF
!     DATE FOR THIS PARTICULAR MEASUREMENT
      ROTPCE(1,1)=REFMT(1)*ROT1+REFMT(2)*ROT4+REFMT(3)*ROT7
      ROTPCE(2,1)=REFMT(1)*ROT2+REFMT(2)*ROT5+REFMT(3)*ROT8
      ROTPCE(3,1)=REFMT(1)*ROT3+REFMT(2)*ROT6+REFMT(3)*ROT9
      ROTPCE(1,2)=REFMT(4)*ROT1+REFMT(5)*ROT4+REFMT(6)*ROT7
      ROTPCE(2,2)=REFMT(4)*ROT2+REFMT(5)*ROT5+REFMT(6)*ROT8
      ROTPCE(3,2)=REFMT(4)*ROT3+REFMT(5)*ROT6+REFMT(6)*ROT9
      ROTPCE(1,3)=REFMT(7)*ROT1+REFMT(8)*ROT4+REFMT(9)*ROT7
      ROTPCE(2,3)=REFMT(7)*ROT2+REFMT(8)*ROT5+REFMT(9)*ROT8
      ROTPCE(3,3)=REFMT(7)*ROT3+REFMT(8)*ROT6+REFMT(9)*ROT9
      DO 9000 M=1,2
      DO 8000 I=1,3
      SUM=ZERO
      DO 7000 J=1,3
      SUM=SUM+PARTL(J,M)*ROTPCE(J,I)
 7000 END DO
      PMPXI(N,I,M)=SUM
 8000 END DO
 9000 END DO
 9001 CONTINUE
      RETURN
      END
