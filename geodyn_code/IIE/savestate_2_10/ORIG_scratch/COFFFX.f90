!$COFFFX
      SUBROUTINE COFFFX(MJDSEC,FSEC,AA,II,ISUPE)
!********1*********2*********3*********4*********5*********6*********7**
! COFFFX           30/05/13            1212.0    PGMR -
!                                                       D. PAVLIS
!
!  FUNCTION:  FIND CHEBYCHEV COEFFICIENTS FOR ONE MEASUREMENT AND FILL
!             UP THE COMMON BLOCK CHCFFX
!
!  I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSEC   I    S    INTEGER SECONDS SINCE GEODYN REFERENCE TIME
!   FSEC     I    S    FRACTIONAL REMAINING SECONDS UNTIL FIRST OBS
!   FSECNM   I    S    FRACTIONAL REMAINING SECONDS UNTIL LAST  OBS
!                      IN MEASUREMENT BLOCK
!   AA      I/O   A    REAL DYNAMIC ARRAY
!
! COMMENTS:
!
!     CALL COFFFX(MJDSEC,FSEC,AA,II,II(KISUPE)
!
!     COMMON/CHCFFX/COEFFX1(3,25,11),COEFFXX(3,25,10)
!
!********1*********2*********3*********4*********5*********6*********7**
!
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988), &
     &              NXEPH2
      COMMON/CITER /NINNER,NARC,NGLOBL
      COMMON/CHCFFX/COEFFX1(3,25,11),COEFFXX(3,25,988),TIMBCHEB
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA07/KELEVT,KSRFEL,KTINT,KFSCSD,KXTIM,KFSDM,             &
     & KSGM1,KSGM2,KNOISE,KEPHMS,NXCA07
      COMMON/CORI07/KSMSA1,KSMSA2,KSMSA3,KSMST1,KSMST2,KSMST3,KSMTYP,   &
     &              KSMT1,KSMT2,KMSDM,KIOUT,KISUPE,NXCI07
      COMMON/CREFMT/REFMT(9)
      COMMON/CVIEW /IOUT6 ,ILINE6,IPAGE6,MLINE6,                        &
     &              IOUT8 ,ILINE8,IPAGE8,MLINE8,                        &
     &              IOUT9 ,ILINE9,IPAGE9,MLINE9,                        &
     &              IOUT10,ILIN10,IPAG10,MLIN10,                        &
     &              IOUT15,ILIN15,IPAG15,MLIN15,                        &
     &              IOUT16,ILIN16,IPAG16,MLIN16,                        &
     &              IOUT7 ,NXCVUE
      COMMON/DYNPTR/KDEPHM,KDEPH2,KDAHDR(3,9),KDYNAP(3,9,2),KDNEXT(3),  &
     &NXDYNP
      COMMON/EPHM/FSECXY(1),XP(261),YP(261),A1UT(261),EP(261),EC(261),  &
     &            FSCFLX(1),FLUXS(36),AVGFLX(36),FLUXM(288),FSECEP(1),  &
     &            EPHP(816),EPHN(96),ELIB(120),BUFT(2700),FSECNP(4)
      COMMON/EPHMPT/NTOT,NTOTS,NNPDPR,NUTORD,IBODDG(8),IGRPDG(4),       &
     &              NENPD,INRCD(2),KPLAN(11),NINEP,NEPHMR,NEPHEM,       &
     &              IBHINT,NINTBH,NXEPHP
      COMMON/EPHMX/FSECSE(10,2)
      COMMON/EPHSET/EMFACT,DTENPD,DTINPD,FSC1EN,FSCENP(2),FSCINP(4),    &
     &   FSDINP(4),XEPHST
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IDUAL/IASTSN
      COMMON/INVRSL/LSYMSW,LMATP,NXINVR
      COMMON/IORCHB/ IORM,IORJ,IORSA,IORSUN,IOREM,IORMO,IORCB,IORTB,    &
     &               IGRP,ICHBOG(2,14),IORSCB(988),NXORCH
      COMMON/LEPHM2/LXEPHM
      COMMON/PLNETI/IPLNET(999),IPLNIN(999),MPLNGD(999),MPLNGO(999),   &
     &              IPLNZ(999),NXPLNI
      COMMON/XLITSD/DELULT,DDLULT,UNVLTU(3),DELDLT,DDLDLT,UNVLTD(3),    &
     &              GRELLT,TOLLTX,GRLFCT,FCTJUP,FCTSAT
!
      DIMENSION COFF(988,3,25),SCRTCH(3,25),AA(1),II(1)
      DIMENSION ISUPE(ICBODY,5)
!
!     DIMENSION  FBUF(,1000000)
      DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE ::  FBUF
!  FBUF IS A LOCAL ARRAY HOSTING THE COEFFICIENTS OF ONE BUFFER
!  TO BE USED IN THE CASE OF FORCE MODELING COMPUTATIONS
!
      DATA DAYSEC/86400.D0/
      DATA ZERO/0.D0/,ONE/1.D0/,TWO/2.D0/
      DATA FSECR/0.D0/
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
!

      ILOV=ISUPE(1,3)
!     RLOV=DBLE(ILOV*86400)
      RLOV=(DBLE(ILOV)/100.D0)*DAYSEC
      TQ=DBLE(MJDSEC)+FSEC-TIMBCHEB
      IF(TQ.GE.0.D0.AND.TQ.LE.RLOV) RETURN

      ALLOCATE (FBUF(ICBODY,1000000))
! INITIALIZE FBUF
      DO JJ=1,ICBODY
      DO KK=1,1000000
      FBUF(JJ,KK)= 0.D0
      ENDDO
      ENDDO
!
! COMPUTE EARLIEST AND LATEST POSSIBLE TIME TAG NEEDED FOR PLANET POS
      TIME = DBLE(MJDSEC)+FSEC
!
! **************   CELESTIAL BODY LOOP BEGINS *************************
! LOOP THROUGH EACH CELESTIAL BODY IN THE SUPPLEMENTARY PLANETARY EPHEME
      IADD=0
      DO 2500 I=1,ICBODY

! UPDATE COEFFICIENTS
! FOR SUPPLEMENTARY EPHEMERIS
! HERE DO NOT CALL BUFSUP

!  CODE FROM BUFSUP
      IF(I.GT.1) IADD=ISUPE(I-1,2)*ISUPE(I-1,1)+IADD
      IPTR=KDEPH2+IADD
! ITSYS=1 ET ; ITSYS=2 UTC
      ITSYS=ISUPE(I,4)

           JJ=0


! LOOP THROUGH THE RECORDS
           DO J=1,ISUPE(I,1)
! T1 T2 The SE times of this celestial body
      T1=AA(IPTR+JJ)
      T2=AA(IPTR+JJ+1)
      MJD=INT(T1)
      DIFSEC=(T1-DBLE(MJD))*86400
      CALL MJDYMD(MJD,IYMD1,IHMS1,1)
      CALL YMDTIS(IYMD1,IHMS1,MJDB)
      TIMEB=DBLE(MJDB)
      TIMEB=TIMEB+DIFSEC
      MJD=INT(T2)
      DIFSEC=(T2-DBLE(MJD))*86400
      CALL MJDYMD(MJD,IYMD2,IHMS2,1)
      CALL YMDTIS(IYMD2,IHMS2,MJDE)
      TIMEE=DBLE(MJDE)
      TIMEE=TIMEE+DIFSEC

      IF(ITSYS.EQ.2) THEN
      CALL UTCET(.TRUE.,1,MJDB,FSECR,FSECOT,AA(KA1UT))
      TIMEB=DBLE(MJDB)+FSECOT
      CALL UTCET(.TRUE.,1,MJDE,FSECR,FSECOT,AA(KA1UT))
      REM2=FSECOT
      TIMEE=DBLE(MJDE)+FSECOT
      ENDIF

! LOAD THE LOCAL ARRAY  FBUF FOR THIS CEL. BODY AND THIS DEGREE
      IF(TIME.GE.TIMEB.AND.TIME.LE.TIMEE) THEN
!       IF(I.GT.ICBODY.AND.TIMBCHEB.EQ.TIMEB) RETURN
        IF(I.GT.ICBODY.AND.TIMBCHEB.EQ.TIMEB) THEN
        DEALLOCATE (FBUF)
        RETURN
        ENDIF
        TIMBCHEB=TIMEB

        DO K=3,ISUPE(I,2)
        FBUF(I,K-2)=AA(IPTR+JJ-1+K)
        ENDDO
!     ELSE
!       WRITE(6,*)' TIME OF OBSERVATION ',TIME
!       WRITE(6,*)' NOT WITHIN THE SUPPLEMENTARY EPHEMERIS TIMES '
!       WRITE(6,*)TIMEB,TIMEE
!       WRITE(6,*)' EXECUTION STOPS IN SUBROUTINE COFFFX '
!       STOP
      ENDIF

! INCREASE JJ BY THE RECORD LENGTH
              JJ=JJ+ISUPE(I,2)

           ENDDO  ! LOOP THROUGH RECORDS OF THIS CELESTIAL BODY
!
! *************** ONLY FOR CENTRAL BODY ********************************
! IF CENTRAL BODY IS NOT FEATURED IN THE SUPPLEMENTARY PLANETARY EPHEMER
! SKIP THE CODE BELOW
!     IF(ICBDGM.LT.13) GOTO 175
!           IF(ICBDGM.EQ.I+12) THEN
      IF(ICBDGM.LT.12+IASTSN) GOTO 175
            IF(ICBDGM.EQ.I+11+IASTSN) THEN
! COMPUTE CENTRAL BODY COEFFICIENTS
! FIND POINTERS TO THE SUPPL. EPHEMERIS BUFFER
!     CENTRAL BODY
      ICBD=ICBDGM-11
      IB=ISUPE(ICBD,2)/3
!
        DO 125 JJ=1,3
        DO 125 KK=1,IB
        J=JJ-1
        K=KK-1
        IPT=KK+J*IB
        SCRTCH(JJ,KK)=FBUF(ICBD,IPT)
  125   CONTINUE
! ROTATE & STORE COEFFICIENTS IN APPROPRIATE ARRAYS
      DO 150 J=1,IB
      DO 150 K=1,3
      IPT1=3*K-2
      IPT2=IPT1+1
      IPT3=IPT2+1
      COEFFXX(K,J,1)=REFMT(IPT1)*SCRTCH(1,J)+REFMT(IPT2)*SCRTCH(2,J)+ &
     &          REFMT(IPT3)*SCRTCH(3,J)
  150 CONTINUE
!
            ENDIF
  175 CONTINUE
!     IF(I+12.EQ.ICBDGM) GOTO 310
      IF(I+11+IASTSN.EQ.ICBDGM) GOTO 310

! *************** ONLY FOR CENTRAL BODY END *****************************

!   COMPUTE OTHER CELESTIAL BODIES FROM SUPPLEMENTARY EPHEMERIS
!
      IB=ISUPE(I,2)/3
        DO 200 JJ=1,3
        DO 200 KK=1,IB
        J=JJ-1
        K=KK-1
        COFF(I,JJ,KK)=FBUF(I,KK+J*IB)
  200   CONTINUE
! ROTATE & STORE COEFFICIENTS IN APPROPRIATE ARRAYS
      DO 300 J=1,IORSCB(I)
      DO 300 K=1,3
      IPT1=3*K-2
      IPT2=IPT1+1
      IPT3=IPT2+1
      COEFFXX(K,J,I)=REFMT(IPT1)*COFF(I,1,J)+REFMT(IPT2)*COFF(I,2,J)+ &
     &           REFMT(IPT3)*COFF(I,3,J)
  300 CONTINUE
  310 CONTINUE
!
!
 2500 END DO
! **************   CELESTIAL BODY LOOP ENDS *************************
!
      DEALLOCATE (FBUF)
      RETURN
      END
