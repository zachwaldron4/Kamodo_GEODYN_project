!$EXEC2E
      SUBROUTINE EXEC2E(AA,II,LL,NDIR,IDWPT,LSTNRO)
!********1*********2*********3*********4*********5*********6*********7**
! EXEC2E           00/00/00            0000.0    PGMR - ?
!
!
! FUNCTION:
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   AA      I/O   A    REAL DYNAMIC ARRAY
!   II      I/O   A    INTEGER DYNAMIC ARRAY
!   LL      I/O   A    LOGICAL DYNAMIC ARRAY
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
      PARAMETER( NOPT = 7 )
      PARAMETER( XLARGE = 99999999999999.D0 )
!
! FOR SNAPSHOT CROSSOVERS     TYPE1
!     PARAMETER(MAXD=25)
!     PARAMETER(MADJST=5000)
!
! FOR SNAPSHOT CROSSOVERS     TYPE2
!
!     PARAMETER(MAXNM=260)
!     PARAMETER(MXLASR=10)
!     PARAMETER(NPDEG=10)
!
      COMMON/LSNAPX/LSNAP
      COMMON/SNAPX /MAXD,MADJST,MAXNM,MXLASR,NPDEG,NXSNAP
      COMMON/SAVLTC/RLTCOR
      COMMON/CBLOKA/FSECBL,SIGNL ,VLITEC,SECEND,BLKDAT(6,4),DOPSCL(5,4)
      COMMON/CBLOKI/MJDSBL,MTYPE ,NM    ,JSTATS,NPSEG ,JSATNO(3),ITSYS ,&
     &       NHEADB,NELEVS,ISTAEL(12),INDELV(3,4),JSTANO(3),ITARNO,     &
     &       KTARNO
      COMMON/CESTIM/MPARM,MAPARM,MAXDIM,MAXFMG,ICLINK,IPROCS,NXCEST
      COMMON/CESTML/LNPNM ,NXCSTL
      COMMON/CBLOKL/LIGHT ,LNRATE,LNREFR,LPOLAD,LTDRIV,LNANT ,LNTRAK,   &
     &       LASER ,LGPART,LGEOID,LETIDE,LOTIDE,LNTIME,LAVGRR,LRANGE,   &
     &       LSSTMD,LSSTAJ,LNTDRS,LPSBL,LACC,LAPP,LTARG,LTIEOU,LEOTRM,  &
     &       LSURFM,LGEOI2,LSSTM2,LOTID2,LOTRM2,LETID2,LNUTAD
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CKOUNT/KNTBLK,KSEGMN,KNTOBS,KZROBS
      COMMON/COBGLO/MABIAS,MCBIAS,MPVECT,MINTPL,MPARAM,MSTA,MOBBUF,     &
     &       MNPITR,MWIDTH,MSIZE ,MPART ,MBUF  ,NXCOBG
      COMMON/COBLOC/KXMN  (3,4)  ,KENVN (3,4)  ,KSTINF(3,4)  ,          &
     &       KOBS  ,KDTIME,KSMCOR,KSMCR2,KTMCOR,KOBTIM,KOBSIG,KOBSG2,   &
     &       KIAUNO,KOBCOR(9,7)  ,KFSECS(6,8)  ,KOBSUM(8)    ,          &
     &       KEDSIG,KEDSG2
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/CONTRL/LSIMDT,LOBS  ,LORB  ,LNOADJ,LNADJL,LORFST,LORLST,   &
     &              LORALL,LORBOB,LOBFST,LOBLST,LOBALL,LPREPO,LORBVX,   &
     &              LORBVK,LACC3D,LSDATA,LCUTOT,LACCEL,LDYNAC,LFRCAT,   &
     &              LNIAU, NXCONT
!>>>
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
!<<<
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
!>>>
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
!<<<<
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORA07/KELEVT,KSRFEL,KTINT,KFSCSD,KXTIM,KFSDM,             &
     & KSGM1,KSGM2,KNOISE,KEPHMS,NXCA07
      COMMON/CORBVU/ISATL
!>>>
      COMMON/CORBIN/MJDSNF,NENTRY
!.................................
      COMMON/CORBNA/FNFSTR,FNFSTP,FNFRT,XCORN
!.................................
      COMMON/CORBNF/MAXINF,NORBNF,INFSTA(15),INFNDX(15),INFSTR,INFSTP,  &
     &              INFRT ,NXCORB
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
!<<<
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORI06/KPTRAU,KPTRUA,KNFMG ,KIPTFM,KILNFM,KIGPC ,          &
     &              KIGPS ,KIGPCA,KIGPSA,KIELMT,KMFMG ,KTPGPC,          &
     &              KTPGPS,KTPUC ,KTPUS,                                &
     &              KLINK,KPTFAU,KPTFUA,NXCI06
      COMMON/CORI07/KSMSA1,KSMSA2,KSMSA3,KSMST1,KSMST2,KSMST3,KSMTYP,   &
     &              KSMT1,KSMT2,KMSDM,KIOUT,KISUPE,NXCI07
      COMMON/CORL02/KLNDTT,KLWSTR,KLNDTR,KLEVMF,KLTPMS,NXCL02
      COMMON/CORL04/KLEDIT,KLBEDT,KLEDT1,KLEDT2,KNSCID,KEXTOF,KLSDAT,   &
     &              KLRDED,KLAVOI,KLFEDT,KLANTC,NXCL04
      COMMON/CORL07/KLPTS,NXCL07
      COMMON/CORL06/KLBIAS,KLADEL,NXCL06
      COMMON/CPMPA /KTMPAR(3)    ,KMBPAR(2)    ,KRFPAR(2)    ,          &
     &              KAEPAR,KFEPAR,KFPPAR,KVLPAR,KETPAR(2,2)  ,          &
     &              KPMPAR,KUTPAR,KSTPAR(3,4)  ,NADJST       ,          &
     &              NDIM1 ,NDIM2 ,NXDIM1,NXDIM2
      COMMON/CSBSAT/KR,KRT,KZT,KXY2,KUZ,KUZSQ,KTEMP,KC3,KTHETG
      COMMON/CTIMEA/FSECT
      COMMON/CTIMEI/MJDST
!
      COMMON/CTSIMA/FSCSIM
      COMMON/CTSIMI/MJDSIM,MJDEND
      COMMON/SIMLM/OBSINT,VINT,ELCUTO,XSMLM
!
      COMMON/CVIEW /IOUT6 ,ILINE6,IPAGE6,MLINE6,                        &
     &              IOUT8 ,ILINE8,IPAGE8,MLINE8,                        &
     &              IOUT9 ,ILINE9,IPAGE9,MLINE9,                        &
     &              IOUT10,ILIN10,IPAG10,MLIN10,                        &
     &              IOUT15,ILIN15,IPAG15,MLIN15,                        &
     &              IOUT16,ILIN16,IPAG16,MLIN16,                        &
     &              IOUT7 ,NXCVUE
      COMMON/EMAT  /EMTNUM,EMTPRT,EMTCNT,VMATRT,VMATS,VMATFR,FSCVMA,    &
     &              XEMAT
      COMMON/GPSSHD/LGPSHD,LGPSHO,LSHADS
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/LASTER/LASTR(2),LBINAST,NXASTR
      COMMON/LEPHM2/LXEPHM
      COMMON/LMARIN/ LRADEC, LMARIN, LPASCU, NXLMAR
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/RIMAGE/VIMAGE(6),QUCAM(4),QURSYS,TLBOD2
      COMMON/SIMPAR/MAXCON,NCON,MXLEN,NSDLEN,NSDLER,NPATRN,ISTATS,      &
     &              NXSIML
      COMMON/TIEOUT/XSCTIE,XSCTRF,YMDRRF,YMDTRF,XTIE,XTIEOU
      COMMON/TRAJA/FSECTR
      COMMON/TRAJI/MJDSTR,NTRAJC,MTRAJC,NXTRAJ
      COMMON/TRAJL/LTRAJ
      COMMON/UNITS/IUNT11,IUNT12,IUNT13,IUNT19,IUNT30,IUNT71,IUNT72,    &
     &             IUNT73,IUNT05,IUNT14,IUNT65,IUNT88,IUNT21,IUNT22,    &
     &             IUNT23,IUNT24,IUNT25,IUNT26
      COMMON/VMATFI/MJDVMA
      COMMON/VMATFL/LVMTF,LVMTFO
!
      DOUBLE PRECISION, ALLOCATABLE :: AUX1(:)
      DOUBLE PRECISION, ALLOCATABLE :: ACOF4(:)
      INTEGER, ALLOCATABLE :: MJDLAS(:)
!
      DIMENSION AA(1),II(1),LL(1),INDSTA(3,4),INDSAT(3,4),INDSET(3,4),  &
     &   LELEVS(3,4),INPSTA(3,4),INPSAT(3,4),LNOPT(NOPT),XTIME(NOPT)    &
     &   ,ILCORR(5,4)
       DIMENSION IDWPT(NDIR)
!
! FOR SNAPSHOT CROSSOVERS   TYPE 2
!
!
!     DIMENSION PXEPXI(MAXNM,9)
!     DIMENSION PXEPA(MADJST,MAXNM,3,MXLASR,2),PXEPA2(MADJST,MAXNM,3,2)
!     DIMENSION ACOEF(MAXD,MAXNM,3,MXLASR,2),ACOEF2(3,3,MXLASR,2)
!     DIMENSION ACOEF3(MAXD,4,MXLASR,2)
!     DIMENSION BCOEF(MAXD,MAXNM,3,2),BCOEF2(3,3,2)
!     DIMENSION AUX1(3,MAXNM),TIME1(MAXNM)
!     DIMENSION DDDA(MAXD,6)
!     DIMENSION DIST(MXLASR,MXLASR),DIST0(MXLASR,MXLASR)
!     DIMENSION IOBSC(MXLASR,2),TMSE(2,MXLASR,2)
!     DIMENSION IDLAS(MXLASR,2)
!     DIMENSION IAVP(MADJST,MXLASR,2),NAVP(MXLASR,2)
!     DIMENSION DCDP(MAXD,MADJST,3,MXLASR,2)
!
      DATA ZERO/0.0D0/
!
      EQUIVALENCE (LNOPT(1),LNOBS),(LNOPT(2),LNORB)
      EQUIVALENCE (LNOPT(3),LNTRAJ),(LNOPT(4),LNVMAT)
      EQUIVALENCE (LNOPT(5),LNPSBL)
!>>>
      EQUIVALENCE (LNOPT(6),LNORNF),(LNOPT(7),LNTIEO)
!<<<
!
!**********************************************************************
! START OF EXECUTABLE CODE
!**********************************************************************
!
!     write(6,*) 'exec2e: kstain ', kstain
!
      TLBOD2=1.D0
      LINIM=.TRUE.
      IKOY=0
      KKOYNT=0
      IKOYNT=0
!
      NSNAPB=0
      NSNAPT=0
      LSNAP=.FALSE.
      LSNAP1=.TRUE.
      LTIEOU=.FALSE.
      LNTRAJ=.NOT.LTRAJ
      LNTIEO=.NOT.(LSTINR.AND.EMTNUM.GT.0.D0.AND.XTIE.GT.0.D0)
      ILINE6=MLINE6
      ILINE8=MLINE8
      ILIN10=MLIN10
      ISATL=0
      KNTBLK=0
      KNTOBS=0
      MJDST=0
      FSECT=ZERO
!
!   THE FOLLOWING IS SIMULATED DATA GENERATION CODE
!
      LPSBL=LSIMDT.AND.LSDATA
      IF(.NOT.LPSBL) THEN
      GOTO 999
      ENDIF
      MIDSIM=II(KSMT1)
!   MJSEND IS THE MAXIMUM OF ALL REQUESTED END TIMES
!   IN THE SIMULATED DATA GENERATION INPUT (UNIT17)
      MJSEND=ZERO
      DO 998 I=1,MXLEN
      MXEND=II(KSMT2+I-1)
      MJSEND=MAX(MJSEND,MXEND)
  998 END DO
  999 CONTINUE
!
!----------------------------------------------------------------------
!
!     ....SET THE TRACKING BODY EQUAL TO THE CENTER BODY
!
      IF( LMARIN ) ITBDGM = ICBDGM
!
!----------------------------------------------------------------------
!
!     write(6,12345) LOBS
12345 FORMAT('** EXEC2E ** LOBS=.',L1,'.')
      LNOBS=(.NOT.LOBS.OR.LPSBL)
      LNPSBL=.NOT.LPSBL
      LORITR=LORALL.OR.(LORFST.AND.LITER1).OR.(LORLST.AND.LSTITR)
!>>>
      LORBNF=MAXINF.GT.0.AND.LSTITR
      LNORNF=.NOT.LORBNF
!     write(6,*) 'exec2e: lorbnf, lnornf ', lorbnf, lnornf
!     write(6,*) 'exec2e: maxinf, lstitr ', maxinf, lstitr
!<<
      LNORB=.NOT.(LORITR.AND.LORB)
      LNVMAT=.NOT.LSTITR.OR..NOT.LVMTF
      XTIME(2)=DBLE(MJDST)+FSECT
      XTIME(3)=DBLE(MJDSTR)+FSECTR
      XTIME(4)=DBLE(MJDVMA)+FSCVMA
      XTIME(5)=DBLE(MJDSIM)+FSCSIM
!>>>
      XTIME(6)=DBLE(MJDSNF)+FNFSTR
      XTIME(7)=XSCTIE
!     write(6,*) 'exec2e: start xtime  ', xtime
!<<<
!
! READ A BLOCK OF OBSERVATIONS
! IN THE CASE OF SIMULATED DATA GENERATION OBSRD WILL NOT BE CALLED
 1000 CONTINUE
!     write(6,*) 'exec2e: after 1000 ',LPSBL,LNOBS
      IF(LPSBL) GO TO 2000
      IF(LNOBS) GO TO 2000
      KSEGMN=0
      CALL OBSRD(AA,II,LL,AA(KOBBUF),AA(KPRMVC),LL(KLBIAS),INDSTA, &
     & INDSAT,INDSET,INPSTA,INPSAT,LELEVS,LEOF,AA(KFSDM),AA(KQUINF), &
     & II(KPTRAU),II(KPTRUA),AA(KPNAME),ILCORR,                   &
     & II(KTMRA1),II(KTMRA2),AA(KFRSTR),AA(KFRRAT),LL(KLAVOI),       &
     & AA(KPRML0),NDIR,IDWPT)
      IF(.NOT.LBINAST) TLBOD2=1.D0
      IF(MTYPE.LT.33) TLBOD2=1.D0
      IF(MTYPE.GT.34.AND.MTYPE.LT.99) TLBOD2=1.D0
      IF(NINTOT.GT.0) THEN
      IF(MTYPE.EQ.110.OR.MTYPE.EQ.111) THEN
        KKOYNT=KKOYNT+1
        IF(.NOT.LEOF) GOTO 10000
        REWIND(52)
        RETURN
      ENDIF
      ENDIF
      IF(MTYPE.EQ.33.AND.NINTOT.GT.0) THEN
        IKOYNT=IKOYNT+1
        IF(.NOT.LEOF) GOTO 20000
        RETURN
      ENDIF
!
      IF(LSNAP.AND.LEOF) THEN
          WRITE(6,98765) NSPQOK,NSNPDL
98765     FORMAT(' # OK SNPX ',I12,' # SNPX DEL ',I12)
          REWIND 51
          DEALLOCATE(AUX1)
          DEALLOCATE(ACOF4)
          DEALLOCATE(MJDLAS)
          RETURN
      ENDIF
      IF(LSNAP) GO TO 9000
!     XTIME(1)=DFLOAT(MJDSBL)+FSECBL
      CALL UTCET(.TRUE.,1,MJDSBL,FSECBL,FSECOT,AA(KA1UT))
      XTIME(1)=DBLE(MJDSBL)+FSECOT
      IF(MTYPE.EQ.99) THEN
        KEY=AA(KOBCOR(7,7))
        IF(KEY.LT.0) THEN
            XTIME(1)=XLARGE-99.D0
            LSNAP=.TRUE.
            NQ=5*MAXNM*MXLASR*2
            ALLOCATE(AUX1(NQ))
            NQ=6*MAXNM*MAXD
            ALLOCATE(ACOF4(NQ))
            NQ=MXLASR*2
            ALLOCATE(MJDLAS(NQ))
        ENDIF
      ENDIF
!
! ATTENTION THE MEASUREMENT TYPE CHECK BELOW SHOULD BE REVISED
! WHEN MEASUREMENT TYPES LARGER THAN 100 WILL BE INTRODUCED
      LVLBI=MTYPE.EQ.31.OR.MTYPE.EQ.32
      LDDOR=MTYPE.EQ.36
      IF(LVLBI.OR.LDDOR)  &
     & CALL CHBMAT(AA(KCHB1),AA(KCHB2),AA(KCHBV1),AA(KCHBV2),AA(KCHEB))
      IF(ICBDGM.NE.ITBDGM.OR.LVLBI) THEN
         IF(MTYPE.GE.12.AND.MTYPE.LT.99.AND.MTYPE.NE.33) THEN
            FSEC1 = AA(KFSECS(1,1))
            FSECNM= AA(KFSECS(1,1)+NM-1)
            CALL COEFF(MJDSBL,FSEC1,FSECNM,AA)
            IF(.NOT.LVLBI) THEN
            CALL LITPRX(MJDSBL,ZERO,MJDSST,FSECST,AA,II)
            ENDIF
            TIMEBL=DBLE(MJDSBL)+FSECBL
            XTIME(1)=DBLE(MJDSST)+FSECST+FSECBL
            RLTCOR=TIMEBL-XTIME(1)
              IF(LXEPHM) THEN
              CALL COEFFX(MJDSBL,FSEC1,FSECNM,AA,II,II(KISUPE),         &
     &                    AA(KEPHMS))
           ENDIF
         ENDIF
      ENDIF
!
      LNOBS=LEOF
      IF(LEOF) GO TO 2000
      KNTBLK=KNTBLK+1
!
!  COMPARE TIMES OF OBS,ORB PRINT,TRAJECT FILE AND VMAT FILE
!  IN CASE OF TIE FIRST LISTED GETS PRIORITY
!
 2000 CONTINUE
!     write(6,*) 'exec2e: after 2000 '
!>>>
!     IF(LNORB.AND.LNORNF) GO TO 4001
!     IF(LNORB) GO TO 3001
!     DIFSEC=DFLOAT(MJDSBL-MJDST)+(FSECBL-FSECT)
!     IF(DIFSEC.GT.ZERO) GO TO 5000
!3001 CONTINUE
!     IF(LNORNF) GO TO 4000
!     DIFSEC=DFLOAT(MJDSBL-MJDSNF)+(FSECBL-FNFSTR)
!     IF(DIFSEC.GT.ZERO) GO TO 5000
!4001 CONTINUE
!c      PRINT 44444,MJDSBL,FSECBL
!cc44444 FORMAT(' ** EXEC **  MJDSBL,FSECBL =',I12,G24.16)
!cc      print 4442,kmjdt,ktsec, kacc, ii(kmjdt),aa(ktsec), aa(kacc)
!cc4442  format(' exec before obsgen: kmjdt, ktsec, kacc ',
!cc     1   3i10/' mjdt,fsec,acc ',i12, 2g24.16)
!<<<<
!
!  IF ALL OPTIONS ARE FINISHED RETURN
      LRET=LNOPT(1)
      DO 2500 I=2,NOPT
      LRET=LRET.AND.LNOPT(I)
 2500 END DO
!     write(6,*) 'exec2e: after 2500 lret ', lret
      iknt = iknt + 1
!     if( iknt .gt. 25 ) then
!        write(6,*) 'exec2e: stopping because iknt = ', iknt
!        stop 16
!     endif
      IF(LRET) THEN
         IF(LSNAP) THEN
           GO TO 9000
         ELSE
           RETURN
         ENDIF
      ENDIF
!  FIND THE EARLIEST OPTION
      XEARLY=XLARGE
!>>>
      DO 3000 I=1,NOPT
!<<<
!     PRINT 11443,LNOPT(I),I
!1443 FORMAT('** EXEC2E OPTIONS ** ',L1,I2)
      IF(I.EQ.1.AND.LSDATA)GOTO 3000
      IF(LNOPT(I)) GO TO 3000
      IF(XTIME(I).GE.XEARLY) GO TO 3000
      IEARLY=I
      XEARLY=XTIME(I)
 3000 END DO
!     write(6,*) 'exec2e: after 3000 iearly ', iearly
!
      IF(LGPSHO) GO TO 5000
!   GO TO THE EARLIEST OPTION
!cc   GO TO (4000,5000,6000,7000,8000),IEARLY
!>>>
      GO TO (4000,5000,6000,7000,8000,7001,5500),IEARLY
!<<<
!
! PROCESS OBSERVATIONS
!
 4000 CONTINUE
!     write(6,*) 'exec2e: after 4000 call obsgen '
      IF(LSNAP) GO TO 9000
      IF(LTRAJ) GO TO 1000
!ddr
      LHOLD=LSTINR
      IF(.NOT.LSTINR) LSTINR=LSTNRO
      CALL OBSGEN(AA,II,LL,INDSTA,INDSAT,INDSET,INPSTA,INPSAT,LELEVS,   &
     &            ILCORR)
      LSTINR=LHOLD
!ddr
      GO TO 1000
!
!    PRINT ORBIT
 5000 CONTINUE
!     write(6,*) 'exec2e: after 5000 call orbgen '
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL ORBGEN(AA,II,LL,II(KNTIME),II(KMJSTB),II(KMJSTC),II(KMJSTE), &
     &   II(KISECT),AA(KFSCTB),AA(KFSCTC),AA(KFSCTE),AA(KDSECT),        &
     &   AA(KFSECT),LL(KLNDTT),LORBND,AA(KXUTDT))
      TLBOD2=HLBOD2
      LNORB=LORBND
      XTIME(2)=DBLE(MJDST)+FSECT
      GO TO 2000
!
!    OUTPUT EMAT TIE INFORMATION
 5500 CONTINUE
!     write(6,*) 'exec2e: after 5000 call outtie '
      LTIEOU=.TRUE.
      NDIMO=MAPARM+1
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL OUTTIE(AA,II,LL,II(KNTIME),II(KMJSTB),II(KMJSTC),II(KMJSTE), &
     &   II(KISECT),AA(KFSCTB),AA(KFSCTC),AA(KFSCTE),AA(KDSECT),        &
     &   AA(KFSECT),LL(KLNDTT),LORBND,AA(KTIEOU),NDIMO,II(KNEQN),       &
     &   II(KIPTFM),II(KILNFM),II(KNFMG))
      TLBOD2=HLBOD2
      LTIEOU=.FALSE.
      LNTIEO=.TRUE.
      GO TO 2000
!
!  OUTPUT TRAJ FILE
 6000 CONTINUE
!     write(6,*) 'exec2e: after 6000 call tragen '
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL TRAGEN(AA,II,LL,II(KISATR),II(KTRTMB),II(KTRTMC),II(KNTRTM), &
     &    II(KMSTRC),II(KMSTRE),II(KISCTR),AA(KFSTRC),AA(KFSTRE),       &
     &    AA(KDSCTR),AA(KFSECT),AA(KTRBF),II(KITRUN),LL(KLNDTR),        &
     &    LL(KLWSTR),LTRJND,II(KINDP),AA(KRPOLE),AA(KPXPOL),AA(KS0),    &
     &    II(KNMP),NM,AA(KXDPOL),AA(KXUTDT))
      TLBOD2=HLBOD2
      LNTRAJ=LTRJND
      XTIME(3)=DBLE(MJDSTR)+FSECTR
      GO TO 2000
!
!  OUTPUT VMAT FILE
 7000 CONTINUE
!     write(6,*) 'exec2e: after 7000 call vmtgen '
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL VMTGEN(AA,II,LL,II(KMJDVS),AA(KFSCVS),AA(KXSJ),AA(KXTI),     &
     &    II(KNTMVM),LL(KLEVMF),AA(KXTN))
      TLBOD2=HLBOD2
      LNVMAT=.NOT.LVMTF
      XTIME(4)=DBLE(MJDVMA)+FSCVMA
      GO TO 2000
!
!  PSEUDO BLOCK GENERATION
 8000 CONTINUE
!     write(6,*) 'exec2e: after 8000 call simgen '
!     PRINT 11225
!1225 FORMAT(2X,'SUCCESSFUL OPERATION OF EXEC2E')
      LACC=.FALSE.
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL SIMGEN(AA,II,LL,II(KSMSA1),II(KSMSA2),II(KSMSA3),II(KSMST1), &
     &            II(KSMST2),II(KSMST3),II(KSMTYP),II(KSMT1),II(KSMT2), &
     &            AA(KFSCSD),AA(KELEVT),AA(KSRFEL),AA(KTINT),           &
     &            LFND,AA(KFSDM),II(KMSDM),LL(KLPTS),                   &
     &            AA(KXTIM),INDSAT,INDSTA,INDSET,INPSTA,INPSAT,LELEVS,  &
     &            AA(KSGM1),AA(KSGM2),AA(KNOISE),                       &
     &            ILCORR)
      TLBOD2=HLBOD2
! THE FOLLOWING IS TRUE WHEN THE PSEUDOBLOCK HAS BEEN ACCEPTED
! TEMPORARILY COMMENTED OUT
!     IF(LFND) GOTO 4000
      XTIME(5)=DBLE(MJDSIM)+FSCSIM
      ITIME5=XTIME(5)
      MJSEND=MAX(MJSEND,MJDEND)
      IF(ITIME5.GE.MJSEND)LNOPT(5)=.TRUE.
      GO TO 2000
!>>>
 7001 CONTINUE
!     write(6,*) 'exec2e: after 7001 call orbinf '
      IF(LNORNF) GO TO 8001
!     write(6, 77777) MJDSNF,FNFSTR
77777 FORMAT(' ** EXEC **  7001 MJDSNF,FNFSTR =',I12,G24.16)
      HLBOD2=TLBOD2
      TLBOD2=1.D0
      CALL ORBINF(AA,II,LL,AA(KSXYZ),AA(KXLOCV),LENDNF,AA(KXUTDT))
      TLBOD2=HLBOD2
      LNORNF=LENDNF
      XTIME(6)=DBLE(MJDSNF)+FNFSTR
!cc   IF(LNOBS) GO TO 5000
      GO TO 2000
 8001 CONTINUE
      RETURN
!<<<
      IF(.NOT.LSNAP) RETURN
 9000 CONTINUE
      NSNAPB=NSNAPB+1
      IKOY=IKOY+1
      KEY=AA(KOBCOR(7,7))
!!!!  CALL ATPARP(AA,II,LL,MTYPE,INDSAT(1,1),NM,MJDSBL,AA(KFSECS(1,1)), &
!!!! &            II(KATSAT),II(KKVLAS),AA(KATIME))
      CALL SNAPGN(AA,II,LL,INDSTA,INDSAT,INDSET,INPSTA,INPSAT,LELEVS,   &
     &            ILCORR,LSNAP1,NSNAPB,NSNAPX,ID1,ID2,NB1,NB2,          &
     &            NBT,NBC,NM1,NM2,INDX0,KEY1,KEY2,XLAT,XLON,XS,XN,XW,XE,&
     &            LGRN,MAXD,PPARM,                                      &
     &            AA(KPXEXI),AA(KPXEPA),AA(KPXEP2),AA(KX2COF),          &
     &            AA(KACOF2),AA(KACOF3),AA(KBCOF),AA(KBCOF2),           &
!!!!!&            AA(KX2AUX),AA(KXVTM1),AA(KDDDA),AA(KXDIST),AA(KXDST0),&
     &            AUX1      ,AA(KXVTM1),AA(KDDDA),AA(KXDIST),AA(KXDST0),&
     &            II(KIDLAS),II(KXIOBS),AA(KTMSE),MAXNM,                &
     &            MADJST,MXLASR,NPDEG,II(KIAVP),II(KXNAVP),AA(KDSDP),   &
     &            KEY,MJDLAS,ACOF4)
      GO TO 1000

10000 CONTINUE
      LIN=.FALSE.
      IF(KKOYNT.EQ.1) THEN
       LIN=.TRUE.
       REWIND(52)
      ENDIF

      ISET=INDSET(1,1)
      IF(LNPNM) THEN
      NDIM1=NADJST
      NDIM2=1
      NDIMA=II(KNEQN-1+ISET)
      NDIMB=3
      NDIMC=1
      ELSE
      NDIM1=1
      NDIM2=NADJST
      NDIMA=1
      NDIMB=II(KNEQN-1+ISET)
      NDIMC=3
      ENDIF
      CALL CONGENR(AA,II,LL,INDSAT,INDSET,AA(KEXTRA),AA(KPXEPA),        &
     &            AA(KEDSIG),MAXNM,MXLASR,NDIMA,NDIMB,NDIMC,LIN,AA(KPV),&
     &            AA(KPMPA),AA(KPXPFM),AA(KM2VPA),AA(KOBSIG),AA(KOBS))
      GO TO 1000

20000 CONTINUE

      ISET1=INDSET(1,1)
      ISET2=INDSET(2,1)
      NDIMX11=II(KNEQN-1+ISET1)
      NDIMX12=II(KNEQN-1+ISET2)
      NDIMX1=MAX(NDIMX11,NDIMX12)
      NEQN=NDIMX1
      NDIMX21=II(KN3-1+ISET1)
      NDIMX22=II(KN3-1+ISET2)
      NDIMX2=MAX(NDIMX21,NDIMX22)
      NDIMX3=NM
      NDIM1=NADJST
      NDIM2=NDIMX3
      IF(LNPNM) GO TO 15000
      NDIMX1=NM
      NDIMX21=II(KNEQN-1+ISET1)
      NDIMX22=II(KNEQN-1+ISET2)
      NDIMX2=MAX(NDIMX21,NDIMX22)
      NDIMX31=II(KN3-1+ISET1)
      NDIMX32=II(KN3-1+ISET2)
      NDIMX3=MAX(NDIMX31,NDIMX32)
      NDIM1=NDIMX1
      NDIM2=NADJST
15000 CONTINUE
        write(6,*)' dbg CALL IMAGER '
      CALL IMAGER(AA,II,LL,INDSAT,INDSET,AA(KRESID),AA(KSIGMA),         &
     &     AA(KRATIO),AA(KPMPA ),AA(KOBS),AA(KOBSIG), AA(KS1),JSTATS,   &
     &     MTYPE,                                                       &
     &     XSCR,AA(KXSM),AA(KXSJ),AA(KVSM),AA(KVTK),II(KNEQN-1+ISET2),  &
     &     AA(KPXPFM),NDIMX1,NDIMX2,NDIMX3,II(KN3-1+ISET2),             &
     &     AA(KM2VPA),                                                  &
     &     AA(KATPER),LL(KLEDIT),AA(KEDSIG),AA(KTHETG),AA(KCOSTH),      &
     &     AA(KSINTH),AA(KEXTRA),AA(KWORK),AA(KXHOLD),AA(KATROT),       &
     &     II(KIPTFM),II(KILNFM),II(KNFMG),AA(KPXEPA),LINIM,AA(KOBTIM))

      GO TO 1000

      END
