!$FIELDG
      SUBROUTINE FIELDG(ALT,X,Y,Z,COSLAT)
!********1*********2*********3*********4*********5*********6*********7**
! FIELDG                                         PGMR - R.WILLIAMSON
!
! FUNCTION:
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!
!
!
! this is a special version of the pogo 68/10 magnetic field
! legendre model. transformation coeff. g(144) valid for 1973.
! input: dlat, dlon=geographic coordinates/deg.(-90/90,0/360),
!        alt=altitude/km.
! output: f total field (gauss), z downward vertical component
!        x,y components in the equatorial plane (x to zero longitude).
! sheik,1977.
      COMMON/CTRIG/CHA,SHA,CBG,SBG,CLG,SLG,SMODIP
      dimension h(144),xi(3),g(144),fel1(72),fel2(72)
      equivalence (g(1),fel1(1)),(g(73),fel2(1))
      data fel1/0.0, 0.1506723,0.0101742, -0.0286519, 0.0092606,        &
     & -0.0130846, 0.0089594, -0.0136808,-0.0001508, -0.0093977,        &
     & 0.0130650, 0.0020520, -0.0121956, -0.0023451, -0.0208555,        &
     & 0.0068416,-0.0142659, -0.0093322, -0.0021364, -0.0078910,        &
     & 0.0045586,  0.0128904, -0.0002951, -0.0237245,0.0289493,         &
     & 0.0074605, -0.0105741, -0.0005116, -0.0105732, -0.0058542,       &
     &0.0033268, 0.0078164,0.0211234, 0.0099309, 0.0362792,             &
     &-0.0201070,-0.0046350,-0.0058722,0.0011147,-0.0013949,            &
     & -0.0108838,  0.0322263, -0.0147390,  0.0031247, 0.0111986,       &
     & -0.0109394,0.0058112,  0.2739046, -0.0155682, -0.0253272,        &
     &  0.0163782, 0.0205730,  0.0022081, 0.0112749,-0.0098427,         &
     & 0.0072705, 0.0195189, -0.0081132, -0.0071889, -0.0579970,        &
     & -0.0856642, 0.1884260,-0.7391512, 0.1210288, -0.0241888,         &
     & -0.0052464, -0.0096312, -0.0044834, 0.0201764,  0.0258343,       &
     &0.0083033,  0.0077187/
      data fel2/0.0586055,0.0102236,-0.0396107,                         &
     & -0.0167860, -0.2019911, -0.5810815,0.0379916,  3.7508268,        &
     & 1.8133030, -0.0564250, -0.0557352, 0.1335347, -0.0142641,        &
     & -0.1024618,0.0970994, -0.0751830,-0.1274948, 0.0402073,          &
     &  0.0386290, 0.1883088,  0.1838960, -0.7848989,0.7591817,         &
     & -0.9302389,-0.8560960, 0.6633250, -4.6363869, -13.2599277,       &
     & 0.1002136,  0.0855714,-0.0991981, -0.0765378,-0.0455264,         &
     &  0.1169326, -0.2604067, 0.1800076, -0.2223685, -0.6347679,       &
     &0.5334222, -0.3459502,-0.1573697,  0.8589464, 1.7815990,          &
     &-6.3347645, -3.1513653, -9.9927750,13.3327637, -35.4897308,       &
     &37.3466339, -0.5257398,  0.0571474, -0.5421217,  0.2404770,       &
     & -0.1747774,-0.3433644, 0.4829708,0.3935944, 0.4885033,           &
     &  0.8488121, -0.7640999, -1.8884945, 3.2930784,-7.3497229,        &
     & 0.1672821,-0.2306652, 10.5782146, 12.6031065, 8.6579742,         &
     & 215.5209961, -27.1419220,22.3405762,1108.6394043/
!
!     k=0
!     do 10 i=1,72
!     k=k+1
!     g(k)=fel1(i)
!10   g(72+k)=fel2(i)
!
!     ct=sin(rlat)
!     st=cos(rlat)
      ct=sbg
      st=cbg
!     cp=cos(rlong)
!     sp=sin(rlong)
      cp=clg
      sp=slg
!
      d=SQRT(40680925.0-272336.0*ct*ct)
      zzz=ct*(alt+40408589.0/d)/6371.2
      rho=st*(alt+40680925.0/d)/6371.2
      xxx=rho*cp
      yyy=rho*sp
      rq=1.0/(rho*rho+zzz*zzz)
      xi(1)=xxx*rq
      xi(2)=yyy*rq
      xi(3)=zzz*rq
!
      nmax=11
      ihmax=nmax*nmax+1
      nlast=ihmax+nmax+nmax
      imax=nmax+nmax-1
      do 100 i=ihmax,nlast
  100 h(i)=g(i)
!
      do 200 k=1,3,2
      i=imax
      ih=ihmax
  300 il=ih-i
      f1=2./(i-k+2.)
      x1=xi(1)*f1
      y1=xi(2)*f1
      z1=xi(3)*(f1+f1)
      i=i-2
      if((i-1).lt.0) goto 400
      if((i-1).eq.0) goto 500
      do 600 m=3,i,2
      h(il+m+1)=g(il+m+1)+z1*h(ih+m+1)+x1*(h(ih+m+3)-h(ih+m-1))-        &
     &y1*(h(ih+m+2)+h(ih+m-2))
      h(il+m)=g(il+m)+z1*h(ih+m)+x1*(h(ih+m+2)-h(ih+m-2))+              &
     &y1*(h(ih+m+3)+h(ih+m-1))
  600 continue
  500 h(il+2)=g(il+2)+z1*h(ih+2)+x1*h(ih+4)-y1*(h(ih+3)+h(ih))
      h(il+1)=g(il+1)+z1*h(ih+1)+y1*h(ih+4)+x1*(h(ih+3)-h(ih))
  400 h(il)=g(il)+z1*h(ih)+2.0*(x1*h(ih+1)+y1*h(ih+2))
      ih=il
      if(i.ge.k) goto 300
  200 continue
!
      s=0.5*h(1)+2.0*(h(2)*xi(3)+h(3)*xi(1)+h(4)*xi(2))
      xt=(rq+rq)*SQRT(rq)
      x=xt*(h(3)-s*xxx)
      y=xt*(h(4)-s*yyy)
      z=xt*(h(2)-s*zzz)
      brh0=y*sp+x*cp
      y=y*cp-x*sp
      x=z*st-brh0*ct
      z=-z*ct-brh0*st
!
      coslat=cbg
      return
      END
