!$RAYGRD
      SUBROUTINE RAYGRD (MJDSEC,FSEC,CONNAM,ANGFAC,SCRTCH,GRDANG,       &
     &                   UANG,FAMP,IDOODN,ISLP,ISRP,NTDDOO)
!********1*********2*********3*********4*********5*********6*********7**
! RAYGRD           00/00/00            8604.0    PGMR - ?
!
! FUNCTION:  CONTROLS THE MAINTENANCE OF THE GRID OF TIDAL
!            QUANTITIES THAT ARE COMPUTED AT REGULAR
!            INTERVALS (NO SATELLITE POSITION DEPENDENCY). ROUTINE
!            IS CALLED AT EVERY INTEGRATION STEP. IF THE REQUIRED
!            QUANTITIES HAVE ALREADY BEEN COMPUTED, THEN THE ROUTINE
!            IS EXITED AFTER DETERMINING THE POINTERS TO THE
!            BOUNDING INTERVALS.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   MJDSEC   I    S    INTEGER TIME
!   FSEC     I    A    FRACTIONAL SECONDS FROM MJDSEC
!   ANGFAC   I    A    FACTORS TO MULTIPLY EACH OF THE 5 ARGUMENTS BY
!                      PLUS A -/+ PHASE FOR CERTAIN DOODSON NUMBERS
!   SCRTCH  I/O   A    SCRATCH ARRAY FOR INTERMEDIATE CALCULATION
!   GRDANG   O    A    ANGLE COMPUTED FROM THE LINEAR COMBINATION
!                      OF ASTRONOMICAL ANGLES (GIVEN AT GRID TIMES)
!   UANG     O    A    ANGLE TO BE ADDED TO GRDANG TO COMPENSATE
!                      FOR SIDE BANDS (GIVEN AT GRID TIMES)
!   FAMP     O    A    FACTOR TO MULTIPLLT AMPLITUDE OF THE TIDE TO
!                      UNIQUE DOODSON NUMBERS
!                      SIDEBANDS OR NOT
!   ISLP     O    S    LEFT GRID POINT TO BE USED FOR INTERPOLATION
!   ISRP     O    S    RIGHT GRID POINT TO BE USED FOR INTERPOLATION
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      COMMON/CTIDES/NTIDE,NSTADJ,NET,NETADJ,NETUN,NOT,NOTADJ,           &
     &   NOTUN ,NETUNU,NETADU,NOTUNU,NOTADU,NBSTEP,KTIDA(3),            &
     &   ILLMAX,NUNPLY,NNMPLY,NDOODN,MXTMRT,NRESP ,NXCTID
      COMMON/TIDE2I/ISCRT(5),INTRT,NTMRT,JMP2RS(10)
      DIMENSION ANGFAC(NDOODN,6)
      DIMENSION CONNAM(NDOODN)
      DIMENSION SCRTCH(NTDDOO,4)
      DIMENSION GRDANG(NDOODN,MXTMRT)
      DIMENSION UANG(NDOODN,MXTMRT,3)
      DIMENSION FAMP(NDOODN,MXTMRT,3)
      DIMENSION IDOODN(NDOODN,3)
!
!
!
!***********************************************************************
! START OF EXECUTABLE CODE *********************************************
!***********************************************************************
!
! FIGURE OUT WHERE CURRENT TIME STEP IN THE TIME GRID OF PRECOMPUTED VAL
!
    5 CONTINUE
      FSCST=DBLE(MJDSEC)+FSEC
      ISCST=FSCST
      ISUB=MOD(ISCST,INTRT)
      ISL=ISCST-ISUB
      ISR=ISL+INTRT
!
! IF NO GRID POINTS EXIST
      IF(NTMRT.EQ.0) THEN
         NTMRT=2
         ISLP=1
         ISRP=2
         ISCRT(1)=ISL
         ISCRT(2)=ISR
         CALL RAYTM(1,ISCRT(1),CONNAM,ANGFAC,SCRTCH,GRDANG,             &
     &              UANG,FAMP,IDOODN,NTDDOO)
         CALL RAYTM(2,ISCRT(2),CONNAM,ANGFAC,SCRTCH,GRDANG,             &
     &              UANG,FAMP,IDOODN,NTDDOO)
         RETURN
      ENDIF
!
!  AT LEAST 2 GRID PONTS EXIST
      ISLP=1+(ISL-ISCRT(1))/INTRT
      ISRP=ISLP+1
      IF(ISLP.GE.1.AND.ISRP.LE.NTMRT) RETURN
      NTMRT=0
      GO TO 5
!
!  IF STLL IN ROUTINE (NOT RETURNED YET) GRID WILL NEED ADDITIONAL INFOR
!
!  SEE IF NEED INFO ON LEFT
      IF(ISLP.GE.1) GO TO 300
      NFILL=ABS(ISLP-1)
      NSAVE=MXTMRT-NFILL
      IF(NSAVE.GT.NTMRT) NSAVE=NTMRT
      IF(NSAVE.LE.0) GO TO 110
      NTOP=NFILL+NSAVE
      ITO=NTOP
      IFROM=NSAVE
      DO 100 I=1,NSAVE
      ISCRT(ITO)=ISCRT(IFROM)
      DO J=1,NDOODN
        GRDANG(J,ITO)=GRDANG(J,IFROM)
        UANG(J,ITO,1)=UANG(J,IFROM,1)
        UANG(J,ITO,2)=UANG(J,IFROM,2)
        UANG(J,ITO,3)=UANG(J,IFROM,3)
        FAMP(J,ITO,1)=FAMP(J,IFROM,1)
        FAMP(J,ITO,2)=FAMP(J,IFROM,2)
        FAMP(J,ITO,3)=FAMP(J,IFROM,3)
      ENDDO
      ITO=ITO-1
      IFROM=IFROM-1
  100 END DO
  110 CONTINUE
      NFILL=2
      NTMRT=2
      IF(NSAVE.GT.0) THEN
        NFILL=NTOP-NSAVE
        NTMRT=NTOP
      ENDIF
      ISLP=1
      ISRP=2
      DO 200 I=1,NFILL
      ISCRT(I)=ISL+(I-1)*INTRT
      CALL RAYTM(I,ISCRT(I),CONNAM,ANGFAC,SCRTCH,GRDANG,                &
     &          UANG,FAMP,IDOODN,NTDDOO)
  200 END DO
      RETURN
  300 CONTINUE
!
!
!  NEED INFO ON RIGHT
      NFILL=ISRP-NTMRT
      IF(NFILL.GE.MXTMRT) THEN
         NTMRT=2
         ISLP=1
         ISRP=2
         ISCRT(1)=ISL
         ISCRT(2)=ISR
         CALL RAYTM(1,ISCRT(1),CONNAM,ANGFAC,SCRTCH,GRDANG,             &
     &              UANG,FAMP,IDOODN,NTDDOO)
         CALL RAYTM(2,ISCRT(2),CONNAM,ANGFAC,SCRTCH,GRDANG,             &
     &              UANG,FAMP,IDOODN,NTDDOO)
         RETURN
      ENDIF
      NSAVE=MXTMRT-NFILL
      IF(NSAVE.GT.NTMRT) NSAVE=NTMRT
      NTOP=NSAVE
      IFROM=NTOP
      ITO=1
      DO 400 I=1,NSAVE
      ISCRT(ITO)=ISCRT(IFROM)
      DO J=1,NDOODN
        GRDANG(J,ITO)=GRDANG(J,IFROM)
        UANG(J,ITO,1)=UANG(J,IFROM,1)
        UANG(J,ITO,2)=UANG(J,IFROM,2)
        UANG(J,ITO,3)=UANG(J,IFROM,3)
        FAMP(J,ITO,1)=FAMP(J,IFROM,1)
        FAMP(J,ITO,2)=FAMP(J,IFROM,2)
        FAMP(J,ITO,3)=FAMP(J,IFROM,3)
      ENDDO
      ITO=ITO+1
      IFROM=IFROM+1
  400 END DO
      DO 500 I=1,NFILL
      IQP=I+NTOP
      ISCRT(IQP)=ISR+(I-NFILL)*INTRT
      CALL RAYTM(IQP,ISCRT(IQP),CONNAM,ANGFAC,SCRTCH,GRDANG,            &
     &           UANG,FAMP,IDOODN,NTDDOO)
  500 END DO
      NTMRT=NSAVE+NFILL
      ISRP=NTMRT
      ISLP=ISRP-1
      RETURN
      END
