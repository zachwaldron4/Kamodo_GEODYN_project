!$EBIASE
      SUBROUTINE EBIASE(PMPE  ,FSECN ,RESID ,EDTSIG,RATIO ,OBSSIG,      &
     &           EDFLAG,LEDIT ,NTYPE ,LBEDIT,LNEDIT,OBSC,AA)
!********1*********2*********3*********4*********5*********6*********7**
! EBIASE           00/00/00            0000.0    PGMR - ?
!
!
! FUNCTION:
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   PMPE
!   FSECN
!   RESID
!   EDTSIG
!   RATIO
!   OBSSIG
!   EDFLAG
!   LEDIT
!   NTYPE
!   LBEDIT
!   LNEDIT
!   AA
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
!********1*********2*********3*********4*********5*********6*********7**
! EBIASE           00/00/00            0000.0    PGMR - T. MARTIN
!                      3/90            90??.0    PGMR - W. EDDY
!                      3/90            90??.0    PGMR - J. MCCARTHY
!
! FUNCTION:
!
!
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   PMPE          A    Matrix of partials of measurements wrt E-biases
!   FSECN    I    A    Time in ET seconds from start of data block
!   RESID         A    MEASUREMENT RESIDUALS
!   EDTSIG        S    EDITING SIGMA
!   RATIO         A    RATIO OF RESIDUAL TO MEASUREMENT SIGMA
!   OBSSIG        A    MEASUREMENT SIGMA
!   EDFLAG  I/O   A    ARRAY FOR EDITING FLAGS FOR RESIDUAL PRINTOUT
!   LEDIT   I/O   A    ARRAY OF EDITING SWITCHES FOR EACH POINT
!   NTYPE    I    S    Measurement type
!   LBEDIT   O    S    Editing switch to indicate if bias editing done
!   LNEDIT   I    S    LOCAL EDITING SWITCH (DO LOCAL EDIT IF .FALSE.)
!   AA      I/O   A    DYNAMIC ARRAY FOR REAL VARIABLES.
!   II      I/O   A    DYNAMIC ARRAY FOR INTEGER VARIABLES
!
!
! COMMENTS:
!
!
!********1*********2*********3*********4*********5*********6*********7**
!
      PARAMETER(  ZERO = 0.0D0 )
      PARAMETER(  ONE  = 1.0D0 )
!
!     ....APESIG IS THE INVERSE OF THE  A PRIORI EBIAS SIGMA
      PARAMETER( APESIG = 1.0D-14 )
!
      COMMON/CBIASA/BIASE (4),BIASM (2),BSCALE(1)  ,TBIAS (1),          &
     &              BSTROP(3),BSIONO(3),CLKSTA(4,2),CLKSAT(4,2),        &
     &              CLKSTS(2,2),TROPZE(2,2),TROPGR(2,4),BSLBIA(1)
      COMMON/CBIASI/IEBIAS(4),IMBIAS(2),IBSCAL(1)  ,ITBIAS(1),          &
     &              IBTROP(3),IBIONO(3),KLKSTA(4,2),KLKSAT(4,2),        &
     &              KLKSTS(2,2),ITRPZE(2,2),ITRPGR(2,4),IBSBIA(1)
      COMMON/CBIASL/LEBIAS(4),LMBIAS(2),LBSCAL(1)  ,LTBIAS(1),          &
     &              LBTROP(3),LBIONO(3),LCLSTA(4,2),LCLSAT(4,2),        &
     &              LKLSTS(2,2),LTRPZE(2,2),LTRPGR(2,4),LBSBIA(1),      &
     &              LNBIAS
      COMMON/CBLOKI/MJDSBL,MTYPE ,NM    ,JSTATS,NPSEG ,JSATNO(3),ITSYS ,&
     &       NHEADB,NELEVS,ISTAEL(12),INDELV(3,4),JSTANO(3),ITARNO,     &
     &       KTARNO
      COMMON/CEBGLB/MEPARM,MEDIM ,MEBIAS,MBIASE,NEBGRP,IEBGRP(4),NXCEBG
      COMMON/CEDIT /EDITX ,EDTRMS,EDLEVL,CONVRG,GLBCNV,EBLEVL,EDITSW,   &
     &              ENPX  ,ENPRMS,ENPCNV,EDBOUN,FREEZI,FREEZG,FREEZA,   &
     &              XCEDIT
      COMMON/CESTIM/MPARM,MAPARM,MAXDIM,MAXFMG,ICLINK,IPROCS,NXCEST
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CLIGHT/VLIGHT,ERRLIM,XCLITE
      COMMON/COBLOC/KXMN  (3,4)  ,KENVN (3,4)  ,KSTINF(3,4)  ,          &
     &       KOBS  ,KDTIME,KSMCOR,KSMCR2,KTMCOR,KOBTIM,KOBSIG,KOBSG2,   &
     &       KIAUNO,KOBCOR(9,7)  ,KFSECS(6,8)  ,KOBSUM(8)    ,          &
     &       KEDSIG,KEDSG2
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
!
      DIMENSION PMPE  (MINTIM,MEPARM),RESID (NM),OBSSIG(NM),RATIO (NM)
      DIMENSION OBSC(NM)
!      CHARACTER*8         EDFLAG
      DIMENSION EDFLAG(NM),LEDIT(NM),FSECN(NM),EDTSIG(NM)
!                 ATWB,DIFCOR,BPARTL,BDELTA
!
!               BIASE ,IEBIAS,LEBIAS   ARE DIMENSIONED BY THE MAX NO. OF
!               EBIAS PARAMETERS APPLICABLE TO A SINGLE MEAS. (MEPARM)
!               ATWA IS DIMENSIONED BY MEDIM=(MEPARM*(MEPARM+1)/2
!
      DIMENSION ATWB( 4),DIFCOR( 4),BPARTL( 4),BDELTA(4)
      DIMENSION ATWA(10)
      DIMENSION AA(1)
!
      DATA MITER/3/
      CHARACTER*1         EDTFLG
      CHARACTER*1         EDTLOC
      DATA EDTFLG/'E'/
      DATA EDTLOC/'L'/
      DATA METRIX/37/
!
      CHARACTER*8         TMP_CHAR
      EQUIVALENCE (TMP_CHAR, TMP_DP )
!
!**********************************************************************
! START OF EXECUTABLE CODE ********************************************
!**********************************************************************
!
!
!CC   PRINT *,'EBIASE: NM ',NM
!CC   PRINT *,'EBIASE: LEDIT ',(LEDIT(KK3),KK3=1,NM)
!
! SUBTRACT SIMPLE MEASUREMENT BIAS FROM OBSERVATION RESIDUALS
!
      NINDEX=0
      IF(NEBGRP.LE.0) RETURN
!
! DETERMINE WHICH EBIASES ARE PRESENT (UP TO 4 GROUPS) AND SUBTRACT
! THE EBIAS FROM RESIDUAL
!
      DO 2100 JLOOP=1,NEBGRP
      IF(IEBIAS(JLOOP).EQ.0) GO TO 2100
      IGRP1=IEBIAS(JLOOP)/1000000 +1
!CCC  PRINT *,'EBIASE: JLOOP, IGRP1 ', JLOOP, IGRP1
      GO TO (1000,1100,1200,1300,1400,1500),IGRP1
!
!     GROUP 0XX - MEASUREMENT EBIASES
!
 1000 CONTINUE
      NINDEX=NINDEX+1


      DO  1020 N=1,NM
       IF(NTYPE.NE.40) THEN
       RESID (N)=RESID (N)-BIASE (JLOOP)
       PMPE  (N,NINDEX)=ONE
       ELSE

        IF (ABS(BIASE (JLOOP)).GE.100.D0) THEN
        RESID (N)=RESID (N)-BIASE (JLOOP)
        PMPE  (N,NINDEX)=ONE
        ELSE
        RESID (N)=RESID (N)-BIASE (JLOOP)*(1.D0 - OBSC(N)/VLIGHT)
        PMPE  (N,NINDEX)= ONE-(OBSC(N)/VLIGHT)
        ENDIF

      ENDIF

 1020 END DO
      GO TO 2100
 1100 CONTINUE
!
!     GROUP 1XX - MEASUREMENT SCALE BIASES
!     NOT IMPLEMENTED YET
!
      GO TO 2100
 1200 CONTINUE
!
!     GROUP 2XX - TIME VARYING BIASES
!
      NINDEX=NINDEX+1
      DO 1220 N=1,NM
      PMPE(N,NINDEX)=FSECN(N)
      RESID (N)=RESID (N)-BIASE (JLOOP)*FSECN (N)
 1220 END DO
      GO TO 2100
 1300 CONTINUE
!
!     GROUP 3XX -
!     NOT IMPLEMENTED YET
!
      GO TO 2100
 1400 CONTINUE
!
!     GROUP 4XX -
!     NOT IMPLEMENTED YET
!
      GO TO 2100
 1500 CONTINUE
!
!     GROUP 500 - TROPOSPHERE SCALE BIASES
!
      NINDEX=NINDEX+1
!
! COMPUTE THE TROPOSPHERE PARTIAL - ONLY THE FIRST STA IS IMPLEMENTED
!
      CALL PMPTRP(PMPE,MINTIM,MEPARM,NINDEX,NM,AA(KOBCOR(3,1)),         &
     &           AA(KOBCOR(4,1)),MTYPE,.FALSE.)
!CCC  PRINT *, 'EBIASE: NM, JLOOP,NINDEX ',NM, JLOOP, NINDEX
!CCC  PRINT *, 'EBIASE: PMPE ', (PMPE(N,NINDEX),N=1,NM)
!CCC  PRINT *, 'EBIASE: BIASE(JLOOP) ', BIASE(JLOOP)
      DO  2020 N=1,NM
      RESID (N)=RESID (N)-PMPE(N,NINDEX)*BIASE (JLOOP)
 2020 END DO
      GO TO 2100
 2100 END DO
!
! IF NO BIAS PARAMETERS FOR THIS OBSERVATION BLOCK, RETURN
!
      IF(NINDEX.LE.0) RETURN
      IF(NINDEX .GT. MEPARM ) THEN
         WRITE(6,*) 'EBIASE: NINDEX = ',NINDEX, ' > MEPARM = ', MEPARM
         WRITE(6,*) 'STOPPING IN SUBROUTINE EBIASE '
         STOP 16
      ENDIF
!
      IF(LNEDIT) GO TO 6000
      LBEDIT=.TRUE.
!
! COUNT THE NUMBER OF WEIGHTED OBSERVATIONS
!
      NWTD=0
      DO 2800 N=1,NM
      IF(.NOT.LEDIT(N)) NWTD=NWTD+1
 2800 END DO
!
! IF LESS THAN OR EQUAL TO THE NUMBER OF BIAS PARAMETERS SKIP EDITING
!
!CC   PRINT *,' EBIASE: NWTD,NINDEX ',NWTD,NINDEX
!
!     ....3/22/90 FIX FOR EBIAS
!
      IF( NWTD .LE. (NINDEX+1) ) GO TO 6000
!CCC  IF( NWTD .LE. (NINDEX  ) ) GO TO 6000
!     ....3/22/90 FIX FOR EBIAS
!
!
!***********************************************************************
!
! EDIT OBSERVATION RESIDUALS AND FORM NORMALS FOR LOCAL
!      DIFFERENTIAL CORRECTIONS TO ELECTRONIC BIAS PARAMETERS.
! REMOVE LOCAL CORRECTIONS FROM RESIDUALS AND ITERATE BACK TO EDIT STEP.
!
!***********************************************************************
!
! CLEAR DIFFERENTIAL CORRECTION ARRAY
!
      CALL CLEARA(DIFCOR,MEPARM)
      NITER=MITER
      ITER=0
      RMSPRV=EDTRMS
!
!     ....IN ORDER TO DO THE GROSS EDITING OF LOCAL EDITING, SET
!     ....THE EDIT LEVEL TO THE E-BIAS EDITING LEVEL ON THE FIRST
!     ....ITERATION.  ON SUBSEQUENT ITERATIONS, THE E-BIAS EDITING
!     ....LEVEL IS REPLACED BY THE REGULAR EDIT LEVEL, AND THUS
!     ....MAY BE TOO SMALL AND EDIT OUT BIASED PASSES
!
      IF( LITER1 ) EBLEV0 = EBLEVL
      EDTLVL=EBLEV0
!C    WRITE(6,*) 'EBIASE: BEFORE 3000 LITER1, EBLEVL, EBLEV0 ',
!C   1                                LITER1, EBLEVL, EBLEV0
!
 3000 CONTINUE
      ITER=ITER+1
      LAST=ITER.GE.NITER
!
! CLEAR SUMMATION ARRAYS
!
      CALL CLEARA(ATWA,MEDIM)
      CALL CLEARA(ATWB,MEPARM)
      RMS=ZERO
      NWTD=0
      DO 4000 N=1,NM
      IF(LEDIT(N)) GO TO 4000
!
! STORE PARTIALS INTO LOCAL ARRAY AND SUM PARTIALS*DIFFERENTIAL CORR.
!
      RESCOR=ZERO
      DO 3200 I=1,NINDEX
      BPARTL(I)=PMPE(N,I)
!CCCC PRINT *,'EBIASE: I,BPARTL(I) ', I, BPARTL(I)
      RESCOR=RESCOR+DIFCOR(I)*BPARTL(I)
 3200 END DO
!
! CORRECT LOCAL RESIDUAL, COMPUTE RATIO TO EDITING SIGMA AND EDIT
!
      RESDIF=RESID (N)-RESCOR
      RATDIF=RESDIF/EDTSIG(N)
      LNGOOD = ABS(RATDIF).GT.EDTLVL
      IF(LNGOOD) GO TO 3900
      NWTD=NWTD+1
      IF(LAST) GO TO 3800
!
! SUM THIS OBSERVATION EQUATION INTO LOCAL NORMALS
!
      WT=ONE/OBSSIG(N)**2
!CCCC PRINT *,'EBIASE: WT, RESDIF, NINDEX ', WT, RESDIF, NINDEX
      CALL SUMBNP(BPARTL,RESDIF,WT,NINDEX,NINDEX,ATWA,ATWB,BDELTA)
      RMS=RMS+(RESDIF/OBSSIG(I))**2
      GO TO 4000
 3800 CONTINUE
!
! SAVE EDITING RATIO ON LAST ITERATION
!
      RATIO(N)=RATDIF
      GO TO 4000
 3900 CONTINUE
      IF(.NOT.LAST) GO TO 4000
!
! ON LAST ITERATION FLAG EDITED RESIDUALS
!
      LEDIT (N)=.TRUE.
!      EDFLAG(N)= EDTLOC
      TMP_CHAR = EDTLOC
      EDFLAG(N)= TMP_DP
 4000 END DO
      IF(LAST) GO TO 5000
!
!     ....3/22/90 FIX
      IF( NWTD .LE. (NINDEX+1) ) GO TO 4200
!CCC  IF( NWTD .LE. (NINDEX  ) ) GO TO 4200
!     ....3/22/90 FIX
!
!     ....ADD APRIORI SIGMA TO ATWA MATRIX TO PREVENT INVERSION
!     ....PROBLEMS IF TROP BIAS IS ZERO
!
      IK = 1
      DO 4010 I = 1, NINDEX
         ATWA(IK) = ATWA(IK) + APESIG
         IK = IK + NINDEX + 1 - I
 4010   CONTINUE
!
! INVERT NORMAL MATRIX
      CALL DSINV(ATWA  ,NINDEX,NINDEX,BDELTA)
! SOLVE FOR LOCAL BIAS DIFFERENTIAL CORRECTIONS
      CALL SOLVE(ATWA  ,ATWB  ,NINDEX,NINDEX,BDELTA)
! UPDATE LOCAL DIFFERENTIAL CORRECTION SUMS
      DO 4100 I=1,NINDEX
      DIFCOR(I)=DIFCOR(I)+BDELTA(I)
!CCC  PRINT *,'EBIASE: I, DIFCOR(I), BDELTA(I) ',I,DIFCOR(I),BDELTA(I)
 4100 END DO
! COMPUTE NEW RMS
      DENOM=NWTD-NINDEX
      RMS= SQRT(RMS/DENOM)
 4200 CONTINUE
! CHECK FOR CONVERGENCE
      RMSCHK=CONVRG*RMS
      RMSDIF = ABS(RMSPRV-RMS)
      IF(RMSDIF.LE.RMSCHK) NITER=MIN(ITER+1,MITER)
      EDTLVL=EDITX *RMS
!C    WRITE(6,*) 'EBIASE: AFTER 4200  ITER, EDITX, RMS, EDTLVL ',
!C   1                    ITER, EDITX, RMS, EDTLVL
      GO TO 3000
 5000 CONTINUE
      DO 5100 N=1,NM
!CC   IF(LEDIT(N)) EDFLAG(N)=EDTLOC
!CC      IF(LEDIT(N).AND.EDFLAG(N).NE.EDTLOC) EDFLAG(N)=EDTFLG
       TMP_DP = EDFLAG(N)
      IF(LEDIT(N).AND.TMP_CHAR .NE.EDTLOC) THEN
          TMP_CHAR =EDTFLG
          EDFLAG(N)=TMP_DP
      ENDIF
 5100 END DO
!
!     ....DO NORMAL EDIT AFTER LOCAL EDIT
!     ....TO REMOVE OUTLIERS   JJM 7/9/90
!
      DO 5700 N=1,NM
      IF(LEDIT(N)) GO TO 5600
!
!     ....STORE PARTIALS INTO LOCAL ARRAY AND
!     ....SUM PARTIALS*DIFFERENTIAL CORR.
!
      RESCOR=ZERO
      DO 5200 I=1,NINDEX
      BPARTL(I)=PMPE(N,I)
!CCCC PRINT *,'EBIASE: I,BPARTL(I) ', I, BPARTL(I)
      RESCOR=RESCOR+DIFCOR(I)*BPARTL(I)
 5200 END DO
!
!     ....CORRECT LOCAL RESIDUAL, COMPUTE RATIO TO EDITING SIGMA
!     ....EDIT USING E-BIAS LEVEL FOR CURRENT ITERATION
!
      RESDIF = RESID (N)-RESCOR
      RATION=RESDIF / EDTSIG(N)
      IF( ABS(RATION).LE.EBLEVL) GO TO 5700
      LEDIT(N)=.TRUE.
 5600 CONTINUE
!C      IF( EDFLAG(N) .NE. EDTFLG ) EDFLAG(N)=EDTLOC
      TMP_DP = EDFLAG(N)
      IF( TMP_CHAR .NE. EDTFLG ) THEN
        TMP_CHAR =EDTLOC
        EDFLAG(N)=TMP_DP
      ENDIF
 5700 END DO
      RETURN
!
! PERFORM NORMAL RESIDUAL EDIT SO THAT GROSS DATA POINTS ARE NOT
!         USED LATER IN E-BIAS ESTIMATION
!
 6000 CONTINUE
      LBEDIT=.TRUE.
!C    WRITE(6,*) 'EBIASE: AFTER 6000  EBLEVL ',
!C   1                    EBLEVL
      DO 7000 N=1,NM
      IF(LEDIT(N)) GO TO 6500
      RATION=RESID(N)/EDTSIG(N)
      IF( ABS(RATION).LE.EBLEVL) GO TO 7000
      LEDIT(N)=.TRUE.
 6500 CONTINUE
!      IF( EDFLAG(N) .NE. EDTFLG ) EDFLAG(N)=EDTLOC
      TMP_DP = EDFLAG(N)
      IF( TMP_CHAR .NE. EDTFLG ) THEN
        TMP_CHAR =EDTLOC
        EDFLAG(N)=TMP_DP
      ENDIF
 7000 END DO
      RETURN
      END
