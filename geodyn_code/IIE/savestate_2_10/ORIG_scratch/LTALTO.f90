!$LTALTO
      SUBROUTINE LTALTO(AA,II,LL,LNADJJ,MJDSBL,FSECN,FSECM,FSECK,NM,    &
     &                  MTYPE,                                          &
     &                  ISAT,ISET,OBS,XSN,XBM,XSK,VSN,VSK,OFF,THETAG,   &
     &                  COSTHG,SINTHG,OBSMET,OCDRYT,OCWETT,OCIONO,      &
     &                  OTIDES,XSCR,LNPNM,LDIOUT,LXGOUT,PMATT,HOLD,     &
     &                  SSTS,RINDEX,SATLAT,SATLON,SATH,XY2,ZT,RT,RA,    &
     &                  XTRA,ATROT,UTDT,UNQNDX,ETIDES,ISATID,           &
     &                  RLAND)


      USE MSSGFC_MOD
      USE DEMinterpolate, only : interpolate_DEMgrids

      IMPLICIT DOUBLE PRECISION (A-H,O-Z),LOGICAL(L)
      SAVE
      PARAMETER(MDPOR=1000)
      PARAMETER(MAXNM=1000)
      PARAMETER(MXPMPA=10000)
!
      COMMON/ATTCBD/BATPER,ATTPRT
      COMMON/AXIS/LINTAX
      COMMON/BIAOR/NAMBB,NCYCB,NAMBBH
      COMMON/CALTOP/LADYNO,LAGEOO,LRGEOT,LRETDT,LROTDT,LRSSTT,LCOTRM,   &
     &              LFILOT,LATCOR,LFIRIT,LX1ALT,LX2ALT,LMSSWG,LATMOD,   &
     &              LG1BOT,LG1B,LONEG1,LXATTD,LXBEAM,NXALTO
      COMMON/CBIASA/BIASE (4),BIASM (2),BSCALE(1)  ,TBIAS (1),          &
     &              BSTROP(3),BSIONO(3),CLKSTA(4,2),CLKSAT(4,2),        &
     &              CLKSTS(2,2),TROPZE(2,2),TROPGR(2,4),BSLBIA(1)
      COMMON/CBIASI/IEBIAS(4),IMBIAS(2),IBSCAL(1)  ,ITBIAS(1),          &
     &              IBTROP(3),IBIONO(3),KLKSTA(4,2),KLKSAT(4,2),        &
     &              KLKSTS(2,2),ITRPZE(2,2),ITRPGR(2,4),IBSBIA(1)
      COMMON/CBINRL/LBINR,LLOCR,LODR,LBNCR,LBINRI,LLOCRI,LODRI,LBNCRI,  &
     &              NXCBIN
      COMMON/CBLOKA/FSECBL,SIGNL ,VLITEC,SECEND,BLKDAT(6,4),DOPSCL(5,4)
      COMMON/CBLOKL/LIGHT ,LNRATE,LNREFR,LPOLAD,LTDRIV,LNANT ,LNTRAK,   &
     &       LASER ,LGPART,LGEOID,LETIDE,LOTIDE,LNTIME,LAVGRR,LRANGE,   &
     &       LSSTMD,LSSTAJ,LNTDRS,LPSBL,LACC,LAPP,LTARG,LTIEOU,LEOTRM,  &
     &       LSURFM,LGEOI2,LSSTM2,LOTID2,LOTRM2,LETID2,LNUTAD
      COMMON/CEBODY/APL(11),APLSQ,FINVPL(11),FGP,EGSQP,EGSQPP,C1P,C2P,  &
     &              FOURCP,TWOC2P,WREFP(11),RPMEAN,RFPC20,              &
     &              RFPC40,RFPC60,BEGP,CBLTCP,                          &
     &              WAE2P,GAMMAP,FSTARP,F4P
      COMMON/CGRAV/GM,AE,AESQ,FE,FFSQ32,FSQ32,XK2,XK3,XLAM,SIGXK2,      &
     &      SIGXK3,SIGLAM,RATIOM(2),AU,RPRESS
      COMMON/CINTI/IBACK ,IBACKV,IORDER,IORDRV,NOSTEP,NOCORR,           &
     &      NSAT  ,N3    ,NEQN  ,NEQN3 ,NH    ,NHV   ,NSTEPS,           &
     &      NSTEPV,ICPP  ,ICPV  ,ICCP  ,ICCV  ,ICCPV ,ICCVV ,           &
     &      ISUMX ,IXDDOT,ISUMPX,IPXDDT
      COMMON/CITER /NINNER,NARC,NGLOBL
      COMMON/CITERL/LSTGLB,LSTARC,LSTINR,LNADJ ,LITER1,LSTITR,          &
     &              LOBORB,LRESID,LFREEZ,LSAVEF,LHALT,LADJPI,LADJCI
      COMMON/CKOUNT/KNTBLK,KSEGMN,KNTOBS,KZROBS
      COMMON/CLIGHT/VLIGHT,ERRLIM,XCLITE
      COMMON/CMET/P0,T0,RELHUM,E0,WAVLEN
      COMMON/CNIGLO/MINTIM,MSATG3,MEQNG ,MEQNG3,MSATG ,MSATOB,MSATA ,   &
     &              MSATA3,MSETA ,MINTVL,MSORDR,MSORDV,NMXORD,          &
     &       MCIPV ,MXBACK,MXI   ,MPXPF ,MAXAB ,MSETDG,MXSATD,          &
     &       MXDEGS,MXDRP ,MXDRPA,MXSRP ,MXSRPA,MXGAP ,MSATDR,          &
     &       MSATSR,MSATGA,MXDRPD,MXSRPD,MXGAPD,MXBCKP,MXTPMS,          &
     &       NSTAIN,NXCNIG
      COMMON/CONSTR/PI,TWOPI,DEGRAD,SECRAD,SECDAY
      COMMON/CORA01/KFSEC0,KFSECB,KFSEC ,KFSECV,KH    ,KHV   ,KCTOL ,   &
     &              KRSQ  ,KVMATX,KCPP  ,KCPV  ,KCCP  ,KCCV  ,KCCPV ,   &
     &              KCCVV ,KXPPPP,KX    ,KPX   ,KSUMX ,KXDDOT,KSUMPX,   &
     &              KPXDDT,KAB   ,KPN   ,KAORN ,KSINLM,KCOSLM,KTANPS,   &
     &              KCRPAR,KVRARY,KXM   ,KXNP1 ,KXPRFL,KXM2  ,KXNNP1,   &
     &              KWRK  ,KFI   ,KGE   ,KB0DRG,KBDRAG,KAPGM ,KAPLM ,   &
     &              KCN   ,KSN   ,KSTID ,KTIDE ,KSTDRG,KSTSRD,KSTACC,   &
     &              KLGRAV,KGM   ,KAE   ,KFPL  ,KFEQ  ,KPLNPO,KPLNVL,   &
     &              KXEPOC,KCD   ,KCDDOT,KCR   ,KGENAC,KACN  ,KASN  ,   &
     &              KTHDRG,KCKEP ,KCKEPN,KXNRMZ,KXNRMC,KFSCEP,KFSCND,   &
     &              KAREA ,KXMASS,KRMSPO,KTCOEF,KTXQQ ,KTIEXP,KTXMM ,   &
     &              KTXLL1,KTXSN1,KTS2QQ,KT2M2H,KT2MHJ,KTXKK ,KTSCRH,   &
     &              KPXPK ,KAESHD,KCSAVE,KSSAVE,KCGRVT,KSGRVT,KXDTMC,   &
     &              KDNLT ,KTXSN2,KTNORM,KTWRK1,KTWRK2,KUNORM,KAERLG,   &
     &              KSINCO,KPARLG,KCONST,KBFNRM,KTDNRM,KCSTHT,KTPSTR,   &
     &              KTPSTP,KTPFYW,KPLMGM,KTPXAT,KEAQAT,KEAFSS,KEAINS,   &
     &              KACS  ,KECS  ,KSOLNA,KSOLNE,KSVECT,KSFLUX,KFACTX,   &
     &              KFACTY,KADIST,KGEOAN,KPALB ,KALBCO,KEMMCO,KCNAUX,   &
     &              KSNAUX,KPPER ,KACOSW,KBSINW,KACOFW,KBCOFW,KANGWT,   &
     &              KWT   ,KPLNDX,KPLANC,KTGACC,KTGDRG,KTGSLR,KWTACC,   &
     &              KWTDRG,KWTSLR,KTMACC,KTMDRG,KTMSLR,KATTUD,KDYACT,   &
     &              KACCBT,KACPER,KXDDNC,KXDDAO,KXNC  ,KXPPNC,KSMXNC,   &
     &              KXDDTH,KPDDTH,KXSSBS,KCPPNC,KEXACT,KXACIN,KXACOB,   &
     &              KPXHDT,KTPXTH,KPACCL,KTXSTA,KDELXS,KSMRNC,KPRX  ,   &
     &              KSMRNP,KDSROT,KXUGRD,KYUGRD,KZUGRD,KSUMRC,KXDDRC,   &
     &              KTMOS0,KTMOS, KTMOSP,KSMXOS,KSGTM1,KSGTM2,KSMPNS,   &
     &              KXGGRD,KYGGRD,KZGGRD,KXEGRD,KYEGRD,KZEGRD,KSSDST,   &
     &              KSDINS,KSDIND,KSSDSR,KSSDDG,KTATHM,KTAINS,KTAFSS,   &
     &              KSRAT ,KTRAT ,KHLDV ,KHLDA1,KHLDA4,KHLDA7,KQAST1,   &
     &              KQAST2,KQAST3,KQAST4,KQAST5,KQAST6,NXCA01
      COMMON/CORA02/KFSCTB,KFSCTC,KFSCTE,KDSECT,                        &
     &              KFSECT,KS    ,KCIP  ,KCIV  ,                        &
     &       KXTN  ,KXSM  ,KXTK  ,KXSJ  ,KXTI  ,KXTKP ,                 &
     &       KVTN  ,KVSM  ,KVTK  ,KVSJ  ,KVTI  ,KVTKP ,                 &
     &       KSATLT,KSATLN,KSATH ,KCOSTH,KSINTH,                        &
     &       KPXPFM,KPXPFK,KPXPFJ,KTRBF ,KFSTRC,                        &
     &       KFSTRE,KDSCTR,KFSCVS,KXSMBF,KXSKBF,KXSJBF,                 &
     &       KRSSV1,KRSSV2,KRSSV3,KTPMES,KACOEF,KACTIM,                 &
     &       KXTNPC,KXSMPC,KXTKPC,KXSJPC,KXTIPC,KXTKPP,                 &
     &       KRLRNG,KASTO,KASTP,NXCA02
      COMMON/CORA03/KRFMT ,KROTMT,KSRTCH,KCFSC ,KTHG  ,KCOSTG,KSINTG,   &
     &              KDPSI ,KEPST ,KEPSM ,KETA  ,KZTA  ,KTHTA ,KEQN  ,   &
     &              KDPSR ,KSL   ,KH2   ,KL2   ,KXPUT ,KYPUT ,KUT   ,   &
     &              KSPCRD,KSPSIG,KSTAIN,KSXYZ ,KSPWT ,KDXSDP,KDPSDP,   &
     &              KXLOCV,KSTNAM,KA1UT ,KPLTIN,KPLTVL,KPLTDV,KPUTBH,   &
     &              KABCOF,KSPEED,KANGFC,KSCROL,KSTVEL,KSTVDV,KTIMVL,   &
     &              KSTEL2,KSTEH2,KSL2DV,KSH2DV,                        &
     &              KAPRES, KASCAL, KASOFF,KXDOTP,KSAVST,               &
     &              KANGT , KSPDT , KCONAM,KGRDAN,KUANG ,KFAMP ,        &
     &              KOFACT, KOTSGN,KWRKRS,KANFSD,KSPDSD,KPRMFS,KSCRFR,  &
     &              KCOSAS,KSINAS,KDXTID,KALCOF,KSTANF,KNUTIN,KNUTMD,   &
     &              KPDPSI,KPEPST,KDXDNU,KDPSIE,KEPSTE,NXCA03
      COMMON/CORA04/KABIAS,KABSTR,KABSTP,KCBIAS,KCBSTR,KCBSTP,          &
     &       KRNM  ,KRKM  ,KRKJ  ,KRIJ  ,KRKPM ,                        &
     &       KRRNM ,KRRKM ,KRRKJ ,KRRIJ ,KRRKPM,                        &
     &       KURNM ,KURKM ,KURKJ ,KURIJ ,KURKPM,                        &
     &       KPRRNM,KPRRKM,KPRRKJ,KPRRIJ,KPRRKP,                        &
     &       KPMPXI,KPMPXE,KRA   ,KRELV ,KUHAT ,KWORK ,KTMPCR,KU    ,   &
     &       KS0   ,KS1   ,KXTP  ,KPXSXP,KPXDXP,KXUTDT,KRPOLE,KPXPOL,   &
     &       KXDPOL,KOBBUF,KOBSC ,KRESID,KSIGMA,KRATIO,KELEVS,          &
     &       KPMPA ,KPXSLV,KTPRTL,                                      &
     &       KFRQOF,KXYZOF,KFRQST,KFRQSA,KSTDLY,KSADLY,KXYZCG,KSCMRA,   &
     &       KEBVAL,KEBSIG,KEBNAM,KBTWB ,KTBTWA,KBTWD ,KPMPE ,          &
     &       KFSEB1,KFSEB2,KSTAMT,KPXSPA,KDIAGN,KOBOUT,KGRLT1,KGRLT2,   &
     &       KGRLT3,KGRLT4,KGRLT5,KPSTAT,KRSUNS,KCHEMR,KCHMOR,KEPOSR,   &
     &       KCHEMT,KCHMOT,KEPOST,KCHCBS,KCPOSS,KSCRTM,KXSTT ,KXSTR ,   &
     &       KXSS  ,KRANGT,KRANGR,KCHB1 ,KCHB2 ,KCHBV1,KCHBV2,KCHEB ,   &
     &       KSSTFQ,KSSTCC,KSSTSS,KSSTWT,KRLCOR,KWVLBI,KQUINF,KBRTS ,   &
     &       KBRTSV,KLRARC,KXEPBF,KXEPBR,KPRCBD,KPRTBD,KXPMPA,KXL,      &
     &       KXSIG ,KXEDTS,KXALO1,KXALO2,KXYOF2,KDLATF,KDLATS,KDLONF,   &
     &       KDLONS,KPF   ,KPS   ,                                      &
     &       KXOBSV,KXOBSW,KXEDSW,                                      &
     &       KXSIGW,KPSF  ,KDNUM ,KCNUM ,KFCOR ,KCOSAR,KSINAR,KSABIA,   &
     &       KSBTM1,KSBTM2,KYAWBS,KVLOUV,KACMAG,KOBSTR,                 &
     &       KPRL1 ,KPRL2, KRL1  ,KT1SE ,KTCP  ,                        &
     &       KRATDR,KFQT1S,KFQT1E,KT1STR,KFTTSE,KFRSTR,KFRRAT,KSV1  ,   &
     &       KSV2  ,KTSLOV,                                             &
     &       KGLGR1,KGLGR2,KGLFR1,KGLFR2,                               &
     &       KARGR1,KARGR2,KARFR1,KARFR2,                               &
     &       KRDS1L,KFT1AV,KDFQP ,KFREQ1,KFREQ3,KSAVD1,KSAVD2,          &
     &       KANTOU,KFM3CF,KF2CF,KTMG,KLTMG,KX2TIM,KX2OBS,KXRNDX,KX2SCR,&
     &       KALTWV,KXXBM ,KX2PAR,KATIME,KPMPAT,KPMATT,KX2PAT,          &
     &       KPXEXI,KPXEPA,KPV,KPXEP2,KX2COF,KACOF2,KACOF3,KBCOF,KBCOF2,&
     &       KDDDA ,KX2AUX,KX2VPR,KX2VPA,KEXTRA,KVARAY,KATROT,KATPER,   &
     &       KLTAR ,KXHOLD,KANTBL,KPHC  ,KOFDRV,KGNAME,KGRSIZ,KGRCNT,   &
     &       KGRDAT,KACCDT,KCTBTI,KCTBWE,KCTCTM,KANTUV,KANTOR,KW1PU ,   &
     &       KPYSQH,KSIGSP,KXYOF3,KXVTM1,KXDIST,KXDST0,KTMSE ,KDSDP ,   &
     &       KEXCST,KEXCDT,KEXCGX,KEXCGY,KEXCGZ,KIMNDX,KIMOBS,KIMTIM,   &
     &       KIMSAT,KM2VPA,KDCDD ,KDWNWT,KDPOR ,KC2PAR,KBOUNC,KBPART,   &
     &       NXCA04
      COMMON/CORA06/KPRMV ,KPNAME,KPRMV0,KPRMVC,KPRMVP,KPRMSG,KPARVR,   &
     &              KPRML0,KPDLTA,KSATCV,KSTACV,KPOLCV,KTIDCV,KSUM1 ,   &
     &              KSUM2 ,KGPNRA,KGPNRM,KPRSG0,KCONDN,KVELCV,          &
     &              KSL2CV,KSH2CV,KTIEOU,KPRMDF,NXCA06
      COMMON/CORI01/KMJDS0,KMJDSB,KMJDSC,KMJDSV,KIBACK,KIBAKV,KIORDR,   &
     &              KIORDV,KNOSTP,KNOCOR,KNSAT ,KN3   ,KNEQN ,KNEQN3,   &
     &              KNH   ,KNHV  ,KNSTPS,KNSTPV,KICPP ,KICPV ,KICCP ,   &
     &              KICCV ,KICCPV,KICCVV,KISUMX,KIXDDT,KISMPX,KIPXDD,   &
     &              KNMAX ,KNTOLD,KNTOLO,KICNT ,KISNT ,KMM   ,KKK   ,   &
     &              KJJ   ,KHH   ,KIBDY ,KSIGN1,KSIGN2,KLL   ,KQQ   ,   &
     &              KIORFR,KIPDFR,KITACC,KJSAFR,KJSPFR,KMJDEP,KMJDND,   &
     &              KNVSTP,KNSTRN,KNDARK,KTIPPT,KTJBDY,                 &
     &              KICNTA,KISNTA,KISHDP,KIPTC ,KIPTS ,KIGTSR,KIXTMC,   &
     &              KTIPTT,KTNOSD,KTQNDX,KTLL1 ,KTJJBD,KTITDE,KTCNTR,   &
     &              KTNN  ,KITACX,KNMOVE,KPANEL,KPLPTR,KNADAR,KNADSP,   &
     &              KNADDF,KNADEM,KNADTA,KNADTC,KNADTD,KNADTF,KNADTX,   &
     &              KITPMD,KSCATT,KITPAT,KILTPX,KEASBJ,KEANMP,KEANAN,   &
     &              KEAPMP,KEAPAN,KEAMJS,KEAPPP,KEAAAA,KICNTT,KISNTT,   &
     &              KTPGRC,KTPGRS,KTPC  ,KTPS  ,KALCAP,KEMCAP,KNSEG ,   &
     &              KICNTP,KISNTP,KNRDGA,KNRDDR,KNRDSR,KIRDGA,KIRDRG,   &
     &              KIRSLR,KSTRTA,KSTRTD,KSTRTS,KDYNPE,KACCPE,KIBCKN,   &
     &              KNRAT ,KIXDDN,KISMXN,KDXDDN,KDSMXN,KICPPN,KACSID,   &
     &              KNEQNH,KHRFRC,KPTFBS,KPTFSB,KIPXDA,KIACCP,KXSTAT,   &
     &              KPXST ,KSALST,KMAPLG,KNMBUF,KSTEPS,KSGMNT,KSATIN,   &
     &              KMEMST,KNEQNI,KBUFIN,KWEMGA,KWEMDR,KTPATS,KTANMP,   &
     &              KTAPPP,KTAMJS,KTASID,KGPSID,KNSSVA,KPNALB,KBRAX1,   &
     &              KBRAX2,KBRAX3,NXCI01
      COMMON/CORI02/KNTIME,KMJSTB,KMJSTC,KMJSTE,KISECT,                 &
     &              KINDH ,KNMH  ,KIVSAT,KIPXPF,KNTRTM,KMSTRC,          &
     &              KMSTRE,KISCTR,KISATR,KITRUN,KTRTMB,KTRTMC,          &
     &              KMJDVS,KNTMVM,NXCI02
      COMMON/CORI03/KICRD ,KICON ,KISTNO,KINDPI,KMJDPL,KIPOLC,          &
     &              KNDOLA,KIOLPA,KKIOLA,KIP0OL,KNDOLM,KIOLPM,          &
     &              KKIOLM,KIPVOL,KICNL2,KICNH2,                        &
     &              KSTMJD, KNUMST, KITAST, KSTNRD, KICNV,              &
     &              KTIDES,KFODEG,KFOORD,KRDEGR,KRORDR,                 &
     &              KPHINC,KDOODS,KOTFLG,KJDN  ,KPTDN ,                 &
     &              KATIND,KPRESP,KMP2RS,KSITE,KPTOLS,NXCI03
      COMMON/CORI04/KNMP  ,KINDP ,KNDPAR,KNPVCT,KISATN,KISET ,KIANTO,   &
     &              KISATO,KIANTD,KISATD,KISTAD,KISATC,KMJDCG,KISTAT,   &
     &              KMJDEB,KMJDBN,KNDBIN,KNWTDB,KIXPAR,KNDBUF,KSSTNM,   &
     &              KSSTNA,KMBSAT,KMBSTA,KXKEY ,KXVKEY,KXFLAG,KIPNTF,   &
     &              KIPNTS,KNCON ,KKF   ,KIDATB,KNSTLV,KSLVID,KLLBIA,   &
     &              KTMRA1,KTMRA2,KIND1 ,KTARID,KATARD,KYAWID,KXOBLK,   &
     &              KDSCWV,KATRSQ,KATSAT,KKVLAS,KPARTP,KLTMSC,KLTASC,   &
     &              KCTBST,KSTBST,KANCUT,KANGPS,KANTYP,                 &
     &              KANTOF,                                             &
     &              KYSAT, KMBDEG,                                      &
     &              KMBNOD,KMBSST,KBSPLN,KSSPLN,KXIOBS,KIDLAS,KIAVP ,   &
     &              KXNAVP,KNEXCG,KIDEXC,KNREXC,KTELEO,KIKEY ,KIMKEY,   &
     &              KIMBLK,KIMPRT,KCN110,KCN111,KC110,KC111,KTDSAT,     &
     &              KTDANT,NXCI04
      COMMON/CORI06/KPTRAU,KPTRUA,KNFMG ,KIPTFM,KILNFM,KIGPC ,          &
     &              KIGPS ,KIGPCA,KIGPSA,KIELMT,KMFMG ,KTPGPC,          &
     &              KTPGPS,KTPUC ,KTPUS,                                &
     &              KLINK,KPTFAU,KPTFUA,NXCI06
      COMMON/CORL01/KLORBT,KLORBV,KLNDRG,KLBAKW,KLSETS,KLAFRC,KLSTSN,   &
     &              KLSNLT,KLAJDP,KLAJSP,KLAJGP,KLTPAT,KEALQT,KLRDGA,   &
     &              KLRDDR,KLRDSR,KFHIRT,KLSURF,KHRFON,KLTPXH,KSETDN,   &
     &              KTALTA,NXCL01
      COMMON/CORL02/KLNDTT,KLWSTR,KLNDTR,KLEVMF,KLTPMS,NXCL02
      COMMON/CPRESW/LPRE9 (24),LPRE  (24,3),LSWTCH(10,8),LOBSIN,LPREPW, &
     &              LFS   (40)
      COMMON/CREFMT/REFMT(9)
      COMMON/DPLNOR/DXGEO1,DXGEO2,DXFRC1,DXFRC2,XPLNOR
      COMMON/DTMGDN/TGTYMD,TMGDN1,TMGDN2,REPDIF,XTMGN
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999),    &
     &              IBDPF(999),                                     &
     &              ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,             &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/ION2EL/LIONC,LFRQOP,LFRQOF,NXIONL
      COMMON/IONO2E/IONNDX(12),IONRZ(12),IONOYM(12),IONYMS,IONYME,IURSI,&
     &              INTERP,NXIONO
      COMMON/LALTPT/LNQT
      COMMON/LOLOAD/LOLMD,LOLAJ,L2FOLT,LAPLOD
      COMMON/MREFDT/DMESRF,RMESRF,XMREF
      COMMON/MULTDM/MLTDEM,MEMDEM,NXMDEM
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/OLDADJ/NPV0OL(3,3),JPV0OL(3,3),NYZ0OL(3,3),JYZ0OL(3,3),    &
     &              NEO0OL(3,3),JEO0OL(3,3)
      COMMON/OLOADA/LXYZCO,LEOPTO
      COMMON/POLESW/LDNPOL,NXPOLS
! DEC_0, W_0, RA_t_0, DEC_t_0, and W_t_0 (DO0DA0)
      COMMON/PORINF/PLOR(228,2),DO0DA0(12,6,2)
!...End TJS
      COMMON/UNITS/IUNT11,IUNT12,IUNT13,IUNT19,IUNT30,IUNT71,IUNT72,    &
     &             IUNT73,IUNT05,IUNT14,IUNT65,IUNT88,IUNT21,IUNT22,    &
     &             IUNT23,IUNT24,IUNT25,IUNT26
      COMMON/XOVER /KXKNT,KXBST,KXOBL,KXBUP,KXBPA,IAPLSC,IAPLL
      COMMON/XOVER2/KAPSCL
      COMMON/XOVERS/NRXTOT,NXBLK,NUSIDE,NDEGX2,NDEGXX,NUCON,ITERNU,     &
     &              IPEDIT,IDEDIT,NXXOVR
      COMMON/XPCNT /NXTRAC,NXFLAG,NXALLC,NCPPER,NMINRT,NDPOR,NXXTRA
      COMMON/IOS/ISTOS1,ISTOS2,ISTOS3,ISTLST,INTSUB(3),JNTSUB(3),      &
     &        ILSTSG(80),INTOSP,MAPSAT(3,4)

      DIMENSION AA(1),II(1),LL(1),FSECN(NM),FSECM(NM),FSECK(NM),OBS(NM)
      DIMENSION COSTHG(NM),SINTHG(NM),THETAG(NM)
      DIMENSION XSN(MINTIM,3),XBM(MINTIM,3),XSK(MINTIM,3)
! VSN,VBM,VSK,VSJ,VSI,VSKP ARE USED AS SCRATCH LUMPED INTO VSN
! pd %%%%%% note: major changes to VSN array for
! VSKP HAS 2 EXTRA MINTIMS AT THE END OF IT (SEE KORC02 & KORP02)
      DIMENSION VSN(MINTIM,20)
      DIMENSION VSK(MINTIM,3)
! XTRA SPACE ; *,29 is FSECNN; *,30 is FSECKK
!              *,23 is COROBS; *,24 is XPTH; *,25 is ELPSEC
!              *,31 is ROLL; *,32 is PITCH; *,33 is YAW
      DIMENSION XTRA(MINTIM,33)
! OFF IS XSJ
      DIMENSION OFF(MINTIM,3)
      DIMENSION OBSMET(NM),OCDRYT(NM),OCWETT(NM),OCIONO(NM)
      DIMENSION OTIDES(NM),ETIDES(NM)
      DIMENSION PMATT(NUCON,3,20)
      DIMENSION RINDEX(NXBLK,3)
! PMATT IS USED FOR PARTIALS OF THE BOUNCE POINT  WRT TO VARIOUS PARAMET
! (UP TO 20) THE FIRST 3 ARE USED FOR ATTITUDE ANGLES (ROLL PITCH AND YA
      DIMENSION XSCR(3,MINTIM)
      DIMENSION HOLD(MINTIM,30)
      DIMENSION SSTS(NM)
      DIMENSION SPF(9),XTOR(3),YTOR(3),ZTOR(3),QUAT(4),ROT(3,3)
      DIMENSION CIN(3),XYZECF(3,1)
      DIMENSION X1(3),X2(3),RA(NM,3)
      DIMENSION SATLAT(NM),SATLON(NM),SATH(NM),XY2(NM),ZT(NM),RT(NM)
      DIMENSION ATROT(3,3,MINTIM),XPQ(3),VPQ(3),QSBFJ2(4)
      DIMENSION UTDT(NM,4)
      DIMENSION UNQNDX(NM),RLAND(NM)
      DIMENSION DUM(3),DUM1(3,2,1)
      DOUBLE PRECISION :: DADA0(3,6),DADIC(3,6)
      DIMENSION LAVDUM(30),DUMQ(1)
!
!!!      DOUBLE PRECISION, ALLOCATABLE :: XR(:)
!!!      DOUBLE PRECISION, ALLOCATABLE :: PPOR(:,:,:)
!!!      DOUBLE PRECISION, ALLOCATABLE :: PMPA(:,:,:)
!
      DIMENSION XR(1000)
      DIMENSION PPOR(3,3,1000)
      DIMENSION PMPA(10000)
!
!***********************************************************************
! START OF EXECUTABLE CODE
!***********************************************************************
!
!      print *,'ltalto: lfilot,ldiout,lxgout: ',lfilot,ldiout,lxgout

!
!
! Initialize
!
      LMLTDEM=.FALSE.
      IF(MLTDEM.EQ.1) LMLTDEM=.TRUE.
      LIND1=NUCON.EQ.NM
      IF(NINTOT.GT.0) THEN
      IF(INTOSP.EQ.0) INTOSP=1
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF


!
      IF(LINTAX) THEN
        IF(NDPOR.GT.MDPOR) THEN
          WRITE(6,6002) NDPOR,MDPOR
          STOP
        ENDIF
        IF(NM.GT.MAXNM) THEN
          WRITE(6,6003) NM,MAXNM
          STOP
        ENDIF
        NTEST=NXTRAC*3*NM
        IF(NTEST.GT.MXPMPA) THEN
          WRITE(6,6004) NXTRAC,NM
          WRITE(6,6004) MXPMPA,NTEST
          STOP
        ENDIF
      ENDIF
!
!
! Initialize
!
      LIND1=NUCON.EQ.NM
      IF(NINTOT.GT.0) THEN
      IF(INTOSP.EQ.0) INTOSP=1
      CALL FNDNUM(ISATID,II(KSATIN),NINTOT,IRET)
      IF(IRET.GT.0) THEN
      KNSTEPS=II(KSTEPS-1+IRET)
      NEQNI=II(KNEQNI-1+IRET)
      ENDIF
      ENDIF

      CALL ORBSET(II(KNSAT),II(KIVSAT),LL(KLSETS),ISAT,                 &
     &   KNSTEPS,NEQNI,II(KSGMNT-1+IRET),                               &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),IRET,MJDSBL,FSECK(1),      &
     &   FSECK(NM),NM,AA,II)
!
!
! SIMPLE MEASURMENT BIAS
      BIASX=0
      IF(IMBIAS(1).GT.0) BIASX=BIASM(1)
! INDIVIDUAL LASER BIAS IS ADDITIVE
      NUMD=NPVAL(IXANTD)
      IPTLB=0
      IPTLB0=0
      IF(NUMD.GT.0) THEN
        IANT=BLKDAT(4,1)
        INTR=IANT/10
        INTT=IANT-(INTR*10)
        IPTLB0=0
        IF(INTT.GT.0) THEN
          DO IAD=1,NUMD
            IPT=IPVAL(IXANTD)+IAD-1
            IF(ISATID.EQ.II(KTDSAT-1+IAD)) THEN
              ITEST=II(KTDANT-1+IAD)-50
              IF(INTT.EQ.ITEST) THEN
               IPTLB=IPT
              ENDIF
            ENDIF
          ENDDO
          IF(IPTLB.GT.0) THEN
! BIAS FOR LASER IDENTIFIED
            BIASX=BIASX+AA(KPRMV-1+IPTLB)
            IPTLB0=II(KPTRUA-1+IPTLB)
          ENDIF
          IF(.NOT.LSTINR) IPTLB0=0
! ENDIF : IF(INTT.GT.0) THEN
        ENDIF
! ENDIF : IF(NUMD.GT.0) THEN
      ENDIF
!
! END OF SIMPLE MEAS BIAS
!
!
!
! OBSERVATION TIMING BIAS
      TTGO0=0.D0
      IPTOTB=0
      IF(KLKSTA(1,2).GT.0) THEN
          TTGO0=CLKSTA(1,2)
          IPTOTB=KLKSTA(1,2)
      ELSE
          IF(ITBIAS(1).GT.0) THEN
             TTGO0=TBIAS(1)
             IPTOTB=ITBIAS(1)
          ENDIF
      ENDIF
! ATTITUDE TIMING BIAS
      TTGA0=0.D0
      IPTATB=0
      IF(KLKSTA(1,1).GT.0) THEN
          TTGA0=CLKSTA(1,1)
          IPTATB=KLKSTA(1,1)
      ENDIF
!
      NUMIT=0
      ITAT1=-1
      ITAT3=-1
      ITTT1=-1
      ITTT2=-1
      ITOR1=-1
      ITOR3=-1
      ISTRT=2
      IF(IAPLSC.GT.0.AND.NINNER.GT.ITERNU) THEN
         NUMIT=NUMIT+3
         ITAT1=ISTRT
         ITAT3=ITAT1+2
         ISTRT=ISTRT+3
      ENDIF
      IF(IPTOTB.GT.0.AND.NINNER.GT.ITERNU) THEN
         NUMIT=NUMIT+1
         ITTT1=ISTRT
         ISTRT=ISTRT+1
      ENDIF
      IF(IPTATB.GT.0.AND.NINNER.GT.ITERNU) THEN
         NUMIT=NUMIT+1
         ITTT2=ISTRT
         ISTRT=ISTRT+1
      ENDIF
      IF(LSTINR.AND.NPVAL0(IXXTRO).GT.0) THEN
         NUMIT=NUMIT+3
         ITOR1=ISTRT
         ITOR3=ITOR1+2
         ISTRT=ISTRT+3
      ENDIF
      LNUMIT=LX2ALT.AND.NUMIT.GT.0
      LNADJX=.TRUE.
      IF(LNUMIT) THEN
        NUMIT=NUMIT+2
      ELSE
        NUMIT=1
      ENDIF
!
      ITERP=0
      KIT=0
   40 CONTINUE
      JOR=0
      KIT=KIT+1

!      print *,'ltalto: after 40 KIT,numit: ',kit,numit

      LAST=.FALSE.
      IF(KIT.EQ.NUMIT) LAST=.TRUE.

!      print *,'ltalto: LAST: ',last,KIT,NUMIT

      LNADJY=LNADJJ
      IF(.NOT.LAST.OR.(NINNER.LE.ITERNU)) LNADJY=.TRUE.
      JTERP=0
!!!   IF(KIT.GE.ITAT1.AND.KIT.LE.ITAT3) JTERP=ITERP
! THE ADDITION OF THREE IS SO PARTIALS WILL BE FOR LASER
! AS OPPOSED TO SC BODY. THERE IS ONLT SPACE IN PMATT FOR
! SC OR LASER AND NOT BOTH. TO MAKE THE PARTIALS FOR THE
! SC BODY ; JTERP=ITERP
      IF(KIT.GE.ITAT1.AND.KIT.LE.ITAT3.AND.ITERP.GT.0) JTERP=ITERP+3
      TTG=TTGO0
      IF(KIT.EQ.ITTT1) TTG=TTG+.05D0
      TTA=TTGA0
      IF(KIT.EQ.ITTT2) TTA=TTA+.05D0
      IF(KIT.GE.ITOR1.AND.KIT.LE.ITOR3) THEN
         JOR=1+KIT-ITOR1
         IF(KIT.EQ.ITOR1.AND.LINTAX) THEN
!!!            ALLOCATE(XR(NDPOR))
!!!            ALLOCATE(PPOR(3,3,NM))
!!!            ALLOCATE(PMPA(NXTRAC,3,NM))
            NZ=NXTRAC*3*NM
            DO IQP=1,NZ
!!!              PMPA(IQP,1,1)=0.D0
              PMPA(IQP)=0.D0
            ENDDO
         ENDIF
      ENDIF

!      print *,'ltalto: TTGO0,TTGA0: ',TTGO0,TTGA0
!
!    The Time Tag / Position Key (yes this is correct)
!
!     FSECN  - receive time
!     XSK    - receive position
!     FSECK  - transmit time
!     XSN    - transmit position
!
! SET ZERO OBSERVATIONS TO 100.00 METERS
! GET TRANSMIT TIME
!
!
! DEP
      DO I=1,NM
! IF TAGED AS TRANSMIT
!!!!!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7
!!!!!    IF(LXBEAM) XTRA(I,29)=FSECN(I)+2.D0*ABS(OBS(I))/VLIGHT+TTG
         XTRA(I,29)=FSECN(I)+2.D0*ABS(OBS(I))/VLIGHT+TTG
!!!!!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7
! IF TAGED AS BOUNCE
! DEP
!         XTRA(I,29)=FSECK(I)+1.D0*ABS(OBS(I))/VLIGHT+TTG
! IF TAGED AS RECEIVE
! RECEIVE TIME
         IF(.NOT.LXBEAM) XTRA(I,29)=FSECN(I)+TTG
         IF(MTYPE.EQ.110.OR.MTYPE.EQ.111) XTRA(I,29)=FSECN(I)+TTG

         IF(OBS(I).EQ.0.D0) THEN
            OBS(I) = 100.D0
            KZROBS = KZROBS + 1
         END IF
!        FSECK(I)=XTRA(I,29)-2.D0*ABS(OBS(I))/VLIGHT
! DEP
! TRANSMIT TIME
!         FSECK(I)=XTRA(I,29)-ABS(OBS(I))/VLIGHT
!         IF(MTYPE.EQ.110.OR.MTYPE.EQ.111) XTRA(I,30)=FSECK(I)+TTA
        FSECK(I)=XTRA(I,29)-ABS(OBS(I))/VLIGHT
        IF(LX2ALT) FSECK(I)=XTRA(I,29)-2.D0*ABS(OBS(I))/VLIGHT
!!!!!   IF(MTYPE.EQ.110.OR.MTYPE.EQ.111) XTRA(I,30)=FSECK(I)+TTA
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7&
        FSECK(I)=FSECN(I)
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7&
        XTRA(I,30)=FSECK(I)+TTA
      ENDDO

!      print *,'ltalto: TTA,TTG: ',TTA,TTG
!
!
!   GET TRUE OF REF POSITION OF SATELLITE AT ALTIM TRANSMIT

      IF(NINTOT.GT.0) THEN
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      ENDIF
      ENDIF

!
!      write(6,*)' dbg CALLING ORBIT TRANSMIT '
      CALL ORBIT(MJDSBL,FSECK,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),  &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSN,AA(KPXPFM),              &
     &   LNADJX,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),               &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)


!      print *,''
!      print *,'ltalto: mjdsbl,fseck(1): ',mjdsbl,fseck(1)
!      print *,'ltalto: xsn1: ',xsn(1,1),xsn(1,2),xsn(1,3)
!      xxxmag=sqrt(xsn(1,1)**2+xsn(1,2)**2+xsn(1,3)**2)
!      print *,'ltalto: xxxmag1: ',xxxmag
!      print *,'ltalto: mjdsbl,fseck(nm): ',mjdsbl,fseck(nm)
!      print *,'ltalto: xsnnm: ',xsn(nm,1),xsn(nm,2),xsn(nm,3)
!      xxxmag=sqrt(xsn(nm,1)**2+xsn(nm,2)**2+xsn(nm,3)**2)
!      print *,'ltalto: xxxmagnm: ',xxxmag
!      print *,''
!
!   GET TRUE OF REF UNIT POINTING VECTOR FOR ALTIMETER AT TRANSMIT
!   TIME AND THE TRUE OF REF OFFSET VECTOR FROM THE CENTER OF
!   MASS TO THE ALTIMETER TRACKING POINT. THE FOLLOWING
!   APPROXIMATIONS AND ASSUMPTIONS ARE MADE:
!
!   1) TRACKING POINT OFFSET COMPUTED AT RECEIVE VALID AT TRANSMIT
!   2) ALTIMTER ALLIGNED TO Z AXIS OF SPACECRAFT
!
!
!   XTRA(*,4-6) IS THE TRACKING POINT OFFSET FOR BOTH SIDES TOR
!   OFF IS THE UNIT VECTOR OF ALTIMTER ORIENTATION IN TOR
!   XTRA(*,7-20) IS SCRATCH SPACE
!
      LNQT=.FALSE.
!      CALL SATUPD(MJDSBL,FSECK,XSN,XBM,AA,NM,MINTIM,.TRUE.,.FALSE.,II, &
!     &            0,1)
!      print *,'ltalto: before altpt transmit'
!      write(6,*)' dbg CALLING ALTPT TRANSMIT '
!
! LTALTO CAN ONLY LOAD SC BODY ATITUDE PARTIALS OR LASER
! NEXT TWO LINES GET PARTIALS FOR WHICHEVER HAS LOOSER SIGMA
!
      JTERPQ=JTERP
!!!!  IF(JTERP.GT.0.AND.KAPSCL.EQ.IAPLL) JTERPQ=JTERP+3
      IF(JTERP.GT.0.AND.KAPSCL.EQ.IAPLL) JTERPQ=JTERP+4
      CALL ALTPT(AA,II,LL,NM,MJDSBL,XTRA(1,30),ISAT,ISET,OFF,XTRA(1,4), &
     &           XTRA(1,7),XSN,VSN,JTERPQ,ATROT,HOLD,2,FRQLNK)
!
!  WITH THE ICESat POINTING VECTOR BEING DETERMINED FROM A
!  COMBINATION OF A VECTOR FROM THE DATA RECORD AND QUATERNIONS FROM
!  THE EXAT01 FILE, THERE IS THE POSSIBILITY THAT OFF (THE POINTING
!  VECTOR) WILL BE UNDEFINED FOR A FEW EPOCHS. IN THESE CASES
!  OFF WILL HAVE BEEN SET TO (999,999,999). FOR THESE POINTS
!  SET OFF TO GEOCENTRIC POINTING AND SET XTRA(*,1) TO 999. THE
!  RESET OF OFF WILL ALLOW NORMAL PROCESSING TO CONTINUE. AT THE
!  END OF THE ROUTINE USE XTRA(*,1) TO SET THE BOUNCE POINT
!  LOCATION TO (0,0,0)
!
      DO I=1,NM
        XTRA(I,1)=0.D0
        IF(OFF(I,1).GT.998.D0) THEN
           XTRA(I,1)=999.D0
           OF1=-XSN(I,1)
           OF2=-XSN(I,2)
           OF3=-XSN(I,3)
           OF=SQRT(OF1*OF1+OF2*OF2+OF3*OF3)
           OFF(I,1)=OF1/OF
           OFF(I,2)=OF2/OF
           OFF(I,3)=OF3/OF
        ENDIF
      ENDDO
!
!  MAKE SURE OFF IS POINTING GENERALLY DOWNWARD. FLIP DIRECTION
!  IF NECESSARY
!

!  FOR NEAR ONLY
!     OFF(1,1)=-OFF(1,1)
!     h=OFF(1,2)
!     g=OFF(1,3)
!     OFF(1,2)=g
!     OFF(1,3)=-h
!  FOR NEAR ONLY

!     temporarilly use vsk to save the unitized satellite vector
      xs=SQRT(xsn(1,1)*xsn(1,1)+xsn(1,2)*xsn(1,2)+xsn(1,3)*xsn(1,3))
      vsk(1,1)=xsn(1,1)/xs
      vsk(1,2)=xsn(1,2)/xs
      vsk(1,3)=xsn(1,3)/xs
      A=vsk(1,1)*vsk(1,1)+vsk(1,2)*vsk(1,2)+vsk(1,3)*vsk(1,3)
      B=off(1,1)*off(1,1)+off(1,2)*off(1,2)+off(1,3)*off(1,3)
!     write(6,*)' dbg vsk ',vsk(1,1),vsk(1,2),vsk(1,3)
!     write(6,*)' dbg off ',off(1,1),off(1,2),off(1,3)
!     CALL DOTPRD(XSN,OFF,XTRA(1,23),MINTIM,MINTIM,MINTIM,3)
      CALL DOTPRD(VSK,OFF,XTRA(1,23),MINTIM,MINTIM,MINTIM,3)
      theta=ACOS(XTRA(1,23))
      theta=theta/degrad





      CALL DOTPRD(XSN,OFF,XTRA(1,23),MINTIM,MINTIM,MINTIM,3)
      IF(XTRA(1,23).GT.0.D0) THEN
      DO 11510 I=1,MINTIM
      DO 11510 J=1,3
      OFF(I,J)=-OFF(I,J)
11510 CONTINUE
      ENDIF

! HERE I HAVE XSN,VSN AT TRANSMIT TIME, COMPUTE ROTATION INERTIAL TO LVL

!
! COMPUTE AND SAVE FULL ROLL, PITCH and YAW FROM LASER TO LVLH
! THIS IS OUTPUT ON THE GEOLOCATION FILE
!

!     out angles:
      IF(LDIOUT.OR.LXGOUT.AND.KIT.EQ.1) THEN

      DO N=1,NM

!....GET J2000 COORDINATES OF S/C
        XPQ(1)=REFMT(1)*XSN(N,1)+REFMT(4)*XSN(N,2)+REFMT(7)*XSN(N,3)
        XPQ(2)=REFMT(2)*XSN(N,1)+REFMT(5)*XSN(N,2)+REFMT(8)*XSN(N,3)
        XPQ(3)=REFMT(3)*XSN(N,1)+REFMT(6)*XSN(N,2)+REFMT(9)*XSN(N,3)
        VPQ(1)=REFMT(1)*VSN(N,1)+REFMT(4)*VSN(N,2)+REFMT(7)*VSN(N,3)
        VPQ(2)=REFMT(2)*VSN(N,1)+REFMT(5)*VSN(N,2)+REFMT(8)*VSN(N,3)
        VPQ(3)=REFMT(3)*VSN(N,1)+REFMT(6)*VSN(N,2)+REFMT(9)*VSN(N,3)

!....GET SBF TO J2000 QUATERNION
        CALL ROTQAT(ATROT(1,1,N),QSBFJ2)

!....GET ROLL, PITCH AND YAW TO LVLH
        CALL QATCMP(XPQ,VPQ,QSBFJ2,XTRA(N,31),XTRA(N,32),XTRA(N,33))

      ENDDO

      ENDIF  ! out angles
!      print *,'ltalto: 1 r p and y: ',xtra(1,31),xtra(1,32),xtra(1,33)
!
! ATMOSPHERIC CORRECTIONS (ONLY ON 1ST TRIP TRHOUGH) TIL 80000
      IF(KIT.GT.1) GO TO 80000
!
! AT THIS POINT THE APPROXIMATE BOUNCE POINT CAN BE FIGURED.
! COMPUTE TROP CORRECTION IF NECESSARY
!
! TROP AND EVENTUALLY IONOSPHERE
!     IF((.NOT.LPRE9(3).OR.NOT.(LPRE9(4).OR.NOT.LPRE9(6))
!    1   .AND.ICBDGM.EQ.ITBDGM) THEN
!
      IF((.NOT.LPRE9(3).OR..NOT.LPRE9(4)).AND.ICBDGM.EQ.ITBDGM) THEN
!!       write(6,*)' dbg CALL ALTRFC'
        CALL ALTRFC(XSN,XBM,OFF,OBS,THETAG,XTRA(1,7),XTRA(1,15),OCDRYT, &
     &              OCWETT,OBSMET,NM,MTYPE,.FALSE.,MJDSBL,AA(KFSEC),AA)
      ENDIF
!      print *,'dry,wet,iono 1: ',OCDRYT(1),OCWETT(1),OCIONO(1)
!      print *,'dry,wet,iono nm: ',OCDRYT(nm),OCWETT(nm),OCIONO(nm)
!
! IONOSPHERE
!
!      print *,'ltalto: LPRE(6,1),LIONC: ',LPRE(6,1),LIONC
      IF(LPRE9(6)) GO TO 80000
!.....IONOSPHERE
      IF(LIONC)THEN
!      print *,'ltalto: computing iono correction'
! COMPUTE COSINES AND SINES OF RIGHT ASCENSION OF GREENWICH ACROSS
!         ENTIRE BLOCK OF DATA
      IF(ICBDGM.EQ.3) THEN
!
!CDEP CHECK THIS BELOW
!
      CALL GRHRAN(MJDSBL,FSECK,.TRUE.,.TRUE. ,AA(KEQN),AA(KSRTCH),      &
     &   THETAG,COSTHG,SINTHG,NM,AA,II,UTDT(1,1),.FALSE.,DUM,DUm1)
      ELSE
      CALL ROTXTR(MJDSBL,FSECK,.TRUE.,AA(KEQN),AA(KSRTCH),              &
     &   THETAG,COSTHG,SINTHG,NM,AA,AA(KACOSW),AA(KBSINW),AA(KANGWT),   &
     &   AA(KWT),AA(KACOFW),AA(KBCOFW),II,1)
      ENDIF
! COMPUTE GEODETIC SATELLITE COORDINATES
      CALL SUBTRK(XSN,THETAG,XY2,ZT,RT,SATLAT,SATLON,SATH,NM)
!
!CDEP CHECK THIS ABOVE
!
        LOGINT=.FALSE.
        IF(INTERP.EQ.1) LOGINT=.TRUE.
        DO 11520 N=1,NM
          CIN(1)=SATLAT(N)*DEGRAD
          CIN(2)=SATLON(N)*DEGRAD
          CIN(3)=0.D0
          CALL XYZOUT(1,CIN,XYZECF(1,1),AE,FE)
          CALL INERTP(XYZECF,COSTHG(N),SINTHG(N),X2,1,1,1)
          DO 11530 JJ=1,3
            X1(JJ)=XSN(N,JJ)
11530     CONTINUE
! CONVERT POSITIONS FROM TRUE OF REFERENCE TO TRUE OF DATE
          CALL TDORTR(MJDSBL,FSECK(N),X1,X1,AA,1,1,.TRUE.,.FALSE.,II)
          CALL TDORTR(MJDSBL,FSECK(N),X2,X2,AA,1,1,.FALSE.,.FALSE.,II)
          MJDSV=MJDSBL
          TMJDSC=DBLE(MJDSV)+FSECK(N)
          CALL IONRC(AA,TMJDSC,X1,X2,RA(N,3),LOGINT)
11520   CONTINUE
        CFACI=1.D0
        ELCTOM=40.3*CFACI/FRQLNK**2
        DO 11540 N=1,NM
          OCIONO(N)=OCIONO(N)+RA(N,3)*ELCTOM
11540   CONTINUE
      ENDIF
!
!
! END IONOSPHERE
80000 CONTINUE
!
! XTRA(I,23) WILL CONTAIN OBSERVATION WITH THE EFFECTS OF REFRACTION
! REMOVED. THIS WILL BE USED FOR GEOLOCATION. ORIGINAL OBSERVATION
! USED FOR TIME TAGS
!      print *,'ltalto: OCWETT(1)+NM: ',OCWETT(1),OCWETT(NM)
!      print *,'ltalto: OCDRYT(1)+NM: ',OCDRYT(1),OCDRYT(NM)
!      print *,'ltalto: OCIONO(1)+NM: ',OCIONO(1),OCIONO(NM)
!      print *,'ltalto: BIASX: ',BIASX
      DO I=1,NM
        XTRA(I,23)=ABS(OBS(I))-(ABS(OCWETT(I))+ABS(OCDRYT(I))         &
     &                         +ABS(OCIONO(I)))-BIASX
!        XTRA(I,23)=ABS(OBS(I))-BIASX
!         XTRA(I,23)=ABS(OBS(I))-(OCIONO(I))-BIASX
!         WRITE(6,88123) I,OBS(I),XTRA(I,23)
88123    FORMAT(' LTALTO : I,OBS(I),XTRA(I,23) ',I6,2D20.11)
!         WRITE(6,88124) OCWETT(I),OCDRYT(I),OCIONO(I)
88124    FORMAT(' WDI ',3D20.11)
      END DO
!
!   GET TRUE OF REF POSITION OF SATELLITE AT ALTIM RECEIVE
!
      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      ENDIF

!     write(6,*)' dbg CALL ORBIT AT RECEIVE'
      CALL ORBIT(MJDSBL,XTRA(1,29),AA(KS),NM,II(KINDH),II(KNMH),        &
     &   II(KMJDSC),                                                    &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSK,AA(KPXPFM),              &
     &   LNADJX,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),               &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)

!
! PRELIMINARY COMPUTATIONS FOR BOUNCE POINT
!
  110 CONTINUE

!...GET TRANSMIT VECTOR
      DO I=1,NM
       XSN(I,1)=XSN(I,1)+XTRA(I,4)
       XSN(I,2)=XSN(I,2)+XTRA(I,5)
       XSN(I,3)=XSN(I,3)+XTRA(I,6)
      ENDDO

!...GET RECEIVE VECTOR
!      print *,'ltalto: before altpt receive'
!      write(6,*)' dbg CALLING ALTPT RECEIVE '
!
! LTALTO CAN ONLY LOAD SC BODY ATITUDE PARTIALS OR LASER
! NEXT TWO LINES GET PARTIALS FOR WHICHEVER HAS LOOSER SIGMA
!
      JTERPQ=JTERP
!!!!  IF(JTERP.GT.0.AND.KAPSCL.EQ.IAPLL) JTERPQ=JTERP+3
      IF(JTERP.GT.0.AND.KAPSCL.EQ.IAPLL) JTERPQ=JTERP+4
      CALL ALTPT(AA,II,LL,NM,MJDSBL,XTRA(1,29),ISAT,ISET,XTRA(1,26),    &
     &      XTRA(1,4),XTRA(1,7),XSK,VSK,JTERPQ,ATROT,HOLD,1,FRQLNK)
      DO I=1,NM
       XSK(I,1)=XSK(I,1)+XTRA(I,4)
       XSK(I,2)=XSK(I,2)+XTRA(I,5)
       XSK(I,3)=XSK(I,3)+XTRA(I,6)
      ENDDO

      DO 200 I=1,NM
      XTRA(I,5)=(XSK(I,1)-XSN(I,1))**2 + (XSK(I,2)-XSN(I,2))**2 +       &
     &     (XSK(I,3)-XSN(I,3))**2
!
!      XTRA(I,5)=XSK(I,1)*XSK(I,1)+XSK(I,2)*XSK(I,2)+XSK(I,3)*XSK(I,3)
!     1        +XSN(I,1)*XSN(I,1)+XSN(I,2)*XSN(I,2)+XSN(I,3)*XSN(I,3)
!     2  -2.D0*(XSK(I,1)*XSN(I,1)+XSK(I,2)*XSN(I,2)+XSK(I,3)*XSN(I,3))

      XTRA(I,6)=XTRA(I,23)*2.D0*(OFF(I,1)*(XSK(I,1)-XSN(I,1))           &
     &                        +OFF(I,2)*(XSK(I,2)-XSN(I,2))             &
     &                        +OFF(I,3)*(XSK(I,3)-XSN(I,3)))
      XTRA(I,7)=XTRA(I,23)*XTRA(I,23)
      XTRA(I,8)=SQRT(XTRA(I,5)+XTRA(I,7)-XTRA(I,6))+XTRA(I,23)
      XTRA(I,9)=SQRT(XTRA(I,5)+.9801D0*XTRA(I,7)-.99D0*XTRA(I,6))       &
     &        +.99D0*XTRA(I,23)
      XTRA(I,10)=100.D0*(XTRA(I,8)-XTRA(I,9))
      XTRA(I,11)=2.D0*XTRA(I,23)
      XTRA(I,12)=1.D0
  200 END DO
!
!  ITERATE FOR POSITION OF BOUNCE POINT
!
!     write(6,*)' dbg ITERATE FOR BOUNCE POINT '
      KOUNT=0
  300 CONTINUE
      KOUNT=KOUNT+1
      IF(KOUNT.GT.10) THEN
         WRITE(6,6000)
         DO 350 I=1,NM
         XTRA(I,18)=DBLE(MJDSBL)+FSECK(I)
         WRITE(6,6001) XTRA(I,18),OBS(I),XTRA(I,12)
  350    CONTINUE
         STOP
 6000 FORMAT(' CONVERGENCE NOT ACHIEVED FOR GEOLOCATED ALTIMETRY')
 6001 FORMAT(' MJDSEC ',F14.1,' OBS ',F14.1,' SCALE ',F15.9)
      ENDIF
      LCNVRG=.TRUE.
      DO 400 I=1,NM
      XTRA(I,13)=XTRA(I,11)-XTRA(I,8)
!     IF(.NOT.LX2ALT) THEN
      IF(ABS(XTRA(I,13)).GT..001D0) LCNVRG=.FALSE.
!     ENDIF
      XTRA(I,12)=XTRA(I,12)+XTRA(I,13)/XTRA(I,10)
      XTRA(I,8)=SQRT(XTRA(I,5)+XTRA(I,12)*XTRA(I,12)*XTRA(I,7)          &
     &              -XTRA(I,12)*XTRA(I,6))                              &
     &        +XTRA(I,12)*XTRA(I,23)
  400 END DO
!     if(lcnvrg)  write(6,*)' BP CONVERGED '
      IF(.NOT.LCNVRG) GO TO 300
!
!
! CONVERGENCE ACHIEVED. GET BOUNCE POINT AND TIME TAG
!
      DO I=1,NM
       XBM(I,1)=XSN(I,1)+XTRA(I,12)*XTRA(I,23)*OFF(I,1)
       XBM(I,2)=XSN(I,2)+XTRA(I,12)*XTRA(I,23)*OFF(I,2)
       XBM(I,3)=XSN(I,3)+XTRA(I,12)*XTRA(I,23)*OFF(I,3)
       a=XTRA(I,23)*OFF(I,1)
       b=XTRA(I,23)*OFF(I,2)
       c=XTRA(I,23)*OFF(I,3)
       d=SQRT(a*a+b*b+c*c)
!      write(6,*)' dbg d ',d
!      write(6,*)' dbg xs ',xs
!      write(6,*)' dbg 1 ',XTRA(I,23)*OFF(I,1)
!      write(6,*)' dbg 2 ',XTRA(I,23)*OFF(I,2)
!      write(6,*)' dbg 3 ',XTRA(I,23)*OFF(I,3)
       IF(MTYPE.EQ.110.OR.MTYPE.EQ.111) GOTO 5000
       FSECM(I)=FSECK(I)+XTRA(I,12)*ABS(OBS(I))/VLIGHT
       GOTO 5500
5000   CONTINUE
       if(iterp.eq.0) FSECM(I)=FSECK(I)+XTRA(I,12)*ABS(OBS(I))/VLIGHT
5500   CONTINUE
!       IF(ITERP.EQ.0) THEN
        RQP=SQRT(XBM(I,1)*XBM(I,1)+XBM(I,2)*XBM(I,2)+XBM(I,3)*XBM(I,3))
!       WRITE(6,88914) I,XTRA(I,12)
!       WRITE(6,88915) OFF(I,1),OFF(I,2),OFF(I,3)
!       WRITE(6,88916) XSN(I,1),XSN(I,2),XSN(I,3),ISATID
!       WRITE(6,88917) XBM(I,1),XBM(I,2),XBM(I,3)
!       WRITE(6,88918) RQP
!       ENDIF
      ENDDO

88914 FORMAT(' I, FACT ',I5,D20.11)
88915 FORMAT(' OFF ',3D20.11,F10.1)
88916 FORMAT(' SAT ',3D20.11,I8)
88917 FORMAT(' BNC ',3D20.11)
!88918 FORMAT(' RBN ',D20.11)
88918 FORMAT(' RADIUS TO PLANET ',F20.11)
      IF(.NOT.LDIOUT.AND..NOT.LXGOUT) THEN
         JJ=1
         IF(.NOT.LIND1) THEN
            TBEST=RINDEX(KXBST,2)
            CALL FNDRN(TBEST,FSECN,NM,IRETAT)
            IF(IRETAT.GT.0) THEN
            JJ=IRETAT-(NUCON/2)
            ENDIF
         ENDIF
         DO I=1,NUCON
          PMATT(I,3,20)=XTRA(I-1+JJ,12)
         ENDDO
      ENDIF
!      print *,'ltalto: 1 xsn: ',xsn(1,1),xsn(1,2),xsn(1,3)
!      xsnmag=sqrt(xsn(1,1)**2+xsn(1,2)**2+xsn(1,3)**2)
!      print *,'ltalto: 1 xbm: ',xbm(1,1),xbm(1,2),xbm(1,3)
!      xbmmag=sqrt(xbm(1,1)**2+xbm(1,2)**2+xbm(1,3)**2)
!      print *,'ltalto: 1 xsnmag: ',xsnmag
!      print *,'ltalto: 1 xbmmag: ',xbmmag
!      print *,'ltalto: 1 obs: ',obs(1)

!
! CONVRT BOUNCE POINT TO TRUE OF DATE CONVERT TO EARTH FIXED LATER
!
      CALL SATUPD(MJDSBL,FSECM,XBM,XBM,AA,NM,MINTIM,.TRUE.,.FALSE.,II,  &
     &            JOR,1)
!
!   GET TRUE OF REF POSITION OF SATELLITE AT ALTIM TRANSMIT

      IF(IRET.GT.0) THEN
      KSUMXOS=MAPSAT(INTOSP,1)
      KSUMPOS=MAPSAT(INTOSP,2)
      KXDDTOS=MAPSAT(INTOSP,3)
      KPDDTOS=MAPSAT(INTOSP,4)
      ENDIF

!
      CALL ORBIT(MJDSBL,FSECK,AA(KS),NM,II(KINDH),II(KNMH),II(KMJDSC),  &
     &   AA(KFSEC),II(KMJDSV),AA(KFSECV),LL(KLSETS),II(KIPXPF),         &
     &   II(KIVSAT),1,II(KNMAX),II(KNTOLD),XSN,AA(KPXPFM),              &
     &   LNADJY,.FALSE.,II(KPLPTR),II(KPANEL),II(KNMOVE),               &
     &   AA(KTPMES+4*MINTIM),LL(KLTPMS+6*MINTIM),LL(KSETDN),            &
     &   AA(KTMOS0-1+INTOSP),AA(KTMOS-1+INTOSP),AA(KTMOSP-1+INTOSP),    &
     &   AA(KSMXOS-1+KSUMXOS),AA(KSMXOS-1+KSUMPOS),AA(KSMXOS-1+KXDDTOS),&
     &   AA(KSMXOS-1+KPDDTOS),KNSTEPS,NEQNI,II(KSGMNT-1+IRET),          &
     &   AA(KSGTM1-1+IRET),AA(KSGTM2-1+IRET),AA,II,LL)


!
  120 CONTINUE
!
! BEFORE CONVERT TO TRUE OF DATE COMPUTE ANGLE BETWEEN ACTUAL POINTING
! AND CENTRIC POINTING (OFF IS IN TRUE OF REF)
!
      DO 600 I=1,NM
      XTRA(I,20)=SQRT(XSN(I,1)*XSN(I,1)+XSN(I,2)*XSN(I,2)               &
     &               +XSN(I,3)*XSN(I,3))
!     XTRA(I,17)=ACOS((XSN(I,1)*OFF(I,1)+XSN(I,2)*OFF(I,2)
!    1               +XSN(I,3)*OFF(I,3))/XTRA(I,20))/DEGRAD
      XTRA(I,17)=  ((XSN(I,1)*OFF(I,1)+XSN(I,2)*OFF(I,2)                &
     &              +XSN(I,3)*OFF(I,3))/XTRA(I,20))
      IF(XTRA(I,17).GT.1.D0.AND.XTRA(I,17).LT.1.00001D0) THEN
         XTRA(I,17)=.99999999D0
      ENDIF
      IF(XTRA(I,17).LT.-1.D0.AND.XTRA(I,17).GT.-1.00001D0) THEN
         XTRA(I,17)=-.99999999D0
      ENDIF
      XTRA(I,17)=ACOS(XTRA(I,17))/DEGRAD
!      IF(DABS(XTRA(I,17)).GT.100.D0) THEN
!         XTRA(I,17)=DABS(180.D0-DABS(XTRA(I,17)))
!      ENDIF
  600 END DO

!      print *,'ltalto: 1 geoang: ',xtra(1,17)
!
!   GET TRUE OF DATE POSITION OF SATELLITE AT ALTIM TRANSMIT
!
      CALL SATUPD(MJDSBL,FSECK,XSN,XSN,AA,NM,MINTIM,.TRUE.,.FALSE.,II,  &
     &            JOR,1)
      CALL SATUPD(MJDSBL,FSECK,VSN,VSN,AA,NM,MINTIM,.FALSE.,.FALSE.,II, &
     &            JOR,1)
!
! AT THIS POINT OUTPUT THE SATELLITE ALTIMETRY DATA RECORD INTO THE
! BINARY RESIDUAL FILE IF REQUESTED.
      IF(ITERP.EQ.0) THEN
!
       IF(LLOCRI)WRITE(IUNT19)(FSECK(JP),JP=1,NM),                      &
     &                   (XSN(JP,1),JP=1,NM),                           &
     &                   (XSN(JP,2),JP=1,NM),                           &
     &                   (XSN(JP,3),JP=1,NM),                           &
     &                   (VSN(JP,1),JP=1,NM),                           &
     &                   (VSN(JP,2),JP=1,NM),                           &
     &                   (VSN(JP,3),JP=1,NM)
!
      ENDIF
!
! GET PLANET FIXED POSITION OF ALTIMETRY LINE OF SIGHT UNIT VECTOR
! pd %%%%%% i think XTRA(1,7-9) are all outputs and will be over written
!           in the next ALMEAN call. so things should just be fine.
!           the values that we need in this call will be saved in
!           XTRA(1,18-20). allocatable array would probably not work
!           since the dimension of XTRA(1,18) changes within ALMEAN.
      CALL SATUPD(MJDSBL,FSECK,OFF,OFF,AA,NM,MINTIM,.FALSE.,.FALSE.,II, &
     &            JOR,1)
      CALL ALMEAN(AA,II,LL,MJDSBL,FSECK,NM,OFF,XTRA(1,7),XTRA(1,18),    &
     &            XTRA(1,7),XTRA(1,8),XTRA(1,9),THETAG,COSTHG,SINTHG,   &
     &            OTIDES,.TRUE.,LAST,.FALSE.,AA(KVARAY),HOLD,LDIOUT,    &
     &            LXGOUT,ETIDES,RLAND,JOR)
      CALL SATUPD(MJDSBL,FSECK,OFF,OFF,AA,NM,MINTIM,.TRUE.,.TRUE.,II,  &
     &            JOR,1)
!
! GET PLANET FIXED POSITION OF SATELLITE AT ALTIM TRANSMIT
!
      CALL ALMEAN(AA,II,LL,MJDSBL,FSECK,NM,XSN,XTRA(1,7),XTRA(1,4),     &
     &            XTRA(1,7),XTRA(1,8),XTRA(1,9),THETAG,COSTHG,SINTHG,   &
     &            OTIDES,.TRUE.,LAST,.FALSE.,AA(KVARAY),HOLD,LDIOUT,    &
     &            LXGOUT,ETIDES,RLAND,JOR)
!
! GET PLANET FIXED POSITION OF BOUNCE POINT AT BOUNCE TIME
!
!      DO I=1,NM
!      RQP=DSQRT(XBM(I,1)*XBM(I,1)+XBM(I,2)*XBM(I,2)+XBM(I,3)*XBM(I,3))
!      WRITE(6,88927) XBM(I,1),XBM(I,2),XBM(I,3)
!      WRITE(6,88928) RQP
!      ENDDO
88927 FORMAT(' BNC2',3D20.11)
88928 FORMAT(' RQP2',D20.11)
!     write(6,*)' dbg  call ALMEAN TO GET BP FIXED POSITION'
      CALL ALMEAN(AA,II,LL,MJDSBL,FSECM,NM,XBM,XTRA(1,13),XTRA(1,10),   &
     &            XTRA(1,13),XTRA(1,14),XTRA(1,15),THETAG,COSTHG,SINTHG,&
     &            OTIDES,.FALSE.,LAST,.FALSE.,AA(KVARAY),HOLD,LDIOUT,   &
     &            LXGOUT,ETIDES,RLAND,JOR)
!      DO I=1,NM
!      RQP=DSQRT(XTRA(I,10)*XTRA(I,10)+XTRA(I,11)*XTRA(I,11)            &
!    &         +XTRA(I,12)*XTRA(I,12))
!      WRITE(6,88937) XTRA(I,10),XTRA(I,11),XTRA(I,12)
!      WRITE(6,88938) RQP
!      ENDDO

88937 FORMAT(' BNC3',3D20.11)
88938 FORMAT(' RQP3',D20.11)
!
! pd %%%%%% save values of XTRA(I,15) to XTRA(I,24) before it is over wr
!           and make sure that all longitudes are positive.
      IF(LAST) THEN
         DO I=1,NM
            XTRA(I,24) = XTRA(I,15)
            IF(XTRA(I,8).LT.0) XTRA(I,8) = XTRA(I,8) + 360.0D0
            IF(XTRA(I,14).LT.0) XTRA(I,14) = XTRA(I,14) + 360.0D0
         END DO
      ENDIF

!      print *,'ltalto: 1 lat,lon,ht: ',XTRA(1,13),XTRA(1,14),XTRA(1,15)

!
! COMPUTE THE SEA SURFACE HEIGHT ABOVE THE REFERENCE ELLIPSOID
! USING GRID DATA IF REQUESTED. GRID IS ATTACHED TO UNIT 29.
!
!           WRITE(6,*)' CALLING THE SURFACE MODEL ROUTINES '
      IF(LMSSWG) THEN
      IF(LMSS) THEN
       JJ=1

      DO N=1,NM
      SSTS(N)=0.D0
      IF(RLAND(N).GT..99D0.AND.RLAND(N).LT.1.01D0) THEN
           CALL GINTRP(4,5.D0,GRID1,XLATS(JJ),XLONW(JJ),DPHI(JJ),       &
     &     DPHI(JJ),NNL(JJ),NEW(JJ),NNL(JJ),NEW(JJ),                    &
     &     XTRA(N,13),XTRA(N,14),                                       &
     &     SSTS(N))
      ENDIF
      ENDDO
      ENDIF
!
!...COMPUTE DEM
!
      IF(LMLTDEM) THEN
       DO N=1,NM
       SSTS(N)=interpolate_DEMgrids(XTRA(N,14),XTRA(N,13))
       ENDDO
      ELSE IF(LDEM) THEN
       JJ=2

       DO N=1,NM

      IF(RLAND(N).GT.1.99D0.AND.RLAND(N).LT.2.01D0) THEN
         CALL GINTRP(4,5.D0,GRID2,XLATS(JJ),XLONW(JJ),DPHI(JJ),         &
     &   DPHI(JJ),NNL(JJ),NEW(JJ),NNL(JJ),NEW(JJ),                      &
     &   XTRA(N,13),XTRA(N,14),                                         &
     &   SSTS(N))
      ENDIF

       END DO

      ENDIF
!      print *,'aldst2: SSTS 1: ',SSTS(1)
      ENDIF
!
      IF(LXGOUT.OR.LDIOUT) GOTO 90
!
      IF(LNUMIT.AND.NINNER.GT.ITERNU) THEN
      IADD=0
      IF(LAST) GOTO 80
!
      IF(ITERP.EQ.0) THEN
      IADD=3
      DO I=1,NM
      XSCR(1,I)=XTRA(I,10)
      XSCR(2,I)=XTRA(I,11)
      XSCR(3,I)=XTRA(I,12)
      ENDDO
      ELSE
      ITERP3=ITERP-3
      JJ=1
      IF(.NOT.LIND1) THEN
        TBEST=RINDEX(KXBST,2)
        CALL FNDRN(TBEST,FSECN,NM,IRETAT)
        IF(IRETAT.GT.0) THEN
           JJ=IRETAT-(NUCON/2)
        ENDIF
      ENDIF
      IF(JJ.EQ.0) JJ=1
      SCALE=1.D0
      IF(KIT.GE.ITAT1.AND.KIT.LE.ITAT3) SCALE=1.D0/ATTPRT
      IF(KIT.EQ.ITTT1.OR.KIT.EQ.ITTT2) SCALE=20.D0
      ITDUM=ITERP3
      IF(KIT.EQ.ITTT1) ITDUM=4
      IF(KIT.EQ.ITTT2) ITDUM=5
      LCALLF=.TRUE.
      IF(KIT.GE.ITOR1.AND.KIT.LE.ITOR3) THEN
         ITDUM=12+KIT-ITOR1
         ITDUM2=1+KIT-ITOR1
         SCALE=1.D0/DXGEO1
         IF(JOR.EQ.3)  SCALE=1.D0/DXGEO2
         IF(LINTAX) THEN
           LCALLF=.FALSE.
           DO IQ=1,NM
             PPOR(ITDUM2,1,IQ)=(XTRA(IQ,10)-XSCR(1,IQ))*SCALE
             PPOR(ITDUM2,2,IQ)=(XTRA(IQ,11)-XSCR(2,IQ))*SCALE
             PPOR(ITDUM2,3,IQ)=(XTRA(IQ,12)-XSCR(3,IQ))*SCALE
           ENDDO
           IF(ITDUM2.EQ.3) THEN
             IHLD=IPVAL0(IXXTRO)
             IPVAL0(IXXTRO)=1
             DO IQ=1,NM
               DO JQ=1,NDPOR
                  XR(JQ) = AA(KDPOR-1+IQ + (JQ-1)*MINTIM) ! AATJS(1,J)
               END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  FOR NOW  DO0DA0 IS SET FOR FIRST ASTEROID
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
               CALL GETDADA0 (XR(4),XR(13),DO0DA0,DADA0)
               CALL GETDADIC (XR(4),XR(157),DADIC)
               IPMP=1+3*NXTRAC*(IQ-1)
!!!            CALL CHPOR(PPOR(1,1,IQ),PMPA(1,1,IQ),1,NXTRAC,1,.TRUE.,  &
               CALL CHPOR(PPOR(1,1,IQ),PMPA(IPMP),1,NXTRAC,1,.TRUE.,    &
     &                    DUMQ,LAVDUM,DUMQ,DUMQ,DUMQ,                   &
     &                    DADA0,DADIC,1)
               IPMP=1+NXTRAC+3*NXTRAC*(IQ-1)
!!!            CALL CHPOR(PPOR(1,2,IQ),PMPA(1,2,IQ),1,NXTRAC,1,.TRUE.,  &
               CALL CHPOR(PPOR(1,2,IQ),PMPA(IPMP),1,NXTRAC,1,.TRUE.,    &
     &                    DUMQ,LAVDUM,DUMQ,DUMQ,DUMQ,                   &
     &                    DADA0,DADIC,1)
               IPMP=1+2*NXTRAC+3*NXTRAC*(IQ-1)
!!!            CALL CHPOR(PPOR(1,3,IQ),PMPA(1,3,IQ),1,NXTRAC,1,.TRUE.,  &
               CALL CHPOR(PPOR(1,3,IQ),PMPA(IPMP),1,NXTRAC,1,.TRUE.,    &
     &                    DUMQ,LAVDUM,DUMQ,DUMQ,DUMQ,                   &
     &                    DADA0,DADIC,1)
             ENDDO
             IPVAL0(IXXTRO)=IHLD
             DO IQ=1,NUCON
               DO JQ=1,3
                 IPMP=(JQ-1)*NXTRAC+(IQ-2+JJ)*3*NXTRAC
!!                 PMATT(IQ,JQ,12)=PMPA(1,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,13)=PMPA(2,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,14)=PMPA(3,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,15)=PMPA(4,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,16)=PMPA(5,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,17)=PMPA(6,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ, 6)=PMPA(NXTRAC-5,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ, 7)=PMPA(NXTRAC-4,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ, 8)=PMPA(NXTRAC-3,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ, 9)=PMPA(NXTRAC-2,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,10)=PMPA(NXTRAC-1,JQ,IQ-1+JJ)
!!                 PMATT(IQ,JQ,11)=PMPA(NXTRAC,JQ,IQ-1+JJ)
!
                 PMATT(IQ,JQ,12)=PMPA(1+IPMP)
                 PMATT(IQ,JQ,13)=PMPA(2+IPMP)
                 PMATT(IQ,JQ,14)=PMPA(3+IPMP)
                 PMATT(IQ,JQ,15)=PMPA(4+IPMP)
                 PMATT(IQ,JQ,16)=PMPA(5+IPMP)
                 PMATT(IQ,JQ,17)=PMPA(6+IPMP)
                 PMATT(IQ,JQ, 6)=PMPA(NXTRAC-5+IPMP)
                 PMATT(IQ,JQ, 7)=PMPA(NXTRAC-4+IPMP)
                 PMATT(IQ,JQ, 8)=PMPA(NXTRAC-3+IPMP)
                 PMATT(IQ,JQ, 9)=PMPA(NXTRAC-2+IPMP)
                 PMATT(IQ,JQ,10)=PMPA(NXTRAC-1+IPMP)
                 PMATT(IQ,JQ,11)=PMPA(NXTRAC+IPMP)
               ENDDO
             ENDDO
!!!             DEALLOCATE(XR)
!!!             DEALLOCATE(PPOR)
!!!             DEALLOCATE(PMPA)
!!!!!!!!!!!ENDIF FOR:  IF(ITDUM2.EQ.3) THEN
           ENDIF
!!!!!!!!!ENDIF FOR:  IF(LINTAX) THEN
         ENDIF
!!!!!!ENDIF FOR: IF(KIT.GE.ITOR1.AND.KIT.LE.ITOR3) THEN
      ENDIF
!     write(6,*)' dbg filling up filatp ',ITDUM
      IF(LCALLF) THEN
        CALL FILATP(PMATT(1,1,1),ITDUM,XSCR,XTRA(1,10),XTRA(1,11),      &
     &            XTRA(1,12), NM,SCALE,JJ,NUCON)
      ENDIF
      ENDIF
!
      ITERP=ITERP+1+IADD
!     write(6,*)' dbg going back to 40',ITERP,IADD
      GOTO 40
!
   80 CONTINUE
      ENDIF
!
      IF(LAST) THEN
         JJ=1
         IF(.NOT.LIND1) THEN
           TBEST=RINDEX(KXBST,2)
           CALL FNDRN(TBEST,FSECN,NM,IRETAT)
           IF(IRETAT.GT.0) THEN
             JJ=IRETAT-(NUCON/2)
           ENDIF
         ENDIF
         IMBP=IMBIAS(1)
         IF(NAMBB.GT.0) IMBP=IMBIAS(1)-IPVAL0(IXBISA)+1
          IF(IMBIAS(1).GT.0.OR.IPTLB0.GT.0) THEN
           DO I=1,NUCON
             PMATT(I,1,19)=OFF(I-1+JJ,1)*PMATT(I,3,20)
             PMATT(I,2,19)=OFF(I-1+JJ,2)*PMATT(I,3,20)
             PMATT(I,3,19)=OFF(I-1+JJ,3)*PMATT(I,3,20)
           ENDDO
          ENDIF
         DO I=1,NUCON
           PMATT(I,1,20)=XTRA(I-1+JJ,17)
           PMATT(I,2,20)=DBLE(IMBP)
           PMATT(I,3,20)=RLAND(I-1+JJ)
           PMATT(I,1,18)=DBLE(IPTOTB)
           PMATT(I,2,18)=DBLE(IPTATB)
           PMATT(I,3,18)=DBLE(IPTLB0)
         ENDDO
      ENDIF

   90 CONTINUE
!
! SET BOUNCE POINTS FOR WHICH THERE WAS NO POINTING TO ZERO
      DO I=1,NM
        IF(XTRA(I,1).GT.998.D0) THEN
           XTRA(I,10)=0.D0
           XTRA(I,11)=0.D0
           XTRA(I,12)=0.D0
        ENDIF
      ENDDO
!
!
!************************************************************
! OUTPUT FILES (GEOLOCATION AND CORRECTIONS)
!************************************************************

!
! GET TRANSMIT TIME IN UTC
!
      CALL UTCET(.FALSE.,NM,MJDSBL,FSECK,XTRA(1,25),AA(KA1UT))

!
! OUTPUT CORRECTIONS FILE
!
      IF(LG1BOT) THEN
         DO I = 1,NM
            ISATLA = INT(XTRA(I,13)*1.0D6)
            ISATLO = INT(XTRA(I,14)*1.0D6)
            TIME = MJDSBL + XTRA(I,25)
            ISSTS = INT(SSTS(I)*1.0D3)
            IOCDRY = INT(OCDRYT(I)*1.0D3)
            IOCWET = INT(OCWETT(I)*1.0D3)
            IETCOR = INT(HOLD(I,4)*1.0D3)
            IOTIDE = INT(OTIDES(I)*1.0D3)
            WRITE(UNIT=17,FMT=17) TIME,ISATLA,ISATLO,ISSTS,IOCDRY,      &
     &           IOCWET,IETCOR,IOTIDE
   17       FORMAT(F20.8,I15,I15,I7,I7,I7,I7,I7)
         END DO
      ENDIF
!
! OUTPUT GEOLOCATION FILE
!
!     geoloc file:
      IF(LDIOUT.OR.LXGOUT) THEN

      DO 700 I=1,NM
      XTRA(I,16)=SQRT(XTRA(I,10)*XTRA(I,10)+XTRA(I,11)*XTRA(I,11)      &
     &           +XTRA(I,12)*XTRA(I,12))
      XTRA(I,15)=ASIN(XTRA(I,12)/XTRA(I,16))/DEGRAD
      XTRA(I,25)=XTRA(I,25) - TTG
  700 END DO

      IMESRF = INT(DMESRF + 0.5)
      TIMEBL=DBLE(MJDSBL)
!
! NOTE: ALL TIMES ARE TRANSMIT TIME (FSECK)
!
!   TIMBL        :  Modified Julian Date Seconds of the final receive ti
!                   of the first observation in the block (UTC sec)
!   XTRA(I,25)   :  Elapsed seconds from the 1st observation of the bloc
!                   (UTC sec)
!   REFELP       :  Mission elapsed (UTC) seconds from Mission Reference
!                   at ground bounce time). The mission Reference time i
!                   provided by the ALTOUT option.
!   XTRA(I,13)   :  Geodetic latitude of the point of intersection
!   XTRA(I,14)   :  East longitude of the point of intersection
!   XTRA(I,24)   :  Intersection  point height above the reference ellip
!   XTRA(I,23)   :  Laser Altimeter Observation corrected for Tropospher
!                   and constant measurement bias.
!   OBS(I)       :  Original provided Laser Altimeter Observation
!   XTRA(I,9):      S/C height above reference ellipsoid (m)
!   XTRA(I,10-12):  Body fixed coordinates of the point of intersection.
!   XTRA(I,18-20):  Altimeter line of sight unit vector in the body fixe
!                   coordinate system.
!   XTRA(I,4-6)  :  Body fixed coordinates of the S/C (m)
!   XTRA(I,17)   :  Angle between actual observation direction and geoce
!                   direction.
!   OCDRYT       :  Dry Tropospheric correction
!   OCWETT       :  Wet Tropospheric correction
!   SSTS(I)      :  Mean Sea Surface Height at the point of intersection
!   OTIDES(I)    :  Ocean Tides.
!   HOLD(I,4)    :  Correction due to solid earth tides. (Radial Compone
!   XTRA(I,31-33):  Fully corrected roll, pitch and yaw
!

!      print *,'ltalto: 1a r p and y: ',xtra(1,31),xtra(1,32),xtra(1,33)
      DO I=1,NM

         REFELP = DBLE(MJDSBL-IMESRF) + (XTRA(I,25)-RMESRF)


            ISSTS = INT(SSTS(I)*1.0D3)
            IOCDRY = INT(OCDRYT(I)*1.0D3)
            IOCWET = INT(OCWETT(I)*1.0D3)
! NEGATIVE SIGN NECESSARY TO GET STANDARD CORRECTION TO GO FROM TIME
! INVARIANT TO TIME VARYING
            IETIDE = INT(ETIDES(I)*1.0D3)
            IOTIDE = INT(OTIDES(I)*1.0D3)
            ILAND  =INT(RLAND(I))
         WRITE(18) TIMEBL,XTRA(I,25),REFELP,XTRA(I,13),XTRA(I,14),      &
     &             XTRA(I,24),XTRA(I,23),OBS(I),XTRA(I,9),              &
     &             (XTRA(I,J),J=10,12),(XTRA(I,J),J=18,20),             &
     &             (XTRA(I,J),J=4,6),XTRA(I,17),                        &
     &             XTRA(I,31),XTRA(I,32),XTRA(I,33),                    &
     &             IOCDRY,IOCWET,ISSTS,IOTIDE,IETIDE,ILAND,UNQNDX(I)

!      print *,'*********************************************'
!      print *,'************ 0003  **************************'
!      print *,'*********************************************'
!      print *,'i:  ',i
!      print *,'timebl: ',timebl
!      print *,'xtra(i,25): ',xtra(i,25)
!      print *,'refelp: ',refelp
!      print *,'xtra(i,13): ',xtra(i,13)
!      print *,'xtra(i,14): ',xtra(i,14)
!      print *,'xtra(i,24): ',xtra(i,24)
!      print *,'xtra(i,23): ',xtra(i,23)
!      print *,'obs(i): ',obs(i)
!      print *,'xtra(i,9): ',xtra(i,9)
!      print *,'xtra(i,10): ',xtra(i,10)
!      print *,'xtra(i,11): ',xtra(i,11)
!      print *,'xtra(i,12): ',xtra(i,12)
!      print *,'xtra(i,18): ',xtra(i,18)
!      print *,'xtra(i,19): ',xtra(i,19)
!      print *,'xtra(i,20): ',xtra(i,20)
!      print *,'xtra(i,4): ',xtra(i,4)
!      print *,'xtra(i,5): ',xtra(i,5)
!      print *,'xtra(i,6): ',xtra(i,6)
!      print *,'xtra(i,17): ',xtra(i,17)
!      print *,'xtra(i,31): ',xtra(i,31)
!      print *,'xtra(i,32): ',xtra(i,32)
!      print *,'xtra(i,33): ',xtra(i,33)
!      print *,'iocdry: ',iocdry
!      print *,'iocwet: ',iocwet
!      print *,'issts: ',issts
!      print *,'iotide: ',iotide
!      print *,'ietide: ',ietide

      END DO

      ENDIF !  geoloc file

!       stop 69
      RETURN
 6002 FORMAT(' EXECUTION TERMINARING IN LTALTO; NDPOR & MDPOR ',2I12)
 6003 FORMAT(' EXECUTION TERMINARING IN LTALTO; NM & MAXNM ',2I12)
 6004 FORMAT(' EXECUTION TERMINARING IN LTALTO; NXTRAC & NM ',2I12)
 6005 FORMAT(' MAX ALLOWABLE NXTRAC*3*NMi AND ACTUAL ',2I12)
      END
