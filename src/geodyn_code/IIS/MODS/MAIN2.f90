!$MAIN2
      SUBROUTINE MAIN2(AA1,II1,LL1          )
!********1*********2*********3*********4*********5*********6*********7**
! MAIN2            MM/DD/YY            VVVV.V    PGMR - BILL EDDY
!
! FUNCTION         CONTROL GEODYN IIS FLOW AFTER FIRST DYNAMIC ALLOC.
!
! I/O PARAMETERS:
!
!   NAME    I/O  A/S   DESCRIPTION OF PARAMETERS
!   ------  ---  ---   ------------------------------------------------
!   AA1     I/O   A    DYNAMIC ARRAY FOR REAL VARIABLES ALLOCATION1
!   II1     I/O   A    DYNAMIC ARRAY FOR INTEGER VARIABLES ALLOCATION2
!   LL1     I/O   A    DYNAMIC ARRAY FOR LOGICAL VARIABLES ALLOCATION2
!
! COMMENTS
!
!
!********1*********2*********3*********4*********5*********6*********7**
      IMPLICIT DOUBLE PRECISION (A-H,O-Z), LOGICAL(L)
      SAVE
!
      PARAMETER ( NCORE2 = 11 )
!
      CHARACTER*5 FILNAM
!
      COMMON/ACCELR/NSATAC,NACCB,NSATDY,NDYNAC,NXACC,                   &
     &       MXACC,NXACCX,MXACCX,NXISSM,MXISSM,NXS1,MXS1,NXS2,MXS2,     &
     &       NXPPN,MXPPN,NXSBS,MXSBS,NSATHR,NFACCB(2,200),NFATIT(2,200),&
     &       MRAT,NBAPPD(200),NDYNPD(200),IACSAT(200),NACB(200),        &
     &       IDNSAT(200),NDYN(200)
      COMMON/ATTCB /KPAT,MAXAT,MAXLAS,IBLAS,                            &
     &              NASAT,IATCNT,NXATT
      COMMON/AGRAV /NACSET,NADEG,NAORD,IAGCB,IAGCE,IDATB,IDATE,INTAG,   &
     &KCOUNT,KSKIP,INTC21,NXAGRA
      COMMON/ARCPAR/MAXSEL,NSEL,MAXDEL,NDEL,MAXMET,NMETDT,NSATID,       &
     &              IATDEN,ISATEQ,ITRMAX,ITRMIN,ITRMX2,                 &
     &              MJDSRF,MREFSY,NTDDR,NBTOTL,IDRAGM,IMRNUT,           &
     &              NXARCP
      COMMON/BINBUF/NBUFIN,NLENI ,MAXBUF,MAXOBS,NBUFOT,NLENO ,NMAXOT,   &
     &              KBUFOT,MXBLEN,MAXTDD,NLENDR,MOBSBK,MXTIMB,          &
     &              MXOBSB,IIOBDR,IPSMAX,ILIMBK,NPASS ,MVERSN,NXBINB
      COMMON/CLSSOT/LSSTMO,LOTMOD,LPRDES,NXLSST
      COMMON/CONTRL/LSIMDT,LOBS  ,LORB  ,LNOADJ,LNADJL,LORFST,LORLST,   &
     &              LORALL,LORBOB,LOBFST,LOBLST,LOBALL,LPREPO,LORBVX,   &
     &              LORBVK,LACC3D,LSDATA,LCUTOT,LACCEL,LDYNAC,LFRCAT,   &
     &              LNIAU ,NXCONT
      COMMON/CORA  /KA1UTC,KA1UT1,KXP   ,KYP   ,KEOPDP,KEOPDS,KFLXS ,   &
     &              KFLXM ,KFLXAV,KBIN  ,KBOUT ,KOBDR ,KDAT1 ,KDAT2 ,   &
     &              KDAT3 ,KSCOB ,KB1   ,KB2   ,KB3   ,KBSIGM,KBBIAS,   &
     &              JDSCRP,JDPSR ,JPOLIN,JPUTBH,JXNMOL,JEAQFB,JEAQFE,   &
     &              JEAEFB,JEAEFE,JEAINT,JEASTP,JEAVER,JATPER,JTACCL,   &
     &              JTIMES,JTDYNS,JTIMED,JEXACT,JXACIN,JCTBTI,JCTBWE,   &
     &              JCTCTM,JRTMTB,JVLOPT,JSIGSP,JSSDST,JSSDSR,JSSDDG,   &
     &              JXCGST,JXCGDT,JTACFB,JTACFE,JTAVER,JTAEFB,JTAEFE,   &
     &              JTAINT,JTASTP,JNUTIN,JNUTMD,JDWNWT,NXCORA
      COMMON/CORE2S/KORE2S(3,2),KSCL2S(3),NGRP2S,MACH2S,KCOM2S,MAXC2E,  &
     &              NXCORS
      COMMON/COREQ /NCHRLY,MAXUTC,MAXUT1,MAXFLX,MAXDSC,KORSUM(3),       &
     &              KORSM2(3),NXCORQ
      COMMON/CORI  /KNAME ,KSTA  ,KCONFG,KTYPE ,KSATCD,KMOD  ,KDAY1 ,   &
     &              KTIM1 ,KDAY2 ,KTIM2 ,KVBAS ,KVSTA ,KSATID,KISETN,   &
     &              KVBSTA,KVBVEL,KQUAID,KBNQUA,KBSTA1,KBSAT1,KBTYPE,   &
     &              KBTIM1,KBTIM2,KBIDX, KKPTR ,KSATEQ,JIORFR,JIPDFR,   &
     &              JINDPI,KPSSTA,KPSSAT,KPSTYP,KPSBIA,KPSBLK,KPSTIM,   &
     &              KPSPTR,JEBSTA,JEBSAT,JEBTYP,JEBBEG,JEBEND,JBKBIA,   &
     &              JIPOLC,JIBASP,JIPDAD,JIPDRD,JISTOL,JGTSRT,JGTSRA,   &
     &              JSSTPT,JSSTPA,JSSTFQ,JNPANE,JIFACE,JIPARE,JIPSPR,   &
     &              JIPDIF,JIPEMI,JIPTPA,JIPTPC,JIPTMD,JIPTMF,JIPTHX,   &
     &              JNADAR,JNADSP,JNADDF,JNADEM,JNADTA,JNADTC,JNADTD,   &
     &              JNADTF,JNADTX,JNMOVE,JEASID,JEAQSB,JEAQSE,JEANPA,   &
     &              JEAESB,JEAESE,JEAPNT,JEANMQ,KVBSL2,KVBSH2,KBATYP,   &
     &              JNRDGA,JNRDDR,JNRDSR,JCSETA,JCSETD,JCSETS,JVSETA,   &
     &              JVSETD,JVSETC,JSTRTA,JSTRTD,JSTRTS,JNSTLV,JSLVID,   &
     &              JATSAT,JKVLAS,JYWSID,JLOV  ,JCBID ,JCBDEG,JSATAC,   &
     &              JSATDY,JSATHR,JACSID,JCTBST,JSRTTB,JTMPTB,JSTBST,   &
     &              JDN   ,JDN2  ,JDN3  ,JALSIT,JAPLST,KBDEGR,KBNODE,   &
     &              KBNPRM,KBSSTA,JBSPLN,JSSPLN,JNEXCG,JIDEXC,JNREXC,   &
     &              JWEMGA,JWEMDR,JTPATS,KSIGOV,JTACSB,JTACSE,JTASID,   &
     &              JTAESB,JTAESE,JTANMC,JTAPNT,JTANPA,JGPSID,JGPSBL,   &
     &              JGPSND,JPNALB,JTDSAT,JTDANT,NXCORI
      COMMON/CORL  /KLKEEP,JLAFRC,KPSOUT,KPSOPN,KNBCDT,KQUADJ,JLEBIS,   &
     &              JLAJOL,JEAFIL,JLRDGA,JLRDDR,JLRDSR,JACFIL,KQVADJ,   &
     &              JTAFIL,NXCORL
      COMMON/CTIDES/NTIDE ,NSTADJ,NET   ,NETADJ,NETUN ,NOT   ,NOTADJ,   &
     &              NOTUN ,NETUNU,NETADU,NOTUNU,NOTADU,NBSTEP,KTIDA(3), &
     &              ILLMAX,NUNPLY,NNMPLY,NDOODN,MXTMRT,NRESP ,NXCTID
      COMMON/DELOFF/NOFFST,NSATDL,NSTADL,NCGMAS,NXDELO
      COMMON/EXTAGL/LEXTHC,NXTAGL
      COMMON/EXTAAI/NTASAT,NXTAAI
      COMMON/EXATGL/LEXATT,NXEAGL
      COMMON/EXATAI/NEASAT,NXEAAI
      COMMON/FANTOM/LFGLB,LFARC,LFTARC,LFTGLB,LENDGL,LPHNTM(4),LPHTIM(4)&
     &             ,LXTRAF,LSATFA(4,3),NXFANT
      COMMON/GLBPAR/NARCS,NDPOLE,NDCSA,MXDEGG,MXORDG,NSRA,              &
     &              NDUMMY,MAXPAS,NXGLBP
      COMMON/IBODPT/IBDCF(999),IBDSF(999),IBDGM(999),IBDAE(999)      ,  &
     &              IBDPF(999),ICBDCF,ICBDSF,ICBDGM,ICBDAE,ICBDPF,      &
     &              ITBDCF,ITBDSF,ITBDGM,ITBDAE,ITBDPF,NXBDPT
      COMMON/IEPHM2/ISUPL,ICBODY,ISEQB(2),MAXDEG,ITOTSE,IREPL(988),  &
     &              NXEPH2
      COMMON/IONO2E/IONNDX(12),IONRZ(12),IONOYM(12),IONYMS,IONYME,IURSI,&
     &              INTERP,NXIONO
      COMMON/ION2EL/LIONC,LFRQOP,lFRQOF,NXIONL
      COMMON/KNTSTS/KNTACC(9,40),MKNTAC,KNTDRG,KNTSLR,MAXNGA,MAXNDR,    &
     &              MAXNSR,NXKNTS
      COMMON/LAPLOD/LAPL,NXLAPL
      COMMON/LOCLSW/LINTER,NXLOCL
      COMMON/LSWTCH/LFLXPR,LMALL,LPGRAV,LST50,LST50I,LTERMV,LST17,      &
     &              NXLSWT
      COMMON/MBIAS /NBIASK,NBIASA,NBIASG,NBCDP,NBCDT,                   &
     &              NUMPAS,NPSFIL,NARCBS,NEBKNT,NXMBIA
      COMMON/MBIAST/MBTRAD,MBTRUN,ICONBIA,IPRCTP,IPREND,NXMBST
      COMMON/MBSGLB/MBIASK,MBIASA,MBIASG,MBCDP,MBCDT,MARCBS,            &
     &              NBIST2,MEBKNT,NBIAST,NXMBGB
      COMMON/MLTARC/LAUNIT,LREWND
      COMMON/NEQINT/NINTOT,MEMTOT,NEQNIM,NXNEQS
      COMMON/NPCOM /NPNAME,NPVAL(92),NPVAL0(92),IPVAL(92),IPVAL0(92),   &
     &              MPVAL(28),MPVAL0(28),NXNPCM
      COMMON/NPCOMX/IXARC ,IXSATP,IXDRAG,IXSLRD,IXACCL,IXGPCA,IXGPSA,   &
     &              IXAREA,IXSPRF,IXDFRF,IXEMIS,IXTMPA,IXTMPC,IXTIMD,   &
     &              IXTIMF,IXTHTX,IXTHDR,IXOFFS,IXBISA,IXFAGM,IXFAFM,   &
     &              IXATUD,IXRSEP,IXACCB,IXDXYZ,IXGPSBW,IXCAME,IXBURN,  &
     &              IXGLBL,IXGPC ,IXGPS, IXTGPC,IXTGPS,IXGPCT,IXGPST,   &
     &              IXTIDE,IXETDE,IXOTDE,IXOTPC,IXOTPS,IXLOCG,IXKF  ,   &
     &              IXGM  ,IXSMA ,IXFLTP,IXFLTE,IXPLTP,IXPLTV,IXPMGM,   &
     &              IXPMJ2,IXVLIT,IXEPHC,IXEPHT,IXH2LV,IXL2LV,IXOLOD,   &
     &              IXPOLX,IXPOLY,IXUT1 ,IXPXDT,IXPYDT,IXUTDT,IXVLBI,   &
     &              IXVLBV,IXXTRO,IXBISG,IXSSTF,IXFGGM,IXFGFM,IXLNTM,   &
     &              IXLNTA,IX2CCO,IX2SCO,IX2GM ,IX2BDA,IXRELP,IXJ2SN,   &
     &              IXGMSN,IXPLNF,IXPSRF,IXANTD,IXTARG,                 &
     &              IXSTAP,IXSSTC,IXSSTS,IXSTAV,IXSTL2,                 &
     &              IXSTH2,IXDPSI,IXEPST,IXCOFF,IXTOTL,NXNPCX
      COMMON/OFFSTL/LOFFST
      COMMON/OLDMOD/NTOLFR,NTOLF2,NTOLMD,NSTAOL,NSITOL,NTOLAJ,MXOLSA,   &
     &              NPOLSH,                                             &
     &              NXOLMD
      COMMON/PLMONI/IMNNUM(5,2),NXPLMI
      COMMON/SSLIST/MXBAS,MXSTA,MXSAT,MXBSTA,MXSTV,MXQUA,NXSSLI
      COMMON/STATN /NSTA,NSTAE,NMSTA,NCSTA,NSTAV,NSTLV,NSTEL2,          &
     &              NSTEH2,                                             &
     &              NPH2L2,                                             &
     &              NSTNUM, NSTIME, NALLST,KCONAD, NXSTAT
      COMMON/UNITS /IUNT01,IUNT02,IUNT03,IUNT05,IUNT06,IUNT07,IUNT11,   &
     &              IUNT12,IUNT15,IUNT16,                               &
     &              IUNT30,IUNT31,IUNT39,IUNT40,IUNT41,IUNT42,IUNT43,   &
     &              IUNT50,IUNT52,IUNT53,IUNT60,IUNT90,IUNT91,IUNT99,   &
     &              ILINE(2),IPAGE(2),MLINEP(2),MAXCOL(2),IUNT17,       &
     &              IUNT70,IUNT71,                                      &
     &              IUNT88,NXUNIT
      COMMON/VLBI/NQUA,NADJQ,NADJQV,NQUAB,IYMDV,NVOPT,NXVLBI
      COMMON/LSFSHD/LSLFSH, NXSLFS

      COMMON/TOPOVR/NMTPAT,MXTPAT,NOVRID,NGCATT,NTPBIA,NSTLVS,          &
     &              NISLV, NYWBIA,MSATYW,MAXYWB,NSATTP,NXTOPO
      COMMON/EXCGCR/NEXCG,IDEXCG(200),IFTPCG(200),NRCDCG(200),NXEXCG
      COMMON/SLRATI/ISLRNS,ISLRID(10),ISLRNO(10),ISLRMO,NXSLRI
      COMMON/SLRATL/LRATIO,NXSLRL

      DIMENSION AA1(1)
      DIMENSION II1(1)
      DIMENSION LL1(1)
!
!     ....BELOW CHANGED FROM 3,9 TO 3,NCORE2 3/11/92 JJM
      DIMENSION KORE(3,NCORE2)
!
! DUMMY ARRAYS FOR CALL TO ARCCON
      DIMENSION ADUM(1),IDUM(1),LDUM(1)
! DEBUG
      DIMENSION DUMMY1(2601),DUMMY2(100)
!
      DIMENSION BS1(11)
! DEBUG
      DIMENSION ISIGOV(1)

! THIS IS A LOCAL JUNK ARRAY TO USE WITH MOSTCMN IT ACTS AS A PLACE
! HOLDER IN THE PARAMETER  5/11/99 PD
      DIMENSION IJUNK(20)
!
      DATA NCORE/11/
!**********************************************************************
!* START OF EXECUTABLE CODE *******************************************
!**********************************************************************
!
      NTIDE=0
!
! INITIALIZATIONS FOR ATITUDE MODEL
      NASAT=0
      DO 10 I=1,MXSAT
      II1(JATSAT-1+I)=0
   10 END DO
! INITIALIZATIONS
      LATGRV=.FALSE.
      CALL ZEROI(NPVAL    ,NPNAME)
      CALL ZEROI(NPVAL0   ,NPNAME)
!
! INITIALIZE LENDGL of COMMON/FANTOM/
      LENDGL=.FALSE.

       DO 11 I = 0,(MAXCDS-1)
         II1(KSIGOV+I)=0
   11  ENDDO

! READ GRAVITY MODEL HEADER
!
      CALL RDGRAV(.TRUE.,DUM1,DUM2)
!
! READ A1-UTC AND A1-UT1 DATA
!
      CALL RDA1UT(AA1(KA1UTC),AA1(KA1UT1) )
!
! READ POLAR MOTION DATA
      CALL RDPOLE(AA1(KXP),AA1(KYP) )
!
! READ ADDITIONAL EARTH ORIENTATION PARAMETERS
      CALL RDEOPS(AA1(KEOPDP),AA1(KEOPDS) )
!
! READ SOLAR FLUX DATA
!
      IFLX=1
      CALL RDFLUX(AA1(KFLXS),IFLX)
!
! READ MAGNETIC FLUX DATA
!
      IFLX=3
      IF(IATDEN.EQ.10) IFLX=2
      CALL RDFLUX(AA1(KFLXM),IFLX)
!
! READ 3 HOURLY MAGNETIC FLUX DATA
!
      IF((IATDEN.EQ.42).OR.(IATDEN.EQ.43)) CALL RDFLX8(AA1(KFLXM))
      IF((IATDEN.EQ.52).OR.(IATDEN.EQ.53)) CALL RDFLX8(AA1(KFLXM))
      IF((IATDEN.EQ.62).OR.(IATDEN.EQ.63)) CALL RDFLX8(AA1(KFLXM))
!
! READ IONOSPHERIC DATA
!
      IF(LIONC)CALL RDIONO
!
! REWIND TABLES FILE
!
      REWIND IUNT02


      IF(LRATIO) CALL RDRATO(2,77,DUM,DUM,DUM)

!
! LOAD GLOBAL SET INFORMATION INTO ALLOCATION #1 ARRAYS AND COUNT
! GLOBAL PARAMETERS FOR ALLOCATION #2
!
! SETTING FIRST VALUE OF THE AVERAGE SOLAR FLUX ARRAY EQUAL TO
! ZERO.  THIS VALUE IS USED AS A FLAG FOR USER SPECIFIED AVERAGE
! SOLAR FLUX IN FLXAVG
      AA1(KFLXAV)=0.0D0
!
! SETTING THE CENTRAL BODY ID IN THE COMMONLY KNOWN VARIABLE
!
      ICBDGM=ICBDCF
      NINTOT=0
!
      IARC=0
      CALL DEFALC(IARC)
      IF(LOFFST) THEN
       INQUIRE(EXIST=LEXIST,FILE='OFFSET.scr')
        IF(LEXIST) THEN
         OPEN(UNIT=47,FILE='OFFSET.scr',STATUS='OLD',FORM='FORMATTED')
         CLOSE(UNIT=47,STATUS='DELETE')
        ENDIF
       OPEN(UNIT=47,FILE='OFFSET.scr',STATUS='NEW',FORM='FORMATTED')
      ENDIF

      CALL RD50A2(AA1,II1,LL1,IARC,II1(KNAME),II1(KSTA),II1(KCONFG),    &
     &     II1( KTYPE),II1(KSATCD),II1(KMOD  ),II1(KDAY1 ),II1(KTIM1 ), &
     &     II1( KDAY2),II1( KTIM2),AA1( KDAT1),AA1( KDAT2),AA1( KDAT3), &
     &     II1( KVSTA),II1(KSATID),II1(KISETN),II1(KBSTA1),II1(KBSAT1), &
     &     II1(KBTYPE),II1(KBTIM1),II1(KBTIM2),AA1(KBSIGM),AA1(KBBIAS), &
     &     II1(JIORFR),II1(JIPDFR),LL1(JLAFRC),AA1(JPOLIN),AA1(JDPSR ), &
     &     II1(JINDPI),II1( KVBAS),II1(KVBSTA),II1(JEBBEG),II1(JEBEND), &
     &     II1(JEBTYP),II1(JEBSTA),II1(JEBSAT),II1(JIBASP),II1(JIPDAD), &
     &     AA1(JXNMOL),LL1(JLAJOL),II1(JGTSRT),II1(JGTSRA),             &
     &     II1(JSSTPT),II1(JSSTPA),II1(KQUAID),II1(KBNQUA),LL1(KQUADJ), &
     &     II1(JNPANE),II1(JNMOVE),II1(JIFACE),                         &
     &     II1(JIPARE),II1(JIPSPR),II1(JIPDIF),II1(JIPEMI),II1(JIPTPA), &
     &     II1(JIPTPC),II1(JIPTMD),II1(JIPTMF),II1(JIPTHX),II1(JNADAR), &
     &     II1(JNADSP),II1(JNADDF),II1(JNADEM),II1(JNADTA),II1(JNADTC), &
     &     II1(JNADTD),II1(JNADTF),II1(JNADTX),LATGRV     ,II1(KBATYP), &
     &     LL1(JLRDGA),LL1(JLRDDR),LL1(JLRDSR),II1(JCSETA),II1(JCSETD), &
     &     II1(JCSETS),AA1(KA1UTC),II1(JNSTLV),II1(JSLVID),II1(JATSAT), &
     &     II1(JKVLAS),AA1(JATPER),II1(JYWSID),AA1(JTACCL),AA1(JTDYNS), &
     &     II1(JSATHR),II1(JCTBST),AA1(JCTBTI),AA1(JCTBWE),AA1(JCTCTM), &
     &     II1(JDN),   LL1(KQVADJ),II1(KBDEGR),II1(KBNODE),II1(KBSSTA), &
     &     AA1(JVLOPT),AA1(JSIGSP),II1(JBSPLN),II1(JSSPLN),II1(KBNPRM), &
     &     II1(JTPATS),II1(KSIGOV),AA1(JNUTIN),AA1(JNUTMD),II1(JGPSID), &
     &     II1(JGPSBL),II1(JGPSND),II1(JPNALB),II1(JTDSAT),II1(JTDANT))

!      write(6,*) "RD50A2: AA1(JNUTIN) :", AA1(JNUTIN),JNUTIN
!      write(6,*) "RD50A2: AA1(JNUTMD) :", AA1(JNUTMD),JNUTMD


! ORDERING THE TIME DEPENDENT GRAVITY COEFFICIENTS
      NDSORT=NPVAL(IXGPCT)+NPVAL(IXGPST)
      CALL GRVTMO(II1(JGTSRT),NDSORT)
      NDSORA=NPVAL0(IXGPCT)+NPVAL0(IXGPST)
      CALL GRVTMO(II1(JGTSRA),NDSORA)
!
!
! ORDERING THE SEA SURFACE TOPOGRAPHY TERMS (EMAT ORDER)
      NDSORT=NPVAL(IXSSTC)+NPVAL(IXSSTS)
      NDSORA=NPVAL0(IXSSTC)+NPVAL0(IXSSTS)
      CALL GRVTMO(II1(JSSTPT),NDSORT)
      CALL GRVTMO(II1(JSSTPA),NDSORA)
!
!  COUNT AND CHECK PLANET PARAMETERS
      CALL BDCNT
!
! PUT PLANET MOONS IN EMAT ORDER
!
      IF(NPVAL(IXPMGM).GT.1) THEN
      CALL PMSORT
      ENDIF
!
! REORDER POLAR MOTION ARRAYS
!
      CALL POLORD(II1(JINDPI),AA1(JDPSR),AA1(JPOLIN),II1(JIPOLC))
!
! REORDER GLOBAL MBIAS
!
      MBK3=MBIASK*3
      IF(MBIASG.GT.1) CALL BISORG(II1(KBSTA1+MBK3),II1(KBSAT1+MBK3),    &
     &     II1(KBTYPE+MBIASK),II1(KBTIM1+MBIASK),II1(KBTIM2+MBIASK),    &
     &     AA1(KBSIGM+MBIASK),AA1(KBBIAS+MBIASK),II1(KBIDX+MBIASK) )
!
! REORDER SOME OF THE OCEAN LOADING INFORMATION
!
      IF(NTOLMD.GT.0) CALL OLORD1(LL1(JLAJOL),AA1(JXNMOL),II1(JISTOL))
!
! GET UNIQUE DOODSON NUMBER ARRAY FOE TIDES
      CALL GETDOO(II1(JDN),II1(JDN2),NTOLMD,AA1(JXNMOL),NDOODN)
! DEBUG
      JB=KSATEQ
      JE=JB+7
! SUM GLOBAL PARAMETERS FOR ALLOCATION#2
! DEBUG
      WRITE(IUNT90,98520) IARC,IXARC,IXGLBL,IXTOTL,NPVAL(IXARC),        &
     &     NPVAL(IXGLBL),MPVAL(IXARC)
98520 FORMAT(1X,'MAIN2-IARC,IXARC,IXGLB,IXTOTL,NPVAL(IXARC)',7I6)
! DEBUG
      CALL SUMNP(IARC)
      CALL SUMNP(IARC)
! DEBUG
      WRITE(IUNT90,98520) IARC,IXARC,IXGLBL,IXTOTL,NPVAL(IXARC),        &
     &     NPVAL(IXGLBL)
! DEBUG
!
!  READ THE HEADERS OF ATMOSPHERIC COEFFICIENT FILES TO SELECT
!  AND DEFINE THE TOTAL NUMBER OF FILES.
      IF(LATGRV) THEN
      NSAG=1
      CALL RDATGR(AA2,18,.FALSE.,DUMMY1,DUMMY2,NSAG)
      IF(NADEG.GT.MXDEGG)THEN
      NADEG=MXDEGG
      NAORD=NADEG
      ENDIF
      ENDIF
!
      IF(LAPL) THEN
      CALL RDAPLF(2,24,.FALSE.,II1(JALSIT),DUM1,II1(JISTOL),IDUM,       &
     &            II1(JAPLST),DUM1)
      ENDIF
!
! FIRST READ 20 OR 21 FILES IF THERE ARE OTMOD OR SSTMOD CARDS OR BOTH
!
      IF(.NOT.LPRDES) GOTO 7770
      IF(.NOT.LSSTMO.AND..NOT.LOTMOD) GOTO 7770
      LALL = (LSSTMO.AND.LOTMOD)
      CALL RDPRDC(LSSTMO,LOTMOD,LALL)
 7770 CONTINUE
!
! PROCESS ARC INFORMATION
!
!
      MAXPAS=0
      DO 500 IARC=1,NARCS
! DEBUG
      WRITE(IUNT90,90110) IARC
90110 FORMAT(1X,'MAIN2 - ARC NO. ',I5)
! DEBUG
!  INITIALIZE ARC INFORMATION
      CALL DEFALC(IARC)
      CALL INITA2(II1(KSATID),II1(KISETN),II1(KSATEQ),II1(JIORFR),      &
     & II1(JIPDFR),LL1(JLAFRC),II1(JIBASP),II1(JIPDAD),II1(KNAME),      &
     & II1(KSTA),II1(KCONFG),II1(KTYPE),II1(KSATCD),II1(KMOD),          &
     & II1(KDAY1),II1(KTIM1),II1(KDAY2),II1(KTIM2),                     &
     & II1(JNPANE),II1(JNADAR),II1(JNADSP),II1(JNADDF),II1(JNADEM),     &
     & II1(JNADTA),II1(JNADTC),II1(JNADTD),II1(JNADTF),II1(JNADTX),     &
     & II1(JNMOVE))
!
! IF EXTERNAL THERMAL ACCELERATION REQUESTED ON ANY ONE ARC THEN READ
!
      IF(LEXTHC) THEN
       CALL RDTACC(2,IARC,AA1,II1,LL1)
      ENDIF
!
! IF EXTERNAL ATTITUDE REQUESTED ON ANY ONE ARC THEN TEST AND READ FOR T
!
      IF(LEXATT) THEN
       CALL RDEXAT(2,IARC,AA1,II1,LL1)
      ENDIF
!
! IF SELF SHADOWING MODEL REQUESTED
      IF(LSLFSH) THEN
        CALL RDSSHD(2,AA1)
      ENDIF
!
! INITIALIZE II1(JNEXCG) THIS HAS TO BE DONE
      II1(JNEXCG)=0
      IF(NEXCG.GT.0) THEN
        CALL RDEXCG(2,AA1,II1)
      ENDIF
!
!  PARAMETERS FOR ALLOCATION#2
!
!  LOAD ARC SET INFORMATION INTO ALLOCATION#1 ARRAYS AND COUNT ARC
!  PARAMETERS FOR ALLOCATION#2
      NMTPAT=0
!
      CALL RD50A2(AA1,II1,LL1,IARC,II1(KNAME),II1(KSTA),II1(KCONFG),    &
     &     II1( KTYPE),II1(KSATCD),II1(KMOD  ),II1(KDAY1 ),II1(KTIM1 ), &
     &     II1( KDAY2),II1( KTIM2),AA1( KDAT1),AA1( KDAT2),AA1( KDAT3), &
     &     II1( KVSTA),II1(KSATID),II1(KISETN),II1(KBSTA1),II1(KBSAT1), &
     &     II1(KBTYPE),II1(KBTIM1),II1(KBTIM2),AA1(KBSIGM),AA1(KBBIAS), &
     &     II1(JIORFR),II1(JIPDFR),LL1(JLAFRC),AA1(JPOLIN),AA1(JDPSR ), &
     &     II1(JINDPI),II1( KVBAS),II1(KVBSTA),II1(JEBBEG),II1(JEBEND), &
     &     II1(JEBTYP),II1(JEBSTA),II1(JEBSAT),II1(JIBASP),II1(JIPDAD), &
     &     AA1(JXNMOL),LL1(JLAJOL),II1(JGTSRT),II1(JGTSRA),             &
     &     II1(JSSTPT),II1(JSSTPA),II1(KQUAID),II1(KBNQUA),LL1(KQUADJ), &
     &     II1(JNPANE),II1(JNMOVE),II1(JIFACE),                         &
     &     II1(JIPARE),II1(JIPSPR),II1(JIPDIF),II1(JIPEMI),II1(JIPTPA), &
     &     II1(JIPTPC),II1(JIPTMD),II1(JIPTMF),II1(JIPTHX),II1(JNADAR), &
     &     II1(JNADSP),II1(JNADDF),II1(JNADEM),II1(JNADTA),II1(JNADTC), &
     &     II1(JNADTD),II1(JNADTF),II1(JNADTX),LATGRV     ,II1(KBATYP), &
     &     LL1(JLRDGA),LL1(JLRDDR),LL1(JLRDSR),II1(JCSETA),II1(JCSETD), &
     &     II1(JCSETS),AA1(KA1UTC),II1(JNSTLV),II1(JSLVID),II1(JATSAT), &
     &     II1(JKVLAS),AA1(JATPER),II1(JYWSID),AA1(JTACCL),AA1(JTDYNS), &
     &     II1(JSATHR),II1(JCTBST),AA1(JCTBTI),AA1(JCTBWE),AA1(JCTCTM), &
     &     II1(JDN),   LL1(KQVADJ),II1(KBDEGR),II1(KBNODE),II1(KBSSTA), &
     &     AA1(JVLOPT),AA1(JSIGSP),II1(JBSPLN),II1(JSSPLN),II1(KBNPRM), &
     &     II1(JTPATS),II1(KSIGOV),AA1(JNUTIN),AA1(JNUTMD),II1(JGPSID), &
     &     II1(JGPSBL),II1(JGPSND),II1(JPNALB),II1(JTDSAT),II1(JTDANT))
!
! READ EXTERNAL CGMASS FILE

!
!  RE-ORDER INFORMATION ON THE TROPOSPHERIC BIAS CONSTRAINTS ARRAYS TO M
!  THE SEQUENCE OF THE PARMV0 ARRAY CTBORD (CON TROP BIAS ORDER)

      IF(ICONBIA.GT.0)                                                  &
     &CALL CTBORD(II1(JCTBST),AA1(JCTBTI),AA1(JCTBWE),AA1(JCTCTM),      &
     &            II1(JSRTTB),II1(JTMPTB),AA1(JRTMTB),ICONBIA)
!
! IF EXTERNAL ACCELERATION REQUESTED ON ANY ONE ARC ,TEST AND READ FOR T
!
      IF(LDYNAC) THEN
       CALL RDEXAC(2,IARC,AA1,II1,LL1,II1(KSATID))
      ENDIF

! RE-ORDER AND CHECK THE ACCELEROMETER BIAS SCHEDULING ARRAYS
         IF(LACCEL.AND.NACCB.GT.0)                                      &
     &   CALL ACCCHK(AA1(JTACCL),AA1(JTIMES),II1(JSATAC),II1(KSATID))
         IF(LDYNAC) CALL DYNCHK(AA1(JTDYNS),AA1(JTIMED),II1(JSATDY),    &
     &              II1(KSATID))
! COUNT THE NUMBER OF SATELLITES THAT HAVE YAWBIAS CARDS
      IF(NYWBIA .GT. 0) THEN
         CALL UNIQNUM(II1(JYWSID),NYWBIA,MSATYW)
         CALL MOSTCMN(II1(JYWSID),NYWBIA,MSATYW,MAXYWB,IJUNK,.FALSE.)
      ENDIF
!
! COUNT THE ARC OFFSET PARMS
      IF(LOFFST) CALL OFFCNT(II1(KSATID))
!
! IF THERE ARE OFFSET CARDS AND  THE IONOSPHERIC OPTION HAS BEEN SELECTE
! AND THERE FREQUENCIES ON ALL THE OFFSET CARDS SET LFRQOP TO TRUE.
!
      IF((NOFFST.NE.0).AND.LIONC.AND.LFRQOF)LFRQOP=.TRUE.
!
! ORDERING THE TIME DEPENDENT GRAVITY COEFFICIENTS
      NDSORT=NPVAL(IXGPCT)+NPVAL(IXGPST)
      CALL GRVTMO(II1(JGTSRT),NDSORT)
      NDSORA=NPVAL0(IXGPCT)+NPVAL0(IXGPST)
      CALL GRVTMO(II1(JGTSRA),NDSORA)
!
! ORDERING THE BOX-WING PARAMETERS
      NDSORT=NPVAL(IXAREA)
      IF(NDSORT .GT. 1) THEN
      CALL GRVTMO(II1(JIFACE),NDSORT)
      ENDIF
! ORDERING THE ADJUSTED BOX-WING PARAMETERS
      NDSORA=NPVAL0(IXAREA)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPARE),NDSORA)
      ENDIF
!    1            (NPVAL0(IKB),IKB=8,16)
!
      NDSORA=NPVAL0(IXSPRF)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPSPR),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXDFRF)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPDIF),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXEMIS)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPEMI),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXTMPA)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPTPA),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXTMPC)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPTPC),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXTIMD)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPTMD),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXTIMF)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPTMF),NDSORA)
      ENDIF
!
      NDSORA=NPVAL0(IXTHTX)
      IF(NDSORA .GT. 1) THEN
      CALL GRVTMO(II1(JIPTHX),NDSORA)
      ENDIF
!
!  RE-ORDER II(JGPSND)
      NGPSPRM=NPVAL0(IXGPSBW)
      IF(NGPSPRM.GT.1) THEN
      CALL GRVTMO(II1(JGPSND),NGPSPRM)
      ENDIF
!


      JLAF12=JLAFRC+11
      WRITE(IUNT90,70077) (LL1(JX),JX=JLAFRC,JLAF12)
70077 FORMAT(1X,'AFTER RD50A2,BEFORE BINARY,LAFRC=',12L2)
! DEBUG
!  READ DATA FOR ARC
      IF(LOBS.AND..NOT.LSDATA) THEN
       IF(IARC.GT.1) THEN
        IF(LAUNIT) THEN
        CLOSE(IUNT40)
        IA1=IARC/10
        IA2=IARC-IA1*10
        WRITE(FILNAM,FMT='(A3,I1,I1)')'ARC',IA1,IA2
        OPEN(UNIT=IUNT40,FILE=FILNAM,FORM='UNFORMATTED',STATUS='OLD')
        GOTO 1100
        ELSE
        IF(LREWND) REWIND IUNT40
        GOTO 1100
        ENDIF
       ENDIF
      OPEN(UNIT=IUNT40,FILE='ftn40',FORM='UNFORMATTED',STATUS='OLD')
 1100 CONTINUE

      CALL BINARY(II1(KSTA),II1(KCONFG),II1(KTYPE),II1(KSATCD),         &
     &     II1(KMOD),II1(KDAY1),II1(KTIM1),II1(KDAY2),II1(KTIM2),       &
     &     AA1(KDAT1),AA1(KDAT2),AA1(KDAT3),II1(KNAME),LL1(KLKEEP),     &
     &     II1(KKPTR),AA1(KSCOB),AA1(KB1),AA1(KB2),AA1(KB3),            &
     &     AA1(KBIN),AA1(KBOUT),AA1(KOBDR),II1(KVBAS),II1(KVSTA),       &
     &     II1(KSATID),II1(KVBSTA),II1(KBSTA1),II1(KBSAT1),II1(KBTYPE), &
     &     II1(KBTIM1),II1(KBTIM2),II1(KBIDX),AA1(KBSIGM),AA1(KBBIAS),  &
     &     AA1(JDSCRP),II1(KPSSTA),II1(KPSSAT),II1(KPSTYP),II1(KPSBIA), &
     &     II1(KPSBLK),II1(KPSTIM),LL1(KPSOUT),LL1(KPSOPN),II1(KPSPTR), &
     &     LL1(KNBCDT),II1(JEBBEG),II1(JEBEND),II1(JEBTYP),II1(JEBSTA), &
     &     II1(JEBSAT),LL1(JLEBIS),II1(JBKBIA),II1(KQUAID),II1(KBNQUA), &
     &     LL1(KQUADJ),II1(KBATYP),     LACCEL,     LDYNAC,LL1(KQVADJ), &
     &     II1(KBDEGR),II1(KBNODE),II1(KBSSTA),II1(KBNPRM),II1(KSIGOV))
      ENDIF
! DEBUG
      JLAF12=JLAFRC+11
      WRITE(IUNT90,70177) (LL1(JX),JX=JLAFRC,JLAF12)
70177 FORMAT(1X,'AFTER BINARY,BEFORE ARCSM2,LAFRC=',12L2)
! DEBUG
! TERMINATE FLAG IF A DATA REDUCTION RUN HAS NO OBSERVATIONS FOUND
      IF(LOBS.AND.NTDDR.EQ.0) LINTER=.FALSE.
      IF(LSDATA) LINTER=.TRUE.
!  SUMMARIZE ARC INFORMATION
! debug extatt
!      print *,'main2: iarc,neasat is: ',iarc,neasat
! debug extatt

      CALL ARCSM2(IARC,II1(KSATID),II1(KISETN),II1(KSATEQ),             &
     &     II1(JIORFR),II1(JIPDFR),LL1(JLAFRC),II1(JIPDAD),             &
     &     LL1(JEAFIL),II1(JEASID),II1(JEAQSB),II1(JEAQSE),             &
     &     II1(JEANPA),II1(JEAESB),II1(JEAESE),AA1(JEAQFB),             &
     &     AA1(JEAQFE),AA1(JEAEFB),AA1(JEAEFE),AA1(JEAINT),             &
     &     AA1(JEASTP),II1(JEAPNT),II1(JEANMQ),     NEASAT,             &
     &     AA1(JEXACT),AA1(JXACIN),LL1(JTAFIL),II1(JTASID),             &
     &     II1(JTACSB),II1(JTACSE),II1(JTAESB),II1(JTAESE),             &
     &     AA1(JTACFB),AA1(JTACFE),AA1(JTAEFB),AA1(JTAEFE),             &
     &     AA1(JTAINT),II1(JTANPA),NTASAT,II1(JTAPNT),                  &
     &     II1(JTANMC),AA1(JTASTP))


! DEBUG
      JLAF12=JLAFRC+11
      WRITE(IUNT90,70277) (LL1(JX),JX=JLAFRC,JLAF12)
70277 FORMAT(1X,'AFTER ARCSM2,BEFORE STORE ,LAFRC=',12L2)
! DEBUG
      MBK3=MBIASK*3
      WRITE(IUNT90,70377) KBSTA1,MBK3,KBTYPE,MBIASK
70377 FORMAT(1X,'KBSTA1,MBK3:',1X,I10,1X,I10,1X,'KBTYPE,MBIASK:',1X,    &
     &     I10,1X,I10)
! STORE ARC DATA ON SCRATCH DISK
      CALL ARCCON(AA1,II1,LL1,ADUM,IDUM,LDUM,52,.TRUE.,IARC,.TRUE.)
  500 END DO
!
! READ EPHEMERIS FILE
!
      CALL EPHMHD(AA1)
!
! CALL ROUTINES FOR SUPPLEMENTARY EPHEMERIS IF APPLICABLE
!
      IF(ISUPL.GT.0) THEN
      CALL RDEPH2(II1)
      CALL EPHEM2(II1,II1(JCBDEG),II1(JLOV))
      ENDIF
!
! QUASAR  COORDINATE INFORMATION
! STATION COORDINATE INFORMATION.
! SET NPVAL & NPVAL0 FOR STATIONS(NPVAL0 WILL BE RESET IN OPTSTA)
!
      NPVAL(IXVLBI)=NQUAB*2
      NPVAL(IXVLBV)=NQUAB*2
      NPVAL(IXSTAP)=NSTA*3
      NPVAL(IXSTAV)=NSTA*3
      NPVAL(IXSTL2)=NSTA
      NPVAL(IXSTH2)=NSTA
      IF(NPVAL0(IXVLBI) .GT. 0) NPVAL0(IXVLBI)=NADJQ*2
      IF(NPVAL0(IXVLBV) .GT. 0) NPVAL0(IXVLBV)=NADJQV*2
      IF(NPVAL0(IXSTAP) .GT. 0) NPVAL0(IXSTAP)=NSTA*3
      IF(NPVAL0(IXSTAV) .GT. 0) NPVAL0(IXSTAV)=NSTA*3
      IF(NPVAL0(IXSTL2).GT.0.OR.NPVAL0(IXSTH2).GT.0) THEN
      NPVAL0(IXSTL2)=NSTA
      NPVAL0(IXSTH2)=NSTA
      ENDIF
!     IF(NPVAL0(IXSTH2) .GT. 0) NPVAL0(IXSTH2)=NSTA
      CALL SUMNP(0)
! SUM UP THE FORCE MODEL PARAMETERS TO USE WITH THE HIGH RATE OPTION
!
!     CALL SUMFRC
! REWIND PASS-BY-PASS FILE, INPUT CARD FILE, ARC PARAMETER FILE
!        AND OBSERVATION DIRECTORY RECORD FILE
!
      ENDFILE IUNT41
      REWIND IUNT41
      REWIND IUNT43
      REWIND IUNT50
      REWIND IUNT52
! DEBUG
      IF(NPSFIL.LE.1) GOTO 7777
      DO 7776 I=1,NPSFIL
      READ(IUNT43) BS1
      WRITE(IUNT90,77776) I,BS1
77776 FORMAT(1X,'MAIN2 PASS BIAS #',1X,I6,/,4X,5(D20.13,1X),/,          &
     &     4X,5(D20.13,1X),/,4X,D20.13)
 7776 END DO
      REWIND IUNT43
 7777 CONTINUE
! DEBUG
!
! COMPUTE CORE REQUIREMENTS FOR ALLOCATION #2
      CALL KORCA2(KORE,KORSM2,NCORE2)
!
! COMPUTE POINTERS FOR ALLOCATION #2 ARRAYS
      CALL KORPA2(KORE,KORSM2,NCORE2)
!
! SCALE KORSM2 TO PROPER MACHINE ALLOCATION UNITS
!
      DO 5000 I=1,3
      KORSM2(I)=KORSM2(I)*KSCL2S(I)
 5000 END DO
      RETURN
      END
